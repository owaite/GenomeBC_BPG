
# Thermal Conversion

This method converts raw imagery from the Zenmuse H20T to temperature rasters. We wrote this method to bypass DJI's thermal analysis tool app since we have thousands of images and the app would often crash when a few were uploaded. This script uses the DJI thermal analysis tool's software developer kit (SDK) 


Prior to running this code you must:
- Download the .bat file for step 2 from the GitHub




```{r, eval=FALSE, echo=TRUE}
library(exiftoolr)
library(dplyr)
library(lubridate)
library(OpenImageR)
library(raster)
library(doParallel)
library(stringr)


# Read in CSV of weather data (ensure adjustments for daylight savings have been made if necessary) 
df <- read.csv("D:\\Fdc_PR_Canoe\\Site_Info\\Powell_River_Canoe2_All_Data_2023_02_07_PST_1_DaylightSavings_mar16_nov6_2022.csv")
df$Date <- as.Date(df$Date, '%m/%d/%y') #comes out as year-0m-0d

dates_DST <- c(unique(df$Date))
dates_DST
dates_list <- as.list(dates_DST)
dates_list

Canoe_df <- df
```


## Folder Set-Up

This step goes over how we organize our imagery for the following thermal conversion. 

Here we:

- create a folder named:

  - "Merged_T" within the original "H20T" folder, this is the location the raw thermal images will be copied. This allow us to (a) keep a backup of the original data and (b) easily iterate over the images to convert them in later steps
  
  - "Temperature_rasters" within the Merged_T folder that will hold converted imagery

  - "Temperature_rasters_EXIF" within the Merged_T folder that will hold converted imagery that has original imagery exif data written to it

- locate all folders within the defined directory that have DJI and H20T in the name

- Iterate over the folders found in the above step and:

  - find files that end in _T.JPG (the raw thermal images)
  - copy over the raw thermal images to the merged folder

**Note:** Our folder structure was:

- paste0("I:\\PARSER_Ext\\",site,"\\Flights\\", data_date, "\\1_Data\\H20T"), where "site" is a string of the site name that we defined prior to the for loop and data_date is a string representing the flight date that is defined in the for loop. This was done so we could easily iterate over sites and dates. Feel free to change this to match your folder structure.

```{r, eval=FALSE, echo=TRUE}
# Setting the site and flight date to convert thermal imagery
flight_dates <-  c("2023_05_10") # Here only one date is shown however this can be a list of however many dates you would like to iterate over
site <- "Fdc_PR_Canoe" 
merged <- "Merged_T" #name of the 'merged' folder that will contain all the h20T images from the multiple folders ouput by the H20T

for(i in 1:length(flight_dates)){
  data_date <- flight_dates[i]
  print(data_date)
  dir <- paste0("I:\\PARSER_Ext\\",site,"\\Flights\\", data_date, "\\1_Data\\H20T")
  #create folders
  if (!dir.exists(paste0(dir, "\\",merged))) {
    dir.create(paste0(dir, "\\",merged),recursive = TRUE)
  }
  if (!dir.exists(paste0(dir, "\\",merged,"\\Temperature_rasters"))) {
    dir.create(paste0(dir, "\\",merged,"\\Temperature_rasters"),recursive = TRUE)
  }
  if (!dir.exists(paste0(dir, "\\",merged,"\\Temperature_rasters_EXIF"))) {
    dir.create(paste0(dir, "\\",merged,"\\Temperature_rasters_EXIF"),recursive = TRUE)
  }
  
  list_dir <- list.files(dir, full.names = TRUE,pattern = c("DJI.+-H20T")) #selecting folders in the H20T folder that have DJI and end in -H20T, this is how we named our folders, change this pattern to match your folders. You should be selecting all folders with H20T imagery ending in _T for that flight
  print(list_dir) #to check only correct directories are being read
  
  for (d in 1:length(list_dir)){
    folder_dir <- list_dir[d] #calling each directly separately
    T_files <- list.files(folder_dir, pattern = "_T\\.JPG$") #selecting all JPEGs ending in _T 
    file.copy(from = paste0(folder_dir,"\\", T_files),
              to = paste0(dir,"\\",merged,"\\", T_files), overwrite = FALSE) #copying h20T images ending in _T (aka unprocessed thermal images) into the thermal only folder for ease in DJI SDK step
  }
}
```

## Weather Data

For this step you will need :

Humidity, Ambient Temperature

First, we use the first and last image in the Merged_T folder to define the start and end time of the flight, along with the date of the flight as a date object.

```{r, eval=FALSE, echo=TRUE}
#getting image capture date from exif data of the first image in the H20T folder

data_date <- flight_dates[1]

time_file_list <- list.files(paste0(dir,"\\",merged), pattern = "_T\\.JPG$")

#Retrieving the time the FIRST H20T thermal image was taken
(img_1 <- time_file_list[1]) #find the first thermal image and print the name
start_exif_flight_date <- data.frame(exif_read(paste0(dir,"\\",merged,"\\",img_1),
                                               tags = "CreateDate",
                                               quiet = TRUE)) #find the time the image was taken/written from the CreateDate tag in the exif data
(start_flight_date_time <- start_exif_flight_date$CreateDate) #Start of the flight

#Retrieving the time the LAST H20T thermal image was taken
(img_last <- tail(time_file_list, n=1))#End flight time
end_flight_date_time <- data.frame(exif_read(paste0(dir,"\\",merged,"\\",img_last),
                                             tags = "CreateDate",
                                             quiet = TRUE))
(end_flight_date_time <- end_flight_date_time$CreateDate)#End of the flight


(flight_date <- as.Date(start_exif_flight_date$CreateDate, '%Y:%m:%d %H:%M:%S')) #the flight date as a date object
(flight_date_filt <- as.Date(flight_date, format = '%Y-%m-%d')) #flight date in the format of 2024-03-10, YYYY-mm-dd, this ill be used in the next step to filter weather data
```

Next, since our weather station provided hourly measurements, we calculate a weighted average of temperature and humidity values based on time intervals. This was done to account for the fact that variables will change throughout the flight, so gathering a weighted average where each hourly measurement is weighted in proportion to how much of the hour fell within the flight window gives us a better estimate of the overall weather variables than if a plain average was taken.

To begin, we read in the weather data and set a start time and end time of the flight, where start time is rounded down to the nearest hour (i.e. 10:15am -> 10:00am) and end time is rounded up to the nearest hour (i.e. 11:30am -> 12:00pm). These values will be used to filter the weather data.
```{r, eval=FALSE, echo=TRUE}
cfs_weather <- "path to weather data" #loading in HOBO weather station data
cfs_weather$Date <- as.Date(cfs_weather$Date, format = "%m/%d/%y") #converting date in the format m/d/Y to a date object written as YYY-mm-dd

start_time_avg <- "10:00:00" #Based off of start_flight_date_time of 10:15am
stop_time_avg <- "12:00:00" #Based off of end_flight_date_time of 11:30am

```

For simplicity we kept weights as 0.25 (15min), 0.5 (30min), 0.75 (45min) or 1 (1 hr) and rounded the start time to the earliest 15 min marker and the end time to the latest 15 min marker. For example, for a flight that started at 10:03am and ended at 11:09am, we rounded 10:03am to 10:00am and 11:09am to 11:15am.

Weights for start, middle, and end hours:

- The start weight corresponds to how much of the first hour is covered by the flight time. For example, if the flight starts at 10:15, 45 minutes (or 0.75 of the hour) are included in that hour, so the start weight is 0.75.

 -The middle weight (if the flight spans more than one hour) represents the full hour(s) covered by the flight. In the example of a flight from 10:15 to 11:30, the middle weight (for the 11:00-12:00 interval) would be 1, since the full hour is included.
 
- The end weight applies similarly for the last hour of the flight. If the flight ends at 11:30, 30 minutes (or 0.5 of the hour) are included in that hour, so the end weight is 0.5.

```{r, eval=FALSE, echo=TRUE}
#Ie: Flight starts at 10:15am and ends at 11:30am
start_weight <- 0.75 # 75% of 10am
mid_weight <- 1 # 100% of  11am 
end_weight <- 0.5 # 50% of 12pm

sum_weight <- sum(start_weight,
                  mid_weight,#comment out the mid_weight if no mid weight
                  end_weight) 

#creating df with weighted average air temperature and humidity values
(cfs_weather_time_avg <- cfs_weather%>%
  filter(Date == flight_date_filt ) %>%
  filter(Time <= stop_time_avg & Time >= start_time_avg)%>% #filtering for values taken between the defined start (10am) and end (12pm) times
  mutate(Average_hum = (start_weight*RH[1]
                         + mid_weight*RH[2] #comment out this line if no mid_weight and just below index of [3] to [2]
                         + end_weight*RH[3])/sum_weight,
         Average_air_temp = (start_weight*Temperature[1] 
                             + mid_weight*Temperature[2]#comment out this line if no mid_weight and just below index of [3] to [2]
                             + end_weight*Temperature[3])/sum_weight))

#check values 
(avg_hum <- cfs_weather_time_avg$Average_hum)
(avg_temp <- cfs_weather_time_avg$Average_air_temp)
(date <- as.Date(cfs_weather_time_avg$Date, '%d-%m-%Y'))

#creating a data frame  with weighted averaged values
Canoe_flight_table <- data.frame(
  date,
  avg_hum,
  avg_temp
)
Canoe_flight_table <- Canoe_flight_table %>% distinct()#removing duplicate rows

#resetting index in table to go from 1-N
rownames(Canoe_flight_table) <- NULL

#setting variables for weighted average of humidity and ambient temperature, these variables will be used as inputs into DJI's thermal anlysis tool SDK to convert rasters to temperature
flight_humidity <- Canoe_flight_table[Canoe_flight_table$date == flight_date, "avg_hum"]
flight_humidity

flight_amb_temp <- Canoe_flight_table[Canoe_flight_table$date == flight_date, "avg_temp"]
flight_amb_temp

```

## STEP 2: DJI SDK temperature conversion

below section is old directions to open powershell and run script in the shell but now an .bat file with be written into the specified directory that does this, im just keeping it in the code in case we need it again

Just needed to download DJI SDK and most recent Visual Studio
- Open windows powershell:C:\Users\owaite\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Windows PowerShell (or can look in the start menu)
- change directory to folder with dji_irp.exe : cd "C:\dji_thermal_sdk_v1.3_20220517\utility\bin\windows\release_x64"
- below is code used in windows powershell for a single image (path: C:\Users\owaite\Downloads\dji_thermal_sdk_v1.3_20220517\utility\bin\windows\release_x64)
- .\dji_irp.exe -s "G:\Cw_PR_Rainbow\2022_05_07\1_Data\H20\Cw_PR_Rainbow_plotA_2022_05_07_80_65_90_1.2\DJI_202205071532_008_cedarAh20t\DJI_20220507153545_0001_T.JPG" -a measure -o measure.raw



### Parameters required for thermal conversion:

- **Reflection** : reflection of target is currently set to 23 range is -40 to 500
^ Reflected Temperature: the surface of the target that is measured could reflect the energy radiated by the surrounding objects. This reflected energy could be picked up by the camera along with the radiation, which could cause an error in the temperature reading. If there are no objects with extreme high or low temperatures nearby, set this parameter as the ambient temperature. Reflected temperature configurations could affect the measurement result, and the bigger the difference between the reading and the ambient temperature, the bigger the impact. Here we use the weighted average ambient temperature calculated above from the HOBO climate logger (aka flight_amb_temp)

- **Humidity**: weighted average from on-site HOBO climate logger (flight_humidity)

- **Distance**: Using max distance of 25m meter since we are flying higher (~40m away from object for h20T depending on site)

- **Emissivity**: 


```{r, eval=FALSE, echo=TRUE}
#setting parameters:
(flight_amb_temp) # already set above, () to print out the value in the console to ensure it is the correct one
(flight_humidity) # already set above
distance <- 25 
emissivity <- 0.98

```



### Editing .bat file for DJI SDK tool and running in terminal

First, we copy the original .bat file into the Merged_T folder. We do this so that the original does not get edited and instead each flight will have their own edited .bat file. This allows you to go back and see what parameters were used if needed.

The original .bat file can be found [here]() on GitHub and looks like this:
```{r}
REM to change dir to the location of this file
REM start time used to average humidity and temperature values: start_time_avg
REM end time used to average humidity and temperature values: stop_time_avg
REM weights (in 15min intervals ie 0.25, 0.5, 0.75 or 1, round down for start and up for end time): start w: start_weight, mid w: mid_weight (might not have one), end w: end_weight

cd /D "%~dp0"

mkdir DJI_SDK_raw

for %%i in (*.JPG) do (
echo Working on %%i...
C:\dji_thermal_sdk_v1.3_20220517\utility\bin\windows\release_x64\dji_irp.exe -s %%i -a measure -o DJI_SDK_raw/%%~ni.raw --humidity hum_change --distance dist_change --emissivity emis_change --reflection reflec_change
)
pause
```


```{r, eval=FALSE, echo=TRUE}
omp_dir <- "C:/Users/owaite/Documents/Scripts/DJI_SDK_TemperatureConversion_Script" #change to the directory where you saved the original .bat script to

file.copy(from = paste0(omp_dir,"\\", "DJI_SDK_loop.bat"), #copy the original omp.bat file into the Merged_T folder
          to = paste0(dir,"\\",merged,"\\","DJI_SDK_loop.bat"), overwrite = FALSE)

bat_old <- file(paste0(dir,"\\",merged,"\\","DJI_SDK_loop.bat")) #opening .bat file to edit
bat_new <- readLines(bat_old) #reading in lines of .bat file to edit and saving them out
close(bat_old)

#replacing values
comment out mid_weight line if necessary
bat_new <- gsub("hum_change",flight_humidity, bat_new)
bat_new <- gsub("dist_change",distance, bat_new)
bat_new <- gsub("emis_change",emissivity,bat_new)
bat_new <- gsub("reflec_change",flight_amb_temp,bat_new)
bat_new <- gsub("start_time_avg",start_time_avg, bat_new)
bat_new <- gsub("stop_time_avg",stop_time_avg,bat_new)
bat_new <- gsub("start_weight", start_weight, bat_new)
bat_new <- gsub("mid_weight", mid_weight, bat_new) #if no mid_weight, comment this line out
bat_new <- gsub("end_weight", end_weight, bat_new)

#Write the new file
fileConn <- file(paste0(dir,"\\",merged,"\\DJI_SDK_loop_updated.bat"))
writeLines(bat_new, fileConn)
close(fileConn)
```

Nest, we run the updated .bat file in windows terminal using the R code below. This will automatically output a folder of new raw images with temperature in binary saved to the Merged_T/DJI_SDK_raw folder 

```{r, eval=FALSE, echo=TRUE}
shell.exec(paste0(dir,"\\",merged,"\\DJI_SDK_loop_updated.bat"))
```

#STEP 3: Read binary and convert to a raster: https://community.rstudio.com/t/solution-to-reading-raw-images-into-r/45435




























```{r, eval=FALSE, echo=TRUE}
therm_dates <- c("2022_10_05")

for(x in 1:length(therm_dates)){
  date_therm <- therm_dates[x]
  print(date_therm)
  
  dir <- paste0("I:\\PARSER_Ext\\Fdc_PR_Canoe\\Flights\\",date_therm,"\\1_Data\\H20T") #directory to h20T imagery
  list_dir <- list.files(dir, full.names = TRUE,pattern = c("DJI.+-H20T")) #folders containing orignal imagery
  print(list_dir)
  
  # GETTING ALL RGB IMAGES
  for (d in 1:length(list_dir)){
    #calling each directly separately
    folder_dir <- list_dir[d]
    if(d == 1){
      files_W <- list.files(folder_dir, pattern = "_W.JPG$")
    }else{
      files_W_add <- list.files(folder_dir, pattern = "_W.JPG$")
      files_W <- append(files_W,files_W_add)
    }
  }
  
  dir_IR <- paste0("I:\\PARSER_Ext\\Fdc_PR_Canoe\\Flights\\",date_therm,"\\1_Data\\H20T\\Merged_T\\Temperature_rasters_EXIF_DST")
  
  #list of thermal files
  files_T <- list.files(dir_IR, pattern = "_T.tiff$")
  
  
  # Function to extract the core name from a file path
  get_core_name <- function(file_path) {
    basename(file_path) %>%
      gsub("_[TW]$", "", .)
  }
  
  #creating a new folder for the metahspae test
  merged <- "Merged_T"
  
  if (!dir.exists(paste0(dir, "\\",merged,"\\RGB_&_IR_EXIF_DST"))) {
    dir.create(paste0(dir, "\\",merged,"\\RGB_&_IR_EXIF_DST"),recursive = TRUE)
  }
  
  dir_new <- paste0(dir, "\\",merged,"\\RGB_&_IR_EXIF_DST")
  
  for (d in 1:length(list_dir)){
    #calling each directly separately
    print(d)
    folder_dir_W <- list_dir[d]
    files_W <- list.files(folder_dir_W, pattern = "_W.JPG$")
    
    for (i in 1:length(files_T)) {
      core_name_T <- substr(files_T[i], 1, nchar(files_T[i]) - 6)
      matching_file_W <- files_W[str_detect(files_W, core_name_T)]
      if(length(matching_file_W)>=1){
        #copying over files
        file.copy(from = paste0(folder_dir_W,"\\", matching_file_W),
                  to = paste0(dir_new,"\\", matching_file_W), overwrite = FALSE)
        file.copy(from = paste0(dir_IR,"\\", files_T[i]),
                  to = paste0(dir_new,"\\", files_T[i]), overwrite = FALSE)
      }
    }
  }
  
}
```


**Note**: We have run across an error in some imagery, DJI is working on a solution.

The error is as follows:
ERROR: call dirp_set_measurement_params failed
ERROR: call prv_isp_config failed
Test done with return code -6