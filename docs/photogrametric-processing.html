<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 2 Photogrametric Processing | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</title>
  <meta name="description" content="Chapter 2 Photogrametric Processing | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 2 Photogrametric Processing | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 2 Photogrametric Processing | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  
  
  

<meta name="author" content="Jake King*, Olivia Waite, Miriam Isaac-Renton, Nicholas C. Coops, Samuel Grubinger, Liam Irwin, Lise Van Der Merwe, Jon Degner, Alex Liu" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="lidar-processing-workflow.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Drone Based Phenotyping for Research Trials</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#github-link"><i class="fa fa-check"></i>GitHub link</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-cite-this-report"><i class="fa fa-check"></i>How to cite this report:</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html"><i class="fa fa-check"></i><b>1</b> LiDAR Processing Workflow</a>
<ul>
<li class="chapter" data-level="1.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#dji-terra"><i class="fa fa-check"></i><b>1.1</b> DJI Terra</a></li>
<li class="chapter" data-level="1.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#register-the-lidar-to-the-dap-point-cloud"><i class="fa fa-check"></i><b>1.2</b> Register the LiDAR to the DAP point cloud</a>
<ul>
<li class="chapter" data-level="1.2.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#prepare-lidar-for-registration"><i class="fa fa-check"></i><b>1.2.1</b> Prepare LiDAR for registration</a></li>
<li class="chapter" data-level="1.2.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#register-lidar-to-dap-cloud-in-cloudcompare"><i class="fa fa-check"></i><b>1.2.2</b> Register LiDAR to DAP cloud in CloudCompare</a></li>
<li class="chapter" data-level="1.2.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#rescale-and-tile-the-registered-lidar"><i class="fa fa-check"></i><b>1.2.3</b> Rescale and tile the registered LiDAR:</a></li>
</ul></li>
<li class="chapter" data-level="1.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#normalization-and-individual-tree-point-clouds"><i class="fa fa-check"></i><b>1.3</b> Normalization and individual tree point clouds</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#creating-a-dtm-from-the-registered-lidar-tiles"><i class="fa fa-check"></i><b>1.3.1</b> Creating a DTM from the registered LiDAR tiles</a></li>
<li class="chapter" data-level="1.3.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#normalizing-the-tiles-using-the-dtm"><i class="fa fa-check"></i><b>1.3.2</b> Normalizing the tiles using the DTM</a></li>
<li class="chapter" data-level="1.3.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#creating-a-4cm-chm-from-the-max-z-values"><i class="fa fa-check"></i><b>1.3.3</b> Creating a 4cm CHM from the max Z values</a></li>
<li class="chapter" data-level="1.3.4" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#segmenting-tiles"><i class="fa fa-check"></i><b>1.3.4</b> Segmenting tiles</a></li>
<li class="chapter" data-level="1.3.5" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#merging-segmented-tiles-to-create-one-large-point-cloud-containing-the-top-defined-height-of-each-tree"><i class="fa fa-check"></i><b>1.3.5</b> Merging segmented tiles to create one large point cloud containing the top defined height % of each tree</a></li>
<li class="chapter" data-level="1.3.6" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#clipping-the-point-cloud-into-individual-point-clouds-per-tree"><i class="fa fa-check"></i><b>1.3.6</b> Clipping the point cloud into individual point clouds per tree</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#individual-tree-metrics"><i class="fa fa-check"></i><b>1.4</b> Individual Tree Metrics</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="photogrametric-processing.html"><a href="photogrametric-processing.html"><i class="fa fa-check"></i><b>2</b> Photogrametric Processing</a>
<ul>
<li class="chapter" data-level="2.1" data-path="photogrametric-processing.html"><a href="photogrametric-processing.html#processing-orthomosaics"><i class="fa fa-check"></i><b>2.1</b> Processing Orthomosaics</a></li>
<li class="chapter" data-level="2.2" data-path="photogrametric-processing.html"><a href="photogrametric-processing.html#shadow-masks"><i class="fa fa-check"></i><b>2.2</b> Shadow Masks</a></li>
<li class="chapter" data-level="2.3" data-path="photogrametric-processing.html"><a href="photogrametric-processing.html#crown-level-vegetation-indicies"><i class="fa fa-check"></i><b>2.3</b> Crown-level Vegetation Indicies</a>
<ul>
<li class="chapter" data-level="2.3.1" data-path="photogrametric-processing.html"><a href="photogrametric-processing.html#vi-workflow"><i class="fa fa-check"></i><b>2.3.1</b> VI Workflow</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="photogrametric-processing" class="section level1 hasAnchor" number="2">
<h1><span class="header-section-number">Chapter 2</span> Photogrametric Processing<a href="photogrametric-processing.html#photogrametric-processing" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="processing-orthomosaics" class="section level2 hasAnchor" number="2.1">
<h2><span class="header-section-number">2.1</span> Processing Orthomosaics<a href="photogrametric-processing.html#processing-orthomosaics" class="anchor-section" aria-label="Anchor link to header"></a></h2>
</div>
<div id="shadow-masks" class="section level2 hasAnchor" number="2.2">
<h2><span class="header-section-number">2.2</span> Shadow Masks<a href="photogrametric-processing.html#shadow-masks" class="anchor-section" aria-label="Anchor link to header"></a></h2>
</div>
<div id="crown-level-vegetation-indicies" class="section level2 hasAnchor" number="2.3">
<h2><span class="header-section-number">2.3</span> Crown-level Vegetation Indicies<a href="photogrametric-processing.html#crown-level-vegetation-indicies" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Vegetation indices (VIs) are important tools for near-real time monitoring and function as proxies for health, productivity, structural changes, and stress.</p>
<p>Below we describe a few commonly used VIs that will be calculated in this workflow:</p>
<ul>
<li><p><strong>Normalized Difference Vegetation Index (NDVI)</strong> is of the oldest vegetation indices established in vegetation monitoring and is used as a metric of greenness. However, due to saturation of the chlorophyll absorption peak around 660-680nm at moderately low chlorophyll levels, NDVI is often not able to tease out small differences between healthy plants (Sims &amp; Gamon, 2002). To solve this issue, the red reflectance band can be replaced with a red edge reflectance band creating the normalized difference red edge index mentioned below.</p></li>
<li><p><strong>Normalized Difference Red Edge index (NDRE)</strong> normalizes a reflectance band in the red edge to a reflectance band in the near-infrared region to estimate chlorophyll content. This index is a derivative of NDVI that is sensitive to shifts in chlorophyll content at high concentrations (Clevers &amp; Gitelson, 2013; Evangelides &amp; Nobajas, 2020).</p></li>
<li><p><strong>Chlorophyll Carotenoid Index (CCI)</strong> is a proxy for the ratio of chlorophylls to carotenoids in pigment pools. It is often used as a metric for tracking the onset of the growing season and photosynthetic activity (Gamon et al., 2016).</p></li>
<li><p><strong>Photochemical Reflectance Index (PRI)</strong> can be used as a proxy for xanthophyll pigment epoxidation or changes in bulk seasonal pigment pool ratios depending on the timescale of analysis. Over a scale of milliseconds to minutes PRI can isolate the photoprotective conversion of violaxanthin into antheraxanthin and zeaxanthin within the xanthophyll cycle by normalizing the 531nm reflectance band to the 560nm reference reflectance band. However, on the seasonal scale the 560nm reflectance band no longer acts as a reference for isolating changes in xanthophyll pigments since it changes with bulk pigment shifts. Hence, seasonal PRI meaurments are instead used as another proxy for the ratio of carotenoid to chlorophyll pigments and are used to show changes in photosynthetic activity (Wong et al., 2020).</p></li>
<li><p><strong>Red Edge (RE) slope</strong> captures changes in chlorophyl content and structural health. Steep RE slopes generally indicate healthy vegetation while more gradual slopes often indicate stressed vegetation. This is due to the base of the RE slope sitting around a main chlorophyll absorption peak and the end of the RE slope sitting near the near-infrared (NIR) range. Hence, the more chlorophyll the lower the reflectance around the base of the RE slope and the greater the reflectance in the NIR, often attributed to healthy vegetative material, the steeper the overall slope of the RE (Sims and Gamon, 2002, Clevers and Gitelson)</p></li>
<li><p><strong>Green Chromatic Cordinate (GCC)</strong> is a measure of green reflectance relative to the total reflectance in the visible light portion on the electromagnetic spectrum. It is a metric of greeness that is often used as a proxy for vegetation health (Reid et al., 2016).</p></li>
</ul>
<div id="vi-workflow" class="section level3 hasAnchor" number="2.3.1">
<h3><span class="header-section-number">2.3.1</span> VI Workflow<a href="photogrametric-processing.html#vi-workflow" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Below are code chunks that take the <a href="09-Crown_delineation#Crown-delineation">delineated crowns</a> and <a href="Photogrametric_processing#Processing%20Orthomosaics">multispectral orthomosaics</a> and output a .rds file containing several popular vegetation indices at the crown-level. In this script we demonstrate how to calculate both mean and median values of vegetation indices per crown.</p>
<p>We begin by loading the necessary packages:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="photogrametric-processing.html#cb20-1" tabindex="-1"></a><span class="fu">library</span>(terra) <span class="co"># to work with the orthomosaics (rasters)</span></span>
<span id="cb20-2"><a href="photogrametric-processing.html#cb20-2" tabindex="-1"></a><span class="fu">library</span>(dplyr) <span class="co">#for data manipulation</span></span>
<span id="cb20-3"><a href="photogrametric-processing.html#cb20-3" tabindex="-1"></a><span class="fu">library</span>(tidyverse) <span class="co"># for data manipulation</span></span>
<span id="cb20-4"><a href="photogrametric-processing.html#cb20-4" tabindex="-1"></a><span class="fu">library</span>(sf) <span class="co"># to work with the delineated crown polygons</span></span>
<span id="cb20-5"><a href="photogrametric-processing.html#cb20-5" tabindex="-1"></a><span class="fu">library</span>(exactextractr) <span class="co"># for the exact_extract function</span></span></code></pre></div>
<p>Next, we read in the mulispectral orthomosaic and shadow mask. The shadow mask will work to remove shadowed pixels so they do not skew the values for the vegetation indices. See the section on <a href="Photogrametric_processing#Shadow%20Masks">shadow masks</a> for a detailed workflow.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="photogrametric-processing.html#cb21-1" tabindex="-1"></a><span class="co"># Load in multispectral orthomosaic </span></span>
<span id="cb21-2"><a href="photogrametric-processing.html#cb21-2" tabindex="-1"></a>ms_ortho <span class="ot">=</span> <span class="fu">rast</span>(<span class="fu">list.files</span>(<span class="fu">paste0</span>(dir, <span class="st">&quot;metashape</span><span class="sc">\\</span><span class="st">3_MS_ORTHO</span><span class="sc">\\</span><span class="st">&quot;</span>), <span class="at">pattern =</span> <span class="st">&quot;.*MS_Calibrated.*_bestPanel.tif$&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>)) <span class="co">#path to multispectral ortho</span></span>
<span id="cb21-3"><a href="photogrametric-processing.html#cb21-3" tabindex="-1"></a></span>
<span id="cb21-4"><a href="photogrametric-processing.html#cb21-4" tabindex="-1"></a><span class="co"># Reading in the NIR shadow mask</span></span>
<span id="cb21-5"><a href="photogrametric-processing.html#cb21-5" tabindex="-1"></a>shadow_mask <span class="ot">=</span> <span class="fu">rast</span>(<span class="fu">list.files</span>(<span class="fu">paste0</span>(dir, Nir_shadow_folder,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>),  <span class="at">pattern =</span> <span class="st">&quot;.*_NIR_shadow.*_thresh.*_mask2.tif$&quot;</span>, <span class="at">full.names =</span> <span class="cn">TRUE</span>))<span class="co"># NIR shadow mask</span></span>
<span id="cb21-6"><a href="photogrametric-processing.html#cb21-6" tabindex="-1"></a></span>
<span id="cb21-7"><a href="photogrametric-processing.html#cb21-7" tabindex="-1"></a></span>
<span id="cb21-8"><a href="photogrametric-processing.html#cb21-8" tabindex="-1"></a><span class="co"># Below selects the root name of the multispectral ortho ie: &quot;Name_of_multispectral_ortho&quot; that will be used to name the multispectral shadow masked orthos created in the following steps</span></span>
<span id="cb21-9"><a href="photogrametric-processing.html#cb21-9" tabindex="-1"></a>ms_ortho_name_root <span class="ot">&lt;-</span> <span class="fu">substr</span>(<span class="fu">names</span>(ms_ortho)[<span class="dv">1</span>], <span class="dv">1</span>, <span class="fu">nchar</span>(<span class="fu">names</span>(ms_ortho)[<span class="dv">1</span>]) <span class="sc">-</span> <span class="dv">2</span>)</span>
<span id="cb21-10"><a href="photogrametric-processing.html#cb21-10" tabindex="-1"></a></span>
<span id="cb21-11"><a href="photogrametric-processing.html#cb21-11" tabindex="-1"></a><span class="co">#names(ms_ortho)[1] grabs the name for band 1 of the ms_ortho: ie: &quot;Name_of_multispectral_ortho_1&quot;, so that the substr function can selection the rootname as done above</span></span></code></pre></div>
<p>To speed up processing, we mask the shadow mask to only contain areas inside delineated crowns.</p>
<p>The shadow mask is a raster containing values 1 (shadowed pixel) and NA (not shadowed pixel). The <em>mask</em> function below identifies pixels in the multispectral orthomosaic that align with shadowed pixels in the shadow mask and changes their value to NA.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="photogrametric-processing.html#cb22-1" tabindex="-1"></a><span class="co"># Mask shadow mask to delineated crowns:</span></span>
<span id="cb22-2"><a href="photogrametric-processing.html#cb22-2" tabindex="-1"></a>shadow_mask <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">mask</span>(shadow_mask, pols)</span>
<span id="cb22-3"><a href="photogrametric-processing.html#cb22-3" tabindex="-1"></a>  </span>
<span id="cb22-4"><a href="photogrametric-processing.html#cb22-4" tabindex="-1"></a><span class="co"># Mask the multispectral ortho using the shadow mask</span></span>
<span id="cb22-5"><a href="photogrametric-processing.html#cb22-5" tabindex="-1"></a>ms_mask <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">mask</span>(ms_ortho, shadow_mask, <span class="at">maskvalues =</span> <span class="dv">1</span>, <span class="at">updatevalue =</span> <span class="cn">NA</span>)</span>
<span id="cb22-6"><a href="photogrametric-processing.html#cb22-6" tabindex="-1"></a></span>
<span id="cb22-7"><a href="photogrametric-processing.html#cb22-7" tabindex="-1"></a><span class="co">#writing out the shadow masked multispectral ortho</span></span>
<span id="cb22-8"><a href="photogrametric-processing.html#cb22-8" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">writeRaster</span>(ms_mask, <span class="fu">paste0</span>(dir, Nir_shadow_folder,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,ms_ortho_name_root,<span class="st">&quot;_NirShadow_masked.tif&quot;</span>),</span>
<span id="cb22-9"><a href="photogrametric-processing.html#cb22-9" tabindex="-1"></a>                     <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>The shadow masked multispectral orthomosaic is then masked to the delineated crowns polygon to speed raster calculations in the next step.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="photogrametric-processing.html#cb23-1" tabindex="-1"></a><span class="co"># Mask shadow masked raster to delineated crowns</span></span>
<span id="cb23-2"><a href="photogrametric-processing.html#cb23-2" tabindex="-1"></a>ms_mask <span class="ot">&lt;-</span> terra<span class="sc">::</span><span class="fu">mask</span>(ms_mask, pols)</span>
<span id="cb23-3"><a href="photogrametric-processing.html#cb23-3" tabindex="-1"></a></span>
<span id="cb23-4"><a href="photogrametric-processing.html#cb23-4" tabindex="-1"></a><span class="co"># Write out the masked raster</span></span>
<span id="cb23-5"><a href="photogrametric-processing.html#cb23-5" tabindex="-1"></a>terra<span class="sc">::</span><span class="fu">writeRaster</span>(ms_mask, <span class="fu">paste0</span>(dir, Nir_shadow_folder,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,ms_ortho_name_root,<span class="st">&quot;_NirShadow_ms_mask_to_pols.tif&quot;</span>),</span>
<span id="cb23-6"><a href="photogrametric-processing.html#cb23-6" tabindex="-1"></a>                     <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span></code></pre></div>
<p>Here we calculate several vegetation indices using the multispectral orthomosaic from above with shadowed pixels and non-crown pixels removed.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="photogrametric-processing.html#cb24-1" tabindex="-1"></a><span class="co"># List of band reflectances (R444 - R842) and index values that will be calculated per tree crown</span></span>
<span id="cb24-2"><a href="photogrametric-processing.html#cb24-2" tabindex="-1"></a>rast_list <span class="ot">=</span> <span class="fu">list</span>(</span>
<span id="cb24-3"><a href="photogrametric-processing.html#cb24-3" tabindex="-1"></a>  <span class="co"># reflectance values</span></span>
<span id="cb24-4"><a href="photogrametric-processing.html#cb24-4" tabindex="-1"></a>  <span class="at">R444 =</span> ms_mask[[<span class="dv">1</span>]],</span>
<span id="cb24-5"><a href="photogrametric-processing.html#cb24-5" tabindex="-1"></a>  <span class="at">R475 =</span> ms_mask[[<span class="dv">2</span>]],</span>
<span id="cb24-6"><a href="photogrametric-processing.html#cb24-6" tabindex="-1"></a>  <span class="at">R531 =</span> ms_mask[[<span class="dv">3</span>]],</span>
<span id="cb24-7"><a href="photogrametric-processing.html#cb24-7" tabindex="-1"></a>  <span class="at">R560 =</span> ms_mask[[<span class="dv">4</span>]],               </span>
<span id="cb24-8"><a href="photogrametric-processing.html#cb24-8" tabindex="-1"></a>  <span class="at">R650 =</span> ms_mask[[<span class="dv">5</span>]],               </span>
<span id="cb24-9"><a href="photogrametric-processing.html#cb24-9" tabindex="-1"></a>  <span class="at">R668 =</span> ms_mask[[<span class="dv">6</span>]],               </span>
<span id="cb24-10"><a href="photogrametric-processing.html#cb24-10" tabindex="-1"></a>  <span class="at">R705 =</span> ms_mask[[<span class="dv">7</span>]],               </span>
<span id="cb24-11"><a href="photogrametric-processing.html#cb24-11" tabindex="-1"></a>  <span class="at">R717 =</span> ms_mask[[<span class="dv">8</span>]],               </span>
<span id="cb24-12"><a href="photogrametric-processing.html#cb24-12" tabindex="-1"></a>  <span class="at">R740 =</span> ms_mask[[<span class="dv">9</span>]],               </span>
<span id="cb24-13"><a href="photogrametric-processing.html#cb24-13" tabindex="-1"></a>  <span class="at">R842 =</span> ms_mask[[<span class="dv">10</span>]],                              </span>
<span id="cb24-14"><a href="photogrametric-processing.html#cb24-14" tabindex="-1"></a>    </span>
<span id="cb24-15"><a href="photogrametric-processing.html#cb24-15" tabindex="-1"></a>  <span class="co"># Near-infrared greenness</span></span>
<span id="cb24-16"><a href="photogrametric-processing.html#cb24-16" tabindex="-1"></a>  <span class="at">mDatt =</span> (ms_mask[[<span class="dv">10</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">8</span>]]) <span class="sc">/</span> (ms_mask[[<span class="dv">10</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">6</span>]]),</span>
<span id="cb24-17"><a href="photogrametric-processing.html#cb24-17" tabindex="-1"></a>  <span class="at">NDVI =</span> (ms_mask[[<span class="dv">10</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">6</span>]]) <span class="sc">/</span> (ms_mask[[<span class="dv">10</span>]] <span class="sc">+</span> ms_mask[[<span class="dv">6</span>]]), </span>
<span id="cb24-18"><a href="photogrametric-processing.html#cb24-18" tabindex="-1"></a>    </span>
<span id="cb24-19"><a href="photogrametric-processing.html#cb24-19" tabindex="-1"></a>  <span class="co"># Chlorophyll </span></span>
<span id="cb24-20"><a href="photogrametric-processing.html#cb24-20" tabindex="-1"></a>  <span class="at">NDRE1 =</span> (ms_mask[[<span class="dv">10</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">7</span>]]) <span class="sc">/</span> (ms_mask[[<span class="dv">10</span>]] <span class="sc">+</span> ms_mask[[<span class="dv">7</span>]]),     </span>
<span id="cb24-21"><a href="photogrametric-processing.html#cb24-21" tabindex="-1"></a>  <span class="at">NDRE2 =</span> (ms_mask[[<span class="dv">10</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">8</span>]]) <span class="sc">/</span> (ms_mask[[<span class="dv">10</span>]] <span class="sc">+</span> ms_mask[[<span class="dv">8</span>]]), </span>
<span id="cb24-22"><a href="photogrametric-processing.html#cb24-22" tabindex="-1"></a>  <span class="at">NDRE3 =</span> (ms_mask[[<span class="dv">10</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">9</span>]]) <span class="sc">/</span> (ms_mask[[<span class="dv">10</span>]] <span class="sc">+</span> ms_mask[[<span class="dv">9</span>]]), </span>
<span id="cb24-23"><a href="photogrametric-processing.html#cb24-23" tabindex="-1"></a>  <span class="at">EVI =</span> (<span class="fl">2.5</span> <span class="sc">*</span> (ms_mask[[<span class="dv">10</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">6</span>]])) <span class="sc">/</span> (ms_mask[[<span class="dv">10</span>]] <span class="sc">+</span> (<span class="dv">6</span> <span class="sc">*</span> ms_mask[[<span class="dv">6</span>]]) <span class="sc">-</span> ( <span class="fl">7.5</span> <span class="sc">*</span> ms_mask[[<span class="dv">1</span>]] <span class="sc">+</span> <span class="dv">1</span>)),             </span>
<span id="cb24-24"><a href="photogrametric-processing.html#cb24-24" tabindex="-1"></a>  <span class="at">GCC =</span> (ms_mask[[<span class="dv">4</span>]]<span class="sc">+</span> ms_mask[[<span class="dv">3</span>]]) <span class="sc">/</span> (ms_mask[[<span class="dv">1</span>]] <span class="sc">+</span> ms_mask[[<span class="dv">2</span>]] <span class="sc">+</span> ms_mask[[<span class="dv">3</span>]]<span class="sc">+</span>ms_mask[[<span class="dv">4</span>]] <span class="sc">+</span> ms_mask[[<span class="dv">5</span>]] <span class="sc">+</span> ms_mask[[<span class="dv">6</span>]]),             </span>
<span id="cb24-25"><a href="photogrametric-processing.html#cb24-25" tabindex="-1"></a>  </span>
<span id="cb24-26"><a href="photogrametric-processing.html#cb24-26" tabindex="-1"></a>  <span class="co"># Carotenoids, waxes</span></span>
<span id="cb24-27"><a href="photogrametric-processing.html#cb24-27" tabindex="-1"></a>  <span class="at">ARI =</span> (<span class="dv">1</span> <span class="sc">/</span> ms_mask[[<span class="dv">4</span>]]) <span class="sc">-</span> (<span class="dv">1</span> <span class="sc">/</span> ms_mask[[<span class="dv">7</span>]]),    </span>
<span id="cb24-28"><a href="photogrametric-processing.html#cb24-28" tabindex="-1"></a>  <span class="at">EWI9 =</span> (ms_mask[[<span class="dv">6</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">8</span>]]) <span class="sc">/</span> (ms_mask[[<span class="dv">6</span>]] <span class="sc">+</span> ms_mask[[<span class="dv">8</span>]]),</span>
<span id="cb24-29"><a href="photogrametric-processing.html#cb24-29" tabindex="-1"></a>    </span>
<span id="cb24-30"><a href="photogrametric-processing.html#cb24-30" tabindex="-1"></a>  <span class="co"># Carotenoids             </span></span>
<span id="cb24-31"><a href="photogrametric-processing.html#cb24-31" tabindex="-1"></a>  <span class="at">PRI =</span> (ms_mask[[<span class="dv">3</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">4</span>]]) <span class="sc">/</span> (ms_mask[[<span class="dv">3</span>]] <span class="sc">+</span> ms_mask[[<span class="dv">4</span>]]),             </span>
<span id="cb24-32"><a href="photogrametric-processing.html#cb24-32" tabindex="-1"></a>  <span class="at">CCI =</span> (ms_mask[[<span class="dv">3</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">5</span>]]) <span class="sc">/</span> (ms_mask[[<span class="dv">3</span>]] <span class="sc">+</span> ms_mask[[<span class="dv">5</span>]]),             </span>
<span id="cb24-33"><a href="photogrametric-processing.html#cb24-33" tabindex="-1"></a>    </span>
<span id="cb24-34"><a href="photogrametric-processing.html#cb24-34" tabindex="-1"></a>  <span class="co"># Red edge             </span></span>
<span id="cb24-35"><a href="photogrametric-processing.html#cb24-35" tabindex="-1"></a>  <span class="at">RE_upper =</span> (ms_mask[[<span class="dv">9</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">8</span>]]) <span class="sc">/</span> <span class="dv">23</span>,             </span>
<span id="cb24-36"><a href="photogrametric-processing.html#cb24-36" tabindex="-1"></a>  <span class="at">RE_lower =</span> (ms_mask[[<span class="dv">8</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">7</span>]]) <span class="sc">/</span> <span class="dv">12</span>,             </span>
<span id="cb24-37"><a href="photogrametric-processing.html#cb24-37" tabindex="-1"></a>  <span class="at">RE_total =</span> (ms_mask[[<span class="dv">9</span>]] <span class="sc">-</span> ms_mask[[<span class="dv">7</span>]]) <span class="sc">/</span> <span class="dv">35</span></span>
<span id="cb24-38"><a href="photogrametric-processing.html#cb24-38" tabindex="-1"></a>)</span>
<span id="cb24-39"><a href="photogrametric-processing.html#cb24-39" tabindex="-1"></a>  </span>
<span id="cb24-40"><a href="photogrametric-processing.html#cb24-40" tabindex="-1"></a>rast_all <span class="ot">=</span> <span class="fu">rast</span>(rast_list)</span></code></pre></div>
<p>Below is an example of the resolution of the calculated vegetation indices. The image shows the chlorophyll carotenoid index (CCI) of a single crown across four summer time points. Greener pixels represent a higher ratio of chlorophylls to carotenoids. As you can see, the proportion of the crown with high CCI values increases from the May to July acquisitions, when productivity is likely at its highest, and decreases during the august acquisition suggesting lower productivity, likely due to end of summer drought conditions.</p>
<p><img src="Photos_&_gifs/CCI_timeseries.png" width="100%" style="display: block; margin: auto;" /></p>
<p>Lastly, we use the <em>exact_extract</em> function to calculate crown-level statistics per vegetation index raster created above. Below we show an example of taking the mean and median crown values per index as well as count the number of pixels that were used for the index calculation. We do this as a data quality check so we can remove crowns that had very few pixels involved in their index calculation.</p>
<p><strong>Note:</strong> the append_cols parameter should be set to a list of column names that exist in pols (the shapefile of delineated crowns) that you would like to be appended to the dataframe containing vegetation indcies per tree crown. As you can see below we have attached many columns we found useful, however the only column necessary to append is a column in pols that represents a unique ID per tree crown.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="photogrametric-processing.html#cb25-1" tabindex="-1"></a><span class="co"># Calculating Mean Index values per crown</span></span>
<span id="cb25-2"><a href="photogrametric-processing.html#cb25-2" tabindex="-1"></a>df_spectral_mean <span class="ot">=</span> <span class="fu">exact_extract</span>(rast_all, pols, <span class="at">fun =</span> <span class="st">&quot;mean&quot;</span>, <span class="at">append_cols =</span> <span class="fu">c</span>(<span class="st">&quot;treeID&quot;</span>,<span class="st">&quot;Edited&quot;</span>,<span class="st">&quot;tag__&quot;</span>,<span class="st">&quot;rep&quot;</span>,<span class="st">&quot;blk&quot;</span>,<span class="st">&quot;fam&quot;</span>,<span class="st">&quot;fem&quot;</span>))</span>
<span id="cb25-3"><a href="photogrametric-processing.html#cb25-3" tabindex="-1"></a>  </span>
<span id="cb25-4"><a href="photogrametric-processing.html#cb25-4" tabindex="-1"></a><span class="co"># Calculating the number of non-masked pixels used for index calculation</span></span>
<span id="cb25-5"><a href="photogrametric-processing.html#cb25-5" tabindex="-1"></a>df_count <span class="ot">=</span> <span class="fu">exact_extract</span>(ms_mask[[<span class="dv">1</span>]], pols, <span class="at">fun =</span> <span class="st">&quot;count&quot;</span>, <span class="at">progress =</span> <span class="cn">TRUE</span>, <span class="at">append_cols =</span> <span class="fu">c</span>(<span class="st">&quot;treeID&quot;</span>,<span class="st">&quot;Edited&quot;</span>,<span class="st">&quot;tag__&quot;</span>,<span class="st">&quot;rep&quot;</span>,<span class="st">&quot;blk&quot;</span>,<span class="st">&quot;fam&quot;</span>,<span class="st">&quot;fem&quot;</span>))</span>
<span id="cb25-6"><a href="photogrametric-processing.html#cb25-6" tabindex="-1"></a>  </span>
<span id="cb25-7"><a href="photogrametric-processing.html#cb25-7" tabindex="-1"></a><span class="co"># Joining the mean index values df and the count values df</span></span>
<span id="cb25-8"><a href="photogrametric-processing.html#cb25-8" tabindex="-1"></a>df_spectral_mean_count <span class="ot">&lt;-</span> <span class="fu">merge</span>(df_spectral_mean,df_count, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;treeID&quot;</span>,<span class="st">&quot;Edited&quot;</span>,<span class="st">&quot;tag__&quot;</span>,<span class="st">&quot;rep&quot;</span>,<span class="st">&quot;blk&quot;</span>,<span class="st">&quot;fam&quot;</span>,<span class="st">&quot;fem&quot;</span>))</span>
<span id="cb25-9"><a href="photogrametric-processing.html#cb25-9" tabindex="-1"></a>  </span>
<span id="cb25-10"><a href="photogrametric-processing.html#cb25-10" tabindex="-1"></a><span class="co"># Saving out mean crown values + non masked pixel count to an rds file</span></span>
<span id="cb25-11"><a href="photogrametric-processing.html#cb25-11" tabindex="-1"></a><span class="fu">saveRDS</span>(df_spectral_mean_count, <span class="fu">paste0</span>(dir_D,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,updated_metrics_folder,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>, date_list[x], <span class="st">&quot;_NIRshadowMask_MeanCrownSpectralIndices.rds&quot;</span>))</span>
<span id="cb25-12"><a href="photogrametric-processing.html#cb25-12" tabindex="-1"></a></span>
<span id="cb25-13"><a href="photogrametric-processing.html#cb25-13" tabindex="-1"></a><span class="co"># Calculating Median Index values per crown</span></span>
<span id="cb25-14"><a href="photogrametric-processing.html#cb25-14" tabindex="-1"></a>df_spectral_median <span class="ot">=</span> <span class="fu">exact_extract</span>(rast_all, pols, <span class="at">fun =</span> <span class="st">&quot;median&quot;</span>, <span class="at">append_cols =</span> <span class="fu">c</span>(<span class="st">&quot;treeID&quot;</span>,<span class="st">&quot;Edited&quot;</span>,<span class="st">&quot;tag__&quot;</span>,<span class="st">&quot;rep&quot;</span>,<span class="st">&quot;blk&quot;</span>,<span class="st">&quot;fam&quot;</span>,<span class="st">&quot;fem&quot;</span>))</span>
<span id="cb25-15"><a href="photogrametric-processing.html#cb25-15" tabindex="-1"></a>  </span>
<span id="cb25-16"><a href="photogrametric-processing.html#cb25-16" tabindex="-1"></a>df_spectral_median_count <span class="ot">&lt;-</span> <span class="fu">merge</span>(df_spectral_median,df_count, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;treeID&quot;</span>,<span class="st">&quot;Edited&quot;</span>,<span class="st">&quot;tag__&quot;</span>,<span class="st">&quot;rep&quot;</span>,<span class="st">&quot;blk&quot;</span>,<span class="st">&quot;fam&quot;</span>,<span class="st">&quot;fem&quot;</span>))</span>
<span id="cb25-17"><a href="photogrametric-processing.html#cb25-17" tabindex="-1"></a>  </span>
<span id="cb25-18"><a href="photogrametric-processing.html#cb25-18" tabindex="-1"></a><span class="co"># Saving out median crown values + non masked pixel count to an rds file</span></span>
<span id="cb25-19"><a href="photogrametric-processing.html#cb25-19" tabindex="-1"></a><span class="fu">saveRDS</span>(df_spectral_median_count, <span class="fu">paste0</span>(dir_D,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,updated_metrics_folder,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>, date_list[x], <span class="st">&quot;_NIRshadowMask_MedianCrownSpectralIndices.rds&quot;</span>))</span></code></pre></div>
<p>References:</p>
<p>Clevers, J. G. P. W., &amp; Gitelson, A. A. (2013). Remote estimation of crop and grass chlorophyll and nitrogen content using red-edge bands on Sentinel-2 and -3. International Journal of Applied Earth Observation and Geoinformation, 23(1), 344–351. <a href="https://doi.org/10.1016/J.JAG.2012.10.008" class="uri">https://doi.org/10.1016/J.JAG.2012.10.008</a></p>
<p>Evangelides, C., &amp; Nobajas, A. (2020). Red-Edge Normalised Difference Vegetation Index (NDVI705) from Sentinel-2 imagery to assess post-fire regeneration. Remote Sensing Applications: Society and Environment, 17, 100283. <a href="https://doi.org/10.1016/J.RSASE.2019.100283" class="uri">https://doi.org/10.1016/J.RSASE.2019.100283</a></p>
<p>Gamon, J. A., Huemmrich, K. F., Wong, C. Y. S., Ensminger, I., Garrity, S., Hollinger, D. Y., Noormets, A., &amp; Peñuelask, J. (2016). A remotely sensed pigment index reveals photosynthetic phenology in evergreen conifers. Proceedings of the National Academy of Sciences of the United States of America, 113(46), 13087–13092. <a href="https://doi.org/10.1073/pnas.1606162113" class="uri">https://doi.org/10.1073/pnas.1606162113</a></p>
<p>Reid, A. M., Chapman, W. K., Prescott, C. E., &amp; Nijland, W. (2016). Using excess greenness and green chromatic coordinate colour indices from aerial images to assess lodgepole pine vigour, mortality and disease occurrence. Forest Ecology and Management, 374, 146–153. <a href="https://doi.org/10.1016/J.FORECO.2016.05.006" class="uri">https://doi.org/10.1016/J.FORECO.2016.05.006</a></p>
<p>Sims, D. A., &amp; Gamon, J. A. (2002). Relationships between leaf pigment content and spectral reflectance across a wide range of species, leaf structures and developmental stages. Remote Sensing of Environment, 81(2–3), 337–354. <a href="https://doi.org/10.1016/S0034-4257(02)00010-X" class="uri">https://doi.org/10.1016/S0034-4257(02)00010-X</a></p>
<p>Wong, C. Y. S., D’Odorico, P., Arain, M. A., &amp; Ensminger, I. (2020). Tracking the phenology of photosynthesis using carotenoid-sensitive and near-infrared reflectance vegetation indices in a temperate evergreen and mixed deciduous forest. New Phytologist, 226(6). <a href="https://doi.org/10.1111/nph.16479" class="uri">https://doi.org/10.1111/nph.16479</a></p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="lidar-processing-workflow.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/owaite/GenomeBC_BPG/edit/main/Photogrametric_processing.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/owaite/GenomeBC_BPG/blob/main/Photogrametric_processing.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

</body>

</html>
