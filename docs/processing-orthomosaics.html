<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 7 Agisoft Photogrammetry pipeline | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</title>
  <meta name="description" content="Chapter 7 Agisoft Photogrammetry pipeline | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 7 Agisoft Photogrammetry pipeline | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 7 Agisoft Photogrammetry pipeline | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  
  
  

<meta name="author" content="Jake King*, Olivia Waite, Miriam Isaac-Renton, Nicholas C. Coops, Samuel Grubinger, Liam Irwin, Lise Van Der Merwe, Jon Degner, Alex Liu" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="data-processing-software-and-hardware-costs-and-options.html"/>
<link rel="next" href="georeferencing-plot-trees.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Drone Based Phenotyping for Research Trials</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#github-link"><i class="fa fa-check"></i>GitHub link</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-cite-this-report"><i class="fa fa-check"></i>How to cite this report:</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i><b>2</b> Glossary</a></li>
<li class="chapter" data-level="3" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html"><i class="fa fa-check"></i><b>3</b> Range of Sites Assessed</a>
<ul>
<li class="chapter" data-level="3.1" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#jordan-river"><i class="fa fa-check"></i><b>3.1</b> Jordan River</a></li>
<li class="chapter" data-level="3.2" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#powell-river"><i class="fa fa-check"></i><b>3.2</b> Powell River</a></li>
<li class="chapter" data-level="3.3" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#sites"><i class="fa fa-check"></i><b>3.3</b> 2024 Sites</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="preflight-planning.html"><a href="preflight-planning.html"><i class="fa fa-check"></i><b>4</b> Preflight Planning</a>
<ul>
<li class="chapter" data-level="4.1" data-path="preflight-planning.html"><a href="preflight-planning.html#achieving-positional-accuracy-on-multi-temporal-and-multi-sensor-data-collections"><i class="fa fa-check"></i><b>4.1</b> Achieving positional accuracy on multi-temporal and multi-sensor data collections</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="preflight-planning.html"><a href="preflight-planning.html#kinematic-processing-rtkppk"><i class="fa fa-check"></i><b>4.1.1</b> Kinematic processing: RTK/PPK</a></li>
<li class="chapter" data-level="4.1.2" data-path="preflight-planning.html"><a href="preflight-planning.html#ground-control-points-gcp"><i class="fa fa-check"></i><b>4.1.2</b> Ground Control Points (GCP)</a></li>
<li class="chapter" data-level="4.1.3" data-path="preflight-planning.html"><a href="preflight-planning.html#absolute-and-relative-reference-with-precise-point-positioning-ppp"><i class="fa fa-check"></i><b>4.1.3</b> Absolute and Relative Reference with Precise Point Positioning (PPP)</a></li>
<li class="chapter" data-level="4.1.4" data-path="preflight-planning.html"><a href="preflight-planning.html#terrain-following-on-sites-with-elevation-change"><i class="fa fa-check"></i><b>4.1.4</b> Terrain Following on Sites with Elevation Change</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="preflight-planning.html"><a href="preflight-planning.html#site-selection-considerations"><i class="fa fa-check"></i><b>4.2</b> Site Selection Considerations</a></li>
<li class="chapter" data-level="4.3" data-path="preflight-planning.html"><a href="preflight-planning.html#drone-and-sensors-what-will-i-need-to-purchase-and-how-much-will-it-cost"><i class="fa fa-check"></i><b>4.3</b> Drone and Sensors: What will I need to purchase and how much will it cost?</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="preflight-planning.html"><a href="preflight-planning.html#hardware-costs"><i class="fa fa-check"></i><b>4.3.1</b> Hardware Costs</a></li>
<li class="chapter" data-level="4.3.2" data-path="preflight-planning.html"><a href="preflight-planning.html#drone-training-in-canada"><i class="fa fa-check"></i><b>4.3.2</b> Drone Training in Canada</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html"><i class="fa fa-check"></i><b>5</b> Data Collection and Flights</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#hardware---dji-matrice-300-rtk-m300"><i class="fa fa-check"></i><b>5.1</b> Hardware - DJI Matrice 300 RTK (M300)</a></li>
<li class="chapter" data-level="5.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#battery-management"><i class="fa fa-check"></i><b>5.2</b> Battery Management</a></li>
<li class="chapter" data-level="5.3" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#Site-Reconnaissance"><i class="fa fa-check"></i><b>5.3</b> Workflow: Site Reconnaissance</a></li>
<li class="chapter" data-level="5.4" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#data-collection-flight-planning"><i class="fa fa-check"></i><b>5.4</b> Data Collection: Flight Planning</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#flight-planning-theory"><i class="fa fa-check"></i><b>5.4.1</b> Flight planning theory</a></li>
<li class="chapter" data-level="5.4.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#flight-planning-with-dji-pilot"><i class="fa fa-check"></i><b>5.4.2</b> Flight planning with DJI Pilot</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#data-collection-sensors-parameters-and-ideal-conditions"><i class="fa fa-check"></i><b>5.5</b> Data Collection: Sensors, Parameters, and Ideal Conditions</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#micasense-10-band-spectral-sensor-for-vegetative-indices"><i class="fa fa-check"></i><b>5.5.1</b> MicaSense: 10-Band Spectral Sensor for Vegetative Indices</a></li>
<li class="chapter" data-level="5.5.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-p1-high-quality-natural-colour-rgb-imagery"><i class="fa fa-check"></i><b>5.5.2</b> Zenmuse P1: High-Quality Natural-Colour (RGB) Imagery</a></li>
<li class="chapter" data-level="5.5.3" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-l1-lidar-and-rgb"><i class="fa fa-check"></i><b>5.5.3</b> Zenmuse L1: LiDAR and RGB</a></li>
<li class="chapter" data-level="5.5.4" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-h20t-thermal-and-rgb"><i class="fa fa-check"></i><b>5.5.4</b> Zenmuse H20T: Thermal and RGB</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-processing-software-and-hardware-costs-and-options.html"><a href="data-processing-software-and-hardware-costs-and-options.html"><i class="fa fa-check"></i><b>6</b> Data Processing: Software and hardware costs and options</a></li>
<li class="chapter" data-level="7" data-path="processing-orthomosaics.html"><a href="processing-orthomosaics.html"><i class="fa fa-check"></i><b>7</b> Agisoft Photogrammetry pipeline</a>
<ul>
<li class="chapter" data-level="7.1" data-path="processing-orthomosaics.html"><a href="processing-orthomosaics.html#overview"><i class="fa fa-check"></i><b>7.1</b> Overview</a></li>
<li class="chapter" data-level="7.2" data-path="processing-orthomosaics.html"><a href="processing-orthomosaics.html#detailed-workflow"><i class="fa fa-check"></i><b>7.2</b> Detailed Workflow</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="georeferencing-plot-trees.html"><a href="georeferencing-plot-trees.html"><i class="fa fa-check"></i><b>8</b> Georeferencing Plot Trees</a>
<ul>
<li class="chapter" data-level="8.1" data-path="georeferencing-plot-trees.html"><a href="georeferencing-plot-trees.html#Workflow-in-QGIS"><i class="fa fa-check"></i><b>8.1</b> Workflow in QGIS</a></li>
<li class="chapter" data-level="8.2" data-path="georeferencing-plot-trees.html"><a href="georeferencing-plot-trees.html#alternate-workflow-in-r"><i class="fa fa-check"></i><b>8.2</b> Alternate Workflow in R</a></li>
<li class="chapter" data-level="8.3" data-path="georeferencing-plot-trees.html"><a href="georeferencing-plot-trees.html#final-steps-in-qgis"><i class="fa fa-check"></i><b>8.3</b> Final Steps in QGIS</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="crown-delineation.html"><a href="crown-delineation.html"><i class="fa fa-check"></i><b>9</b> Crown Delineation</a>
<ul>
<li class="chapter" data-level="9.1" data-path="crown-delineation.html"><a href="crown-delineation.html#circles-proportional-to-tree-height"><i class="fa fa-check"></i><b>9.1</b> Circles Proportional to Tree Height</a></li>
<li class="chapter" data-level="9.2" data-path="crown-delineation.html"><a href="crown-delineation.html#supercell-raster"><i class="fa fa-check"></i><b>9.2</b> Supercell Raster</a></li>
<li class="chapter" data-level="9.3" data-path="crown-delineation.html"><a href="crown-delineation.html#filter-merge-supercells"><i class="fa fa-check"></i><b>9.3</b> Filter &amp; Merge Supercells</a></li>
<li class="chapter" data-level="9.4" data-path="crown-delineation.html"><a href="crown-delineation.html#manually-edit-crowns"><i class="fa fa-check"></i><b>9.4</b> Manually Edit Crowns</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="shadow-mask.html"><a href="shadow-mask.html"><i class="fa fa-check"></i><b>10</b> Shadow Masks</a></li>
<li class="chapter" data-level="11" data-path="Vegetation-Indicies.html"><a href="Vegetation-Indicies.html"><i class="fa fa-check"></i><b>11</b> Crown-level Vegetation Indicies</a>
<ul>
<li class="chapter" data-level="11.1" data-path="Vegetation-Indicies.html"><a href="Vegetation-Indicies.html#vi-workflow"><i class="fa fa-check"></i><b>11.1</b> VI Workflow</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html"><i class="fa fa-check"></i><b>12</b> LiDAR Processing Workflow</a>
<ul>
<li class="chapter" data-level="12.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#dji-terra"><i class="fa fa-check"></i><b>12.1</b> DJI Terra</a></li>
<li class="chapter" data-level="12.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#register-the-lidar-to-the-dap-point-cloud"><i class="fa fa-check"></i><b>12.2</b> Register the LiDAR to the DAP point cloud</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#prepare-lidar-for-registration"><i class="fa fa-check"></i><b>12.2.1</b> Prepare LiDAR for registration</a></li>
<li class="chapter" data-level="12.2.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#register-lidar-to-dap-cloud-in-cloudcompare"><i class="fa fa-check"></i><b>12.2.2</b> Register LiDAR to DAP cloud in CloudCompare</a></li>
<li class="chapter" data-level="12.2.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#rescale-and-tile-the-registered-lidar"><i class="fa fa-check"></i><b>12.2.3</b> Rescale and tile the registered LiDAR:</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#normalization-and-individual-tree-point-clouds"><i class="fa fa-check"></i><b>12.3</b> Normalization and individual tree point clouds</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#creating-a-dtm-from-the-registered-lidar-tiles"><i class="fa fa-check"></i><b>12.3.1</b> Creating a DTM from the registered LiDAR tiles</a></li>
<li class="chapter" data-level="12.3.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#normalizing-the-tiles-using-the-dtm"><i class="fa fa-check"></i><b>12.3.2</b> Normalizing the tiles using the DTM</a></li>
<li class="chapter" data-level="12.3.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#creating-a-4cm-chm-from-the-max-z-values"><i class="fa fa-check"></i><b>12.3.3</b> Creating a 4cm CHM from the max Z values</a></li>
<li class="chapter" data-level="12.3.4" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#segmenting-tiles"><i class="fa fa-check"></i><b>12.3.4</b> Segmenting tiles</a></li>
<li class="chapter" data-level="12.3.5" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#merging-segmented-tiles-to-create-one-large-point-cloud-containing-the-top-defined-height-of-each-tree"><i class="fa fa-check"></i><b>12.3.5</b> Merging segmented tiles to create one large point cloud containing the top defined height % of each tree</a></li>
<li class="chapter" data-level="12.3.6" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#clipping-the-point-cloud-into-individual-point-clouds-per-tree"><i class="fa fa-check"></i><b>12.3.6</b> Clipping the point cloud into individual point clouds per tree</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#individual-tree-metrics"><i class="fa fa-check"></i><b>12.4</b> Individual Tree Metrics</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html"><i class="fa fa-check"></i><b>13</b> MicaSense Irradiance Correction</a>
<ul>
<li class="chapter" data-level="13.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#background"><i class="fa fa-check"></i><b>13.1</b> Background</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#deriving-horizontal-irradiance"><i class="fa fa-check"></i><b>13.1.1</b> Deriving Horizontal Irradiance</a></li>
<li class="chapter" data-level="13.1.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#calculating-reflectance"><i class="fa fa-check"></i><b>13.1.2</b> Calculating Reflectance</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#the-problem"><i class="fa fa-check"></i><b>13.2</b> The Problem</a></li>
<li class="chapter" data-level="13.3" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#is-correction-needed"><i class="fa fa-check"></i><b>13.3</b> Is Correction Needed?</a>
<ul>
<li class="chapter" data-level="13.3.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#do-the-sun-sensor-angles-make-sense"><i class="fa fa-check"></i><b>13.3.1</b> Do the sun sensor angles make sense?</a></li>
<li class="chapter" data-level="13.3.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#does-the-relationship-between-direct-and-horizontal-irradiance-make-sense"><i class="fa fa-check"></i><b>13.3.2</b> Does the relationship between direct and horizontal irradiance make sense?</a></li>
<li class="chapter" data-level="13.3.3" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#does-the-scattered-direct-ratio-make-sense-for-the-lighting-conditions-of-that-day"><i class="fa fa-check"></i><b>13.3.3</b> Does the scattered: direct ratio make sense for the lighting conditions of that day?</a></li>
</ul></li>
<li class="chapter" data-level="13.4" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#DLS1-correction"><i class="fa fa-check"></i><b>13.4</b> Correcting Irradiance Values for MicaSense Cameras</a>
<ul>
<li class="chapter" data-level="13.4.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#reading-exif-data"><i class="fa fa-check"></i><b>13.4.1</b> Reading Exif Data</a></li>
<li class="chapter" data-level="13.4.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#calculating-solar-zenith-angle"><i class="fa fa-check"></i><b>13.4.2</b> Calculating Solar Zenith Angle</a></li>
<li class="chapter" data-level="13.4.3" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#SSA-correction"><i class="fa fa-check"></i><b>13.4.3</b> Calculating Sun-Sensor Angles</a></li>
<li class="chapter" data-level="13.4.4" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#scattered-direct-ratio-estimate"><i class="fa fa-check"></i><b>13.4.4</b> Scattered: Direct Ratio Estimate</a></li>
<li class="chapter" data-level="13.4.5" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#computing-horizontal-corrected-irradiance"><i class="fa fa-check"></i><b>13.4.5</b> Computing Horizontal (Corrected) Irradiance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="thermal-conversion.html"><a href="thermal-conversion.html"><i class="fa fa-check"></i><b>14</b> Thermal Conversion</a>
<ul>
<li class="chapter" data-level="14.1" data-path="thermal-conversion.html"><a href="thermal-conversion.html#folder-set-up"><i class="fa fa-check"></i><b>14.1</b> Folder Set-Up</a></li>
<li class="chapter" data-level="14.2" data-path="thermal-conversion.html"><a href="thermal-conversion.html#weather-data"><i class="fa fa-check"></i><b>14.2</b> Weather Data</a></li>
<li class="chapter" data-level="14.3" data-path="thermal-conversion.html"><a href="thermal-conversion.html#dji-thermal-sdk-temperature-conversion"><i class="fa fa-check"></i><b>14.3</b> DJI Thermal SDK: temperature conversion</a>
<ul>
<li class="chapter" data-level="14.3.1" data-path="thermal-conversion.html"><a href="thermal-conversion.html#parameters"><i class="fa fa-check"></i><b>14.3.1</b> Parameters</a></li>
<li class="chapter" data-level="14.3.2" data-path="thermal-conversion.html"><a href="thermal-conversion.html#running-the-sdk"><i class="fa fa-check"></i><b>14.3.2</b> Running the SDK</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="thermal-conversion.html"><a href="thermal-conversion.html#convert-to-raster"><i class="fa fa-check"></i><b>14.4</b> Convert to Raster</a></li>
<li class="chapter" data-level="14.5" data-path="thermal-conversion.html"><a href="thermal-conversion.html#examples"><i class="fa fa-check"></i><b>14.5</b> Examples</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="processing-orthomosaics" class="section level1 hasAnchor" number="7">
<h1><span class="header-section-number">Chapter 7</span> Agisoft Photogrammetry pipeline<a href="processing-orthomosaics.html#processing-orthomosaics" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><strong>Processing P1 data and registering multispectral to it</strong></p>
<p>Software: Agisoft LLC. (2024). <em>Agisoft Metashape Professional, Version 2.1.1</em>.</p>
<p>We use Agisoft Metashape Pro to process aerial photogrammetry into orthomosaics. The following is a complete workflow for processing a P1 RGB that is geometrically accurate, registering the less accurate multispectral imagery to it, and producing calibrated ten band orthomosaics for further processing into vegetative indices. We process all DAP flights from the same site on the same day in one Agisoft project. Each flight is referred to as a “chunk” by Agisoft. In this case we are processing both a MS and MS_P chunk in order to test and provide examples, but normally only one would be used. The settings used will vastly affect processing times and quality and each setting has been carefully considered.</p>
<p>Agisoft processes can be started using GUI tools or scripted using the python console. We don’t use a full scripted workflow as there are several manual steps outlined below, but we do use snippets of code for some steps.</p>
<p>The workflow is based on a site approximately 1.5 Ha buffered to 2Ha and the raw data would be approximately:</p>
<ul>
<li>P1 (RGB): 500 photos and 12 GB of data</li>
<li>MS_P (10 band plus panchro): 12,000 photos equaling 42 GB</li>
<li>MS (10 band): 10,500 photos equaling 25GB</li>
</ul>
<div id="overview" class="section level2 hasAnchor" number="7.1">
<h2><span class="header-section-number">7.1</span> Overview<a href="processing-orthomosaics.html#overview" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ol style="list-style-type: decimal">
<li>Import all photos for each chunk and locate the calibration panel captures for the multispectral chunks. Then save to the project file structure.</li>
<li>Manually assess all flight lines and disable outliers.</li>
<li>Build the P1 RGB through to orthomosaic using the settings detailed below.</li>
<li>Confirm the P1 is aligned to the GCPs and template P1 if this is not the primary flight.</li>
<li>For each of the other DAP sensors, specifically MS and MS_P chunks, build through to orthomosaic following the steps outlined below paying particular attention to the chunk align.</li>
<li>Check the ortho registration and reflectance values.</li>
<li>Run the closing script for each multispectral sensor after entering the variables into the script. This script will:
<ul>
<li>Normalize the 16bit pixel values.<br />
</li>
<li>Import the 15m buffered shape of the trial and export the orthomosaic clipped to this shape in NAD83 to the project specific folder.</li>
</ul></li>
</ol>
<p>Approximate processing times:</p>
<ul>
<li>~12 hours for the P1 RGB.</li>
<li>~18-38 hours for each of the Micasense Dual sensors, with the MS_P on the higher end.</li>
</ul>
<p>This process produces an Agisoft folder with the P1 and MS chunks containing ~80GB of files.
The exported orthomosaic tifs contain 10 (MS) or 11 (MS_P) bands and are ready for analysis.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:aligned-agisoft"></span>
<img src="Photos_&_gifs/Aligned_agisoft.png" alt="A dense point cloud processed in Agisoft Metashape with the camera locations turned on and disabled flight trajectories shown." width="100%" />
<p class="caption">
Figure 7.1: A dense point cloud processed in Agisoft Metashape with the camera locations turned on and disabled flight trajectories shown.
</p>
</div>
<p><strong>Coordinate Reference Systems:</strong></p>
<ul>
<li>DJI drones and GNSS units work in the geodetic coordinate system (GCS) WGS84, EPSG:4326</li>
<li>We chose to work in WGS84 during photogrammetry processing until exporting orthomosaics. We export orthomosaics for further processing into the coordinate reference system NAD83/UTM.</li>
</ul>
<p><strong>Agisoft Preferences Setup:</strong>
Prior to commencing processing, we recommend the following settings in Tools-Preferences.</p>
<ul>
<li>GPU tab: Uncheck the Use CPU when performing GPU accelerated processing. This will free up your CPU during the heavy processing steps.</li>
<li>Advanced tab: The settings in Figure <a href="processing-orthomosaics.html#fig:metashape-pref">7.2</a> are recommended.</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:metashape-pref"></span>
<img src="Photos_&_gifs/metashape_pref.png" alt="Recommended Metashape preferences setup in Tools, Metashape Preferences, under the Advanced tab." width="50%" /><img src="Photos_&_gifs/metashape_pref_2.png" alt="Recommended Metashape preferences setup in Tools, Metashape Preferences, under the Advanced tab." width="50%" />
<p class="caption">
Figure 7.2: Recommended Metashape preferences setup in Tools, Metashape Preferences, under the Advanced tab.
</p>
</div>
</div>
<div id="detailed-workflow" class="section level2 hasAnchor" number="7.2">
<h2><span class="header-section-number">7.2</span> Detailed Workflow<a href="processing-orthomosaics.html#detailed-workflow" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<ol style="list-style-type: decimal">
<li><strong>Load Photos and locate calibration panels</strong> - Script (or GUI). 15 minutes.</li>
</ol>
<p>Agisoft processes all ten bands as a multicamera with one primary channel. We import imagery using a python script located <a href="https://github.com/owaite/GenomeBC_BPG/blob/main/Scripts/TheOpener_BPG.py">here</a> and shown below. However, you can also import folders containing imagery in metashape via the import tool or by dragging and dropping the folder into the specified chunk.</p>
<ul>
<li>The script will import all photos for each chunk, then locate the calibration panel captures for the multispectral and move them to a “Calibration images” folder in the Agisoft Workspace tab.
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb1"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="processing-orthomosaics.html#cb1-1" tabindex="-1"></a><span class="im">import</span> os, Metashape</span>
<span id="cb1-2"><a href="processing-orthomosaics.html#cb1-2" tabindex="-1"></a><span class="im">import</span> glob</span>
<span id="cb1-3"><a href="processing-orthomosaics.html#cb1-3" tabindex="-1"></a><span class="co"># the location of all photos for the Agisoft psx, select site, check path, enter date YYYY_MM_DD</span></span>
<span id="cb1-4"><a href="processing-orthomosaics.html#cb1-4" tabindex="-1"></a><span class="co">#name = &quot;Fdc_JR_East_GCA&quot;</span></span>
<span id="cb1-5"><a href="processing-orthomosaics.html#cb1-5" tabindex="-1"></a>name <span class="op">=</span> <span class="st">&quot;Hillcrest_GCA&quot;</span></span>
<span id="cb1-6"><a href="processing-orthomosaics.html#cb1-6" tabindex="-1"></a><span class="co">#name = &quot;Big_Tree_GCA&quot;</span></span>
<span id="cb1-7"><a href="processing-orthomosaics.html#cb1-7" tabindex="-1"></a>path <span class="op">=</span> <span class="st">&quot;Q:</span><span class="ch">\\</span><span class="st">SNC</span><span class="ch">\\</span><span class="st">Data&quot;</span></span>
<span id="cb1-8"><a href="processing-orthomosaics.html#cb1-8" tabindex="-1"></a>date <span class="op">=</span> <span class="st">&quot;2024_08_28&quot;</span></span>
<span id="cb1-9"><a href="processing-orthomosaics.html#cb1-9" tabindex="-1"></a><span class="co"># make sure that subfolders with the name of this project exist</span></span>
<span id="cb1-10"><a href="processing-orthomosaics.html#cb1-10" tabindex="-1"></a><span class="co"># Create folder structure specific to current project file setup</span></span>
<span id="cb1-11"><a href="processing-orthomosaics.html#cb1-11" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(path <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;Flights&quot;</span> <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> date <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2_Inputs</span><span class="ch">\\</span><span class="st">metashape</span><span class="ch">\\</span><span class="st">1_TILES</span><span class="ch">\\</span><span class="st">&quot;</span>):</span>
<span id="cb1-12"><a href="processing-orthomosaics.html#cb1-12" tabindex="-1"></a>     os.makedirs(path <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;Flights&quot;</span> <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> date <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2_Inputs</span><span class="ch">\\</span><span class="st">metashape</span><span class="ch">\\</span><span class="st">1_TILES</span><span class="ch">\\</span><span class="st">&quot;</span>)</span>
<span id="cb1-13"><a href="processing-orthomosaics.html#cb1-13" tabindex="-1"></a></span>
<span id="cb1-14"><a href="processing-orthomosaics.html#cb1-14" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(path <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;Flights&quot;</span> <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> date <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2_Inputs</span><span class="ch">\\</span><span class="st">metashape</span><span class="ch">\\</span><span class="st">2_ORTHO</span><span class="ch">\\</span><span class="st">&quot;</span>):</span>
<span id="cb1-15"><a href="processing-orthomosaics.html#cb1-15" tabindex="-1"></a>    os.makedirs(path <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;Flights&quot;</span> <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> date <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2_Inputs</span><span class="ch">\\</span><span class="st">metashape</span><span class="ch">\\</span><span class="st">2_ORTHO</span><span class="ch">\\</span><span class="st">&quot;</span>)</span>
<span id="cb1-16"><a href="processing-orthomosaics.html#cb1-16" tabindex="-1"></a></span>
<span id="cb1-17"><a href="processing-orthomosaics.html#cb1-17" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(path <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;Flights&quot;</span> <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> date <span class="op">+</span><span class="st">&quot;</span><span class="ch">\\</span><span class="st">2_Inputs</span><span class="ch">\\</span><span class="st">metashape</span><span class="ch">\\</span><span class="st">3_MS_ORTHO</span><span class="ch">\\</span><span class="st">&quot;</span>):</span>
<span id="cb1-18"><a href="processing-orthomosaics.html#cb1-18" tabindex="-1"></a>    os.makedirs(path <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;Flights&quot;</span> <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> date <span class="op">+</span><span class="st">&quot;</span><span class="ch">\\</span><span class="st">2_Inputs</span><span class="ch">\\</span><span class="st">metashape</span><span class="ch">\\</span><span class="st">3_MS_ORTHO</span><span class="ch">\\</span><span class="st">&quot;</span>)    </span>
<span id="cb1-19"><a href="processing-orthomosaics.html#cb1-19" tabindex="-1"></a><span class="co"># P1 path    </span></span>
<span id="cb1-20"><a href="processing-orthomosaics.html#cb1-20" tabindex="-1"></a>rgb_P1_path <span class="op">=</span> path <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">Flights</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> date <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1_Data</span><span class="ch">\\</span><span class="st">P1</span><span class="ch">\\</span><span class="st">*</span><span class="ch">\\</span><span class="st">*.JPG&quot;</span>  </span>
<span id="cb1-21"><a href="processing-orthomosaics.html#cb1-21" tabindex="-1"></a><span class="co">#micasense mx path</span></span>
<span id="cb1-22"><a href="processing-orthomosaics.html#cb1-22" tabindex="-1"></a>ms_path <span class="op">=</span> path <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">Flights&quot;</span> <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> date <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1_Data&quot;</span><span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">Micasense</span><span class="ch">\\</span><span class="st">*</span><span class="ch">\\</span><span class="st">*</span><span class="ch">\\</span><span class="st">*</span><span class="ch">\\</span><span class="st">*&quot;</span></span>
<span id="cb1-23"><a href="processing-orthomosaics.html#cb1-23" tabindex="-1"></a><span class="co">#micasense Pan chromatic path</span></span>
<span id="cb1-24"><a href="processing-orthomosaics.html#cb1-24" tabindex="-1"></a>ms_P_path <span class="op">=</span> path <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">Flights&quot;</span> <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> date <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">1_Data&quot;</span><span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">Micasense_P</span><span class="ch">\\</span><span class="st">*</span><span class="ch">\\</span><span class="st">*</span><span class="ch">\\</span><span class="st">*</span><span class="ch">\\</span><span class="st">*&quot;</span></span>
<span id="cb1-25"><a href="processing-orthomosaics.html#cb1-25" tabindex="-1"></a><span class="co">#path to save project</span></span>
<span id="cb1-26"><a href="processing-orthomosaics.html#cb1-26" tabindex="-1"></a>psx_path <span class="op">=</span> path <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;Flights&quot;</span> <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> date <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2_Inputs</span><span class="ch">\\</span><span class="st">metashape</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;_&quot;</span> <span class="op">+</span> date <span class="op">+</span><span class="st">&quot;.psx&quot;</span></span>
<span id="cb1-27"><a href="processing-orthomosaics.html#cb1-27" tabindex="-1"></a><span class="co">#setting up the document </span></span>
<span id="cb1-28"><a href="processing-orthomosaics.html#cb1-28" tabindex="-1"></a>doc <span class="op">=</span> Metashape.app.document</span>
<span id="cb1-29"><a href="processing-orthomosaics.html#cb1-29" tabindex="-1"></a>doc.save(psx_path)</span>
<span id="cb1-30"><a href="processing-orthomosaics.html#cb1-30" tabindex="-1"></a><span class="co"># Adding the RGB_P1 chunk, load photos with EXIF</span></span>
<span id="cb1-31"><a href="processing-orthomosaics.html#cb1-31" tabindex="-1"></a>chunk <span class="op">=</span> doc.addChunk()</span>
<span id="cb1-32"><a href="processing-orthomosaics.html#cb1-32" tabindex="-1"></a>chunk.label <span class="op">=</span> <span class="st">&quot;RGB_P1&quot;</span></span>
<span id="cb1-33"><a href="processing-orthomosaics.html#cb1-33" tabindex="-1"></a>photo_list <span class="op">=</span> glob.glob(rgb_P1_path)</span>
<span id="cb1-34"><a href="processing-orthomosaics.html#cb1-34" tabindex="-1"></a>chunk.addPhotos(photo_list) <span class="co"># add the photos</span></span>
<span id="cb1-35"><a href="processing-orthomosaics.html#cb1-35" tabindex="-1"></a>chunk.loadReferenceExif(load_rotation<span class="op">=</span><span class="va">True</span>, load_accuracy<span class="op">=</span><span class="va">True</span>)<span class="co"># load the exif data</span></span>
<span id="cb1-36"><a href="processing-orthomosaics.html#cb1-36" tabindex="-1"></a><span class="co"># Adding the MS_Mica chunk, loading photos and locating reflectance panels</span></span>
<span id="cb1-37"><a href="processing-orthomosaics.html#cb1-37" tabindex="-1"></a>chunk <span class="op">=</span> doc.addChunk()</span>
<span id="cb1-38"><a href="processing-orthomosaics.html#cb1-38" tabindex="-1"></a>chunk.label <span class="op">=</span> <span class="st">&quot;MS_Mica&quot;</span></span>
<span id="cb1-39"><a href="processing-orthomosaics.html#cb1-39" tabindex="-1"></a>photo_list <span class="op">=</span> glob.glob(ms_path)</span>
<span id="cb1-40"><a href="processing-orthomosaics.html#cb1-40" tabindex="-1"></a>chunk.addPhotos(photo_list)<span class="co"># add the photos</span></span>
<span id="cb1-41"><a href="processing-orthomosaics.html#cb1-41" tabindex="-1"></a>chunk.loadReferenceExif(load_rotation<span class="op">=</span><span class="va">True</span>, load_accuracy<span class="op">=</span><span class="va">True</span>)<span class="co">#load the exif data</span></span>
<span id="cb1-42"><a href="processing-orthomosaics.html#cb1-42" tabindex="-1"></a>chunk.locateReflectancePanels()<span class="co"># locate reflectance panels</span></span>
<span id="cb1-43"><a href="processing-orthomosaics.html#cb1-43" tabindex="-1"></a>doc.save()</span>
<span id="cb1-44"><a href="processing-orthomosaics.html#cb1-44" tabindex="-1"></a><span class="co"># Adding the MS_Mica_P chunk, loading photos and locating reflectance panels</span></span>
<span id="cb1-45"><a href="processing-orthomosaics.html#cb1-45" tabindex="-1"></a>chunk <span class="op">=</span> doc.addChunk()</span>
<span id="cb1-46"><a href="processing-orthomosaics.html#cb1-46" tabindex="-1"></a>chunk.label <span class="op">=</span> <span class="st">&quot;MS_Mica_P&quot;</span></span>
<span id="cb1-47"><a href="processing-orthomosaics.html#cb1-47" tabindex="-1"></a>photo_list <span class="op">=</span> glob.glob(ms_P_path)</span>
<span id="cb1-48"><a href="processing-orthomosaics.html#cb1-48" tabindex="-1"></a>chunk.addPhotos(photo_list) <span class="co"># add the photos </span></span>
<span id="cb1-49"><a href="processing-orthomosaics.html#cb1-49" tabindex="-1"></a>chunk.loadReferenceExif(load_rotation<span class="op">=</span><span class="va">True</span>, load_accuracy<span class="op">=</span><span class="va">True</span>)<span class="co">#load the exif data</span></span>
<span id="cb1-50"><a href="processing-orthomosaics.html#cb1-50" tabindex="-1"></a>chunk.locateReflectancePanels()<span class="co"># locate reflectance panels</span></span>
<span id="cb1-51"><a href="processing-orthomosaics.html#cb1-51" tabindex="-1"></a>doc.save()</span></code></pre></div>
</details></li>
<li>If you chose to manually import imagery, you can locate calibration panels using the Calibrate Reflectance tool in the Tools GUI as seen below in Figure <a href="processing-orthomosaics.html#fig:cal-ref-agisoft">7.3</a>.</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:cal-ref-agisoft"></span>
<img src="Photos_&_gifs/cal_ref_metashape.png" alt="Calibrate reflectance tool found under Tools in Metashape." width="100%" />
<p class="caption">
Figure 7.3: Calibrate reflectance tool found under Tools in Metashape.
</p>
</div>
<p><strong>Note:</strong> To leverage the higher resolution imagery available with the MS_P sensor you are required to set the panchromatic camera as the primary channel for processing. Go to Tools – Set Primary Channel – select Panchro.</p>
<ol start="2" style="list-style-type: decimal">
<li><strong>Micasense Corrections outside of Agisoft(if necessary)</strong> – R Script. 2 hours.</li>
</ol>
<ul>
<li>We have encountered incorrect irradiance data in metadata of MicaSense imagery due to incorrect measurements by the DLS2. To correct the irradiance data prior to processing we use methods from MicaSense’s DLS1 system. See the chapter on <a href="micasense-irradiance-correction.html#micasense-irradiance-correction">MicaSense Irradiance Correction</a> for checks on whether your data needs correction and a detailed explanation of the correction process.</li>
</ul>
<ol start="3" style="list-style-type: decimal">
<li><strong>Visually Assess Flight Trajectory and Disable Outliers</strong> – Manual. 10 minutes.</li>
</ol>
<ul>
<li>The MS cameras start taking pictures as soon as image capture has been started via the webpage on the ground and don’t stop until we power off at the end of the flight. Hence, we examine the flight trajectory and disable photos taken during flight to and from the site.</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:trajectory"></span>
<img src="Photos_&_gifs/trajectory.PNG" alt="Flight trajectory with light blue disabled and dark blue as enabled cameras prior to photo alignment." width="100%" />
<p class="caption">
Figure 7.4: Flight trajectory with light blue disabled and dark blue as enabled cameras prior to photo alignment.
</p>
</div>
<ol start="4" style="list-style-type: decimal">
<li><strong>Select the Best Calibration Panels and Calibrate Reflectance</strong> – Manual and Processed. 15 minutes.</li>
</ol>
<ul>
<li>Each panel has a unique set of calibration values provided by the manufacturer in a csv. The Select Panel button in the Calibrate Reflectance tool will direct you to import the csv.</li>
<li>Agisoft Metashape takes the latest before the flight and the earliest after the flight panel captures and linearly interpolates between them.</li>
<li>We select one panel capture from the start and one from the end of the flight, by visually selecting a centered capture without shadow or glare and moving the rest to an “Unused_Cal_Images” folder (this folder needs to be created in the GUI).</li>
<li>We run the calibration process using both the DLS and Calibration Panels checked in . However, Micasense recommends only calibrating with panels on full sun days. Please refer to the <a href="https://support.micasense.com/hc/en-us/articles/224893167-Best-practices-Collecting-Data-with-MicaSense-Sensors#:~:text=Hold%20the%20aircraft%20at%20chest,offset%20slightly%20to%20prevent%20shadows.">Micasense Knowledge Base - Best practices: Collecting Data with MicaSense Sensors</a> for more details.</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:cal-ref-sunPanel-agisoft"></span>
<img src="Photos_&_gifs/cal_ref_sun_panel_metashape.png" alt="Calibrate reflectance tool found under Tools in Metashape with sun sensor and reflectance panels enabled for calibration." width="100%" />
<p class="caption">
Figure 7.5: Calibrate reflectance tool found under Tools in Metashape with sun sensor and reflectance panels enabled for calibration.
</p>
</div>
<ol start="5" style="list-style-type: decimal">
<li><strong>Align Photos</strong> – GUI - Processed. 3-10 hours.</li>
</ol>
<ul>
<li>Photogrammetric alignment is the process of matching and orienting overlapping images by identifying common features known as tie points, across multiple images. This alignment generates a geometrically accurate sparse point cloud from the tie points.</li>
<li>We use the batch processing tool and settings as seen below.</li>
<li>The sparse clouds vary greatly in density, the P1 clouds on a closed canopy can be as low as 150,000 points. The MS_P sparse clouds could be 48 million points on the same flight plan.</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:align-photo-agisoft"></span>
<img src="Photos_&_gifs/align_photos_metashape.png" alt="Photogrametric camera alignment settings using the alignment tool in Metashape" width="40%" />
<p class="caption">
Figure 7.6: Photogrametric camera alignment settings using the alignment tool in Metashape
</p>
</div>
<ol start="6" style="list-style-type: decimal">
<li><strong>Import and Align GCPs</strong> – Manual. 15 minutes.</li>
</ol>
<ul>
<li>The GCP coordinates are imported in WGS 84.</li>
<li><strong>Note</strong> GCPs can be used either actively as control points in which case they will “pull” the images into alignment or passively as check points to measure error.</li>
<li>We are only using GCPs as check points now, but they will be implemented if registration fails.
-Instructions to align GCPs if necessary
<ul>
<li>In the Reference pane check GCP_1 right click on it and filter photos by marker</li>
<li>Open the photos tab, and double click the first photo. Drag the marker to the center of the photo. Do this for several photos - then click on the update transform tool found in the Reference pane.</li>
<li>Scroll through at least 3 more pics to make sure they are aligned.</li>
<li>Repeat for each GCPs hitting update transform tool located in the reference panel once you have set the photos.</li>
<li>Leave at least one GCP for a “checkpoint”.</li>
</ul></li>
</ul>
<ol start="7" style="list-style-type: decimal">
<li><strong>Sparse Cloud - Filter and Optimize Camera Alignment</strong> - manual. 30-45 minutes.</li>
</ol>
<ul>
<li>This iterative step filters the sparse cloud for outliers and optimizes the camera calibration. Most literature suggests more aggressive filtering, but on closed canopy sites this tends to cause loss. Visually assess the cloud at each stage to confirm the sparse cloud is not becoming too sparse.</li>
<li>In the GUI select Model – Gradual Selection – Reconstruction Uncertainty: Adjust the slider until the value is 25-75, while selecting a Max of %10 of the points.</li>
<li>In Figure <a href="processing-orthomosaics.html#fig:sparseCloud-agisoft">7.7</a>, there are 400,000 points selected out of 40 million and the uncertainty is at 30.</li>
<li>Hit okay and delete to remove points.
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:sparseCloud-agisoft"></span>
<img src="Photos_&_gifs/sparse_cloud_metashape.png" alt="Sparse cloud created in image alignment. Pink points are those selected by the Gradual Selection tool that have a reconstruction uncertainty greater than or equal to 30.4608. These points will be filtered out." width="100%" />
<p class="caption">
Figure 7.7: Sparse cloud created in image alignment. Pink points are those selected by the Gradual Selection tool that have a reconstruction uncertainty greater than or equal to 30.4608. These points will be filtered out.
</p>
</div></li>
<li>Next we optimize the camera alignment. Tools - Optimize Camera Alignment: default settings as in Figure <a href="processing-orthomosaics.html#fig:opt-align-agisoft">7.8</a>.</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:opt-align-agisoft"></span>
<img src="Photos_&_gifs/opt_camera_align_metashape.png" alt="Settings used for the Optimize Camera Alignment tool" width="60%" />
<p class="caption">
Figure 7.8: Settings used for the Optimize Camera Alignment tool
</p>
</div>
<ul>
<li>We now go through the same steps again filtering points and optimizing the cameras for the following settings.</li>
<li>Model – Gradual Selection – Projection Accuracy: 5-20. Max%10</li>
<li>Optimize Camera Alignment at stock - check estimate tiepoint covariance</li>
<li>Model – Gradual Selection – Reprojection Error: 0.3-1. Max%10</li>
<li>Optimize Camera Alignment at stock with fit additional corrections and estimate tiepoint covariance.</li>
<li>Finally using the select tool we manually clip any edge points not cohesive to the flight.</li>
</ul>
<ol start="8" style="list-style-type: decimal">
<li><strong>Point based chunk alignment:</strong> multispectral to P1 - (requires manual verification). 2-6 hours. Batch processing</li>
</ol>
<ul>
<li>Leveraging the accuracy of the P1 as a reference, the MS sparse cloud is aligned to the higher accuracy P1 sparse cloud using the batch processing steps according to the settings in Figure <a href="processing-orthomosaics.html#fig:chunk-align-agisoft">7.9</a>.
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:chunk-align-agisoft"></span>
<img src="Photos_&_gifs/align_chunks_metashape.png" alt="Settings used for point based chunk alignment when aligning the multispectral data to the P1." width="60%" />
<p class="caption">
Figure 7.9: Settings used for point based chunk alignment when aligning the multispectral data to the P1.
</p>
</div></li>
<li>Visually confirm each multispectral has in fact aligned by seeing the [T] for transposed as in Figure <a href="processing-orthomosaics.html#fig:chunk-align-agisoft">7.9</a>. If the chunk align on medium setting fails, try again on low. If this also fails, you will need to align with GCP’s or attempt georeferencing the output orthomosaics in a GIS.</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:chunk-align-confirm-agisoft"></span>
<img src="Photos_&_gifs/transposed_metashape.png" alt="Visual of the [T] that will appear next to chunks that have successfully aligned via chunk alignment." width="60%" />
<p class="caption">
Figure 7.10: Visual of the [T] that will appear next to chunks that have successfully aligned via chunk alignment.
</p>
</div>
<ol start="9" style="list-style-type: decimal">
<li><strong>Build Depth Maps and Dense Cloud</strong> – Script or Batch Process. 5-24 hours.</li>
</ol>
<ul>
<li>A dense point cloud, a high-resolution 3D representation with significantly more detail than the sparse cloud is built in this step. First depth maps are created for each image, capturing detailed information about the distance to surfaces in the scene. These depth maps are then combined to generate the dense point cloud. This is a primary product and can be exported. We have been building these to the highest settings as outlined in Figure <a href="processing-orthomosaics.html#fig:DC-settings-agisoft">7.11</a>, but if this is not required significant time can be saved by lowering the setting. An example dense cloud is seen in Figure <a href="processing-orthomosaics.html#fig:aligned-agisoft">7.1</a></li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:DC-settings-agisoft"></span>
<img src="Photos_&_gifs/DC_settings_metashape.png" alt="Metashape settings for building the depth maps and the dense cloud." width="60%" />
<p class="caption">
Figure 7.11: Metashape settings for building the depth maps and the dense cloud.
</p>
</div>
<ol start="10" style="list-style-type: decimal">
<li><strong>Build DEM</strong> – Script or Batch Processed. ~1 hour.</li>
</ol>
<ul>
<li>Generates a Digital Elevation Model from the dense cloud data. Batch settings in Figure <a href="processing-orthomosaics.html#fig:DEM-settings-agisoft">7.12</a></li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:DEM-settings-agisoft"></span>
<img src="Photos_&_gifs/build_DEM_metashape.png" alt="Metashape settings for DEM generation." width="60%" />
<p class="caption">
Figure 7.12: Metashape settings for DEM generation.
</p>
</div>
<ol start="11" style="list-style-type: decimal">
<li><strong>Build Orthomosaic</strong> – Script or Batch Processed. 1-4 hours.</li>
</ol>
<ul>
<li>Creates an orthomosaic by stitching together the aligned images and the DEM according to batch processing steps in Figure <a href="processing-orthomosaics.html#fig:ortho-settings-agisoft">7.13</a>.</li>
<li><strong>NOTE: We do NOT enable hole filling for multispectral</strong> – only used for RGB orthomosaics that were needed strictly for visual purposes and not analysis.</li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:ortho-settings-agisoft"></span>
<img src="Photos_&_gifs/build_ortho_metashape.png" alt="Metashape settings for building the orthomosaic." width="60%" />
<p class="caption">
Figure 7.13: Metashape settings for building the orthomosaic.
</p>
</div>
<ol start="12" style="list-style-type: decimal">
<li>**Check Orthomosaic Registration* - Manual. 15 minutes to redo from GCP alignment.</li>
</ol>
<ul>
<li>The orthomosaic is checked for alignment to the GCPs. If it is not close on each GCP, we go back and try alignment with GCPs. It is very important to check all corners, as occasionally three out of four will align beautifully, and the fourth will be 25-50cm out of alignment.</li>
<li>In the cases where we were unable to establish GCPs the orthomosaic is exported and checked against the P1 in a GIS.</li>
</ul>
<ol start="13" style="list-style-type: decimal">
<li><strong>Sanity Check Reflectance Values</strong> – Manual. 15 minutes – 2 hours if remaking orthomosaics.</li>
</ol>
<ul>
<li>The orthomosaic is sanity checked for reflectance values. We look at the histogram of three different bands to ensure the values make sense. If they do not, another calibration panel is chosen, the reflectance is recalibrated, and the orthomosaic is rebuilt.</li>
<li>To check values - go into Raster Transform - Enable Transform</li>
<li>Select B1 (blue band). Click the circular arrows to the left of the “interpolate colors” button, then click auto and then apply. B1 should be around ~0.02 for the trees. The range it gives will be for the entire ortho so roads and other vegetation will increase the range so I suggest zooming into the ortho so you can see approximately what values correspond to trees. Repeat for B4 (green) and B10 (NIR). If the values are too large or small, i.e. B10 (NIR) &gt; 1, choose another calibration panel, delete the ortho, recalibrate, remake the ortho and recheck the values.
-<strong>Note</strong> these values are general estimates of what a “tree” should look like however, different vegetation will have different ranges, for example values for cedar may be a little lower compared to Douglas fir.</li>
</ul>
<p><strong>General benchmarks:</strong></p>
<ul>
<li>B1 should be around ~0.02.
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:b1-check-ref-agisoft"></span>
<img src="Photos_&_gifs/reflectance_values_metashape.png" alt="Raster calculator tool in Metashape to look at reflectance values of trees for band 1 (Blue - 444nm) prior to exporting the orthomosaic." width="100%" />
<p class="caption">
Figure 7.14: Raster calculator tool in Metashape to look at reflectance values of trees for band 1 (Blue - 444nm) prior to exporting the orthomosaic.
</p>
</div></li>
<li>B4 should be around ~0.06
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:b4-check-ref-agisoft"></span>
<img src="Photos_&_gifs/b4_reflectance_values_metashape.png" alt="Reflectance values of trees for band 4 (Green - 560nm)." width="100%" />
<p class="caption">
Figure 7.15: Reflectance values of trees for band 4 (Green - 560nm).
</p>
</div></li>
<li>B10 should be around ~0.3 – 0.5, but shouldn’t exceed 0.7
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:b10-check-ref-agisoft"></span>
<img src="Photos_&_gifs/b10_reflectance_values_metashape.png" alt="Reflectance values of trees for band 10 (NIR - 842nm)." width="100%" />
<p class="caption">
Figure 7.16: Reflectance values of trees for band 10 (NIR - 842nm).
</p>
</div></li>
</ul>
<ol start="14" style="list-style-type: decimal">
<li>Normalize and export – Script 5 minutes.</li>
</ol>
<ul>
<li>Run the closing script for each multispectral sensor after entering the variables into the scripts. <a href="https://github.com/owaite/GenomeBC_BPG/blob/main/Scripts/BPG_closing_MS.py">MS</a>, <a href="https://github.com/owaite/GenomeBC_BPG/blob/main/Scripts/BPG_closing_MS_.py">MS_P</a> these scripts will:
<ul>
<li>Normalize the 16bit pixel values for the MS and MS_P. <strong>Note</strong> We do not recommend pan sharpening, but if this is part of your workflow you would do it now as per the micasense knowledge base <a href="https://support.micasense.com/hc/en-us/articles/4416696717847-Pan-sharpening-processing-data-from-Altum-PT-and-RedEdge-P-cameras-in-Agisoft-Metashape">here</a>.</li>
<li>Import the 15m buffered shape of the trial and export the orthomosaic clipped to this shape in NAD83 to the project specific folder. <strong>Note</strong> Importing and clipping the orthomosaic will reduce the size of the export and help speed up further processing.</li>
</ul></li>
</ul>
See the closing script for the MS here:
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb2"><pre class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="processing-orthomosaics.html#cb2-1" tabindex="-1"></a><span class="im">import</span> os, Metashape</span>
<span id="cb2-2"><a href="processing-orthomosaics.html#cb2-2" tabindex="-1"></a><span class="co"># select project variables, name, date, chosen calibration panel numbers, site perimeter </span></span>
<span id="cb2-3"><a href="processing-orthomosaics.html#cb2-3" tabindex="-1"></a>name <span class="op">=</span> <span class="st">&quot;Big_Tree_GCA&quot;</span></span>
<span id="cb2-4"><a href="processing-orthomosaics.html#cb2-4" tabindex="-1"></a>date <span class="op">=</span> <span class="st">&quot;2024_04_30&quot;</span></span>
<span id="cb2-5"><a href="processing-orthomosaics.html#cb2-5" tabindex="-1"></a><span class="co"># enter chosen calibration panel numbers</span></span>
<span id="cb2-6"><a href="processing-orthomosaics.html#cb2-6" tabindex="-1"></a>cal_pan_1 <span class="op">=</span> <span class="st">&quot;9&quot;</span></span>
<span id="cb2-7"><a href="processing-orthomosaics.html#cb2-7" tabindex="-1"></a>cal_pan_2 <span class="op">=</span> <span class="st">&quot;1085&quot;</span></span>
<span id="cb2-8"><a href="processing-orthomosaics.html#cb2-8" tabindex="-1"></a></span>
<span id="cb2-9"><a href="processing-orthomosaics.html#cb2-9" tabindex="-1"></a>site_perim <span class="op">=</span> <span class="st">&quot;Q:</span><span class="ch">\\</span><span class="st">SNC</span><span class="ch">\\</span><span class="st">Data</span><span class="ch">\\</span><span class="st">Big_Tree_GCA</span><span class="ch">\\</span><span class="st">Site_Info</span><span class="ch">\\</span><span class="st">03_GIS</span><span class="ch">\\</span><span class="st">shapefiles</span><span class="ch">\\</span><span class="st">big_tree_15m_buf_WGS84.shp&quot;</span></span>
<span id="cb2-10"><a href="processing-orthomosaics.html#cb2-10" tabindex="-1"></a><span class="co"># confirm project path</span></span>
<span id="cb2-11"><a href="processing-orthomosaics.html#cb2-11" tabindex="-1"></a>path <span class="op">=</span> <span class="st">&quot;Q:</span><span class="ch">\\</span><span class="st">SNC</span><span class="ch">\\</span><span class="st">Data&quot;</span></span>
<span id="cb2-12"><a href="processing-orthomosaics.html#cb2-12" tabindex="-1"></a></span>
<span id="cb2-13"><a href="processing-orthomosaics.html#cb2-13" tabindex="-1"></a><span class="co">## no change necessary from here</span></span>
<span id="cb2-14"><a href="processing-orthomosaics.html#cb2-14" tabindex="-1"></a><span class="co"># MS ortho export path</span></span>
<span id="cb2-15"><a href="processing-orthomosaics.html#cb2-15" tabindex="-1"></a>ms_ortho_path <span class="op">=</span> path <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> <span class="st">&quot;Flights&quot;</span> <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> date <span class="op">+</span> <span class="st">&quot;</span><span class="ch">\\</span><span class="st">2_Inputs</span><span class="ch">\\</span><span class="st">metashape</span><span class="ch">\\</span><span class="st">3_MS_ORTHO</span><span class="ch">\\</span><span class="st">&quot;</span> <span class="op">+</span> name <span class="op">+</span> <span class="st">&quot;_&quot;</span> <span class="op">+</span> date <span class="op">+</span> <span class="st">&quot;_Calp&quot;</span>, cal_pan_1,<span class="st">&quot;p&quot;</span>, cal_pan_2, <span class="st">&quot;_MS_clip.tif&quot;</span></span>
<span id="cb2-16"><a href="processing-orthomosaics.html#cb2-16" tabindex="-1"></a><span class="co"># Get the current document</span></span>
<span id="cb2-17"><a href="processing-orthomosaics.html#cb2-17" tabindex="-1"></a>doc <span class="op">=</span> Metashape.app.document</span>
<span id="cb2-18"><a href="processing-orthomosaics.html#cb2-18" tabindex="-1"></a><span class="co"># Get the current chunk</span></span>
<span id="cb2-19"><a href="processing-orthomosaics.html#cb2-19" tabindex="-1"></a>chunk <span class="op">=</span> doc.chunk</span>
<span id="cb2-20"><a href="processing-orthomosaics.html#cb2-20" tabindex="-1"></a></span>
<span id="cb2-21"><a href="processing-orthomosaics.html#cb2-21" tabindex="-1"></a><span class="co">## Manually check the raster palette values, rebuild ortho if needed</span></span>
<span id="cb2-22"><a href="processing-orthomosaics.html#cb2-22" tabindex="-1"></a><span class="co"># setting raster transform values and disabling transform</span></span>
<span id="cb2-23"><a href="processing-orthomosaics.html#cb2-23" tabindex="-1"></a><span class="co">#  normalize the 16 bit pixel values</span></span>
<span id="cb2-24"><a href="processing-orthomosaics.html#cb2-24" tabindex="-1"></a>chunk.raster_transform.formula <span class="op">=</span> [<span class="st">&quot;B1/32768&quot;</span>, <span class="st">&quot;B2/32768&quot;</span>, <span class="st">&quot;B3/32768&quot;</span>,<span class="st">&quot;B4/32768&quot;</span>, <span class="st">&quot;B5/32768&quot;</span>, <span class="st">&quot;B6/32768&quot;</span>,<span class="st">&quot;B7/32768&quot;</span>, <span class="st">&quot;B8/32768&quot;</span>, <span class="st">&quot;B9/32768&quot;</span>,<span class="st">&quot;B10/32768&quot;</span> ]</span>
<span id="cb2-25"><a href="processing-orthomosaics.html#cb2-25" tabindex="-1"></a>chunk.raster_transform.enabled <span class="op">=</span> <span class="va">False</span></span>
<span id="cb2-26"><a href="processing-orthomosaics.html#cb2-26" tabindex="-1"></a><span class="co">#import the boundary</span></span>
<span id="cb2-27"><a href="processing-orthomosaics.html#cb2-27" tabindex="-1"></a>chunk.importShapes(</span>
<span id="cb2-28"><a href="processing-orthomosaics.html#cb2-28" tabindex="-1"></a>            path<span class="op">=</span> site_perim,</span>
<span id="cb2-29"><a href="processing-orthomosaics.html#cb2-29" tabindex="-1"></a>            boundary_type<span class="op">=</span>Metashape.Shape.OuterBoundary,</span>
<span id="cb2-30"><a href="processing-orthomosaics.html#cb2-30" tabindex="-1"></a>            <span class="bu">format</span><span class="op">=</span>Metashape.ShapesFormat.ShapesFormatSHP)</span>
<span id="cb2-31"><a href="processing-orthomosaics.html#cb2-31" tabindex="-1"></a><span class="co"># setting up the projection</span></span>
<span id="cb2-32"><a href="processing-orthomosaics.html#cb2-32" tabindex="-1"></a>local_crs <span class="op">=</span> Metashape.CoordinateSystem(<span class="st">&quot;EPSG::26910&quot;</span>)</span>
<span id="cb2-33"><a href="processing-orthomosaics.html#cb2-33" tabindex="-1"></a>proj <span class="op">=</span> Metashape.OrthoProjection()</span>
<span id="cb2-34"><a href="processing-orthomosaics.html#cb2-34" tabindex="-1"></a>proj.crs<span class="op">=</span>local_crs</span>
<span id="cb2-35"><a href="processing-orthomosaics.html#cb2-35" tabindex="-1"></a><span class="co"># Export raster with index values, alpha=False, and adjust settings for BigTIFF</span></span>
<span id="cb2-36"><a href="processing-orthomosaics.html#cb2-36" tabindex="-1"></a>compression <span class="op">=</span> Metashape.ImageCompression()</span>
<span id="cb2-37"><a href="processing-orthomosaics.html#cb2-37" tabindex="-1"></a>compression.tiff_big <span class="op">=</span> <span class="va">True</span></span>
<span id="cb2-38"><a href="processing-orthomosaics.html#cb2-38" tabindex="-1"></a><span class="co"># export raster with index values, alpha= false, BigTIFF enabled</span></span>
<span id="cb2-39"><a href="processing-orthomosaics.html#cb2-39" tabindex="-1"></a><span class="co"># warning: this won&#39;t overwrite existing and won&#39;t give warnings that it hasn&#39;t </span></span>
<span id="cb2-40"><a href="processing-orthomosaics.html#cb2-40" tabindex="-1"></a>chunk.exportRaster(ms_ortho_path, raster_transform<span class="op">=</span>Metashape.RasterTransformValue,</span>
<span id="cb2-41"><a href="processing-orthomosaics.html#cb2-41" tabindex="-1"></a>                   image_format<span class="op">=</span>Metashape.ImageFormatTIFF, projection<span class="op">=</span>proj, clip_to_boundary<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb2-42"><a href="processing-orthomosaics.html#cb2-42" tabindex="-1"></a>                   save_alpha<span class="op">=</span><span class="va">False</span>, image_compression<span class="op">=</span>compression)</span>
<span id="cb2-43"><a href="processing-orthomosaics.html#cb2-43" tabindex="-1"></a>doc.save()</span></code></pre></div>
</details>
<p>The following are helpful Agisoft processing references:</p>
<ul>
<li><p><a href="https://www.agisoft.com/downloads/user-manuals/">Agisoft Metashape User Manual: Professional Edition, Version 2.1.</a></p></li>
<li><p><a href="https://pubs.usgs.gov/publication/ofr20211039">USGS_ Processing Coastal Imagery With Agisoft Metashape Professional Edition</a></p></li>
<li><p><a href="https://support.micasense.com/hc/en-us/articles/360002693373-Process-MicaSense-sensor-data-in-Agisoft-Metashape">Micasense - Process MicaSense sensor data in Agisoft Metashape</a></p></li>
<li><p><a href="https://pressbooks.bccampus.ca/ericsaczuk/">Processing Multi-spectral Imagery with Agisoft MetaShape Pro</a></p></li>
</ul>
<p>The knowledge base at Agisoft also has many other useful articles.</p>

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="data-processing-software-and-hardware-costs-and-options.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="georeferencing-plot-trees.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/owaite/GenomeBC_BPG/edit/main/0_Photogrametric_processing.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/owaite/GenomeBC_BPG/blob/main/0_Photogrametric_processing.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"includes": {
"in_header": "analytics.html"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
