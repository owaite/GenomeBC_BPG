<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 9 Crown Delineation | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</title>
  <meta name="description" content="Chapter 9 Crown Delineation | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 9 Crown Delineation | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 9 Crown Delineation | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  
  
  

<meta name="author" content="Jake King*, Olivia Waite, Miriam Isaac-Renton, Nicholas C. Coops, Samuel Grubinger, Liam Irwin, Lise Van Der Merwe, Jon Degner, Alex Liu" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="georeferencing-plot-trees.html"/>
<link rel="next" href="shadow-mask.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Drone Based Phenotyping for Research Trials</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#github-link"><i class="fa fa-check"></i>GitHub link</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-cite-this-report"><i class="fa fa-check"></i>How to cite this report:</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i><b>2</b> Glossary</a></li>
<li class="chapter" data-level="3" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html"><i class="fa fa-check"></i><b>3</b> Range of Sites Assessed</a>
<ul>
<li class="chapter" data-level="3.1" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#jordan-river"><i class="fa fa-check"></i><b>3.1</b> Jordan River</a></li>
<li class="chapter" data-level="3.2" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#powell-river"><i class="fa fa-check"></i><b>3.2</b> Powell River</a></li>
<li class="chapter" data-level="3.3" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#sites"><i class="fa fa-check"></i><b>3.3</b> 2024 Sites</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="preflight-planning.html"><a href="preflight-planning.html"><i class="fa fa-check"></i><b>4</b> Preflight Planning</a>
<ul>
<li class="chapter" data-level="4.1" data-path="preflight-planning.html"><a href="preflight-planning.html#achieving-positional-accuracy-on-multi-temporal-and-multi-sensor-data-collections"><i class="fa fa-check"></i><b>4.1</b> Achieving positional accuracy on multi-temporal and multi-sensor data collections</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="preflight-planning.html"><a href="preflight-planning.html#kinematic-processing-rtkppk"><i class="fa fa-check"></i><b>4.1.1</b> Kinematic processing: RTK/PPK</a></li>
<li class="chapter" data-level="4.1.2" data-path="preflight-planning.html"><a href="preflight-planning.html#ground-control-points-gcp"><i class="fa fa-check"></i><b>4.1.2</b> Ground Control Points (GCP)</a></li>
<li class="chapter" data-level="4.1.3" data-path="preflight-planning.html"><a href="preflight-planning.html#absolute-and-relative-reference-with-precise-point-positioning-ppp"><i class="fa fa-check"></i><b>4.1.3</b> Absolute and Relative Reference with Precise Point Positioning (PPP)</a></li>
<li class="chapter" data-level="4.1.4" data-path="preflight-planning.html"><a href="preflight-planning.html#terrain-following-on-sites-with-elevation-change"><i class="fa fa-check"></i><b>4.1.4</b> Terrain Following on Sites with Elevation Change</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="preflight-planning.html"><a href="preflight-planning.html#site-selection-considerations"><i class="fa fa-check"></i><b>4.2</b> Site Selection Considerations</a></li>
<li class="chapter" data-level="4.3" data-path="preflight-planning.html"><a href="preflight-planning.html#drone-and-sensors-what-will-i-need-to-purchase-and-how-much-will-it-cost"><i class="fa fa-check"></i><b>4.3</b> Drone and Sensors: What will I need to purchase and how much will it cost?</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="preflight-planning.html"><a href="preflight-planning.html#hardware-costs"><i class="fa fa-check"></i><b>4.3.1</b> Hardware Costs</a></li>
<li class="chapter" data-level="4.3.2" data-path="preflight-planning.html"><a href="preflight-planning.html#drone-training-in-canada"><i class="fa fa-check"></i><b>4.3.2</b> Drone Training in Canada</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html"><i class="fa fa-check"></i><b>5</b> Data Collection and Flights</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#hardware---dji-matrice-300-rtk-m300"><i class="fa fa-check"></i><b>5.1</b> Hardware - DJI Matrice 300 RTK (M300)</a></li>
<li class="chapter" data-level="5.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#battery-management"><i class="fa fa-check"></i><b>5.2</b> Battery Management</a></li>
<li class="chapter" data-level="5.3" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#Site-Reconnaissance"><i class="fa fa-check"></i><b>5.3</b> Workflow: Site Reconnaissance</a></li>
<li class="chapter" data-level="5.4" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#data-collection-flight-planning"><i class="fa fa-check"></i><b>5.4</b> Data Collection: Flight Planning</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#flight-planning-theory"><i class="fa fa-check"></i><b>5.4.1</b> Flight planning theory</a></li>
<li class="chapter" data-level="5.4.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#flight-planning-with-dji-pilot"><i class="fa fa-check"></i><b>5.4.2</b> Flight planning with DJI Pilot</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#data-collection-sensors-parameters-and-ideal-conditions"><i class="fa fa-check"></i><b>5.5</b> Data Collection: Sensors, Parameters, and Ideal Conditions</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#micasense-10-band-spectral-sensor-for-vegetative-indices"><i class="fa fa-check"></i><b>5.5.1</b> MicaSense: 10-Band Spectral Sensor for Vegetative Indices</a></li>
<li class="chapter" data-level="5.5.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-p1-high-quality-natural-colour-rgb-imagery"><i class="fa fa-check"></i><b>5.5.2</b> Zenmuse P1: High-Quality Natural-Colour (RGB) Imagery</a></li>
<li class="chapter" data-level="5.5.3" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-l1-lidar-and-rgb"><i class="fa fa-check"></i><b>5.5.3</b> Zenmuse L1: LiDAR and RGB</a></li>
<li class="chapter" data-level="5.5.4" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-h20t-thermal-and-rgb"><i class="fa fa-check"></i><b>5.5.4</b> Zenmuse H20T: Thermal and RGB</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-processing-software-and-hardware-costs-and-options.html"><a href="data-processing-software-and-hardware-costs-and-options.html"><i class="fa fa-check"></i><b>6</b> Data Processing: Software and hardware costs and options</a></li>
<li class="chapter" data-level="7" data-path="processing-orthomosaics.html"><a href="processing-orthomosaics.html"><i class="fa fa-check"></i><b>7</b> Agisoft Photogrammetry pipeline</a>
<ul>
<li class="chapter" data-level="7.1" data-path="processing-orthomosaics.html"><a href="processing-orthomosaics.html#overview"><i class="fa fa-check"></i><b>7.1</b> Overview</a></li>
<li class="chapter" data-level="7.2" data-path="processing-orthomosaics.html"><a href="processing-orthomosaics.html#detailed-workflow"><i class="fa fa-check"></i><b>7.2</b> Detailed Workflow</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="georeferencing-plot-trees.html"><a href="georeferencing-plot-trees.html"><i class="fa fa-check"></i><b>8</b> Georeferencing Plot Trees</a>
<ul>
<li class="chapter" data-level="8.1" data-path="georeferencing-plot-trees.html"><a href="georeferencing-plot-trees.html#Workflow-in-QGIS"><i class="fa fa-check"></i><b>8.1</b> Workflow in QGIS</a></li>
<li class="chapter" data-level="8.2" data-path="georeferencing-plot-trees.html"><a href="georeferencing-plot-trees.html#alternate-workflow-in-r"><i class="fa fa-check"></i><b>8.2</b> Alternate Workflow in R</a></li>
<li class="chapter" data-level="8.3" data-path="georeferencing-plot-trees.html"><a href="georeferencing-plot-trees.html#final-steps-in-qgis"><i class="fa fa-check"></i><b>8.3</b> Final Steps in QGIS</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="crown-delineation.html"><a href="crown-delineation.html"><i class="fa fa-check"></i><b>9</b> Crown Delineation</a>
<ul>
<li class="chapter" data-level="9.1" data-path="crown-delineation.html"><a href="crown-delineation.html#circles-proportional-to-tree-height"><i class="fa fa-check"></i><b>9.1</b> Circles Proportional to Tree Height</a></li>
<li class="chapter" data-level="9.2" data-path="crown-delineation.html"><a href="crown-delineation.html#supercell-raster"><i class="fa fa-check"></i><b>9.2</b> Supercell Raster</a></li>
<li class="chapter" data-level="9.3" data-path="crown-delineation.html"><a href="crown-delineation.html#filter-merge-supercells"><i class="fa fa-check"></i><b>9.3</b> Filter &amp; Merge Supercells</a></li>
<li class="chapter" data-level="9.4" data-path="crown-delineation.html"><a href="crown-delineation.html#manually-edit-crowns"><i class="fa fa-check"></i><b>9.4</b> Manually Edit Crowns</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="shadow-mask.html"><a href="shadow-mask.html"><i class="fa fa-check"></i><b>10</b> Shadow Masks</a></li>
<li class="chapter" data-level="11" data-path="Vegetation-Indicies.html"><a href="Vegetation-Indicies.html"><i class="fa fa-check"></i><b>11</b> Crown-level Vegetation Indicies</a>
<ul>
<li class="chapter" data-level="11.1" data-path="Vegetation-Indicies.html"><a href="Vegetation-Indicies.html#vi-workflow"><i class="fa fa-check"></i><b>11.1</b> VI Workflow</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html"><i class="fa fa-check"></i><b>12</b> LiDAR Processing Workflow</a>
<ul>
<li class="chapter" data-level="12.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#dji-terra"><i class="fa fa-check"></i><b>12.1</b> DJI Terra</a></li>
<li class="chapter" data-level="12.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#register-the-lidar-to-the-dap-point-cloud"><i class="fa fa-check"></i><b>12.2</b> Register the LiDAR to the DAP point cloud</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#prepare-lidar-for-registration"><i class="fa fa-check"></i><b>12.2.1</b> Prepare LiDAR for registration</a></li>
<li class="chapter" data-level="12.2.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#register-lidar-to-dap-cloud-in-cloudcompare"><i class="fa fa-check"></i><b>12.2.2</b> Register LiDAR to DAP cloud in CloudCompare</a></li>
<li class="chapter" data-level="12.2.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#rescale-and-tile-the-registered-lidar"><i class="fa fa-check"></i><b>12.2.3</b> Rescale and tile the registered LiDAR:</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#normalization-and-individual-tree-point-clouds"><i class="fa fa-check"></i><b>12.3</b> Normalization and individual tree point clouds</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#creating-a-dtm-from-the-registered-lidar-tiles"><i class="fa fa-check"></i><b>12.3.1</b> Creating a DTM from the registered LiDAR tiles</a></li>
<li class="chapter" data-level="12.3.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#normalizing-the-tiles-using-the-dtm"><i class="fa fa-check"></i><b>12.3.2</b> Normalizing the tiles using the DTM</a></li>
<li class="chapter" data-level="12.3.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#creating-a-4cm-chm-from-the-max-z-values"><i class="fa fa-check"></i><b>12.3.3</b> Creating a 4cm CHM from the max Z values</a></li>
<li class="chapter" data-level="12.3.4" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#segmenting-tiles"><i class="fa fa-check"></i><b>12.3.4</b> Segmenting tiles</a></li>
<li class="chapter" data-level="12.3.5" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#merging-segmented-tiles-to-create-one-large-point-cloud-containing-the-top-defined-height-of-each-tree"><i class="fa fa-check"></i><b>12.3.5</b> Merging segmented tiles to create one large point cloud containing the top defined height % of each tree</a></li>
<li class="chapter" data-level="12.3.6" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#clipping-the-point-cloud-into-individual-point-clouds-per-tree"><i class="fa fa-check"></i><b>12.3.6</b> Clipping the point cloud into individual point clouds per tree</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#individual-tree-metrics"><i class="fa fa-check"></i><b>12.4</b> Individual Tree Metrics</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html"><i class="fa fa-check"></i><b>13</b> MicaSense Irradiance Correction</a>
<ul>
<li class="chapter" data-level="13.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#background"><i class="fa fa-check"></i><b>13.1</b> Background</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#deriving-horizontal-irradiance"><i class="fa fa-check"></i><b>13.1.1</b> Deriving Horizontal Irradiance</a></li>
<li class="chapter" data-level="13.1.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#calculating-reflectance"><i class="fa fa-check"></i><b>13.1.2</b> Calculating Reflectance</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#the-problem"><i class="fa fa-check"></i><b>13.2</b> The Problem</a></li>
<li class="chapter" data-level="13.3" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#is-correction-needed"><i class="fa fa-check"></i><b>13.3</b> Is Correction Needed?</a>
<ul>
<li class="chapter" data-level="13.3.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#do-the-sun-sensor-angles-make-sense"><i class="fa fa-check"></i><b>13.3.1</b> Do the sun sensor angles make sense?</a></li>
<li class="chapter" data-level="13.3.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#does-the-relationship-between-direct-and-horizontal-irradiance-make-sense"><i class="fa fa-check"></i><b>13.3.2</b> Does the relationship between direct and horizontal irradiance make sense?</a></li>
<li class="chapter" data-level="13.3.3" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#does-the-scattered-direct-ratio-make-sense-for-the-lighting-conditions-of-that-day"><i class="fa fa-check"></i><b>13.3.3</b> Does the scattered: direct ratio make sense for the lighting conditions of that day?</a></li>
</ul></li>
<li class="chapter" data-level="13.4" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#DLS1-correction"><i class="fa fa-check"></i><b>13.4</b> Correcting Irradiance Values for MicaSense Cameras</a>
<ul>
<li class="chapter" data-level="13.4.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#reading-exif-data"><i class="fa fa-check"></i><b>13.4.1</b> Reading Exif Data</a></li>
<li class="chapter" data-level="13.4.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#calculating-solar-zenith-angle"><i class="fa fa-check"></i><b>13.4.2</b> Calculating Solar Zenith Angle</a></li>
<li class="chapter" data-level="13.4.3" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#SSA-correction"><i class="fa fa-check"></i><b>13.4.3</b> Calculating Sun-Sensor Angles</a></li>
<li class="chapter" data-level="13.4.4" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#scattered-direct-ratio-estimate"><i class="fa fa-check"></i><b>13.4.4</b> Scattered: Direct Ratio Estimate</a></li>
<li class="chapter" data-level="13.4.5" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#computing-horizontal-corrected-irradiance"><i class="fa fa-check"></i><b>13.4.5</b> Computing Horizontal (Corrected) Irradiance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="thermal-conversion.html"><a href="thermal-conversion.html"><i class="fa fa-check"></i><b>14</b> Thermal Conversion</a>
<ul>
<li class="chapter" data-level="14.1" data-path="thermal-conversion.html"><a href="thermal-conversion.html#folder-set-up"><i class="fa fa-check"></i><b>14.1</b> Folder Set-Up</a></li>
<li class="chapter" data-level="14.2" data-path="thermal-conversion.html"><a href="thermal-conversion.html#weather-data"><i class="fa fa-check"></i><b>14.2</b> Weather Data</a></li>
<li class="chapter" data-level="14.3" data-path="thermal-conversion.html"><a href="thermal-conversion.html#dji-thermal-sdk-temperature-conversion"><i class="fa fa-check"></i><b>14.3</b> DJI Thermal SDK: temperature conversion</a>
<ul>
<li class="chapter" data-level="14.3.1" data-path="thermal-conversion.html"><a href="thermal-conversion.html#parameters"><i class="fa fa-check"></i><b>14.3.1</b> Parameters</a></li>
<li class="chapter" data-level="14.3.2" data-path="thermal-conversion.html"><a href="thermal-conversion.html#running-the-sdk"><i class="fa fa-check"></i><b>14.3.2</b> Running the SDK</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="thermal-conversion.html"><a href="thermal-conversion.html#convert-to-raster"><i class="fa fa-check"></i><b>14.4</b> Convert to Raster</a></li>
<li class="chapter" data-level="14.5" data-path="thermal-conversion.html"><a href="thermal-conversion.html#examples"><i class="fa fa-check"></i><b>14.5</b> Examples</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="crown-delineation" class="section level1 hasAnchor" number="9">
<h1><span class="header-section-number">Chapter 9</span> Crown Delineation<a href="crown-delineation.html#crown-delineation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p><a href="https://jakubnowosad.com/supercells/">Supercells</a> work to spatially group pixels with similar characteristics making it a great tool for crown delineation. The following workflow shows how to create and filter supercells into delineated crowns and requires:</p>
<ol style="list-style-type: decimal">
<li><p>A shapefile (.shp) with a grid of tree locations derived by georeferencing the census data to the imagery. This will be referred to as the “grid”. Detailed steps for creating the grid can be found in the chapter on <a href="georeferencing-plot-trees.html#georeferencing-plot-trees">georeferencing plot trees</a>.</p></li>
<li><p>Co-registered CHM made from normalized maximum elevation (Z) values, MicaSense orthomosaic, and P1 orthomosaic, ideally from around the same date.</p></li>
</ol>
<p>This workflow goes over:</p>
<ul>
<li><p>Loading in manually edited treetops (i.e. the “grid”) and creating circles proportional to a defined % of the tree’s height.</p></li>
<li><p>Creating a supercell segmentation raster using the CHM and MicaSense and P1 orthomosaics</p></li>
<li><p>Creating delineated crowns by filtering the supercells and merging remaining cells</p></li>
<li><p>Cleaning the delineated crowns</p></li>
</ul>
<p>We then highly suggest the crowns be reviewed and edited where necessary in a GIS to ensure the accuracy of future metrics calculated using the crowns.</p>
<div id="circles-proportional-to-tree-height" class="section level2 hasAnchor" number="9.1">
<h2><span class="header-section-number">9.1</span> Circles Proportional to Tree Height<a href="crown-delineation.html#circles-proportional-to-tree-height" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The following code takes the grid and a registered CHM and creates a circle around each grid point that is proportional to a defined percent of its height. The percent will be dependent on the size and spacing of the plot trees.</p>
<p>In this example we decided to use 10% given the tight spacing and areas of crown closure. We recommend trying a range of percentages and choosing the one that gives proportional circles that contain as much of the visible portion of the crown as possible without also catching neighbouring branches.</p>
<p>Depending on the project, circles proportional to height may serve as adequate tree crowns however, if not, these circles will be used later in this workflow to filter the supercells to create defined crown boundaries.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="crown-delineation.html#cb4-1" tabindex="-1"></a>unique_id <span class="ot">&lt;-</span> <span class="st">&quot;TAG&quot;</span> <span class="co"># change this to the unique ID you have per tree that was used to create the grid</span></span>
<span id="cb4-2"><a href="crown-delineation.html#cb4-2" tabindex="-1"></a>crown_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;path to save crown delineation producst to&quot;</span>)<span class="co"># This was a path to a folder called Crowns for us</span></span>
<span id="cb4-3"><a href="crown-delineation.html#cb4-3" tabindex="-1"></a></span>
<span id="cb4-4"><a href="crown-delineation.html#cb4-4" tabindex="-1"></a>ttops <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&quot;path to your grid&quot;</span>)<span class="co"># read in the treetops as an sp object</span></span>
<span id="cb4-5"><a href="crown-delineation.html#cb4-5" tabindex="-1"></a>ttops<span class="ot">&lt;-</span> ttops<span class="sc">%&gt;%</span></span>
<span id="cb4-6"><a href="crown-delineation.html#cb4-6" tabindex="-1"></a>  <span class="fu">st_centroid</span>()</span>
<span id="cb4-7"><a href="crown-delineation.html#cb4-7" tabindex="-1"></a></span>
<span id="cb4-8"><a href="crown-delineation.html#cb4-8" tabindex="-1"></a><span class="co"># Buffering circles around grid points to get heights for each tree:</span></span>
<span id="cb4-9"><a href="crown-delineation.html#cb4-9" tabindex="-1"></a>buffer_radius <span class="ot">&lt;-</span> <span class="fl">0.1</span>  <span class="co"># buffer radius in meters</span></span>
<span id="cb4-10"><a href="crown-delineation.html#cb4-10" tabindex="-1"></a>ttops_buffered <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(ttops, <span class="at">dist =</span> buffer_radius)<span class="co"># Create a buffer around each centroid with a radius of 10cm (0.1 meters)</span></span>
<span id="cb4-11"><a href="crown-delineation.html#cb4-11" tabindex="-1"></a></span>
<span id="cb4-12"><a href="crown-delineation.html#cb4-12" tabindex="-1"></a><span class="co">#Check geometries, this should be  = 0</span></span>
<span id="cb4-13"><a href="crown-delineation.html#cb4-13" tabindex="-1"></a><span class="fu">sum</span>(<span class="sc">!</span><span class="fu">st_is_valid</span>(ttops_buffered))</span>
<span id="cb4-14"><a href="crown-delineation.html#cb4-14" tabindex="-1"></a></span>
<span id="cb4-15"><a href="crown-delineation.html#cb4-15" tabindex="-1"></a>ttops_buffered <span class="ot">&lt;-</span> ttops_buffered[<span class="sc">!</span><span class="fu">st_is_empty</span>(ttops_buffered), ]</span>
<span id="cb4-16"><a href="crown-delineation.html#cb4-16" tabindex="-1"></a></span>
<span id="cb4-17"><a href="crown-delineation.html#cb4-17" tabindex="-1"></a><span class="co"># Height Quantile from CHM</span></span>
<span id="cb4-18"><a href="crown-delineation.html#cb4-18" tabindex="-1"></a>CHM_L1 <span class="ot">&lt;-</span> <span class="st">&quot;path to CHM&quot;</span> <span class="co">#path to CHM</span></span>
<span id="cb4-19"><a href="crown-delineation.html#cb4-19" tabindex="-1"></a>CHM_max_L1 <span class="ot">&lt;-</span> <span class="fu">rast</span>(CHM_L1) <span class="co">#read in CHM as a raster</span></span>
<span id="cb4-20"><a href="crown-delineation.html#cb4-20" tabindex="-1"></a></span>
<span id="cb4-21"><a href="crown-delineation.html#cb4-21" tabindex="-1"></a>extracted_values <span class="ot">=</span> ttops_buffered <span class="sc">%&gt;%</span> <span class="co">#extract height percentiles</span></span>
<span id="cb4-22"><a href="crown-delineation.html#cb4-22" tabindex="-1"></a>  <span class="fu">exact_extract</span>(<span class="at">x =</span> CHM_max_L1,</span>
<span id="cb4-23"><a href="crown-delineation.html#cb4-23" tabindex="-1"></a>                <span class="at">y =</span> .,</span>
<span id="cb4-24"><a href="crown-delineation.html#cb4-24" tabindex="-1"></a>                <span class="at">fun =</span> <span class="st">&quot;quantile&quot;</span>,</span>
<span id="cb4-25"><a href="crown-delineation.html#cb4-25" tabindex="-1"></a>                <span class="at">quantiles =</span> <span class="fu">c</span>(<span class="fl">0.975</span>, <span class="fl">0.99</span>),</span>
<span id="cb4-26"><a href="crown-delineation.html#cb4-26" tabindex="-1"></a>                <span class="at">force_df =</span> <span class="cn">TRUE</span>,</span>
<span id="cb4-27"><a href="crown-delineation.html#cb4-27" tabindex="-1"></a>                <span class="at">append_cols =</span> <span class="fu">c</span>(unique_id)) </span>
<span id="cb4-28"><a href="crown-delineation.html#cb4-28" tabindex="-1"></a></span>
<span id="cb4-29"><a href="crown-delineation.html#cb4-29" tabindex="-1"></a>ttops_zq99 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(ttops_buffered, extracted_values, <span class="at">by =</span> <span class="fu">c</span>(unique_id)) <span class="co"># Assign the pixel IDs to each polygon</span></span>
<span id="cb4-30"><a href="crown-delineation.html#cb4-30" tabindex="-1"></a></span>
<span id="cb4-31"><a href="crown-delineation.html#cb4-31" tabindex="-1"></a><span class="co"># Saving out shp of buffered points</span></span>
<span id="cb4-32"><a href="crown-delineation.html#cb4-32" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">paste0</span>(crown_dir,<span class="st">&quot;Buffer_radius_ttops_&quot;</span>,buffer_radius))){</span>
<span id="cb4-33"><a href="crown-delineation.html#cb4-33" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">paste0</span>(crown_dir,<span class="st">&quot;Buffer_radius_ttops_&quot;</span>,buffer_radius))</span>
<span id="cb4-34"><a href="crown-delineation.html#cb4-34" tabindex="-1"></a>}</span>
<span id="cb4-35"><a href="crown-delineation.html#cb4-35" tabindex="-1"></a><span class="fu">st_write</span>(ttops_zq99, <span class="fu">paste0</span>(crown_dir,<span class="st">&quot;Buffer_radius_ttops_&quot;</span>,buffer_radius,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,site,<span class="st">&quot;_ttops_&quot;</span>,buffer_radius,<span class="st">&quot;mBuffers_.shp&quot;</span>), <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb4-36"><a href="crown-delineation.html#cb4-36" tabindex="-1"></a></span>
<span id="cb4-37"><a href="crown-delineation.html#cb4-37" tabindex="-1"></a><span class="co"># Proportional hulls based on 10% of the 99th percentile height value</span></span>
<span id="cb4-38"><a href="crown-delineation.html#cb4-38" tabindex="-1"></a>percent <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb4-39"><a href="crown-delineation.html#cb4-39" tabindex="-1"></a>(buffer_dist <span class="ot">&lt;-</span> ttops_zq99<span class="sc">$</span>q99 <span class="sc">*</span> (percent<span class="sc">/</span><span class="dv">100</span>)<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb4-40"><a href="crown-delineation.html#cb4-40" tabindex="-1"></a></span>
<span id="cb4-41"><a href="crown-delineation.html#cb4-41" tabindex="-1"></a>buffer_dist[<span class="fu">is.na</span>(buffer_dist)] <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb4-42"><a href="crown-delineation.html#cb4-42" tabindex="-1"></a></span>
<span id="cb4-43"><a href="crown-delineation.html#cb4-43" tabindex="-1"></a>prop_hulls <span class="ot">&lt;-</span> ttops_zq99<span class="sc">%&gt;%</span></span>
<span id="cb4-44"><a href="crown-delineation.html#cb4-44" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">crs =</span> <span class="dv">26910</span>)<span class="sc">%&gt;%</span> <span class="co">#change to match your CRS</span></span>
<span id="cb4-45"><a href="crown-delineation.html#cb4-45" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="at">dist =</span> buffer_dist)<span class="sc">%&gt;%</span> <span class="co">#value here is the radius</span></span>
<span id="cb4-46"><a href="crown-delineation.html#cb4-46" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">buff =</span> buffer_dist)</span>
<span id="cb4-47"><a href="crown-delineation.html#cb4-47" tabindex="-1"></a></span>
<span id="cb4-48"><a href="crown-delineation.html#cb4-48" tabindex="-1"></a>(prop_hulls<span class="sc">$</span>crownArea <span class="ot">&lt;-</span> <span class="fu">st_area</span>(prop_hulls))</span>
<span id="cb4-49"><a href="crown-delineation.html#cb4-49" tabindex="-1"></a></span>
<span id="cb4-50"><a href="crown-delineation.html#cb4-50" tabindex="-1"></a><span class="co">#Below we remove columns with mainly NAs as they will cause errors for the segmentation raster</span></span>
<span id="cb4-51"><a href="crown-delineation.html#cb4-51" tabindex="-1"></a>prop_hulls_forSEG <span class="ot">&lt;-</span> prop_hulls <span class="sc">%&gt;%</span></span>
<span id="cb4-52"><a href="crown-delineation.html#cb4-52" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(TAG, row, col, q99, q97, crownArea)) <span class="co">#select columns you would like to keep in your crown shapefile, if the columns contain NA values, remove them for the following segmentation steps and re-join the columns at the end</span></span>
<span id="cb4-53"><a href="crown-delineation.html#cb4-53" tabindex="-1"></a></span>
<span id="cb4-54"><a href="crown-delineation.html#cb4-54" tabindex="-1"></a></span>
<span id="cb4-55"><a href="crown-delineation.html#cb4-55" tabindex="-1"></a><span class="fu">st_write</span>(prop_hulls_forSEG, <span class="fu">paste0</span>(crown_dir,<span class="st">&quot;Buffer_radius_ttops_&quot;</span>,buffer_radius,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,site,<span class="st">&quot;_proportional_Hulls_Diam&quot;</span>,percent,<span class="st">&quot;percent_zq99_forSEG_.shp&quot;</span>), <span class="at">append =</span> <span class="cn">FALSE</span>) <span class="co">#Save shapefile of circles proportional to height for each tree</span></span></code></pre></div>
</details>
<p>See Figure <a href="crown-delineation.html#fig:prop-circle-crowns">9.1</a> below for an example of the above output.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:prop-circle-crowns"></span>
<img src="Photos_&_gifs/prop_cirlce_Crowndelin.PNG" alt="A section of the P1 orthomosaic with red circles outlining the circles proprotional to 10% of the 99th height percentile for each plot tree and grid points representing the top of the plot trees shown in blue." width="100%" />
<p class="caption">
Figure 9.1: A section of the P1 orthomosaic with red circles outlining the circles proprotional to 10% of the 99th height percentile for each plot tree and grid points representing the top of the plot trees shown in blue.
</p>
</div>
</div>
<div id="supercell-raster" class="section level2 hasAnchor" number="9.2">
<h2><span class="header-section-number">9.2</span> Supercell Raster<a href="crown-delineation.html#supercell-raster" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To generate supercells, we use a CHM, MicaSense orthomosaic, and a P1 orthomosaic. When possible we provide rasters from the same flight date. However, if that is not feasible we select a CHM, MicaSense, and P1 orthomosaic from flight acquisitions flown as closely together as possible. This ensures that the aerial perspectives of the tree crowns remain highly consistent across the three rasters, facilitating more accurate supercell segmentation.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="crown-delineation.html#cb5-1" tabindex="-1"></a><span class="fu">library</span>(future) </span>
<span id="cb5-2"><a href="crown-delineation.html#cb5-2" tabindex="-1"></a><span class="fu">library</span>(supercells)</span>
<span id="cb5-3"><a href="crown-delineation.html#cb5-3" tabindex="-1"></a><span class="fu">library</span>(RStoolbox)</span>
<span id="cb5-4"><a href="crown-delineation.html#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="crown-delineation.html#cb5-5" tabindex="-1"></a>crown_dir_folder <span class="ot">&lt;-</span> <span class="st">&quot;directory to save files to&quot;</span> <span class="co">#change to match yours</span></span>
<span id="cb5-6"><a href="crown-delineation.html#cb5-6" tabindex="-1"></a>ms_path <span class="ot">&lt;-</span> <span class="st">&quot;path to MicaSense orthomosaic&quot;</span></span>
<span id="cb5-7"><a href="crown-delineation.html#cb5-7" tabindex="-1"></a>p1_path <span class="ot">&lt;-</span> <span class="st">&quot;path to P1&quot;</span></span>
<span id="cb5-8"><a href="crown-delineation.html#cb5-8" tabindex="-1"></a>prop_hulls <span class="ot">&lt;-</span> prop_hulls_forSEG <span class="co">#created in the step above</span></span>
<span id="cb5-9"><a href="crown-delineation.html#cb5-9" tabindex="-1"></a></span>
<span id="cb5-10"><a href="crown-delineation.html#cb5-10" tabindex="-1"></a>Hulls <span class="ot">=</span> prop_hulls</span>
<span id="cb5-11"><a href="crown-delineation.html#cb5-11" tabindex="-1"></a></span>
<span id="cb5-12"><a href="crown-delineation.html#cb5-12" tabindex="-1"></a>bound <span class="ot">=</span> Hulls <span class="sc">%&gt;%</span> <span class="co">#buffer hulls by 5m to get a bounding box to trim rasters with</span></span>
<span id="cb5-13"><a href="crown-delineation.html#cb5-13" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="dv">5</span>)</span>
<span id="cb5-14"><a href="crown-delineation.html#cb5-14" tabindex="-1"></a></span>
<span id="cb5-15"><a href="crown-delineation.html#cb5-15" tabindex="-1"></a><span class="co"># Reading in CHM, MS, and P1 rasters to make supercells</span></span>
<span id="cb5-16"><a href="crown-delineation.html#cb5-16" tabindex="-1"></a>CHM_max_L1 <span class="ot">=</span> <span class="fu">rast</span>(CHM_L1) <span class="sc">%&gt;%</span></span>
<span id="cb5-17"><a href="crown-delineation.html#cb5-17" tabindex="-1"></a>  <span class="fu">crop</span>(bound) <span class="sc">%&gt;%</span></span>
<span id="cb5-18"><a href="crown-delineation.html#cb5-18" tabindex="-1"></a>  <span class="fu">trim</span>()</span>
<span id="cb5-19"><a href="crown-delineation.html#cb5-19" tabindex="-1"></a>ms_ortho <span class="ot">=</span> <span class="fu">rast</span>(ms_path)[[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">6</span>,<span class="dv">9</span>)]] <span class="sc">%&gt;%</span> </span>
<span id="cb5-20"><a href="crown-delineation.html#cb5-20" tabindex="-1"></a>  <span class="fu">resample</span>(CHM_max_L1, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-21"><a href="crown-delineation.html#cb5-21" tabindex="-1"></a>  <span class="fu">crop</span>(bound)<span class="sc">%&gt;%</span></span>
<span id="cb5-22"><a href="crown-delineation.html#cb5-22" tabindex="-1"></a>  trim</span>
<span id="cb5-23"><a href="crown-delineation.html#cb5-23" tabindex="-1"></a>rgb <span class="ot">=</span> <span class="fu">rast</span>(p1_path)[[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb5-24"><a href="crown-delineation.html#cb5-24" tabindex="-1"></a>  <span class="fu">resample</span>(CHM_max_L1,<span class="at">method =</span> <span class="st">&quot;near&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb5-25"><a href="crown-delineation.html#cb5-25" tabindex="-1"></a>  <span class="fu">crop</span>(bound) <span class="sc">%&gt;%</span></span>
<span id="cb5-26"><a href="crown-delineation.html#cb5-26" tabindex="-1"></a>  trim</span>
<span id="cb5-27"><a href="crown-delineation.html#cb5-27" tabindex="-1"></a></span>
<span id="cb5-28"><a href="crown-delineation.html#cb5-28" tabindex="-1"></a><span class="co"># Ensure crs match between rasters prior to stacking</span></span>
<span id="cb5-29"><a href="crown-delineation.html#cb5-29" tabindex="-1"></a><span class="fu">crs</span>(ms_ortho) <span class="ot">&lt;-</span> <span class="fu">crs</span>(CHM_max_L1) </span>
<span id="cb5-30"><a href="crown-delineation.html#cb5-30" tabindex="-1"></a><span class="fu">crs</span>(rgb)<span class="ot">&lt;-</span> <span class="fu">crs</span>(CHM_max_L1) </span>
<span id="cb5-31"><a href="crown-delineation.html#cb5-31" tabindex="-1"></a><span class="fu">crs</span>(CHM_max_L1) <span class="sc">==</span> <span class="fu">crs</span>(ms_ortho)</span>
<span id="cb5-32"><a href="crown-delineation.html#cb5-32" tabindex="-1"></a></span>
<span id="cb5-33"><a href="crown-delineation.html#cb5-33" tabindex="-1"></a>use <span class="ot">=</span> <span class="fu">c</span>( <span class="co"># Creating a SpatRaster, crs must match for this step</span></span>
<span id="cb5-34"><a href="crown-delineation.html#cb5-34" tabindex="-1"></a>  CHM_max_L1,</span>
<span id="cb5-35"><a href="crown-delineation.html#cb5-35" tabindex="-1"></a>  ms_ortho,</span>
<span id="cb5-36"><a href="crown-delineation.html#cb5-36" tabindex="-1"></a>  rgb)</span>
<span id="cb5-37"><a href="crown-delineation.html#cb5-37" tabindex="-1"></a></span>
<span id="cb5-38"><a href="crown-delineation.html#cb5-38" tabindex="-1"></a>use[use <span class="sc">&gt;</span> <span class="dv">60000</span>] <span class="ot">=</span> <span class="cn">NA</span> <span class="co"># Filtering out noisy data</span></span>
<span id="cb5-39"><a href="crown-delineation.html#cb5-39" tabindex="-1"></a></span>
<span id="cb5-40"><a href="crown-delineation.html#cb5-40" tabindex="-1"></a>use2 <span class="ot">=</span> terra<span class="sc">::</span><span class="fu">scale</span>(use)</span>
<span id="cb5-41"><a href="crown-delineation.html#cb5-41" tabindex="-1"></a></span>
<span id="cb5-42"><a href="crown-delineation.html#cb5-42" tabindex="-1"></a><span class="fu">writeRaster</span>(use2, <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;scaled_for_segments.tif&quot;</span>),</span>
<span id="cb5-43"><a href="crown-delineation.html#cb5-43" tabindex="-1"></a>            <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-44"><a href="crown-delineation.html#cb5-44" tabindex="-1"></a></span>
<span id="cb5-45"><a href="crown-delineation.html#cb5-45" tabindex="-1"></a>use3 <span class="ot">=</span> use2 <span class="sc">%&gt;%</span> </span>
<span id="cb5-46"><a href="crown-delineation.html#cb5-46" tabindex="-1"></a>  <span class="fu">ifel</span>(CHM_max_L1 <span class="sc">&lt;</span> .<span class="dv">25</span> , </span>
<span id="cb5-47"><a href="crown-delineation.html#cb5-47" tabindex="-1"></a>       <span class="cn">NA</span>, .)</span>
<span id="cb5-48"><a href="crown-delineation.html#cb5-48" tabindex="-1"></a></span>
<span id="cb5-49"><a href="crown-delineation.html#cb5-49" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> 6L)</span>
<span id="cb5-50"><a href="crown-delineation.html#cb5-50" tabindex="-1"></a></span>
<span id="cb5-51"><a href="crown-delineation.html#cb5-51" tabindex="-1"></a>seg <span class="ot">=</span> <span class="fu">supercells</span>(use3, <span class="at">step =</span> <span class="dv">6</span>, <span class="at">compactness =</span> <span class="dv">5</span>, <span class="at">iter =</span> <span class="dv">50</span>)</span>
<span id="cb5-52"><a href="crown-delineation.html#cb5-52" tabindex="-1"></a></span>
<span id="cb5-53"><a href="crown-delineation.html#cb5-53" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;HULLS&quot;</span>))){ <span class="co">#creating &quot;HULLS&quot; folder to save the below supercell .shp to</span></span>
<span id="cb5-54"><a href="crown-delineation.html#cb5-54" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;HULLS&quot;</span>))</span>
<span id="cb5-55"><a href="crown-delineation.html#cb5-55" tabindex="-1"></a>}</span>
<span id="cb5-56"><a href="crown-delineation.html#cb5-56" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(seg, supercells, geometry), </span>
<span id="cb5-57"><a href="crown-delineation.html#cb5-57" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;HULLS</span><span class="sc">\\</span><span class="st">&quot;</span>,site,<span class="st">&quot;_SEGS_step6_c5.shp&quot;</span>),</span>
<span id="cb5-58"><a href="crown-delineation.html#cb5-58" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb5-59"><a href="crown-delineation.html#cb5-59" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</details>
<p>Figure <a href="crown-delineation.html#fig:seg-parts">9.2</a> shows the supercells (outlined in green) created by the above R code. These outlined areas indicate groups of pixels that the supercell algorithm has deemed similar between the CHM, MicaSense and P1 orthomosaics.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:seg-parts"></span>
<img src="Photos_&_gifs/seg_Crowndelin.PNG" alt="Supercells shown in green, with circles proportional to the 99th height percentile in red and grid points representing plot trees in blue" width="100%" />
<p class="caption">
Figure 9.2: Supercells shown in green, with circles proportional to the 99th height percentile in red and grid points representing plot trees in blue
</p>
</div>
</div>
<div id="filter-merge-supercells" class="section level2 hasAnchor" number="9.3">
<h2><span class="header-section-number">9.3</span> Filter &amp; Merge Supercells<a href="crown-delineation.html#filter-merge-supercells" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Above we found supercells across the site however now we need to filter for supercells that belong to tree crowns only. We do this by using the previously made circles proportional to height where supercells must be within the circle or intersect the perimeter in order to be kept, see Figure <a href="crown-delineation.html#fig:seg-intersection">9.3</a> for a visual. In our case, given that the trees are mature and tightly spaced we are not concerned with capturing lower branches in our crowns as they are not visible due to occlusion and would result in inaccurate spectral and structural metrics. Hence we created circles that were proportional to 10% of the 99th percentile per tree to help refine supercells to areas that were 1) visible from an aerial perspective and 2) had limited overlapping branches with neighbouring trees.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="crown-delineation.html#cb6-1" tabindex="-1"></a><span class="fu">library</span>(smoothr) <span class="co">#for fill_holes</span></span>
<span id="cb6-2"><a href="crown-delineation.html#cb6-2" tabindex="-1"></a><span class="co">#Creating a folder to save files to, this was set up so that multiple tests could be run with different &quot;percent&quot; values </span></span>
<span id="cb6-3"><a href="crown-delineation.html#cb6-3" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99&quot;</span>))){</span>
<span id="cb6-4"><a href="crown-delineation.html#cb6-4" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99&quot;</span>))</span>
<span id="cb6-5"><a href="crown-delineation.html#cb6-5" tabindex="-1"></a>}</span>
<span id="cb6-6"><a href="crown-delineation.html#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="crown-delineation.html#cb6-7" tabindex="-1"></a>chm_dat <span class="ot">=</span> <span class="fu">c</span>(CHM_max_L1)</span>
<span id="cb6-8"><a href="crown-delineation.html#cb6-8" tabindex="-1"></a><span class="fu">names</span>(chm_dat) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;CHM_max_L1&quot;</span>)</span>
<span id="cb6-9"><a href="crown-delineation.html#cb6-9" tabindex="-1"></a></span>
<span id="cb6-10"><a href="crown-delineation.html#cb6-10" tabindex="-1"></a>seg_extract <span class="ot">=</span> seg <span class="sc">%&gt;%</span> </span>
<span id="cb6-11"><a href="crown-delineation.html#cb6-11" tabindex="-1"></a>  <span class="fu">exact_extract</span>(<span class="at">x =</span> chm_dat,</span>
<span id="cb6-12"><a href="crown-delineation.html#cb6-12" tabindex="-1"></a>                <span class="at">y =</span> .,</span>
<span id="cb6-13"><a href="crown-delineation.html#cb6-13" tabindex="-1"></a>                <span class="at">fun =</span> <span class="st">&quot;max&quot;</span>,</span>
<span id="cb6-14"><a href="crown-delineation.html#cb6-14" tabindex="-1"></a>                <span class="at">force_df =</span> <span class="cn">TRUE</span>,</span>
<span id="cb6-15"><a href="crown-delineation.html#cb6-15" tabindex="-1"></a>                <span class="at">append_cols =</span> <span class="fu">c</span>(<span class="st">&quot;supercells&quot;</span>))</span>
<span id="cb6-16"><a href="crown-delineation.html#cb6-16" tabindex="-1"></a></span>
<span id="cb6-17"><a href="crown-delineation.html#cb6-17" tabindex="-1"></a><span class="fu">class</span>(seg_extract)</span>
<span id="cb6-18"><a href="crown-delineation.html#cb6-18" tabindex="-1"></a></span>
<span id="cb6-19"><a href="crown-delineation.html#cb6-19" tabindex="-1"></a>seg1 <span class="ot">=</span> <span class="fu">st_join</span>(seg, prop_hulls_forSEG) <span class="sc">%&gt;%</span> <span class="co">#joins supercells that are within or intersect circles to the circle dataset</span></span>
<span id="cb6-20"><a href="crown-delineation.html#cb6-20" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb6-21"><a href="crown-delineation.html#cb6-21" tabindex="-1"></a>  <span class="fu">left_join</span>(seg_extract, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;supercells&quot;</span>))</span>
<span id="cb6-22"><a href="crown-delineation.html#cb6-22" tabindex="-1"></a></span>
<span id="cb6-23"><a href="crown-delineation.html#cb6-23" tabindex="-1"></a><span class="fu">saveRDS</span>(seg1, <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEG_intersection.rds&quot;</span>))</span>
<span id="cb6-24"><a href="crown-delineation.html#cb6-24" tabindex="-1"></a></span>
<span id="cb6-25"><a href="crown-delineation.html#cb6-25" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg1, </span>
<span id="cb6-26"><a href="crown-delineation.html#cb6-26" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEG_intersection.shp&quot;</span>),</span>
<span id="cb6-27"><a href="crown-delineation.html#cb6-27" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb6-28"><a href="crown-delineation.html#cb6-28" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</details>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:seg-intersection"></span>
<img src="Photos_&_gifs/seg_intersection_Crowndelin.PNG" alt="Supercells (outlined in green) filtered to only retain those that are within or intersect the cirlces propotional to height (red)" width="100%" />
<p class="caption">
Figure 9.3: Supercells (outlined in green) filtered to only retain those that are within or intersect the cirlces propotional to height (red)
</p>
</div>
<p>Below we show an example of further filtering the supercells. First we filter for supercells that overlap areas with a max height greater than a set threshold of 50% of the 99th height percentile using the CHM. This filtering step is mainly if you want to ensure you are only including data from above a certain height percentile in your crowns that was not already removed by the above filtering step using the proportional circles. In this example, no supercells were filtered out from this filter.</p>
<p>We then filter out supercells that are within two proportional circles (a.k.a. in two different crowns). The “supercells” column represents a unique ID for each supercell however in the st_join step above if a supercell intersected more than one proportional circle it will be recorded twice, once for each circle. Hence, we group the supercells by their unique ID (i.e. “supercells” here) and filter out supercells with more than 1 row. For example, in Figure <a href="crown-delineation.html#fig:seg-initial">9.4</a> supercells highlighted in red are those where “count” = 2 ( so intersects two circles) and those highlighted in purple are cells where “count” = 1, we filter to only keep supercells where “count” = 1.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="crown-delineation.html#cb7-1" tabindex="-1"></a>seg2 <span class="ot">=</span> seg1 <span class="sc">%&gt;%</span> </span>
<span id="cb7-2"><a href="crown-delineation.html#cb7-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">z50_L2 =</span> q99 <span class="sc">*</span> .<span class="dv">5</span>) <span class="sc">%&gt;%</span> <span class="co">#filtering out supercells where the CHM value in that super cell as less than 50% of the 99th percentile (~50th height percentile)</span></span>
<span id="cb7-3"><a href="crown-delineation.html#cb7-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TAG_archive =</span> TAG,</span>
<span id="cb7-4"><a href="crown-delineation.html#cb7-4" tabindex="-1"></a>    <span class="at">TAG =</span> <span class="fu">if_else</span>(</span>
<span id="cb7-5"><a href="crown-delineation.html#cb7-5" tabindex="-1"></a>    max <span class="sc">&gt;</span> z50_L2, </span>
<span id="cb7-6"><a href="crown-delineation.html#cb7-6" tabindex="-1"></a>    TAG, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb7-7"><a href="crown-delineation.html#cb7-7" tabindex="-1"></a>  <span class="fu">group_by</span>(supercells) <span class="sc">%&gt;%</span> <span class="co">#group by supercells so you can filter for supercells within two circles</span></span>
<span id="cb7-8"><a href="crown-delineation.html#cb7-8" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span>  <span class="co">#number of rows in each supercell - this value should be 1, if it is two it means that the supercell intersected two circles </span></span>
<span id="cb7-9"><a href="crown-delineation.html#cb7-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TAG =</span> <span class="fu">if_else</span>(count <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="dv">0</span>, TAG))</span>
<span id="cb7-10"><a href="crown-delineation.html#cb7-10" tabindex="-1"></a></span>
<span id="cb7-11"><a href="crown-delineation.html#cb7-11" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg2, </span>
<span id="cb7-12"><a href="crown-delineation.html#cb7-12" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEGS_initial.shp&quot;</span>),</span>
<span id="cb7-13"><a href="crown-delineation.html#cb7-13" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb7-14"><a href="crown-delineation.html#cb7-14" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</details>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:seg-initial"></span>
<img src="Photos_&_gifs/seg_filter_count.PNG" alt="Supercells belonging to one proportional circle (purple) or two proportional circles (red). Those belonging to two proportional circles are highlighted in red and will be removed in the next step." width="100%" />
<p class="caption">
Figure 9.4: Supercells belonging to one proportional circle (purple) or two proportional circles (red). Those belonging to two proportional circles are highlighted in red and will be removed in the next step.
</p>
</div>
<p>Next, we filter for supercells where TAG (the unique tree ID) is not zero, which implements the filtering from the above step. We then create center points, or centroids, for each supercell and filter for supercells with centroids within the proportional crowns. See Figure <a href="crown-delineation.html#fig:seg-keep">9.5</a> for a visual of the supercell centroids that fall within the circles (yellow), boundaries of supercells with centroids that <strong>did not</strong> fall within the circle (green) and those that <strong>did</strong> fall within the circle (orange). This code filters to only keep the supercells outlined in orange.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="crown-delineation.html#cb8-1" tabindex="-1"></a>seg3 <span class="ot">=</span> seg2 <span class="sc">%&gt;%</span> </span>
<span id="cb8-2"><a href="crown-delineation.html#cb8-2" tabindex="-1"></a>  <span class="fu">filter</span>(TAG <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb8-3"><a href="crown-delineation.html#cb8-3" tabindex="-1"></a>  <span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb8-4"><a href="crown-delineation.html#cb8-4" tabindex="-1"></a>  <span class="fu">st_join</span>(<span class="at">y =</span> prop_hulls_forSEG, <span class="at">join =</span> st_within) <span class="sc">%&gt;%</span> </span>
<span id="cb8-5"><a href="crown-delineation.html#cb8-5" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb8-6"><a href="crown-delineation.html#cb8-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(supercells, geometry)</span>
<span id="cb8-7"><a href="crown-delineation.html#cb8-7" tabindex="-1"></a></span>
<span id="cb8-8"><a href="crown-delineation.html#cb8-8" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg3, </span>
<span id="cb8-9"><a href="crown-delineation.html#cb8-9" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEGS_centroids.shp&quot;</span>),</span>
<span id="cb8-10"><a href="crown-delineation.html#cb8-10" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb8-11"><a href="crown-delineation.html#cb8-11" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb8-12"><a href="crown-delineation.html#cb8-12" tabindex="-1"></a></span>
<span id="cb8-13"><a href="crown-delineation.html#cb8-13" tabindex="-1"></a>seg4 <span class="ot">=</span> seg2 <span class="sc">%&gt;%</span> </span>
<span id="cb8-14"><a href="crown-delineation.html#cb8-14" tabindex="-1"></a>  <span class="fu">st_join</span>(seg3) <span class="sc">%&gt;%</span> </span>
<span id="cb8-15"><a href="crown-delineation.html#cb8-15" tabindex="-1"></a>  <span class="fu">drop_na</span>() </span>
<span id="cb8-16"><a href="crown-delineation.html#cb8-16" tabindex="-1"></a></span>
<span id="cb8-17"><a href="crown-delineation.html#cb8-17" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg4, </span>
<span id="cb8-18"><a href="crown-delineation.html#cb8-18" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEGS_keep.shp&quot;</span>),</span>
<span id="cb8-19"><a href="crown-delineation.html#cb8-19" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb8-20"><a href="crown-delineation.html#cb8-20" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</details>
<!--  ```{r seg-centroids, echo=FALSE,fig.align = 'center',out.width="100%", fig.cap= "                 "} -->
<!--  knitr::include_graphics(here("Photos_&_gifs\\seg_centroids_Crowndelin.PNG")) -->
<!--  ``` -->
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:seg-keep"></span>
<img src="Photos_&_gifs/2_seg_keep_outline_Crowndelin.PNG" alt="Filtered supercells (green outline) that do not have a centroid that falls within it's respective proportional circle. Supercells highlighted in orange do have a centorid that falls within it's respective proportional circle, these are the supercells that will be retained and merged to form crowns in the following step." width="100%" />
<p class="caption">
Figure 9.5: Filtered supercells (green outline) that do not have a centroid that falls within it’s respective proportional circle. Supercells highlighted in orange do have a centorid that falls within it’s respective proportional circle, these are the supercells that will be retained and merged to form crowns in the following step.
</p>
</div>
<p>Next we merge the supercells by TAG to create individual tree crowns, as seen in Figure <a href="crown-delineation.html#fig:seg-merge">9.6</a> where the yellow outlines are the outwards boundaries of the merged supercells that form the tree crown.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="crown-delineation.html#cb9-1" tabindex="-1"></a>seg5 <span class="ot">=</span> seg4 <span class="sc">%&gt;%</span> </span>
<span id="cb9-2"><a href="crown-delineation.html#cb9-2" tabindex="-1"></a>  <span class="fu">group_by</span>(TAG) <span class="sc">%&gt;%</span> </span>
<span id="cb9-3"><a href="crown-delineation.html#cb9-3" tabindex="-1"></a>  <span class="fu">summarise</span>()</span>
<span id="cb9-4"><a href="crown-delineation.html#cb9-4" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg5, </span>
<span id="cb9-5"><a href="crown-delineation.html#cb9-5" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEGS_merge.shp&quot;</span>),</span>
<span id="cb9-6"><a href="crown-delineation.html#cb9-6" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb9-7"><a href="crown-delineation.html#cb9-7" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</details>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:seg-merge"></span>
<img src="Photos_&_gifs/seg_merge_Crowndelin.PNG" alt="Retained supercells (orange) merged to form crown boundaries (yellow)." width="100%" />
<p class="caption">
Figure 9.6: Retained supercells (orange) merged to form crown boundaries (yellow).
</p>
</div>
<p>The following two steps help clean the crowns. First, define a threshold value that represents the maximum area of a hole that you would like to fill within the crowns, here we chose 2000cm<span class="math inline">\(^2\)</span>. Figure <a href="crown-delineation.html#fig:seg-merge-smooth">9.7</a> shows the crowns in yellow and the smoothed version of the crowns that have had holes filled in red. As you can see, the crowns are the same. This is because this section of crowns did not contain any holes that required filling.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="crown-delineation.html#cb10-1" tabindex="-1"></a>seg5_smooth <span class="ot">&lt;-</span> seg5 <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="crown-delineation.html#cb10-2" tabindex="-1"></a>  <span class="fu">fill_holes</span>(<span class="at">threshold =</span> units<span class="sc">::</span><span class="fu">set_units</span>(<span class="dv">2000</span>, <span class="st">&quot;cm^2&quot;</span>))</span>
<span id="cb10-3"><a href="crown-delineation.html#cb10-3" tabindex="-1"></a></span>
<span id="cb10-4"><a href="crown-delineation.html#cb10-4" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg5_smooth, </span>
<span id="cb10-5"><a href="crown-delineation.html#cb10-5" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEGS_merge_smooth.shp&quot;</span>),</span>
<span id="cb10-6"><a href="crown-delineation.html#cb10-6" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb10-7"><a href="crown-delineation.html#cb10-7" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</details>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:seg-merge-smooth"></span>
<img src="Photos_&_gifs/seg_merge_smooth_Crowndelin.PNG" alt="Yellow crown boundaries are overlaid on top of crowns that have been edited to remove holes smaller than 2000 cm² (red). In this portion of the plot, no holes were present within the crowns, resulting in no visible differences between the original crowns (yellow) and those that have been refined through hole filling (red)." width="100%" />
<p class="caption">
Figure 9.7: Yellow crown boundaries are overlaid on top of crowns that have been edited to remove holes smaller than 2000 cm² (red). In this portion of the plot, no holes were present within the crowns, resulting in no visible differences between the original crowns (yellow) and those that have been refined through hole filling (red).
</p>
</div>
<p>Next, we cast the crowns as polygons to remove instances of multipolygons associated with the same tree ID. Figure <a href="crown-delineation.html#fig:seg-smooth-np">9.8</a> displays the new polygons, outlined with blue dotted lines. Here we can see an instance of a smaller polygon shown in yellow and red that was originally grouped with the larger crown polygon within the circle, however has been filtered out in this step.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="crown-delineation.html#cb11-1" tabindex="-1"></a>seg5_smooth_NM <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(seg5_smooth, <span class="st">&quot;POLYGON&quot;</span>)</span>
<span id="cb11-2"><a href="crown-delineation.html#cb11-2" tabindex="-1"></a><span class="fu">unique</span>(<span class="fu">st_geometry_type</span>(seg5_smooth_NM)) <span class="co"># CHECK: should only have &quot;Polygon&quot; no more multipolygons</span></span>
<span id="cb11-3"><a href="crown-delineation.html#cb11-3" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg5_smooth_NM, <span class="co">#saving out the crowns for manual editing</span></span>
<span id="cb11-4"><a href="crown-delineation.html#cb11-4" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">HULLS</span><span class="sc">\\</span><span class="st">SEGS_merge_smooth_NoMultipolygon.shp&quot;</span>),</span>
<span id="cb11-5"><a href="crown-delineation.html#cb11-5" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb11-6"><a href="crown-delineation.html#cb11-6" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</details>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:seg-smooth-np"></span>
<img src="Photos_&_gifs/seg_merge_smooth_NMP_Crowndelin.PNG" alt="Blue dotted lines represent crowns that have been converted to polygon class, overlaid on the original crowns in yellow and those with holes removed in red. In the upper center of the figure, a polygon (highlighted in red and yellow) that was initially part of a multipolygon within its proportional circle has been removed during the conversion to polygon in this step." width="100%" />
<p class="caption">
Figure 9.8: Blue dotted lines represent crowns that have been converted to polygon class, overlaid on the original crowns in yellow and those with holes removed in red. In the upper center of the figure, a polygon (highlighted in red and yellow) that was initially part of a multipolygon within its proportional circle has been removed during the conversion to polygon in this step.
</p>
</div>
<p>Lastly, we join the attributes from the original grid that contained information on each tree to the crowns shapefile.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="crown-delineation.html#cb12-1" tabindex="-1"></a>att <span class="ot">&lt;-</span> ttops <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="crown-delineation.html#cb12-2" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()<span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="crown-delineation.html#cb12-3" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(geometry))</span>
<span id="cb12-4"><a href="crown-delineation.html#cb12-4" tabindex="-1"></a></span>
<span id="cb12-5"><a href="crown-delineation.html#cb12-5" tabindex="-1"></a>(seg5_smooth_NM_attributes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(seg5_smooth_NM,att, <span class="at">by =</span> unique_id )) <span class="do">## adding in attributes back</span></span>
<span id="cb12-6"><a href="crown-delineation.html#cb12-6" tabindex="-1"></a></span>
<span id="cb12-7"><a href="crown-delineation.html#cb12-7" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg5_smooth_NM_attributes, </span>
<span id="cb12-8"><a href="crown-delineation.html#cb12-8" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">HULLS</span><span class="sc">\\</span><span class="st">SEGS_merge_smooth_NoMultipolygon_Attributes.shp&quot;</span>),</span>
<span id="cb12-9"><a href="crown-delineation.html#cb12-9" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb12-10"><a href="crown-delineation.html#cb12-10" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</details>
</div>
<div id="manually-edit-crowns" class="section level2 hasAnchor" number="9.4">
<h2><span class="header-section-number">9.4</span> Manually Edit Crowns<a href="crown-delineation.html#manually-edit-crowns" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Figure <a href="crown-delineation.html#fig:crown-seg">9.9</a> is the final shapefile of delineated crowns from the above process. We then highly suggest the crowns be examined in a GIS and edited to remove sections where neighbouring branches intersect the crown to ensure each crown contains only data from the correct tree or to add in missed branches that are above your height cutoff. We recommend also adding a “crown confidence” column, or similar descriptive column, that can be populated throughout this process to mark partially obscured trees or any other instances that would lead to poor data quality down the line. This allows for these potential “problem” trees to be easily highlighted in future analysis. This was the most manually time-consuming process in the whole project.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:crown-seg"></span>
<img src="Photos_&_gifs/seg_crowns_Crowndelin.PNG" alt="Final crowns created using supercells and filtered with circles proportional to the height of each individual tree." width="100%" />
<p class="caption">
Figure 9.9: Final crowns created using supercells and filtered with circles proportional to the height of each individual tree.
</p>
</div>
<!-- ```{r crown-circ, echo=FALSE,fig.align = 'center',out.width="100%", fig.cap= "                 "} -->
<!-- knitr::include_graphics(here("Photos_&_gifs\\seg_crowns_w_propcircles_Crowndelin.PNG")) -->
<!-- ``` -->
<!-- ```{r 2-delin-crowns, echo=FALSE,fig.align = 'center',out.width="60%", fig.cap= "Delineated crowns at Bit Tree Creek with partially obscured plot trees in purple."} -->
<!-- knitr::include_graphics(here("Photos_&_gifs\\crowns.PNG")) -->
<!-- ``` -->

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="georeferencing-plot-trees.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="shadow-mask.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/owaite/GenomeBC_BPG/edit/main/0_Crown_delineation.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/owaite/GenomeBC_BPG/blob/main/0_Crown_delineation.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
},
"includes": {
"in_header": "analytics.html"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
