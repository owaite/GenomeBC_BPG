<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 8 Crown delineation | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</title>
  <meta name="description" content="Chapter 8 Crown delineation | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 8 Crown delineation | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 8 Crown delineation | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  
  
  

<meta name="author" content="Jake King*, Olivia Waite, Miriam Isaac-Renton, Nicholas C. Coops, Samuel Grubinger, Liam Irwin, Lise Van Der Merwe, Jon Degner, Alex Liu" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="Georeferencing-Plot-Trees.html"/>
<link rel="next" href="lidar-processing-workflow.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Drone Based Phenotyping for Research Trials</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#github-link"><i class="fa fa-check"></i>GitHub link</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-cite-this-report"><i class="fa fa-check"></i>How to cite this report:</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="abstract.html"><a href="abstract.html"><i class="fa fa-check"></i><b>1</b> Abstract</a></li>
<li class="chapter" data-level="2" data-path="background-and-basis-of-knowledge.html"><a href="background-and-basis-of-knowledge.html"><i class="fa fa-check"></i><b>2</b> Background and basis of knowledge</a></li>
<li class="chapter" data-level="3" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html"><i class="fa fa-check"></i><b>3</b> Range of Sites Assessed</a>
<ul>
<li class="chapter" data-level="3.1" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#jordan-river"><i class="fa fa-check"></i><b>3.1</b> Jordan River</a></li>
<li class="chapter" data-level="3.2" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#powell-river"><i class="fa fa-check"></i><b>3.2</b> Powell River</a></li>
<li class="chapter" data-level="3.3" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#sites"><i class="fa fa-check"></i><b>3.3</b> 2024 Sites</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="preflight-planning.html"><a href="preflight-planning.html"><i class="fa fa-check"></i><b>4</b> Preflight Planning</a>
<ul>
<li class="chapter" data-level="4.1" data-path="preflight-planning.html"><a href="preflight-planning.html#achieving-positional-accuracy-on-multi-temporal-and-multi-sensor-data-collections"><i class="fa fa-check"></i><b>4.1</b> Achieving positional accuracy on multi-temporal and multi-sensor data collections</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="preflight-planning.html"><a href="preflight-planning.html#kinematic-processing-rtkppk"><i class="fa fa-check"></i><b>4.1.1</b> Kinematic processing: RTK/PPK</a></li>
<li class="chapter" data-level="4.1.2" data-path="preflight-planning.html"><a href="preflight-planning.html#ground-control-points-gcp"><i class="fa fa-check"></i><b>4.1.2</b> Ground Control Points (GCP)</a></li>
<li class="chapter" data-level="4.1.3" data-path="preflight-planning.html"><a href="preflight-planning.html#absolute-and-relative-reference-with-precise-point-positioning-ppp"><i class="fa fa-check"></i><b>4.1.3</b> Absolute and Relative Reference with Precise Point Positioning (PPP)</a></li>
<li class="chapter" data-level="4.1.4" data-path="preflight-planning.html"><a href="preflight-planning.html#terrain-following-on-sites-with-elevation-change"><i class="fa fa-check"></i><b>4.1.4</b> Terrain Following on Sites with Elevation Change</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="preflight-planning.html"><a href="preflight-planning.html#site-selection-considerations"><i class="fa fa-check"></i><b>4.2</b> Site Selection Considerations</a></li>
<li class="chapter" data-level="4.3" data-path="preflight-planning.html"><a href="preflight-planning.html#drone-and-sensors-what-will-i-need-to-purchase-and-how-much-will-it-cost"><i class="fa fa-check"></i><b>4.3</b> Drone and Sensors: What will I need to purchase and how much will it cost?</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="preflight-planning.html"><a href="preflight-planning.html#hardware-costs"><i class="fa fa-check"></i><b>4.3.1</b> Hardware Costs</a></li>
<li class="chapter" data-level="4.3.2" data-path="preflight-planning.html"><a href="preflight-planning.html#drone-training-in-canada"><i class="fa fa-check"></i><b>4.3.2</b> Drone Training in Canada</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html"><i class="fa fa-check"></i><b>5</b> Data Collection and Flights</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#hardware---dji-matrice-3000-rtk-m300"><i class="fa fa-check"></i><b>5.1</b> Hardware - DJI Matrice 3000 RTK (M300)</a></li>
<li class="chapter" data-level="5.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#battery-management"><i class="fa fa-check"></i><b>5.2</b> Battery Management</a></li>
<li class="chapter" data-level="5.3" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#workflow-site-reconnaissance"><i class="fa fa-check"></i><b>5.3</b> Workflow: Site Reconnaissance</a></li>
<li class="chapter" data-level="5.4" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#data-collection-flight-planning"><i class="fa fa-check"></i><b>5.4</b> Data Collection: Flight Planning</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#flight-planning-theory"><i class="fa fa-check"></i><b>5.4.1</b> Flight planning theory</a></li>
<li class="chapter" data-level="5.4.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#flight-planning-with-dji-pilot"><i class="fa fa-check"></i><b>5.4.2</b> Flight planning with DJI Pilot</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#data-collection-sensors-parameters-and-ideal-conditions"><i class="fa fa-check"></i><b>5.5</b> Data Collection: Sensors, Parameters, and Ideal Conditions</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#micasense-10-band-spectral-sensor-for-vegetative-indices"><i class="fa fa-check"></i><b>5.5.1</b> MicaSense: 10-Band Spectral Sensor for Vegetative Indices</a></li>
<li class="chapter" data-level="5.5.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-p1-high-quality-natural-colour-rgb-imagery"><i class="fa fa-check"></i><b>5.5.2</b> Zenmuse P1: High-Quality Natural-Colour (RGB) Imagery</a></li>
<li class="chapter" data-level="5.5.3" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-l1-lidar-and-rgb"><i class="fa fa-check"></i><b>5.5.3</b> Zenmuse L1: LiDAR and RGB</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-processing-photogrammetry-pipeline..html"><a href="data-processing-photogrammetry-pipeline..html"><i class="fa fa-check"></i><b>6</b> Data Processing: Photogrammetry pipeline.</a>
<ul>
<li class="chapter" data-level="6.1" data-path="data-processing-photogrammetry-pipeline..html"><a href="data-processing-photogrammetry-pipeline..html#agisoft-photogrammetry-processing-p1-data-and-registering-multispectral-to-it."><i class="fa fa-check"></i><b>6.1</b> Agisoft Photogrammetry: Processing P1 data and registering multispectral to it.</a>
<ul>
<li class="chapter" data-level="6.1.1" data-path="data-processing-photogrammetry-pipeline..html"><a href="data-processing-photogrammetry-pipeline..html#overview."><i class="fa fa-check"></i><b>6.1.1</b> Overview.</a></li>
<li class="chapter" data-level="6.1.2" data-path="data-processing-photogrammetry-pipeline..html"><a href="data-processing-photogrammetry-pipeline..html#detailed-workflow"><i class="fa fa-check"></i><b>6.1.2</b> Detailed Workflow</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="data-processing-photogrammetry-pipeline..html"><a href="data-processing-photogrammetry-pipeline..html#processing-orthomosaics"><i class="fa fa-check"></i><b>6.2</b> Processing Orthomosaics</a></li>
<li class="chapter" data-level="6.3" data-path="data-processing-photogrammetry-pipeline..html"><a href="data-processing-photogrammetry-pipeline..html#shadow-mask"><i class="fa fa-check"></i><b>6.3</b> Shadow Masks</a></li>
<li class="chapter" data-level="6.4" data-path="data-processing-photogrammetry-pipeline..html"><a href="data-processing-photogrammetry-pipeline..html#crown-level-vegetation-indicies"><i class="fa fa-check"></i><b>6.4</b> Crown-level Vegetation Indicies</a>
<ul>
<li class="chapter" data-level="6.4.1" data-path="data-processing-photogrammetry-pipeline..html"><a href="data-processing-photogrammetry-pipeline..html#vi-workflow"><i class="fa fa-check"></i><b>6.4.1</b> VI Workflow</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Georeferencing-Plot-Trees.html"><a href="Georeferencing-Plot-Trees.html"><i class="fa fa-check"></i><b>7</b> Georeferencing Plot Trees</a></li>
<li class="chapter" data-level="8" data-path="crown-delineation.html"><a href="crown-delineation.html"><i class="fa fa-check"></i><b>8</b> Crown delineation</a>
<ul>
<li class="chapter" data-level="8.1" data-path="crown-delineation.html"><a href="crown-delineation.html#circles-proportional-to-tree-height."><i class="fa fa-check"></i><b>8.1</b> Circles Proportional to Tree Height.</a></li>
<li class="chapter" data-level="8.2" data-path="crown-delineation.html"><a href="crown-delineation.html#supercell-raster"><i class="fa fa-check"></i><b>8.2</b> Supercell Raster</a></li>
<li class="chapter" data-level="8.3" data-path="crown-delineation.html"><a href="crown-delineation.html#filter-merge-supercells"><i class="fa fa-check"></i><b>8.3</b> Filter &amp; Merge Supercells</a></li>
<li class="chapter" data-level="8.4" data-path="crown-delineation.html"><a href="crown-delineation.html#manually-edite-crowns"><i class="fa fa-check"></i><b>8.4</b> Manually Edite Crowns</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html"><i class="fa fa-check"></i><b>9</b> LiDAR Processing Workflow</a>
<ul>
<li class="chapter" data-level="9.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#dji-terra"><i class="fa fa-check"></i><b>9.1</b> DJI Terra</a></li>
<li class="chapter" data-level="9.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#register-the-lidar-to-the-dap-point-cloud"><i class="fa fa-check"></i><b>9.2</b> Register the LiDAR to the DAP point cloud</a>
<ul>
<li class="chapter" data-level="9.2.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#prepare-lidar-for-registration"><i class="fa fa-check"></i><b>9.2.1</b> Prepare LiDAR for registration</a></li>
<li class="chapter" data-level="9.2.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#register-lidar-to-dap-cloud-in-cloudcompare"><i class="fa fa-check"></i><b>9.2.2</b> Register LiDAR to DAP cloud in CloudCompare</a></li>
<li class="chapter" data-level="9.2.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#rescale-and-tile-the-registered-lidar"><i class="fa fa-check"></i><b>9.2.3</b> Rescale and tile the registered LiDAR:</a></li>
</ul></li>
<li class="chapter" data-level="9.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#normalization-and-individual-tree-point-clouds"><i class="fa fa-check"></i><b>9.3</b> Normalization and individual tree point clouds</a>
<ul>
<li class="chapter" data-level="9.3.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#creating-a-dtm-from-the-registered-lidar-tiles"><i class="fa fa-check"></i><b>9.3.1</b> Creating a DTM from the registered LiDAR tiles</a></li>
<li class="chapter" data-level="9.3.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#normalizing-the-tiles-using-the-dtm"><i class="fa fa-check"></i><b>9.3.2</b> Normalizing the tiles using the DTM</a></li>
<li class="chapter" data-level="9.3.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#creating-a-4cm-chm-from-the-max-z-values"><i class="fa fa-check"></i><b>9.3.3</b> Creating a 4cm CHM from the max Z values</a></li>
<li class="chapter" data-level="9.3.4" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#segmenting-tiles"><i class="fa fa-check"></i><b>9.3.4</b> Segmenting tiles</a></li>
<li class="chapter" data-level="9.3.5" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#merging-segmented-tiles-to-create-one-large-point-cloud-containing-the-top-defined-height-of-each-tree"><i class="fa fa-check"></i><b>9.3.5</b> Merging segmented tiles to create one large point cloud containing the top defined height % of each tree</a></li>
<li class="chapter" data-level="9.3.6" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#clipping-the-point-cloud-into-individual-point-clouds-per-tree"><i class="fa fa-check"></i><b>9.3.6</b> Clipping the point cloud into individual point clouds per tree</a></li>
</ul></li>
<li class="chapter" data-level="9.4" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#individual-tree-metrics"><i class="fa fa-check"></i><b>9.4</b> Individual Tree Metrics</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html"><i class="fa fa-check"></i><b>10</b> MicaSense Irradiance Correction</a>
<ul>
<li class="chapter" data-level="10.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#background"><i class="fa fa-check"></i><b>10.1</b> Background</a>
<ul>
<li class="chapter" data-level="10.1.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#deriving-horizontal-irradiance"><i class="fa fa-check"></i><b>10.1.1</b> Deriving Horizontal Irradiance</a></li>
<li class="chapter" data-level="10.1.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#calculating-reflectance"><i class="fa fa-check"></i><b>10.1.2</b> Calculating Reflectance</a></li>
</ul></li>
<li class="chapter" data-level="10.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#the-problem"><i class="fa fa-check"></i><b>10.2</b> The Problem</a></li>
<li class="chapter" data-level="10.3" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#is-correction-needed"><i class="fa fa-check"></i><b>10.3</b> Is Correction Needed?</a>
<ul>
<li class="chapter" data-level="10.3.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#do-the-sun-sensor-angles-make-sense"><i class="fa fa-check"></i><b>10.3.1</b> Do the sun sensor angles make sense?</a></li>
<li class="chapter" data-level="10.3.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#does-the-relationship-between-direct-and-horizontal-irradiance-make-sense"><i class="fa fa-check"></i><b>10.3.2</b> Does the relationship between direct and horizontal irradiance make sense?</a></li>
<li class="chapter" data-level="10.3.3" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#does-the-scattered-direct-ratio-make-sense-for-the-lighting-conditions-of-that-day"><i class="fa fa-check"></i><b>10.3.3</b> Does the scattered: direct ratio make sense for the lighting conditions of that day?</a></li>
</ul></li>
<li class="chapter" data-level="10.4" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#correcting-irradiance-values-for-micasense-cameras"><i class="fa fa-check"></i><b>10.4</b> Correcting Irradiance Values for Micasense Cameras</a>
<ul>
<li class="chapter" data-level="10.4.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#reading-exif-data"><i class="fa fa-check"></i><b>10.4.1</b> Reading Exif Data</a></li>
<li class="chapter" data-level="10.4.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#calculating-solar-zenith-anlge"><i class="fa fa-check"></i><b>10.4.2</b> Calculating Solar Zenith Anlge</a></li>
<li class="chapter" data-level="10.4.3" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#caluclating-sun-sensor-angles"><i class="fa fa-check"></i><b>10.4.3</b> Caluclating Sun-Sensor Angles</a></li>
<li class="chapter" data-level="10.4.4" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#scattereddirect-ratio-estimate"><i class="fa fa-check"></i><b>10.4.4</b> Scattered:Direct Ratio Estimate</a></li>
<li class="chapter" data-level="10.4.5" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#computing-horizontal-corrected-irradiance"><i class="fa fa-check"></i><b>10.4.5</b> Computing Horizontal (Corrected) Irradiance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="11" data-path="thermal-conversion.html"><a href="thermal-conversion.html"><i class="fa fa-check"></i><b>11</b> Thermal Conversion</a>
<ul>
<li class="chapter" data-level="11.1" data-path="thermal-conversion.html"><a href="thermal-conversion.html#folder-set-up"><i class="fa fa-check"></i><b>11.1</b> Folder Set-Up</a></li>
<li class="chapter" data-level="11.2" data-path="thermal-conversion.html"><a href="thermal-conversion.html#weather-data"><i class="fa fa-check"></i><b>11.2</b> Weather Data</a></li>
<li class="chapter" data-level="11.3" data-path="thermal-conversion.html"><a href="thermal-conversion.html#dji-thermal-sdk-temperature-conversion"><i class="fa fa-check"></i><b>11.3</b> DJI Thermal SDK: temperature conversion</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="thermal-conversion.html"><a href="thermal-conversion.html#parameters"><i class="fa fa-check"></i><b>11.3.1</b> Parameters</a></li>
<li class="chapter" data-level="11.3.2" data-path="thermal-conversion.html"><a href="thermal-conversion.html#running-the-sdk"><i class="fa fa-check"></i><b>11.3.2</b> Running the SDK</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="thermal-conversion.html"><a href="thermal-conversion.html#convert-to-raster"><i class="fa fa-check"></i><b>11.4</b> Convert to Raster</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="crown-delineation" class="section level1 hasAnchor" number="8">
<h1><span class="header-section-number">Chapter 8</span> Crown delineation<a href="crown-delineation.html#crown-delineation" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>We are using supercells to create delineated crowns using:</p>
<ol style="list-style-type: decimal">
<li><p>A shapefile (.shp) with a grid of tree locations derived by georeferencing the census data to the imagery. This will be referred to as the “grid”. Detailed steps for creating the grid can be found in chapter <a href="Georeferencing-Plot-Trees.html#Georeferencing-Plot-Trees">7</a>.</p></li>
<li><p>Co-registered CHM made from normalized maximum elevation (Z) values, MicaSense orthomosaic, and P1 orthomosaic, ideally from around the same date.</p></li>
</ol>
<p>The R code contains commented sections where manual editing in a GIS is required. Below steps starting with (R) are steps done in the R code and (GIS) are steps requiring editing in a GIS such as QGIS or ArcGIS. The R code does the following:</p>
<ul>
<li><ol start="18" style="list-style-type: upper-alpha">
<li>The grid treetop points are buffered by 30-40cm, and using the CHM, the grid is snapped to the maximum value within this circle.</li>
</ol></li>
<li><p>(GIS) Check the location of the treetops to the P1 orthomosaic and manual move treetops to align with trees in the P1 orthomosaic where necessary.</p></li>
<li><ol start="18" style="list-style-type: upper-alpha">
<li>Load in manually edited treetops, create circles proportional to tree height.</li>
</ol></li>
<li><ol start="18" style="list-style-type: upper-alpha">
<li>Create a supercell segmentation raster using the CHM and MicaSense and P1 orthomosaics</li>
</ol></li>
<li><ol start="18" style="list-style-type: upper-alpha">
<li>Filter out segments that do not touch any of the circles proportional to tree height</li>
</ol></li>
<li><ol start="18" style="list-style-type: upper-alpha">
<li>Merge remaining segments to create crown polygons</li>
</ol></li>
<li><p>(GIS) Load into a GIS, along with the edited treetops and P1 orthomosaic, and edit the crown polygons to remove sections where neighbouring branches intersect the crown to ensure the crowns contain only data from the correct tree. Obscured trees are given a crown confidence score and can be removed at analysis. This is the most manually time-consuming process in the whole project.</p></li>
</ul>
<p>Once we have a grid that contains a point for every tree we would like to make a crown for we can move onto the next step</p>
<div id="circles-proportional-to-tree-height." class="section level2 hasAnchor" number="8.1">
<h2><span class="header-section-number">8.1</span> Circles Proportional to Tree Height.<a href="crown-delineation.html#circles-proportional-to-tree-height." class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The following code takes the grid and a registered CHM and creates a circle around each grid point that is proportional to a defined percent of its height. The percent will be dependent on the size and spacing of the plot trees.</p>
<p>In this example we decided to use 10% given the tight spacing and areas of crown closure. We recommend trying a range of percentages and choosing the one that gives proportional circles that contain as much of the visible portion of the crown as possible without also catching neighbouring branches.</p>
<p>Depending on the project, circles proportional to height may serve as adequate tree crowns, however if not these circles will be used later in this workflow to filter the supercells for more defined crown boundaries.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="crown-delineation.html#cb17-1" tabindex="-1"></a>unique_id <span class="ot">&lt;-</span> <span class="st">&quot;treeID&quot;</span> <span class="co"># change this to the unique ID you have per tree that was used to create the grid</span></span>
<span id="cb17-2"><a href="crown-delineation.html#cb17-2" tabindex="-1"></a>crown_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;path to save crown delineation producst to&quot;</span>)<span class="co"># This was a path to a folder called Crowns for us</span></span>
<span id="cb17-3"><a href="crown-delineation.html#cb17-3" tabindex="-1"></a></span>
<span id="cb17-4"><a href="crown-delineation.html#cb17-4" tabindex="-1"></a>ttops <span class="ot">&lt;-</span> <span class="fu">st_read</span>(<span class="st">&quot;path to your grid&quot;</span>)<span class="co"># read in the treetops as an sp object</span></span>
<span id="cb17-5"><a href="crown-delineation.html#cb17-5" tabindex="-1"></a>ttops<span class="ot">&lt;-</span> ttops<span class="sc">%&gt;%</span></span>
<span id="cb17-6"><a href="crown-delineation.html#cb17-6" tabindex="-1"></a>  <span class="fu">st_centroid</span>()</span>
<span id="cb17-7"><a href="crown-delineation.html#cb17-7" tabindex="-1"></a></span>
<span id="cb17-8"><a href="crown-delineation.html#cb17-8" tabindex="-1"></a><span class="co"># Buffering circles around grid points to get heights for each tree:</span></span>
<span id="cb17-9"><a href="crown-delineation.html#cb17-9" tabindex="-1"></a>buffer_radius <span class="ot">&lt;-</span> <span class="fl">0.1</span>  <span class="co"># buffer radius in meters</span></span>
<span id="cb17-10"><a href="crown-delineation.html#cb17-10" tabindex="-1"></a>ttops_buffered <span class="ot">&lt;-</span> <span class="fu">st_buffer</span>(ttops, <span class="at">dist =</span> buffer_radius)<span class="co"># Create a buffer around each centroid with a radius of 10cm (0.1 meters)</span></span>
<span id="cb17-11"><a href="crown-delineation.html#cb17-11" tabindex="-1"></a></span>
<span id="cb17-12"><a href="crown-delineation.html#cb17-12" tabindex="-1"></a><span class="co">#Check geometries, this should be  = 0</span></span>
<span id="cb17-13"><a href="crown-delineation.html#cb17-13" tabindex="-1"></a><span class="fu">sum</span>(<span class="sc">!</span><span class="fu">st_is_valid</span>(ttops_buffered))</span>
<span id="cb17-14"><a href="crown-delineation.html#cb17-14" tabindex="-1"></a></span>
<span id="cb17-15"><a href="crown-delineation.html#cb17-15" tabindex="-1"></a>ttops_buffered <span class="ot">&lt;-</span> ttops_buffered[<span class="sc">!</span><span class="fu">st_is_empty</span>(ttops_buffered), ]</span>
<span id="cb17-16"><a href="crown-delineation.html#cb17-16" tabindex="-1"></a></span>
<span id="cb17-17"><a href="crown-delineation.html#cb17-17" tabindex="-1"></a><span class="co"># Height Quantile from CHM</span></span>
<span id="cb17-18"><a href="crown-delineation.html#cb17-18" tabindex="-1"></a>CHM_L1 <span class="ot">&lt;-</span> <span class="st">&quot;path to CHM&quot;</span> <span class="co">#path to CHM</span></span>
<span id="cb17-19"><a href="crown-delineation.html#cb17-19" tabindex="-1"></a>CHM_max_L1 <span class="ot">&lt;-</span> <span class="fu">rast</span>(CHM_L1) <span class="co">#read in CHM as a raster</span></span>
<span id="cb17-20"><a href="crown-delineation.html#cb17-20" tabindex="-1"></a></span>
<span id="cb17-21"><a href="crown-delineation.html#cb17-21" tabindex="-1"></a>extracted_values <span class="ot">=</span> ttops_buffered <span class="sc">%&gt;%</span> <span class="co">#extract height percentiles</span></span>
<span id="cb17-22"><a href="crown-delineation.html#cb17-22" tabindex="-1"></a>  <span class="fu">exact_extract</span>(<span class="at">x =</span> CHM_max_L1,</span>
<span id="cb17-23"><a href="crown-delineation.html#cb17-23" tabindex="-1"></a>                <span class="at">y =</span> .,</span>
<span id="cb17-24"><a href="crown-delineation.html#cb17-24" tabindex="-1"></a>                <span class="at">fun =</span> <span class="st">&quot;quantile&quot;</span>,</span>
<span id="cb17-25"><a href="crown-delineation.html#cb17-25" tabindex="-1"></a>                <span class="at">quantiles =</span> <span class="fu">c</span>(<span class="fl">0.975</span>, <span class="fl">0.99</span>),</span>
<span id="cb17-26"><a href="crown-delineation.html#cb17-26" tabindex="-1"></a>                <span class="at">force_df =</span> <span class="cn">TRUE</span>,</span>
<span id="cb17-27"><a href="crown-delineation.html#cb17-27" tabindex="-1"></a>                <span class="at">append_cols =</span> <span class="fu">c</span>(unique_id)) </span>
<span id="cb17-28"><a href="crown-delineation.html#cb17-28" tabindex="-1"></a></span>
<span id="cb17-29"><a href="crown-delineation.html#cb17-29" tabindex="-1"></a>ttops_zq99 <span class="ot">&lt;-</span> <span class="fu">left_join</span>(ttops_buffered, extracted_values, <span class="at">by =</span> <span class="fu">c</span>(unique_id)) <span class="co"># Assign the pixel IDs to each polygon</span></span>
<span id="cb17-30"><a href="crown-delineation.html#cb17-30" tabindex="-1"></a></span>
<span id="cb17-31"><a href="crown-delineation.html#cb17-31" tabindex="-1"></a><span class="co"># Saving out shp of buffered points</span></span>
<span id="cb17-32"><a href="crown-delineation.html#cb17-32" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">paste0</span>(crown_dir,<span class="st">&quot;Buffer_radius_ttops_&quot;</span>,buffer_radius))){</span>
<span id="cb17-33"><a href="crown-delineation.html#cb17-33" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">paste0</span>(crown_dir,<span class="st">&quot;Buffer_radius_ttops_&quot;</span>,buffer_radius))</span>
<span id="cb17-34"><a href="crown-delineation.html#cb17-34" tabindex="-1"></a>}</span>
<span id="cb17-35"><a href="crown-delineation.html#cb17-35" tabindex="-1"></a><span class="fu">st_write</span>(ttops_zq99, <span class="fu">paste0</span>(crown_dir,<span class="st">&quot;Buffer_radius_ttops_&quot;</span>,buffer_radius,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,site,<span class="st">&quot;_ttops_&quot;</span>,buffer_radius,<span class="st">&quot;mBuffers_.shp&quot;</span>), <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb17-36"><a href="crown-delineation.html#cb17-36" tabindex="-1"></a></span>
<span id="cb17-37"><a href="crown-delineation.html#cb17-37" tabindex="-1"></a><span class="co"># Proportional hulls based on 10% of the 99th percentile height value</span></span>
<span id="cb17-38"><a href="crown-delineation.html#cb17-38" tabindex="-1"></a>percent <span class="ot">&lt;-</span> <span class="dv">10</span></span>
<span id="cb17-39"><a href="crown-delineation.html#cb17-39" tabindex="-1"></a>(buffer_dist <span class="ot">&lt;-</span> ttops_zq99<span class="sc">$</span>q99 <span class="sc">*</span> (percent<span class="sc">/</span><span class="dv">100</span>)<span class="sc">/</span><span class="dv">2</span>)</span>
<span id="cb17-40"><a href="crown-delineation.html#cb17-40" tabindex="-1"></a></span>
<span id="cb17-41"><a href="crown-delineation.html#cb17-41" tabindex="-1"></a>buffer_dist[<span class="fu">is.na</span>(buffer_dist)] <span class="ot">&lt;-</span> <span class="dv">0</span> </span>
<span id="cb17-42"><a href="crown-delineation.html#cb17-42" tabindex="-1"></a></span>
<span id="cb17-43"><a href="crown-delineation.html#cb17-43" tabindex="-1"></a>prop_hulls <span class="ot">&lt;-</span> ttops_zq99<span class="sc">%&gt;%</span></span>
<span id="cb17-44"><a href="crown-delineation.html#cb17-44" tabindex="-1"></a>  <span class="fu">st_as_sf</span>(<span class="at">crs =</span> <span class="dv">26910</span>)<span class="sc">%&gt;%</span> <span class="co">#change to match your CRS</span></span>
<span id="cb17-45"><a href="crown-delineation.html#cb17-45" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="at">dist =</span> buffer_dist)<span class="sc">%&gt;%</span> <span class="co">#value here is the radius</span></span>
<span id="cb17-46"><a href="crown-delineation.html#cb17-46" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">buff =</span> buffer_dist)</span>
<span id="cb17-47"><a href="crown-delineation.html#cb17-47" tabindex="-1"></a></span>
<span id="cb17-48"><a href="crown-delineation.html#cb17-48" tabindex="-1"></a>(prop_hulls<span class="sc">$</span>crownArea <span class="ot">&lt;-</span> <span class="fu">st_area</span>(prop_hulls))</span>
<span id="cb17-49"><a href="crown-delineation.html#cb17-49" tabindex="-1"></a></span>
<span id="cb17-50"><a href="crown-delineation.html#cb17-50" tabindex="-1"></a><span class="co">#Below we remove columns with mainly NAs as they will cause errors for the segmentation raster</span></span>
<span id="cb17-51"><a href="crown-delineation.html#cb17-51" tabindex="-1"></a>prop_hulls_forSEG <span class="ot">&lt;-</span> prop_hulls <span class="sc">%&gt;%</span></span>
<span id="cb17-52"><a href="crown-delineation.html#cb17-52" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(TAG, row, col, q99, q97, crownArea)) <span class="co">#select columns you would like to keep in your crown shapefile, if the columns contain NA values, remove them for the following segmentation steps and re-join the columns at the end</span></span>
<span id="cb17-53"><a href="crown-delineation.html#cb17-53" tabindex="-1"></a></span>
<span id="cb17-54"><a href="crown-delineation.html#cb17-54" tabindex="-1"></a></span>
<span id="cb17-55"><a href="crown-delineation.html#cb17-55" tabindex="-1"></a><span class="fu">st_write</span>(prop_hulls_forSEG, <span class="fu">paste0</span>(crown_dir,<span class="st">&quot;Buffer_radius_ttops_&quot;</span>,buffer_radius,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,site,<span class="st">&quot;_proportional_Hulls_Diam&quot;</span>,percent,<span class="st">&quot;percent_zq99_forSEG_.shp&quot;</span>), <span class="at">append =</span> <span class="cn">FALSE</span>) <span class="co">#Save shapefile of circles proportional to height for each tree</span></span></code></pre></div>
<p>See Figure @(fig:prop-circle-crowns) below for an example of the above output.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:prop-circle-crowns"></span>
<img src="Photos_&_gifs/prop_cirlce_Crowndelin.PNG" alt="Red circles proprotional to height for each plot tree, with grid points representing the top of the plot trees shown in blue. This data has been overlain on a P1 orthomosaic." width="100%" />
<p class="caption">
Figure 8.1: Red circles proprotional to height for each plot tree, with grid points representing the top of the plot trees shown in blue. This data has been overlain on a P1 orthomosaic.
</p>
</div>
</div>
<div id="supercell-raster" class="section level2 hasAnchor" number="8.2">
<h2><span class="header-section-number">8.2</span> Supercell Raster<a href="crown-delineation.html#supercell-raster" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p><a href="https://jakubnowosad.com/supercells/">Supercells</a> work to spatially group pixels with similar characteristics making it a great tool for crown delineation. To generate supercells, we use a Canopy Height Model (CHM), MicaSense orthomosaic, and P1 orthomosaic. When possible we provide rasters from the same flight date. However, if that is not feasible we select a CHM, MicaSense, and P1 orthomosaic from flight acquisitions flown as closely together as possible. This ensures that the aerial perspectives of the tree crowns remain highly consistent across the three rasters, facilitating more accurate supercell segmentation.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="crown-delineation.html#cb18-1" tabindex="-1"></a><span class="fu">library</span>(future) </span>
<span id="cb18-2"><a href="crown-delineation.html#cb18-2" tabindex="-1"></a><span class="fu">library</span>(supercells)</span>
<span id="cb18-3"><a href="crown-delineation.html#cb18-3" tabindex="-1"></a><span class="fu">library</span>(RStoolbox)</span>
<span id="cb18-4"><a href="crown-delineation.html#cb18-4" tabindex="-1"></a></span>
<span id="cb18-5"><a href="crown-delineation.html#cb18-5" tabindex="-1"></a>crown_dir_folder <span class="ot">&lt;-</span> <span class="st">&quot;directory to save files to&quot;</span> <span class="co">#change to match yours</span></span>
<span id="cb18-6"><a href="crown-delineation.html#cb18-6" tabindex="-1"></a>ms_path <span class="ot">&lt;-</span> <span class="st">&quot;path to MicaSense orthomosaic&quot;</span></span>
<span id="cb18-7"><a href="crown-delineation.html#cb18-7" tabindex="-1"></a>p1_path <span class="ot">&lt;-</span> <span class="st">&quot;path to P1&quot;</span></span>
<span id="cb18-8"><a href="crown-delineation.html#cb18-8" tabindex="-1"></a>prop_hulls <span class="ot">&lt;-</span> prop_hulls_forSEG <span class="co">#created in the step above</span></span>
<span id="cb18-9"><a href="crown-delineation.html#cb18-9" tabindex="-1"></a></span>
<span id="cb18-10"><a href="crown-delineation.html#cb18-10" tabindex="-1"></a>Hulls <span class="ot">=</span> prop_hulls</span>
<span id="cb18-11"><a href="crown-delineation.html#cb18-11" tabindex="-1"></a></span>
<span id="cb18-12"><a href="crown-delineation.html#cb18-12" tabindex="-1"></a>bound <span class="ot">=</span> Hulls <span class="sc">%&gt;%</span> <span class="co">#buffer hulls by 5m to get a bounding box to trim rasters with</span></span>
<span id="cb18-13"><a href="crown-delineation.html#cb18-13" tabindex="-1"></a>  <span class="fu">st_buffer</span>(<span class="dv">5</span>)</span>
<span id="cb18-14"><a href="crown-delineation.html#cb18-14" tabindex="-1"></a></span>
<span id="cb18-15"><a href="crown-delineation.html#cb18-15" tabindex="-1"></a><span class="co"># Reading in CHM, MS, and P1 rasters to make supercells</span></span>
<span id="cb18-16"><a href="crown-delineation.html#cb18-16" tabindex="-1"></a>CHM_max_L1 <span class="ot">=</span> <span class="fu">rast</span>(CHM_L1) <span class="sc">%&gt;%</span></span>
<span id="cb18-17"><a href="crown-delineation.html#cb18-17" tabindex="-1"></a>  <span class="fu">crop</span>(bound) <span class="sc">%&gt;%</span></span>
<span id="cb18-18"><a href="crown-delineation.html#cb18-18" tabindex="-1"></a>  <span class="fu">trim</span>()</span>
<span id="cb18-19"><a href="crown-delineation.html#cb18-19" tabindex="-1"></a>ms_ortho <span class="ot">=</span> <span class="fu">rast</span>(ms_path)[[<span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">6</span>,<span class="dv">9</span>)]] <span class="sc">%&gt;%</span> </span>
<span id="cb18-20"><a href="crown-delineation.html#cb18-20" tabindex="-1"></a>  <span class="fu">resample</span>(CHM_max_L1, <span class="at">method =</span> <span class="st">&quot;near&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-21"><a href="crown-delineation.html#cb18-21" tabindex="-1"></a>  <span class="fu">crop</span>(bound)<span class="sc">%&gt;%</span></span>
<span id="cb18-22"><a href="crown-delineation.html#cb18-22" tabindex="-1"></a>  trim</span>
<span id="cb18-23"><a href="crown-delineation.html#cb18-23" tabindex="-1"></a>rgb <span class="ot">=</span> <span class="fu">rast</span>(p1_path)[[<span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>]] <span class="sc">%&gt;%</span> </span>
<span id="cb18-24"><a href="crown-delineation.html#cb18-24" tabindex="-1"></a>  <span class="fu">resample</span>(CHM_max_L1,<span class="at">method =</span> <span class="st">&quot;near&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-25"><a href="crown-delineation.html#cb18-25" tabindex="-1"></a>  <span class="fu">crop</span>(bound) <span class="sc">%&gt;%</span></span>
<span id="cb18-26"><a href="crown-delineation.html#cb18-26" tabindex="-1"></a>  trim</span>
<span id="cb18-27"><a href="crown-delineation.html#cb18-27" tabindex="-1"></a></span>
<span id="cb18-28"><a href="crown-delineation.html#cb18-28" tabindex="-1"></a><span class="co"># Ensure crs match between rasters prior to stacking</span></span>
<span id="cb18-29"><a href="crown-delineation.html#cb18-29" tabindex="-1"></a><span class="fu">crs</span>(ms_ortho) <span class="ot">&lt;-</span> <span class="fu">crs</span>(CHM_max_L1) </span>
<span id="cb18-30"><a href="crown-delineation.html#cb18-30" tabindex="-1"></a><span class="fu">crs</span>(rgb)<span class="ot">&lt;-</span> <span class="fu">crs</span>(CHM_max_L1) </span>
<span id="cb18-31"><a href="crown-delineation.html#cb18-31" tabindex="-1"></a><span class="fu">crs</span>(CHM_max_L1) <span class="sc">==</span> <span class="fu">crs</span>(ms_ortho)</span>
<span id="cb18-32"><a href="crown-delineation.html#cb18-32" tabindex="-1"></a></span>
<span id="cb18-33"><a href="crown-delineation.html#cb18-33" tabindex="-1"></a>use <span class="ot">=</span> <span class="fu">c</span>( <span class="co"># Creating a SpatRaster, crs must match for this step</span></span>
<span id="cb18-34"><a href="crown-delineation.html#cb18-34" tabindex="-1"></a>  CHM_max_L1,</span>
<span id="cb18-35"><a href="crown-delineation.html#cb18-35" tabindex="-1"></a>  ms_ortho,</span>
<span id="cb18-36"><a href="crown-delineation.html#cb18-36" tabindex="-1"></a>  rgb)</span>
<span id="cb18-37"><a href="crown-delineation.html#cb18-37" tabindex="-1"></a></span>
<span id="cb18-38"><a href="crown-delineation.html#cb18-38" tabindex="-1"></a>use[use <span class="sc">&gt;</span> <span class="dv">60000</span>] <span class="ot">=</span> <span class="cn">NA</span> <span class="co"># Filtering out noisy data</span></span>
<span id="cb18-39"><a href="crown-delineation.html#cb18-39" tabindex="-1"></a></span>
<span id="cb18-40"><a href="crown-delineation.html#cb18-40" tabindex="-1"></a>use2 <span class="ot">=</span> terra<span class="sc">::</span><span class="fu">scale</span>(use)</span>
<span id="cb18-41"><a href="crown-delineation.html#cb18-41" tabindex="-1"></a></span>
<span id="cb18-42"><a href="crown-delineation.html#cb18-42" tabindex="-1"></a><span class="fu">writeRaster</span>(use2, <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;scaled_for_segments.tif&quot;</span>),</span>
<span id="cb18-43"><a href="crown-delineation.html#cb18-43" tabindex="-1"></a>            <span class="at">overwrite =</span> <span class="cn">TRUE</span>)</span>
<span id="cb18-44"><a href="crown-delineation.html#cb18-44" tabindex="-1"></a></span>
<span id="cb18-45"><a href="crown-delineation.html#cb18-45" tabindex="-1"></a>use3 <span class="ot">=</span> use2 <span class="sc">%&gt;%</span> </span>
<span id="cb18-46"><a href="crown-delineation.html#cb18-46" tabindex="-1"></a>  <span class="fu">ifel</span>(CHM_max_L1 <span class="sc">&lt;</span> .<span class="dv">25</span> , </span>
<span id="cb18-47"><a href="crown-delineation.html#cb18-47" tabindex="-1"></a>       <span class="cn">NA</span>, .)</span>
<span id="cb18-48"><a href="crown-delineation.html#cb18-48" tabindex="-1"></a></span>
<span id="cb18-49"><a href="crown-delineation.html#cb18-49" tabindex="-1"></a><span class="fu">plan</span>(multisession, <span class="at">workers =</span> 6L)</span>
<span id="cb18-50"><a href="crown-delineation.html#cb18-50" tabindex="-1"></a></span>
<span id="cb18-51"><a href="crown-delineation.html#cb18-51" tabindex="-1"></a>seg <span class="ot">=</span> <span class="fu">supercells</span>(use3, <span class="at">step =</span> <span class="dv">6</span>, <span class="at">compactness =</span> <span class="dv">5</span>, <span class="at">iter =</span> <span class="dv">50</span>)</span>
<span id="cb18-52"><a href="crown-delineation.html#cb18-52" tabindex="-1"></a></span>
<span id="cb18-53"><a href="crown-delineation.html#cb18-53" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;HULLS&quot;</span>))){ <span class="co">#creating &quot;HULLS&quot; folder to save the below supercell .shp to</span></span>
<span id="cb18-54"><a href="crown-delineation.html#cb18-54" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;HULLS&quot;</span>))</span>
<span id="cb18-55"><a href="crown-delineation.html#cb18-55" tabindex="-1"></a>}</span>
<span id="cb18-56"><a href="crown-delineation.html#cb18-56" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> dplyr<span class="sc">::</span><span class="fu">select</span>(seg, supercells, geometry), </span>
<span id="cb18-57"><a href="crown-delineation.html#cb18-57" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;HULLS</span><span class="sc">\\</span><span class="st">&quot;</span>,site,<span class="st">&quot;_SEGS_step6_c5.shp&quot;</span>),</span>
<span id="cb18-58"><a href="crown-delineation.html#cb18-58" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb18-59"><a href="crown-delineation.html#cb18-59" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<p>Figure @(fig:seg-parts) shows the supercells in green created by the above R code. These outlined areas indicate groups of pixels that the supercell algorithm has deemed similar between the CHM, MicaSense and P1 orthomosaics.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:seg-parts"></span>
<img src="Photos_&_gifs/seg_Crowndelin.PNG" alt="Supercells shown in green, with circles proportional to the 99th height percentile in red and grid points representing plot trees in blue" width="100%" />
<p class="caption">
Figure 8.2: Supercells shown in green, with circles proportional to the 99th height percentile in red and grid points representing plot trees in blue
</p>
</div>
</div>
<div id="filter-merge-supercells" class="section level2 hasAnchor" number="8.3">
<h2><span class="header-section-number">8.3</span> Filter &amp; Merge Supercells<a href="crown-delineation.html#filter-merge-supercells" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Above we found supercells across the site however now we need to filter for supercells that belong to tree crowns only. We do this by using the previously made circles proportional to height, where supercells must be within the circle or intersect the perimeter in order to be kept, see Figure @(fig:seg-intersection) for a visual.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="crown-delineation.html#cb19-1" tabindex="-1"></a><span class="fu">library</span>(smoothr) <span class="co">#for fill_holes</span></span>
<span id="cb19-2"><a href="crown-delineation.html#cb19-2" tabindex="-1"></a><span class="co">#Creating a folder to save files to, this was set up so that multiple tests could be run with different &quot;percent&quot; values </span></span>
<span id="cb19-3"><a href="crown-delineation.html#cb19-3" tabindex="-1"></a><span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99&quot;</span>))){</span>
<span id="cb19-4"><a href="crown-delineation.html#cb19-4" tabindex="-1"></a>  <span class="fu">dir.create</span>(<span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99&quot;</span>))</span>
<span id="cb19-5"><a href="crown-delineation.html#cb19-5" tabindex="-1"></a>}</span>
<span id="cb19-6"><a href="crown-delineation.html#cb19-6" tabindex="-1"></a></span>
<span id="cb19-7"><a href="crown-delineation.html#cb19-7" tabindex="-1"></a>chm_dat <span class="ot">=</span> <span class="fu">c</span>(CHM_max_L1)</span>
<span id="cb19-8"><a href="crown-delineation.html#cb19-8" tabindex="-1"></a><span class="fu">names</span>(chm_dat) <span class="ot">=</span> <span class="fu">c</span>(<span class="st">&quot;CHM_max_L1&quot;</span>)</span>
<span id="cb19-9"><a href="crown-delineation.html#cb19-9" tabindex="-1"></a></span>
<span id="cb19-10"><a href="crown-delineation.html#cb19-10" tabindex="-1"></a>seg_extract <span class="ot">=</span> seg <span class="sc">%&gt;%</span> </span>
<span id="cb19-11"><a href="crown-delineation.html#cb19-11" tabindex="-1"></a>  <span class="fu">exact_extract</span>(<span class="at">x =</span> chm_dat,</span>
<span id="cb19-12"><a href="crown-delineation.html#cb19-12" tabindex="-1"></a>                <span class="at">y =</span> .,</span>
<span id="cb19-13"><a href="crown-delineation.html#cb19-13" tabindex="-1"></a>                <span class="at">fun =</span> <span class="st">&quot;max&quot;</span>,</span>
<span id="cb19-14"><a href="crown-delineation.html#cb19-14" tabindex="-1"></a>                <span class="at">force_df =</span> <span class="cn">TRUE</span>,</span>
<span id="cb19-15"><a href="crown-delineation.html#cb19-15" tabindex="-1"></a>                <span class="at">append_cols =</span> <span class="fu">c</span>(<span class="st">&quot;supercells&quot;</span>))</span>
<span id="cb19-16"><a href="crown-delineation.html#cb19-16" tabindex="-1"></a></span>
<span id="cb19-17"><a href="crown-delineation.html#cb19-17" tabindex="-1"></a><span class="fu">class</span>(seg_extract)</span>
<span id="cb19-18"><a href="crown-delineation.html#cb19-18" tabindex="-1"></a></span>
<span id="cb19-19"><a href="crown-delineation.html#cb19-19" tabindex="-1"></a>seg1 <span class="ot">=</span> <span class="fu">st_join</span>(seg, prop_hulls_forSEG) <span class="sc">%&gt;%</span> </span>
<span id="cb19-20"><a href="crown-delineation.html#cb19-20" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb19-21"><a href="crown-delineation.html#cb19-21" tabindex="-1"></a>  <span class="fu">group_by</span>(supercells) <span class="sc">%&gt;%</span> </span>
<span id="cb19-22"><a href="crown-delineation.html#cb19-22" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb19-23"><a href="crown-delineation.html#cb19-23" tabindex="-1"></a>  <span class="fu">left_join</span>(seg_extract, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">&quot;supercells&quot;</span>))</span>
<span id="cb19-24"><a href="crown-delineation.html#cb19-24" tabindex="-1"></a></span>
<span id="cb19-25"><a href="crown-delineation.html#cb19-25" tabindex="-1"></a><span class="fu">saveRDS</span>(seg1, <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEG_intersection.rds&quot;</span>))</span>
<span id="cb19-26"><a href="crown-delineation.html#cb19-26" tabindex="-1"></a></span>
<span id="cb19-27"><a href="crown-delineation.html#cb19-27" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg1, </span>
<span id="cb19-28"><a href="crown-delineation.html#cb19-28" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEG_intersection.shp&quot;</span>),</span>
<span id="cb19-29"><a href="crown-delineation.html#cb19-29" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb19-30"><a href="crown-delineation.html#cb19-30" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="Photos_&_gifs/seg_intersection_Crowndelin.PNG" alt="                 " width="100%" />
<p class="caption">
</p>
</div>
<p>A further filter that can be used is filtering out supercells that overlap areas on the CHM that are under a certain height cutoff per tree. In our case, given that the trees are tightly spaced we are not concerned with capturing lower branches in our crowns as they will likely be either not visible due to occlusion or shadowed by neighbouring trees resulting in the removal of the shadowed pixels within the spectral data anyways. Thus we created circles that were proportional to 10% of the 99th percentile per tree.</p>
<p>Hence further filtering with the 50% of the 99th height percentile, from the below R code, did not result in the removal of any supercells (Figure @(fig:seg-initial)). This filtering step is mainly if you want to ensure you are only includnig data from above a certain height percentile in your crowns that was not already removed by the above filtering step using the proportional circles.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="crown-delineation.html#cb20-1" tabindex="-1"></a>seg2 <span class="ot">=</span> seg1 <span class="sc">%&gt;%</span> </span>
<span id="cb20-2"><a href="crown-delineation.html#cb20-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">z50_L2 =</span> q99 <span class="sc">*</span> .<span class="dv">5</span>) <span class="sc">%&gt;%</span> <span class="co">#filtering out supercells where the CHM value in that super cell as less than 50% of the 99th percentile (~50th height percentile)</span></span>
<span id="cb20-3"><a href="crown-delineation.html#cb20-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TAG_archive =</span> TAG,</span>
<span id="cb20-4"><a href="crown-delineation.html#cb20-4" tabindex="-1"></a>    <span class="at">TAG =</span> <span class="fu">if_else</span>(</span>
<span id="cb20-5"><a href="crown-delineation.html#cb20-5" tabindex="-1"></a>    max <span class="sc">&gt;</span> z50_L2, <span class="co">#&amp;</span></span>
<span id="cb20-6"><a href="crown-delineation.html#cb20-6" tabindex="-1"></a>    <span class="co"># max.CHM_max_L2 &gt; z50_L2,</span></span>
<span id="cb20-7"><a href="crown-delineation.html#cb20-7" tabindex="-1"></a>    TAG, <span class="dv">0</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb20-8"><a href="crown-delineation.html#cb20-8" tabindex="-1"></a>  <span class="fu">group_by</span>(supercells) <span class="sc">%&gt;%</span> </span>
<span id="cb20-9"><a href="crown-delineation.html#cb20-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">count =</span> <span class="fu">n</span>()) <span class="sc">%&gt;%</span> </span>
<span id="cb20-10"><a href="crown-delineation.html#cb20-10" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">TAG =</span> <span class="fu">if_else</span>(count <span class="sc">&gt;</span> <span class="dv">1</span>, <span class="dv">0</span>, TAG))</span>
<span id="cb20-11"><a href="crown-delineation.html#cb20-11" tabindex="-1"></a></span>
<span id="cb20-12"><a href="crown-delineation.html#cb20-12" tabindex="-1"></a></span>
<span id="cb20-13"><a href="crown-delineation.html#cb20-13" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg2, </span>
<span id="cb20-14"><a href="crown-delineation.html#cb20-14" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEGS_initial.shp&quot;</span>),</span>
<span id="cb20-15"><a href="crown-delineation.html#cb20-15" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb20-16"><a href="crown-delineation.html#cb20-16" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb20-17"><a href="crown-delineation.html#cb20-17" tabindex="-1"></a></span>
<span id="cb20-18"><a href="crown-delineation.html#cb20-18" tabindex="-1"></a><span class="fu">dim</span>(seg2)       </span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="Photos_&_gifs/seg_initial_Crowndelin.PNG" alt="                 " width="100%" />
<p class="caption">
</p>
</div>
<div class="figure" style="text-align: center">
<img src="Photos_&_gifs/seg_centroids_Crowndelin.PNG" alt="                 " width="100%" />
<p class="caption">
</p>
</div>
<div class="figure" style="text-align: center">
<img src="Photos_&_gifs/seg_keep_outline_Crowndelin.PNG" alt="                 " width="100%" />
<p class="caption">
</p>
</div>
<div class="figure" style="text-align: center">
<img src="Photos_&_gifs/seg_merge_Crowndelin.PNG" alt="                 " width="100%" />
<p class="caption">
</p>
</div>
<div class="figure" style="text-align: center">
<img src="Photos_&_gifs/seg_merge_smooth_Crowndelin.PNG" alt="                 " width="100%" />
<p class="caption">
</p>
</div>
<div class="figure" style="text-align: center">
<img src="Photos_&_gifs/seg_merge_smooth_NMP_Crowndelin.PNG" alt="                 " width="100%" />
<p class="caption">
</p>
</div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="crown-delineation.html#cb21-1" tabindex="-1"></a>seg3 <span class="ot">=</span> seg2 <span class="sc">%&gt;%</span> </span>
<span id="cb21-2"><a href="crown-delineation.html#cb21-2" tabindex="-1"></a>  <span class="fu">filter</span>(TAG <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb21-3"><a href="crown-delineation.html#cb21-3" tabindex="-1"></a>  <span class="fu">st_centroid</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb21-4"><a href="crown-delineation.html#cb21-4" tabindex="-1"></a>  <span class="fu">st_join</span>(<span class="at">y =</span> prop_hulls_forSEG, <span class="at">join =</span> st_within) <span class="sc">%&gt;%</span> </span>
<span id="cb21-5"><a href="crown-delineation.html#cb21-5" tabindex="-1"></a>  <span class="fu">drop_na</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb21-6"><a href="crown-delineation.html#cb21-6" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(supercells, geometry)</span>
<span id="cb21-7"><a href="crown-delineation.html#cb21-7" tabindex="-1"></a></span>
<span id="cb21-8"><a href="crown-delineation.html#cb21-8" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg3, </span>
<span id="cb21-9"><a href="crown-delineation.html#cb21-9" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEGS_centroids.shp&quot;</span>),</span>
<span id="cb21-10"><a href="crown-delineation.html#cb21-10" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb21-11"><a href="crown-delineation.html#cb21-11" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-12"><a href="crown-delineation.html#cb21-12" tabindex="-1"></a></span>
<span id="cb21-13"><a href="crown-delineation.html#cb21-13" tabindex="-1"></a><span class="fu">plot</span>(seg3)</span>
<span id="cb21-14"><a href="crown-delineation.html#cb21-14" tabindex="-1"></a></span>
<span id="cb21-15"><a href="crown-delineation.html#cb21-15" tabindex="-1"></a>seg4 <span class="ot">=</span> seg2 <span class="sc">%&gt;%</span> </span>
<span id="cb21-16"><a href="crown-delineation.html#cb21-16" tabindex="-1"></a>  <span class="fu">st_join</span>(seg3) <span class="sc">%&gt;%</span> </span>
<span id="cb21-17"><a href="crown-delineation.html#cb21-17" tabindex="-1"></a>  <span class="fu">drop_na</span>() </span>
<span id="cb21-18"><a href="crown-delineation.html#cb21-18" tabindex="-1"></a></span>
<span id="cb21-19"><a href="crown-delineation.html#cb21-19" tabindex="-1"></a>seg5 <span class="ot">=</span> seg4 <span class="sc">%&gt;%</span> </span>
<span id="cb21-20"><a href="crown-delineation.html#cb21-20" tabindex="-1"></a>  <span class="fu">group_by</span>(TAG) <span class="sc">%&gt;%</span> </span>
<span id="cb21-21"><a href="crown-delineation.html#cb21-21" tabindex="-1"></a>  <span class="fu">summarise</span>()</span>
<span id="cb21-22"><a href="crown-delineation.html#cb21-22" tabindex="-1"></a></span>
<span id="cb21-23"><a href="crown-delineation.html#cb21-23" tabindex="-1"></a><span class="fu">plot</span>(seg5)</span>
<span id="cb21-24"><a href="crown-delineation.html#cb21-24" tabindex="-1"></a></span>
<span id="cb21-25"><a href="crown-delineation.html#cb21-25" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg4, </span>
<span id="cb21-26"><a href="crown-delineation.html#cb21-26" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEGS_keep.shp&quot;</span>),</span>
<span id="cb21-27"><a href="crown-delineation.html#cb21-27" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb21-28"><a href="crown-delineation.html#cb21-28" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-29"><a href="crown-delineation.html#cb21-29" tabindex="-1"></a></span>
<span id="cb21-30"><a href="crown-delineation.html#cb21-30" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg5, </span>
<span id="cb21-31"><a href="crown-delineation.html#cb21-31" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEGS_merge.shp&quot;</span>),</span>
<span id="cb21-32"><a href="crown-delineation.html#cb21-32" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb21-33"><a href="crown-delineation.html#cb21-33" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-34"><a href="crown-delineation.html#cb21-34" tabindex="-1"></a></span>
<span id="cb21-35"><a href="crown-delineation.html#cb21-35" tabindex="-1"></a>seg5_smooth <span class="ot">&lt;-</span> seg5 <span class="sc">%&gt;%</span> </span>
<span id="cb21-36"><a href="crown-delineation.html#cb21-36" tabindex="-1"></a>  <span class="fu">fill_holes</span>(<span class="at">threshold =</span> units<span class="sc">::</span><span class="fu">set_units</span>(<span class="dv">2000</span>, <span class="st">&quot;cm^2&quot;</span>))</span>
<span id="cb21-37"><a href="crown-delineation.html#cb21-37" tabindex="-1"></a></span>
<span id="cb21-38"><a href="crown-delineation.html#cb21-38" tabindex="-1"></a><span class="do">## CHECK:</span></span>
<span id="cb21-39"><a href="crown-delineation.html#cb21-39" tabindex="-1"></a><span class="co"># test_tree &lt;- seg5_smooth %&gt;%</span></span>
<span id="cb21-40"><a href="crown-delineation.html#cb21-40" tabindex="-1"></a><span class="co">#   filter(TAG_filtered == 664)</span></span>
<span id="cb21-41"><a href="crown-delineation.html#cb21-41" tabindex="-1"></a><span class="co"># plot(test_tree$geometry, col = &quot;red&quot;)</span></span>
<span id="cb21-42"><a href="crown-delineation.html#cb21-42" tabindex="-1"></a></span>
<span id="cb21-43"><a href="crown-delineation.html#cb21-43" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg5_smooth, </span>
<span id="cb21-44"><a href="crown-delineation.html#cb21-44" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">SEGS_merge_smooth.shp&quot;</span>),</span>
<span id="cb21-45"><a href="crown-delineation.html#cb21-45" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb21-46"><a href="crown-delineation.html#cb21-46" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-47"><a href="crown-delineation.html#cb21-47" tabindex="-1"></a></span>
<span id="cb21-48"><a href="crown-delineation.html#cb21-48" tabindex="-1"></a><span class="fu">unique</span>(<span class="fu">st_geometry_type</span>(seg5_smooth))</span>
<span id="cb21-49"><a href="crown-delineation.html#cb21-49" tabindex="-1"></a></span>
<span id="cb21-50"><a href="crown-delineation.html#cb21-50" tabindex="-1"></a>seg5_smooth_NM <span class="ot">&lt;-</span> <span class="fu">st_cast</span>(seg5_smooth, <span class="st">&quot;POLYGON&quot;</span>)</span>
<span id="cb21-51"><a href="crown-delineation.html#cb21-51" tabindex="-1"></a><span class="co"># </span></span>
<span id="cb21-52"><a href="crown-delineation.html#cb21-52" tabindex="-1"></a><span class="fu">unique</span>(<span class="fu">st_geometry_type</span>(seg5_smooth_NM)) <span class="co"># should only have &quot;Polygon&quot; no more multipolygons</span></span>
<span id="cb21-53"><a href="crown-delineation.html#cb21-53" tabindex="-1"></a></span>
<span id="cb21-54"><a href="crown-delineation.html#cb21-54" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg5_smooth_NM, </span>
<span id="cb21-55"><a href="crown-delineation.html#cb21-55" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">HULLS</span><span class="sc">\\</span><span class="st">SEGS_merge_smooth_NoMultipolygon.shp&quot;</span>),</span>
<span id="cb21-56"><a href="crown-delineation.html#cb21-56" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb21-57"><a href="crown-delineation.html#cb21-57" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span>
<span id="cb21-58"><a href="crown-delineation.html#cb21-58" tabindex="-1"></a></span>
<span id="cb21-59"><a href="crown-delineation.html#cb21-59" tabindex="-1"></a><span class="do">## adding in attributes back</span></span>
<span id="cb21-60"><a href="crown-delineation.html#cb21-60" tabindex="-1"></a>att <span class="ot">&lt;-</span> ttops <span class="sc">%&gt;%</span></span>
<span id="cb21-61"><a href="crown-delineation.html#cb21-61" tabindex="-1"></a>  <span class="fu">as.data.frame</span>()<span class="sc">%&gt;%</span></span>
<span id="cb21-62"><a href="crown-delineation.html#cb21-62" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="sc">-</span><span class="fu">c</span>(geometry))</span>
<span id="cb21-63"><a href="crown-delineation.html#cb21-63" tabindex="-1"></a></span>
<span id="cb21-64"><a href="crown-delineation.html#cb21-64" tabindex="-1"></a>(seg5_smooth_NM_attributes <span class="ot">&lt;-</span> <span class="fu">left_join</span>(seg5_smooth_NM,att, <span class="at">by =</span> unique_id ))</span>
<span id="cb21-65"><a href="crown-delineation.html#cb21-65" tabindex="-1"></a></span>
<span id="cb21-66"><a href="crown-delineation.html#cb21-66" tabindex="-1"></a><span class="fu">st_write</span>(<span class="at">obj =</span> seg5_smooth_NM_attributes, </span>
<span id="cb21-67"><a href="crown-delineation.html#cb21-67" tabindex="-1"></a>         <span class="at">dsn =</span> <span class="fu">paste0</span>(crown_dir_folder,<span class="st">&quot;Prop_Diameter&quot;</span>,percent,<span class="st">&quot;%OfZq99</span><span class="sc">\\</span><span class="st">HULLS</span><span class="sc">\\</span><span class="st">SEGS_merge_smooth_NoMultipolygon_Attributes.shp&quot;</span>),</span>
<span id="cb21-68"><a href="crown-delineation.html#cb21-68" tabindex="-1"></a>         <span class="at">driver =</span> <span class="st">&quot;ESRI Shapefile&quot;</span>,</span>
<span id="cb21-69"><a href="crown-delineation.html#cb21-69" tabindex="-1"></a>         <span class="at">append =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
<div id="manually-edite-crowns" class="section level2 hasAnchor" number="8.4">
<h2><span class="header-section-number">8.4</span> Manually Edite Crowns<a href="crown-delineation.html#manually-edite-crowns" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div class="figure" style="text-align: center">
<img src="Photos_&_gifs/seg_crowns_Crowndelin.PNG" alt="                 " width="100%" />
<p class="caption">
</p>
</div>
<div class="figure" style="text-align: center">
<img src="Photos_&_gifs/seg_crowns_w_propcircles_Crowndelin.PNG" alt="                 " width="100%" />
<p class="caption">
</p>
</div>
<!-- ```{r 2-delin-crowns, echo=FALSE,fig.align = 'center',out.width="60%", fig.cap= "Delineated crowns at Bit Tree Creek with partially obscured plot trees in purple."} -->
<!-- knitr::include_graphics(here("Photos_&_gifs\\crowns.PNG")) -->
<!-- ``` -->

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="Georeferencing-Plot-Trees.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="lidar-processing-workflow.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/owaite/GenomeBC_BPG/edit/main/0_Crown_delineation.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/owaite/GenomeBC_BPG/blob/main/0_Crown_delineation.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
