<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 14 Thermal Conversion | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</title>
  <meta name="description" content="Chapter 14 Thermal Conversion | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  <meta name="generator" content="bookdown 0.41 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 14 Thermal Conversion | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 14 Thermal Conversion | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  
  
  

<meta name="author" content="Jake King*, Olivia Waite, Miriam Isaac-Renton, Nicholas C. Coops, Samuel Grubinger, Liam Irwin, Lise Van Der Merwe, Jon Degner, Alex Liu" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="micasense-irradiance-correction.html"/>

<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Drone Based Phenotyping for Research Trials</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#github-link"><i class="fa fa-check"></i>GitHub link</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-cite-this-report"><i class="fa fa-check"></i>How to cite this report:</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="introduction.html"><a href="introduction.html"><i class="fa fa-check"></i><b>1</b> Introduction</a></li>
<li class="chapter" data-level="2" data-path="glossary.html"><a href="glossary.html"><i class="fa fa-check"></i><b>2</b> Glossary</a></li>
<li class="chapter" data-level="3" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html"><i class="fa fa-check"></i><b>3</b> Range of Sites Assessed</a>
<ul>
<li class="chapter" data-level="3.1" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#jordan-river"><i class="fa fa-check"></i><b>3.1</b> Jordan River</a></li>
<li class="chapter" data-level="3.2" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#powell-river"><i class="fa fa-check"></i><b>3.2</b> Powell River</a></li>
<li class="chapter" data-level="3.3" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#sites"><i class="fa fa-check"></i><b>3.3</b> 2024 Sites</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="preflight-planning.html"><a href="preflight-planning.html"><i class="fa fa-check"></i><b>4</b> Preflight Planning</a>
<ul>
<li class="chapter" data-level="4.1" data-path="preflight-planning.html"><a href="preflight-planning.html#achieving-positional-accuracy-on-multi-temporal-and-multi-sensor-data-collections"><i class="fa fa-check"></i><b>4.1</b> Achieving positional accuracy on multi-temporal and multi-sensor data collections</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="preflight-planning.html"><a href="preflight-planning.html#kinematic-processing-rtkppk"><i class="fa fa-check"></i><b>4.1.1</b> Kinematic processing: RTK/PPK</a></li>
<li class="chapter" data-level="4.1.2" data-path="preflight-planning.html"><a href="preflight-planning.html#ground-control-points-gcp"><i class="fa fa-check"></i><b>4.1.2</b> Ground Control Points (GCP)</a></li>
<li class="chapter" data-level="4.1.3" data-path="preflight-planning.html"><a href="preflight-planning.html#absolute-and-relative-reference-with-precise-point-positioning-ppp"><i class="fa fa-check"></i><b>4.1.3</b> Absolute and Relative Reference with Precise Point Positioning (PPP)</a></li>
<li class="chapter" data-level="4.1.4" data-path="preflight-planning.html"><a href="preflight-planning.html#terrain-following-on-sites-with-elevation-change"><i class="fa fa-check"></i><b>4.1.4</b> Terrain Following on Sites with Elevation Change</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="preflight-planning.html"><a href="preflight-planning.html#site-selection-considerations"><i class="fa fa-check"></i><b>4.2</b> Site Selection Considerations</a></li>
<li class="chapter" data-level="4.3" data-path="preflight-planning.html"><a href="preflight-planning.html#drone-and-sensors-what-will-i-need-to-purchase-and-how-much-will-it-cost"><i class="fa fa-check"></i><b>4.3</b> Drone and Sensors: What will I need to purchase and how much will it cost?</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="preflight-planning.html"><a href="preflight-planning.html#hardware-costs"><i class="fa fa-check"></i><b>4.3.1</b> Hardware Costs</a></li>
<li class="chapter" data-level="4.3.2" data-path="preflight-planning.html"><a href="preflight-planning.html#drone-training-in-canada"><i class="fa fa-check"></i><b>4.3.2</b> Drone Training in Canada</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html"><i class="fa fa-check"></i><b>5</b> Data Collection and Flights</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#hardware---dji-matrice-300-rtk-m300"><i class="fa fa-check"></i><b>5.1</b> Hardware - DJI Matrice 300 RTK (M300)</a></li>
<li class="chapter" data-level="5.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#battery-management"><i class="fa fa-check"></i><b>5.2</b> Battery Management</a></li>
<li class="chapter" data-level="5.3" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#Site-Reconnaissance"><i class="fa fa-check"></i><b>5.3</b> Workflow: Site Reconnaissance</a></li>
<li class="chapter" data-level="5.4" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#data-collection-flight-planning"><i class="fa fa-check"></i><b>5.4</b> Data Collection: Flight Planning</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#flight-planning-theory"><i class="fa fa-check"></i><b>5.4.1</b> Flight planning theory</a></li>
<li class="chapter" data-level="5.4.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#flight-planning-with-dji-pilot"><i class="fa fa-check"></i><b>5.4.2</b> Flight planning with DJI Pilot</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#data-collection-sensors-parameters-and-ideal-conditions"><i class="fa fa-check"></i><b>5.5</b> Data Collection: Sensors, Parameters, and Ideal Conditions</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#micasense-10-band-spectral-sensor-for-vegetative-indices"><i class="fa fa-check"></i><b>5.5.1</b> MicaSense: 10-Band Spectral Sensor for Vegetative Indices</a></li>
<li class="chapter" data-level="5.5.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-p1-high-quality-natural-colour-rgb-imagery"><i class="fa fa-check"></i><b>5.5.2</b> Zenmuse P1: High-Quality Natural-Colour (RGB) Imagery</a></li>
<li class="chapter" data-level="5.5.3" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-l1-lidar-and-rgb"><i class="fa fa-check"></i><b>5.5.3</b> Zenmuse L1: LiDAR and RGB</a></li>
<li class="chapter" data-level="5.5.4" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-h20t-thermal-and-rgb"><i class="fa fa-check"></i><b>5.5.4</b> Zenmuse H20T: Thermal and RGB</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="data-processing-software-and-hardware-costs-and-options.html"><a href="data-processing-software-and-hardware-costs-and-options.html"><i class="fa fa-check"></i><b>6</b> Data Processing: Software and hardware costs and options</a></li>
<li class="chapter" data-level="7" data-path="processing-orthomosaics.html"><a href="processing-orthomosaics.html"><i class="fa fa-check"></i><b>7</b> Agisoft Photogrammetry pipeline</a>
<ul>
<li class="chapter" data-level="7.1" data-path="processing-orthomosaics.html"><a href="processing-orthomosaics.html#overview"><i class="fa fa-check"></i><b>7.1</b> Overview</a></li>
<li class="chapter" data-level="7.2" data-path="processing-orthomosaics.html"><a href="processing-orthomosaics.html#detailed-workflow"><i class="fa fa-check"></i><b>7.2</b> Detailed Workflow</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="georeferencing-plot-trees.html"><a href="georeferencing-plot-trees.html"><i class="fa fa-check"></i><b>8</b> Georeferencing Plot Trees</a>
<ul>
<li class="chapter" data-level="8.1" data-path="georeferencing-plot-trees.html"><a href="georeferencing-plot-trees.html#Workflow-in-QGIS"><i class="fa fa-check"></i><b>8.1</b> Workflow in QGIS</a></li>
<li class="chapter" data-level="8.2" data-path="georeferencing-plot-trees.html"><a href="georeferencing-plot-trees.html#alternate-workflow-in-r"><i class="fa fa-check"></i><b>8.2</b> Alternate Workflow in R</a></li>
<li class="chapter" data-level="8.3" data-path="georeferencing-plot-trees.html"><a href="georeferencing-plot-trees.html#final-steps-in-qgis"><i class="fa fa-check"></i><b>8.3</b> Final Steps in QGIS</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="crown-delineation.html"><a href="crown-delineation.html"><i class="fa fa-check"></i><b>9</b> Crown Delineation</a>
<ul>
<li class="chapter" data-level="9.1" data-path="crown-delineation.html"><a href="crown-delineation.html#circles-proportional-to-tree-height"><i class="fa fa-check"></i><b>9.1</b> Circles Proportional to Tree Height</a></li>
<li class="chapter" data-level="9.2" data-path="crown-delineation.html"><a href="crown-delineation.html#supercell-raster"><i class="fa fa-check"></i><b>9.2</b> Supercell Raster</a></li>
<li class="chapter" data-level="9.3" data-path="crown-delineation.html"><a href="crown-delineation.html#filter-merge-supercells"><i class="fa fa-check"></i><b>9.3</b> Filter &amp; Merge Supercells</a></li>
<li class="chapter" data-level="9.4" data-path="crown-delineation.html"><a href="crown-delineation.html#manually-edit-crowns"><i class="fa fa-check"></i><b>9.4</b> Manually Edit Crowns</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="shadow-mask.html"><a href="shadow-mask.html"><i class="fa fa-check"></i><b>10</b> Shadow Masks</a></li>
<li class="chapter" data-level="11" data-path="Vegetation-Indicies.html"><a href="Vegetation-Indicies.html"><i class="fa fa-check"></i><b>11</b> Crown-level Vegetation Indicies</a>
<ul>
<li class="chapter" data-level="11.1" data-path="Vegetation-Indicies.html"><a href="Vegetation-Indicies.html#vi-workflow"><i class="fa fa-check"></i><b>11.1</b> VI Workflow</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html"><i class="fa fa-check"></i><b>12</b> LiDAR Processing Workflow</a>
<ul>
<li class="chapter" data-level="12.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#dji-terra"><i class="fa fa-check"></i><b>12.1</b> DJI Terra</a></li>
<li class="chapter" data-level="12.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#register-the-lidar-to-the-dap-point-cloud"><i class="fa fa-check"></i><b>12.2</b> Register the LiDAR to the DAP point cloud</a>
<ul>
<li class="chapter" data-level="12.2.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#prepare-lidar-for-registration"><i class="fa fa-check"></i><b>12.2.1</b> Prepare LiDAR for registration</a></li>
<li class="chapter" data-level="12.2.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#register-lidar-to-dap-cloud-in-cloudcompare"><i class="fa fa-check"></i><b>12.2.2</b> Register LiDAR to DAP cloud in CloudCompare</a></li>
<li class="chapter" data-level="12.2.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#rescale-and-tile-the-registered-lidar"><i class="fa fa-check"></i><b>12.2.3</b> Rescale and tile the registered LiDAR:</a></li>
</ul></li>
<li class="chapter" data-level="12.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#normalization-and-individual-tree-point-clouds"><i class="fa fa-check"></i><b>12.3</b> Normalization and individual tree point clouds</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#creating-a-dtm-from-the-registered-lidar-tiles"><i class="fa fa-check"></i><b>12.3.1</b> Creating a DTM from the registered LiDAR tiles</a></li>
<li class="chapter" data-level="12.3.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#normalizing-the-tiles-using-the-dtm"><i class="fa fa-check"></i><b>12.3.2</b> Normalizing the tiles using the DTM</a></li>
<li class="chapter" data-level="12.3.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#creating-a-4cm-chm-from-the-max-z-values"><i class="fa fa-check"></i><b>12.3.3</b> Creating a 4cm CHM from the max Z values</a></li>
<li class="chapter" data-level="12.3.4" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#segmenting-tiles"><i class="fa fa-check"></i><b>12.3.4</b> Segmenting tiles</a></li>
<li class="chapter" data-level="12.3.5" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#merging-segmented-tiles-to-create-one-large-point-cloud-containing-the-top-defined-height-of-each-tree"><i class="fa fa-check"></i><b>12.3.5</b> Merging segmented tiles to create one large point cloud containing the top defined height % of each tree</a></li>
<li class="chapter" data-level="12.3.6" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#clipping-the-point-cloud-into-individual-point-clouds-per-tree"><i class="fa fa-check"></i><b>12.3.6</b> Clipping the point cloud into individual point clouds per tree</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#individual-tree-metrics"><i class="fa fa-check"></i><b>12.4</b> Individual Tree Metrics</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html"><i class="fa fa-check"></i><b>13</b> MicaSense Irradiance Correction</a>
<ul>
<li class="chapter" data-level="13.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#background"><i class="fa fa-check"></i><b>13.1</b> Background</a>
<ul>
<li class="chapter" data-level="13.1.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#deriving-horizontal-irradiance"><i class="fa fa-check"></i><b>13.1.1</b> Deriving Horizontal Irradiance</a></li>
<li class="chapter" data-level="13.1.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#calculating-reflectance"><i class="fa fa-check"></i><b>13.1.2</b> Calculating Reflectance</a></li>
</ul></li>
<li class="chapter" data-level="13.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#the-problem"><i class="fa fa-check"></i><b>13.2</b> The Problem</a></li>
<li class="chapter" data-level="13.3" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#is-correction-needed"><i class="fa fa-check"></i><b>13.3</b> Is Correction Needed?</a>
<ul>
<li class="chapter" data-level="13.3.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#do-the-sun-sensor-angles-make-sense"><i class="fa fa-check"></i><b>13.3.1</b> Do the sun sensor angles make sense?</a></li>
<li class="chapter" data-level="13.3.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#does-the-relationship-between-direct-and-horizontal-irradiance-make-sense"><i class="fa fa-check"></i><b>13.3.2</b> Does the relationship between direct and horizontal irradiance make sense?</a></li>
<li class="chapter" data-level="13.3.3" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#does-the-scattered-direct-ratio-make-sense-for-the-lighting-conditions-of-that-day"><i class="fa fa-check"></i><b>13.3.3</b> Does the scattered: direct ratio make sense for the lighting conditions of that day?</a></li>
</ul></li>
<li class="chapter" data-level="13.4" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#DLS1-correction"><i class="fa fa-check"></i><b>13.4</b> Correcting Irradiance Values for MicaSense Cameras</a>
<ul>
<li class="chapter" data-level="13.4.1" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#reading-exif-data"><i class="fa fa-check"></i><b>13.4.1</b> Reading Exif Data</a></li>
<li class="chapter" data-level="13.4.2" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#calculating-solar-zenith-angle"><i class="fa fa-check"></i><b>13.4.2</b> Calculating Solar Zenith Angle</a></li>
<li class="chapter" data-level="13.4.3" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#SSA-correction"><i class="fa fa-check"></i><b>13.4.3</b> Calculating Sun-Sensor Angles</a></li>
<li class="chapter" data-level="13.4.4" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#scattered-direct-ratio-estimate"><i class="fa fa-check"></i><b>13.4.4</b> Scattered: Direct Ratio Estimate</a></li>
<li class="chapter" data-level="13.4.5" data-path="micasense-irradiance-correction.html"><a href="micasense-irradiance-correction.html#computing-horizontal-corrected-irradiance"><i class="fa fa-check"></i><b>13.4.5</b> Computing Horizontal (Corrected) Irradiance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="14" data-path="thermal-conversion.html"><a href="thermal-conversion.html"><i class="fa fa-check"></i><b>14</b> Thermal Conversion</a>
<ul>
<li class="chapter" data-level="14.1" data-path="thermal-conversion.html"><a href="thermal-conversion.html#folder-set-up"><i class="fa fa-check"></i><b>14.1</b> Folder Set-Up</a></li>
<li class="chapter" data-level="14.2" data-path="thermal-conversion.html"><a href="thermal-conversion.html#weather-data"><i class="fa fa-check"></i><b>14.2</b> Weather Data</a></li>
<li class="chapter" data-level="14.3" data-path="thermal-conversion.html"><a href="thermal-conversion.html#dji-thermal-sdk-temperature-conversion"><i class="fa fa-check"></i><b>14.3</b> DJI Thermal SDK: temperature conversion</a>
<ul>
<li class="chapter" data-level="14.3.1" data-path="thermal-conversion.html"><a href="thermal-conversion.html#parameters"><i class="fa fa-check"></i><b>14.3.1</b> Parameters</a></li>
<li class="chapter" data-level="14.3.2" data-path="thermal-conversion.html"><a href="thermal-conversion.html#running-the-sdk"><i class="fa fa-check"></i><b>14.3.2</b> Running the SDK</a></li>
</ul></li>
<li class="chapter" data-level="14.4" data-path="thermal-conversion.html"><a href="thermal-conversion.html#convert-to-raster"><i class="fa fa-check"></i><b>14.4</b> Convert to Raster</a></li>
<li class="chapter" data-level="14.5" data-path="thermal-conversion.html"><a href="thermal-conversion.html#examples"><i class="fa fa-check"></i><b>14.5</b> Examples</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="thermal-conversion" class="section level1 hasAnchor" number="14">
<h1><span class="header-section-number">Chapter 14</span> Thermal Conversion<a href="thermal-conversion.html#thermal-conversion" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<p>This method converts raw imagery from the Zenmuse H20T to single band temperature tiffs. We use this method to bypass the DJI thermal analysis tool app since we had thousands of images to process and the app would often crash when a few images were uploaded. This method uses the DJI thermal analysis tool’s software developer kit (SDK) instead to loop through a folder of images and return temperature rasters.</p>
<p>This method consists of:</p>
<ol style="list-style-type: decimal">
<li><p>Gathering all “*_T.JPG” imagery into a single folder to loop through</p></li>
<li><p>Calculating weighted averaged values for humidity and ambident temperature, which will be needed for the thermal analysis SDK to run</p></li>
<li><p>Looping through imagery and converting to temperature rasters, then attaching original exif data to the new single band temperature rasters</p></li>
</ol>
<div id="folder-set-up" class="section level2 hasAnchor" number="14.1">
<h2><span class="header-section-number">14.1</span> Folder Set-Up<a href="thermal-conversion.html#folder-set-up" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This step goes over how we organized our imagery for the thermal conversion.</p>
<p>Here we:</p>
<ul>
<li><p>create a folder named:</p>
<ul>
<li><p>“Merged_T” within the original “H20T” folder, this is the location the raw thermal images will be copied. This allow us to (a) keep a backup of the original data and (b) easily iterate over the images to convert them in later steps</p></li>
<li><p>“Temperature_rasters” within the Merged_T folder that will hold converted imagery</p></li>
<li><p>“Temperature_rasters_EXIF” within the Merged_T folder that will hold converted imagery that has original imagery exif data written to it</p></li>
</ul></li>
<li><p>locate all folders within the defined directory that contain raw thermal images, in our case these were folders that had DJI and H20T in the name</p></li>
<li><p>Iterate over the folders found in the above step and:</p>
<ul>
<li>find files that end in _T.JPG (the raw thermal images)</li>
<li>copy over the raw thermal images to the merged folder</li>
</ul></li>
</ul>
<p><strong>Note:</strong> Our folder structure was:</p>
<ul>
<li>paste0(“I:\PARSER_Ext\”,site,“\Flights\”, data_date, “\1_Data\H20T”), where “site” is a string of the site name that we defined prior to the for loop and data_date is a string representing the flight date that is defined in the for loop. This was done so we could easily iterate over sites and dates. Feel free to change this to match your folder structure.</li>
</ul>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="thermal-conversion.html#cb65-1" tabindex="-1"></a><span class="fu">library</span>(exiftoolr)</span>
<span id="cb65-2"><a href="thermal-conversion.html#cb65-2" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb65-3"><a href="thermal-conversion.html#cb65-3" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb65-4"><a href="thermal-conversion.html#cb65-4" tabindex="-1"></a><span class="fu">library</span>(OpenImageR)</span>
<span id="cb65-5"><a href="thermal-conversion.html#cb65-5" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb65-6"><a href="thermal-conversion.html#cb65-6" tabindex="-1"></a><span class="fu">library</span>(stringr)</span>
<span id="cb65-7"><a href="thermal-conversion.html#cb65-7" tabindex="-1"></a></span>
<span id="cb65-8"><a href="thermal-conversion.html#cb65-8" tabindex="-1"></a><span class="co"># Setting the site and flight date to convert thermal imagery</span></span>
<span id="cb65-9"><a href="thermal-conversion.html#cb65-9" tabindex="-1"></a>flight_dates <span class="ot">&lt;-</span>  <span class="fu">c</span>(<span class="st">&quot;2023_05_10&quot;</span>) <span class="co"># Here only one date is shown however this can be a list of however many dates you would like to iterate over</span></span>
<span id="cb65-10"><a href="thermal-conversion.html#cb65-10" tabindex="-1"></a>site <span class="ot">&lt;-</span> <span class="st">&quot;site name here&quot;</span> </span>
<span id="cb65-11"><a href="thermal-conversion.html#cb65-11" tabindex="-1"></a>merged <span class="ot">&lt;-</span> <span class="st">&quot;Merged_T&quot;</span> <span class="co">#name of the &#39;merged&#39; folder that will contain all the h20T images from the multiple folders ouput by the H20T</span></span>
<span id="cb65-12"><a href="thermal-conversion.html#cb65-12" tabindex="-1"></a></span>
<span id="cb65-13"><a href="thermal-conversion.html#cb65-13" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(flight_dates)){</span>
<span id="cb65-14"><a href="thermal-conversion.html#cb65-14" tabindex="-1"></a>  data_date <span class="ot">&lt;-</span> flight_dates[i]</span>
<span id="cb65-15"><a href="thermal-conversion.html#cb65-15" tabindex="-1"></a>  <span class="fu">print</span>(data_date)</span>
<span id="cb65-16"><a href="thermal-conversion.html#cb65-16" tabindex="-1"></a>  dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">&quot;I:</span><span class="sc">\\</span><span class="st">PARSER_Ext</span><span class="sc">\\</span><span class="st">&quot;</span>,site,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>, data_date, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">H20T&quot;</span>)</span>
<span id="cb65-17"><a href="thermal-conversion.html#cb65-17" tabindex="-1"></a>  <span class="co">#create folders</span></span>
<span id="cb65-18"><a href="thermal-conversion.html#cb65-18" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">paste0</span>(dir, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged))) {</span>
<span id="cb65-19"><a href="thermal-conversion.html#cb65-19" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="fu">paste0</span>(dir, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged),<span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-20"><a href="thermal-conversion.html#cb65-20" tabindex="-1"></a>  }</span>
<span id="cb65-21"><a href="thermal-conversion.html#cb65-21" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">paste0</span>(dir, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Temperature_rasters&quot;</span>))) {</span>
<span id="cb65-22"><a href="thermal-conversion.html#cb65-22" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="fu">paste0</span>(dir, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Temperature_rasters&quot;</span>),<span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-23"><a href="thermal-conversion.html#cb65-23" tabindex="-1"></a>  }</span>
<span id="cb65-24"><a href="thermal-conversion.html#cb65-24" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">paste0</span>(dir, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Temperature_rasters_EXIF&quot;</span>))) {</span>
<span id="cb65-25"><a href="thermal-conversion.html#cb65-25" tabindex="-1"></a>    <span class="fu">dir.create</span>(<span class="fu">paste0</span>(dir, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Temperature_rasters_EXIF&quot;</span>),<span class="at">recursive =</span> <span class="cn">TRUE</span>)</span>
<span id="cb65-26"><a href="thermal-conversion.html#cb65-26" tabindex="-1"></a>  }</span>
<span id="cb65-27"><a href="thermal-conversion.html#cb65-27" tabindex="-1"></a>  </span>
<span id="cb65-28"><a href="thermal-conversion.html#cb65-28" tabindex="-1"></a>  list_dir <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir, <span class="at">full.names =</span> <span class="cn">TRUE</span>,<span class="at">pattern =</span> <span class="fu">c</span>(<span class="st">&quot;DJI.+-H20T&quot;</span>)) <span class="co">#selecting folders in the H20T folder that have DJI and end in -H20T, this is how we named our folders, change this pattern to match your folders. You should be selecting all folders with H20T imagery ending in _T for that flight</span></span>
<span id="cb65-29"><a href="thermal-conversion.html#cb65-29" tabindex="-1"></a>  <span class="fu">print</span>(list_dir) <span class="co">#to check only correct directories are being read</span></span>
<span id="cb65-30"><a href="thermal-conversion.html#cb65-30" tabindex="-1"></a>  </span>
<span id="cb65-31"><a href="thermal-conversion.html#cb65-31" tabindex="-1"></a>  <span class="cf">for</span> (d <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(list_dir)){</span>
<span id="cb65-32"><a href="thermal-conversion.html#cb65-32" tabindex="-1"></a>    folder_dir <span class="ot">&lt;-</span> list_dir[d] <span class="co">#calling each directly separately</span></span>
<span id="cb65-33"><a href="thermal-conversion.html#cb65-33" tabindex="-1"></a>    T_files <span class="ot">&lt;-</span> <span class="fu">list.files</span>(folder_dir, <span class="at">pattern =</span> <span class="st">&quot;_T</span><span class="sc">\\</span><span class="st">.JPG$&quot;</span>) <span class="co">#selecting all JPEGs ending in _T </span></span>
<span id="cb65-34"><a href="thermal-conversion.html#cb65-34" tabindex="-1"></a>    <span class="fu">file.copy</span>(<span class="at">from =</span> <span class="fu">paste0</span>(folder_dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>, T_files),</span>
<span id="cb65-35"><a href="thermal-conversion.html#cb65-35" tabindex="-1"></a>              <span class="at">to =</span> <span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>, T_files), <span class="at">overwrite =</span> <span class="cn">FALSE</span>) <span class="co">#copying h20T images ending in _T (aka unprocessed thermal images) into the thermal only folder for ease in DJI SDK step</span></span>
<span id="cb65-36"><a href="thermal-conversion.html#cb65-36" tabindex="-1"></a>  }</span>
<span id="cb65-37"><a href="thermal-conversion.html#cb65-37" tabindex="-1"></a>}</span></code></pre></div>
</details>
</div>
<div id="weather-data" class="section level2 hasAnchor" number="14.2">
<h2><span class="header-section-number">14.2</span> Weather Data<a href="thermal-conversion.html#weather-data" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>DJI thermal’s SDK requires inputs of humidity, reflection (or ambient temperature), distance, and emissivity (see section on <a href="thermal-conversion.html#parameters">parameters</a> for more detail on each of the inputs). In this section we will take hourly weather data from an on-site HOBO climate logger and calculate weighted averages for humidity and ambient temperature.</p>
<p>First, we use the first and last image in the Merged_T folder to define the start and end time of the flight, along with the date of the flight as a date object.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="thermal-conversion.html#cb66-1" tabindex="-1"></a><span class="co">#getting image capture date from exif data of the first image in the H20T folder</span></span>
<span id="cb66-2"><a href="thermal-conversion.html#cb66-2" tabindex="-1"></a></span>
<span id="cb66-3"><a href="thermal-conversion.html#cb66-3" tabindex="-1"></a>data_date <span class="ot">&lt;-</span> flight_dates[<span class="dv">1</span>]</span>
<span id="cb66-4"><a href="thermal-conversion.html#cb66-4" tabindex="-1"></a></span>
<span id="cb66-5"><a href="thermal-conversion.html#cb66-5" tabindex="-1"></a>time_file_list <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged), <span class="at">pattern =</span> <span class="st">&quot;_T</span><span class="sc">\\</span><span class="st">.JPG$&quot;</span>)</span>
<span id="cb66-6"><a href="thermal-conversion.html#cb66-6" tabindex="-1"></a></span>
<span id="cb66-7"><a href="thermal-conversion.html#cb66-7" tabindex="-1"></a><span class="co">#Retrieving the time the FIRST H20T thermal image was taken</span></span>
<span id="cb66-8"><a href="thermal-conversion.html#cb66-8" tabindex="-1"></a>(img_1 <span class="ot">&lt;-</span> time_file_list[<span class="dv">1</span>]) <span class="co">#find the first thermal image and print the name</span></span>
<span id="cb66-9"><a href="thermal-conversion.html#cb66-9" tabindex="-1"></a>start_exif_flight_date <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">exif_read</span>(<span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,img_1),</span>
<span id="cb66-10"><a href="thermal-conversion.html#cb66-10" tabindex="-1"></a>                                               <span class="at">tags =</span> <span class="st">&quot;CreateDate&quot;</span>,</span>
<span id="cb66-11"><a href="thermal-conversion.html#cb66-11" tabindex="-1"></a>                                               <span class="at">quiet =</span> <span class="cn">TRUE</span>)) <span class="co">#find the time the image was taken/written from the CreateDate tag in the exif data</span></span>
<span id="cb66-12"><a href="thermal-conversion.html#cb66-12" tabindex="-1"></a>(start_flight_date_time <span class="ot">&lt;-</span> start_exif_flight_date<span class="sc">$</span>CreateDate) <span class="co">#Start of the flight</span></span>
<span id="cb66-13"><a href="thermal-conversion.html#cb66-13" tabindex="-1"></a></span>
<span id="cb66-14"><a href="thermal-conversion.html#cb66-14" tabindex="-1"></a><span class="co">#Retrieving the time the LAST H20T thermal image was taken</span></span>
<span id="cb66-15"><a href="thermal-conversion.html#cb66-15" tabindex="-1"></a>(img_last <span class="ot">&lt;-</span> <span class="fu">tail</span>(time_file_list, <span class="at">n=</span><span class="dv">1</span>))<span class="co">#End flight time</span></span>
<span id="cb66-16"><a href="thermal-conversion.html#cb66-16" tabindex="-1"></a>end_flight_date_time <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">exif_read</span>(<span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,img_last),</span>
<span id="cb66-17"><a href="thermal-conversion.html#cb66-17" tabindex="-1"></a>                                             <span class="at">tags =</span> <span class="st">&quot;CreateDate&quot;</span>,</span>
<span id="cb66-18"><a href="thermal-conversion.html#cb66-18" tabindex="-1"></a>                                             <span class="at">quiet =</span> <span class="cn">TRUE</span>))</span>
<span id="cb66-19"><a href="thermal-conversion.html#cb66-19" tabindex="-1"></a>(end_flight_date_time <span class="ot">&lt;-</span> end_flight_date_time<span class="sc">$</span>CreateDate)<span class="co">#End of the flight</span></span>
<span id="cb66-20"><a href="thermal-conversion.html#cb66-20" tabindex="-1"></a></span>
<span id="cb66-21"><a href="thermal-conversion.html#cb66-21" tabindex="-1"></a></span>
<span id="cb66-22"><a href="thermal-conversion.html#cb66-22" tabindex="-1"></a>(flight_date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(start_exif_flight_date<span class="sc">$</span>CreateDate, <span class="st">&#39;%Y:%m:%d %H:%M:%S&#39;</span>)) <span class="co">#the flight date as a date object</span></span>
<span id="cb66-23"><a href="thermal-conversion.html#cb66-23" tabindex="-1"></a>(flight_date_filt <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(flight_date, <span class="at">format =</span> <span class="st">&#39;%Y-%m-%d&#39;</span>)) <span class="co">#flight date in the format of 2024-03-10, YYYY-mm-dd, this ill be used in the next step to filter weather data</span></span></code></pre></div>
</details>
<p>Next, since our weather station provided hourly measurements, we calculate a weighted average of temperature and humidity values based on time intervals. This was done to account for the fact that variables will change throughout the flight. The hourly variables are weighted in proportion to how much of the hour fell within the flight window which gives us a better estimate of the overall weather variables than if a plain average was taken.</p>
<p>To begin, we read in the weather data and set a start time and end time of the flight. Start time is rounded down to the nearest hour (i.e. 10:15am becomes 10:00am) and end time is rounded up to the nearest hour (i.e. 11:30am becomes 12:00pm). These values will be used to filter the weather data.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="thermal-conversion.html#cb67-1" tabindex="-1"></a>cfs_weather <span class="ot">&lt;-</span> <span class="st">&quot;path to weather data&quot;</span> <span class="co">#loading in HOBO weather station data</span></span>
<span id="cb67-2"><a href="thermal-conversion.html#cb67-2" tabindex="-1"></a>cfs_weather<span class="sc">$</span>Date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(cfs_weather<span class="sc">$</span>Date, <span class="at">format =</span> <span class="st">&quot;%m/%d/%y&quot;</span>) <span class="co">#converting date in the format m/d/Y to a date object written as YYY-mm-dd</span></span>
<span id="cb67-3"><a href="thermal-conversion.html#cb67-3" tabindex="-1"></a></span>
<span id="cb67-4"><a href="thermal-conversion.html#cb67-4" tabindex="-1"></a>start_time_avg <span class="ot">&lt;-</span> <span class="st">&quot;10:00:00&quot;</span> <span class="co">#Based off of start_flight_date_time of 10:15am</span></span>
<span id="cb67-5"><a href="thermal-conversion.html#cb67-5" tabindex="-1"></a>stop_time_avg <span class="ot">&lt;-</span> <span class="st">&quot;12:00:00&quot;</span> <span class="co">#Based off of end_flight_date_time of 11:30am</span></span></code></pre></div>
</details>
<p>For simplicity we kept weights as 0.25 (15min), 0.5 (30min), 0.75 (45min) or 1 (1 hr) and rounded the start time to the earliest 15 min marker and the end time to the latest 15 min marker. For example, for a flight that started at 10:03am and ended at 11:09am, we rounded 10:03am to 10:00am and 11:09am to 11:15am.</p>
<p>Weights for start, middle, and end hours:</p>
<ul>
<li><p>The start weight corresponds to how much of the first hour is covered by the flight time. For example, if the flight starts at 10:15, 45 minutes (or 0.75 of the hour) are included in that hour, so the start weight is 0.75.</p></li>
<li><p>The middle weight (if the flight spans more than one hour) represents the full hour covered by the flight. In the example of a flight from 10:15 to 11:30, the middle weight would be 1 which takes into account that the drone was flying at 11am when the climate logger logged data.</p></li>
<li><p>The end weight applies similarly for the last hour of the flight. If the flight ends at 11:30, 30 minutes (or 0.5 of the hour) are included in that hour, so the end weight is 0.5.</p></li>
</ul>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="thermal-conversion.html#cb68-1" tabindex="-1"></a><span class="co">#Ie: Flight starts at 10:15am and ends at 11:30am</span></span>
<span id="cb68-2"><a href="thermal-conversion.html#cb68-2" tabindex="-1"></a>start_weight <span class="ot">&lt;-</span> <span class="fl">0.75</span> <span class="co"># 75% of 10am</span></span>
<span id="cb68-3"><a href="thermal-conversion.html#cb68-3" tabindex="-1"></a>mid_weight <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="co"># 100% of  11am </span></span>
<span id="cb68-4"><a href="thermal-conversion.html#cb68-4" tabindex="-1"></a>end_weight <span class="ot">&lt;-</span> <span class="fl">0.5</span> <span class="co"># 50% of 12pm</span></span>
<span id="cb68-5"><a href="thermal-conversion.html#cb68-5" tabindex="-1"></a></span>
<span id="cb68-6"><a href="thermal-conversion.html#cb68-6" tabindex="-1"></a>sum_weight <span class="ot">&lt;-</span> <span class="fu">sum</span>(start_weight,</span>
<span id="cb68-7"><a href="thermal-conversion.html#cb68-7" tabindex="-1"></a>                  mid_weight,<span class="co">#comment out the mid_weight if no mid weight</span></span>
<span id="cb68-8"><a href="thermal-conversion.html#cb68-8" tabindex="-1"></a>                  end_weight) </span>
<span id="cb68-9"><a href="thermal-conversion.html#cb68-9" tabindex="-1"></a></span>
<span id="cb68-10"><a href="thermal-conversion.html#cb68-10" tabindex="-1"></a><span class="co">#creating df with weighted average air temperature and humidity values</span></span>
<span id="cb68-11"><a href="thermal-conversion.html#cb68-11" tabindex="-1"></a>(cfs_weather_time_avg <span class="ot">&lt;-</span> cfs_weather<span class="sc">%&gt;%</span></span>
<span id="cb68-12"><a href="thermal-conversion.html#cb68-12" tabindex="-1"></a>  <span class="fu">filter</span>(Date <span class="sc">==</span> flight_date_filt ) <span class="sc">%&gt;%</span></span>
<span id="cb68-13"><a href="thermal-conversion.html#cb68-13" tabindex="-1"></a>  <span class="fu">filter</span>(Time <span class="sc">&lt;=</span> stop_time_avg <span class="sc">&amp;</span> Time <span class="sc">&gt;=</span> start_time_avg)<span class="sc">%&gt;%</span> <span class="co">#filtering for values taken between the defined start (10am) and end (12pm) times</span></span>
<span id="cb68-14"><a href="thermal-conversion.html#cb68-14" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Average_hum =</span> (start_weight<span class="sc">*</span>RH[<span class="dv">1</span>]</span>
<span id="cb68-15"><a href="thermal-conversion.html#cb68-15" tabindex="-1"></a>                         <span class="sc">+</span> mid_weight<span class="sc">*</span>RH[<span class="dv">2</span>] <span class="co">#comment out this line if no mid_weight and just below index of [3] to [2]</span></span>
<span id="cb68-16"><a href="thermal-conversion.html#cb68-16" tabindex="-1"></a>                         <span class="sc">+</span> end_weight<span class="sc">*</span>RH[<span class="dv">3</span>])<span class="sc">/</span>sum_weight,</span>
<span id="cb68-17"><a href="thermal-conversion.html#cb68-17" tabindex="-1"></a>         <span class="at">Average_air_temp =</span> (start_weight<span class="sc">*</span>Temperature[<span class="dv">1</span>] </span>
<span id="cb68-18"><a href="thermal-conversion.html#cb68-18" tabindex="-1"></a>                             <span class="sc">+</span> mid_weight<span class="sc">*</span>Temperature[<span class="dv">2</span>]<span class="co">#comment out this line if no mid_weight and just below index of [3] to [2]</span></span>
<span id="cb68-19"><a href="thermal-conversion.html#cb68-19" tabindex="-1"></a>                             <span class="sc">+</span> end_weight<span class="sc">*</span>Temperature[<span class="dv">3</span>])<span class="sc">/</span>sum_weight))</span>
<span id="cb68-20"><a href="thermal-conversion.html#cb68-20" tabindex="-1"></a></span>
<span id="cb68-21"><a href="thermal-conversion.html#cb68-21" tabindex="-1"></a><span class="co">#check values </span></span>
<span id="cb68-22"><a href="thermal-conversion.html#cb68-22" tabindex="-1"></a>(avg_hum <span class="ot">&lt;-</span> cfs_weather_time_avg<span class="sc">$</span>Average_hum)</span>
<span id="cb68-23"><a href="thermal-conversion.html#cb68-23" tabindex="-1"></a>(avg_temp <span class="ot">&lt;-</span> cfs_weather_time_avg<span class="sc">$</span>Average_air_temp)</span>
<span id="cb68-24"><a href="thermal-conversion.html#cb68-24" tabindex="-1"></a>(date <span class="ot">&lt;-</span> <span class="fu">as.Date</span>(cfs_weather_time_avg<span class="sc">$</span>Date, <span class="st">&#39;%d-%m-%Y&#39;</span>))</span>
<span id="cb68-25"><a href="thermal-conversion.html#cb68-25" tabindex="-1"></a></span>
<span id="cb68-26"><a href="thermal-conversion.html#cb68-26" tabindex="-1"></a><span class="co">#creating a data frame  with weighted averaged values</span></span>
<span id="cb68-27"><a href="thermal-conversion.html#cb68-27" tabindex="-1"></a>Canoe_flight_table <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(date, avg_hum, avg_temp)</span>
<span id="cb68-28"><a href="thermal-conversion.html#cb68-28" tabindex="-1"></a>Canoe_flight_table <span class="ot">&lt;-</span> Canoe_flight_table <span class="sc">%&gt;%</span> <span class="fu">distinct</span>()<span class="co">#removing duplicate rows</span></span>
<span id="cb68-29"><a href="thermal-conversion.html#cb68-29" tabindex="-1"></a></span>
<span id="cb68-30"><a href="thermal-conversion.html#cb68-30" tabindex="-1"></a><span class="co">#resetting index in table to go from 1-N</span></span>
<span id="cb68-31"><a href="thermal-conversion.html#cb68-31" tabindex="-1"></a><span class="fu">rownames</span>(Canoe_flight_table) <span class="ot">&lt;-</span> <span class="cn">NULL</span></span>
<span id="cb68-32"><a href="thermal-conversion.html#cb68-32" tabindex="-1"></a></span>
<span id="cb68-33"><a href="thermal-conversion.html#cb68-33" tabindex="-1"></a><span class="co">#setting variables for weighted average of humidity and ambient temperature, these variables will be used as inputs into DJI&#39;s thermal anlysis tool SDK to convert rasters to temperature</span></span>
<span id="cb68-34"><a href="thermal-conversion.html#cb68-34" tabindex="-1"></a>flight_humidity <span class="ot">&lt;-</span> Canoe_flight_table[Canoe_flight_table<span class="sc">$</span>date <span class="sc">==</span> flight_date, <span class="st">&quot;avg_hum&quot;</span>]</span>
<span id="cb68-35"><a href="thermal-conversion.html#cb68-35" tabindex="-1"></a>flight_humidity</span>
<span id="cb68-36"><a href="thermal-conversion.html#cb68-36" tabindex="-1"></a></span>
<span id="cb68-37"><a href="thermal-conversion.html#cb68-37" tabindex="-1"></a>flight_amb_temp <span class="ot">&lt;-</span> Canoe_flight_table[Canoe_flight_table<span class="sc">$</span>date <span class="sc">==</span> flight_date, <span class="st">&quot;avg_temp&quot;</span>]</span>
<span id="cb68-38"><a href="thermal-conversion.html#cb68-38" tabindex="-1"></a>flight_amb_temp</span></code></pre></div>
</details>
</div>
<div id="dji-thermal-sdk-temperature-conversion" class="section level2 hasAnchor" number="14.3">
<h2><span class="header-section-number">14.3</span> DJI Thermal SDK: temperature conversion<a href="thermal-conversion.html#dji-thermal-sdk-temperature-conversion" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<div id="parameters" class="section level3 hasAnchor" number="14.3.1">
<h3><span class="header-section-number">14.3.1</span> Parameters<a href="thermal-conversion.html#parameters" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The parameters required as inputs for DJI thermal’s SDK are:</p>
<ul>
<li><p><strong>Reflected Temperature</strong> : The reflected temperature of the target takes into account the impact of radiation reflected from nearby objects that can significantly impact the temperature reading of the object. This parameter is important if there are any objects nearby with either an extremely high or low temperature. Otherwise the reflected temperature can be set to the ambient air temperature. Since none of our sites had an object with extreme high or low temperature nearby we used ambient air temperature (flight_amb_temp) from on-site HOBO climate loggers.</p></li>
<li><p><strong>Relative Humidity</strong>: The relative humidity during the flight. The default value is set to 70% and the allowed range is 20-100%. We used a weighted average humidity value (flight_humidity) calculated using data from the on-site HOBO climate loggers.</p></li>
<li><p><strong>Distance</strong>: The distance from the sensor to the target (i.e. tree crowns). The H20T is an infrared thermal sensor that measures the infrared radiation received from objects. Hence, the further away the object, the more the radiation attenuates and the less accurate the temperature measurement. The maximum distance that the thermal analysis tools allows is 25m. In our case, we are flying higher (~40m away from the crowns, depending on the site) and thus use the 25m maximum and interpret the temperature values as relative to each other while understanding that the absolute temperature likely contains error given the larger distance between the sensor and the object.</p></li>
<li><p><strong>Emissivity</strong>: The emissivity of a material is a measure of its ability to emit energy as thermal radiation. The default value is 1. We used a value of 0.98 as an estimate for all conifers (Rubio et al., 1997).</p></li>
</ul>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="thermal-conversion.html#cb69-1" tabindex="-1"></a><span class="co">#setting parameters:</span></span>
<span id="cb69-2"><a href="thermal-conversion.html#cb69-2" tabindex="-1"></a>(flight_amb_temp) <span class="co"># already set above, () to print out the value in the console to ensure it is the correct one</span></span>
<span id="cb69-3"><a href="thermal-conversion.html#cb69-3" tabindex="-1"></a>(flight_humidity) <span class="co"># already set above</span></span>
<span id="cb69-4"><a href="thermal-conversion.html#cb69-4" tabindex="-1"></a>distance <span class="ot">&lt;-</span> <span class="dv">25</span> <span class="co"># max distance that can be set</span></span>
<span id="cb69-5"><a href="thermal-conversion.html#cb69-5" tabindex="-1"></a>emissivity <span class="ot">&lt;-</span> <span class="fl">0.98</span> <span class="co"># approximate value for trees</span></span></code></pre></div>
</details>
</div>
<div id="running-the-sdk" class="section level3 hasAnchor" number="14.3.2">
<h3><span class="header-section-number">14.3.2</span> Running the SDK<a href="thermal-conversion.html#running-the-sdk" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The SDK is run using a batch script that calls the SDK in a for loop to iterate over the imagery. To set up, first we copy the original .bat file into the Merged_T folder. We do this so that the original script does not get edited and instead each flight will have their own edited .bat file. This allows you to go back and see what parameters were used if needed.</p>
<p>The original <a href="https://github.com/owaite/GenomeBC_BPG/blob/main/Scripts/H20T_thermal/DJI_SDK_loop.bat">.bat file</a> can be found on GitHub and looks like this:</p>
<details>
<summary>
Click to show the code
</summary>
<pre class="cmd"><code>REM to change dir to the location of this file
REM start time used to average humidity and temperature values: start_time_avg
REM end time used to average humidity and temperature values: stop_time_avg
REM weights (in 15min intervals ie 0.25, 0.5, 0.75 or 1, round down for start and up for end time): start w: start_weight, mid w: mid_weight (might not have one), end w: end_weight

cd /D &quot;%~dp0&quot;

mkdir DJI_SDK_raw

for %%i in (*.JPG) do (
echo Working on %%i...
C:\dji_thermal_sdk_v1.3_20220517\utility\bin\windows\release_x64\dji_irp.exe -s %%i -a measure -o DJI_SDK_raw/%%~ni.raw --humidity hum_change --distance dist_change --emissivity emis_change --reflection reflec_change
)
pause</code></pre>
</details>
<p>This script makes a folder called DJI_SDK_raw in the directory the .bat is saved in (which will become the Merged_T folder once we copy it over in the below code) and converts the imagery in the Merged_T folder ending in .JPG to temperature using DJI’s thermal anlysis tool’s SDK.</p>
<p>Before continuing to the next steps:</p>
<ol style="list-style-type: decimal">
<li><p>save the <a href="https://github.com/owaite/GenomeBC_BPG/blob/main/Scripts/H20T_thermal/DJI_SDK_loop.bat">.bat file</a> from GitHub and update the omp_dir path in the below R code to the folder where this file was saved to</p></li>
<li><p>download the dji thermal sdk <a href="https://www.dji.com/ca/downloads/softwares/dji-thermal-sdk">here</a></p></li>
<li><p>edit the location of the dji_irp.exe in your saved <a href="https://github.com/owaite/GenomeBC_BPG/blob/main/Scripts/DJI_SDK_loop.bat">.bat file</a> to match where the program is saved on your computer</p>
<ul>
<li>i.e. replace the “C:\dji_thermal_sdk_v1.3_20220517\utility\bin\windows\release_x64\dji_irp.exe” in the above script to the directory you saved the dji_irp.exe file from step 2</li>
</ul></li>
</ol>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="thermal-conversion.html#cb71-1" tabindex="-1"></a>omp_dir <span class="ot">&lt;-</span> <span class="st">&quot;C:/Users/owaite/Documents/Scripts/DJI_SDK_TemperatureConversion_Script&quot;</span> <span class="co">#change to the directory where you saved the original .bat script from the above GitHub link to</span></span>
<span id="cb71-2"><a href="thermal-conversion.html#cb71-2" tabindex="-1"></a></span>
<span id="cb71-3"><a href="thermal-conversion.html#cb71-3" tabindex="-1"></a><span class="fu">file.copy</span>(<span class="at">from =</span> <span class="fu">paste0</span>(omp_dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>, <span class="st">&quot;DJI_SDK_loop.bat&quot;</span>), <span class="co">#copy the original omp.bat file into the Merged_T folder</span></span>
<span id="cb71-4"><a href="thermal-conversion.html#cb71-4" tabindex="-1"></a>          <span class="at">to =</span> <span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="st">&quot;DJI_SDK_loop.bat&quot;</span>), <span class="at">overwrite =</span> <span class="cn">FALSE</span>)</span>
<span id="cb71-5"><a href="thermal-conversion.html#cb71-5" tabindex="-1"></a></span>
<span id="cb71-6"><a href="thermal-conversion.html#cb71-6" tabindex="-1"></a>bat_old <span class="ot">&lt;-</span> <span class="fu">file</span>(<span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="st">&quot;DJI_SDK_loop.bat&quot;</span>)) <span class="co">#opening .bat file to edit</span></span>
<span id="cb71-7"><a href="thermal-conversion.html#cb71-7" tabindex="-1"></a>bat_new <span class="ot">&lt;-</span> <span class="fu">readLines</span>(bat_old) <span class="co">#reading in lines of .bat file to edit and saving them out</span></span>
<span id="cb71-8"><a href="thermal-conversion.html#cb71-8" tabindex="-1"></a><span class="fu">close</span>(bat_old)</span>
<span id="cb71-9"><a href="thermal-conversion.html#cb71-9" tabindex="-1"></a></span>
<span id="cb71-10"><a href="thermal-conversion.html#cb71-10" tabindex="-1"></a><span class="co">#replacing values</span></span>
<span id="cb71-11"><a href="thermal-conversion.html#cb71-11" tabindex="-1"></a>comment out mid_weight line <span class="cf">if</span> necessary</span>
<span id="cb71-12"><a href="thermal-conversion.html#cb71-12" tabindex="-1"></a>bat_new <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;hum_change&quot;</span>,flight_humidity, bat_new)</span>
<span id="cb71-13"><a href="thermal-conversion.html#cb71-13" tabindex="-1"></a>bat_new <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;dist_change&quot;</span>,distance, bat_new)</span>
<span id="cb71-14"><a href="thermal-conversion.html#cb71-14" tabindex="-1"></a>bat_new <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;emis_change&quot;</span>,emissivity,bat_new)</span>
<span id="cb71-15"><a href="thermal-conversion.html#cb71-15" tabindex="-1"></a>bat_new <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;reflec_change&quot;</span>,flight_amb_temp,bat_new)</span>
<span id="cb71-16"><a href="thermal-conversion.html#cb71-16" tabindex="-1"></a>bat_new <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;start_time_avg&quot;</span>,start_time_avg, bat_new)</span>
<span id="cb71-17"><a href="thermal-conversion.html#cb71-17" tabindex="-1"></a>bat_new <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;stop_time_avg&quot;</span>,stop_time_avg,bat_new)</span>
<span id="cb71-18"><a href="thermal-conversion.html#cb71-18" tabindex="-1"></a>bat_new <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;start_weight&quot;</span>, start_weight, bat_new)</span>
<span id="cb71-19"><a href="thermal-conversion.html#cb71-19" tabindex="-1"></a>bat_new <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;mid_weight&quot;</span>, mid_weight, bat_new) <span class="co">#if no mid_weight, comment this line out</span></span>
<span id="cb71-20"><a href="thermal-conversion.html#cb71-20" tabindex="-1"></a>bat_new <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;end_weight&quot;</span>, end_weight, bat_new)</span>
<span id="cb71-21"><a href="thermal-conversion.html#cb71-21" tabindex="-1"></a></span>
<span id="cb71-22"><a href="thermal-conversion.html#cb71-22" tabindex="-1"></a><span class="co">#Write the new file</span></span>
<span id="cb71-23"><a href="thermal-conversion.html#cb71-23" tabindex="-1"></a>fileConn <span class="ot">&lt;-</span> <span class="fu">file</span>(<span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">DJI_SDK_loop_updated.bat&quot;</span>))</span>
<span id="cb71-24"><a href="thermal-conversion.html#cb71-24" tabindex="-1"></a><span class="fu">writeLines</span>(bat_new, fileConn)</span>
<span id="cb71-25"><a href="thermal-conversion.html#cb71-25" tabindex="-1"></a><span class="fu">close</span>(fileConn)</span></code></pre></div>
</details>
<p>Next, we run the updated .bat file in windows terminal using the R code below. This will automatically output a folder of new raw images with temperature in binary saved to the Merged_T/DJI_SDK_raw folder.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="thermal-conversion.html#cb72-1" tabindex="-1"></a><span class="fu">shell.exec</span>(<span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">DJI_SDK_loop_updated.bat&quot;</span>))</span></code></pre></div>
</details>
</div>
</div>
<div id="convert-to-raster" class="section level2 hasAnchor" number="14.4">
<h2><span class="header-section-number">14.4</span> Convert to Raster<a href="thermal-conversion.html#convert-to-raster" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The following R script:</p>
<ul>
<li><p>reads in the binary data outputted by the thermal SDK</p></li>
<li><p>converts the data to rasters</p></li>
<li><p>updates the new temperature raster with exif data from original _T.JPG H20T imagery</p></li>
</ul>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb73"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb73-1"><a href="thermal-conversion.html#cb73-1" tabindex="-1"></a>dir_raw <span class="ot">&lt;-</span> <span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">DJI_SDK_raw</span><span class="sc">\\</span><span class="st">&quot;</span>)</span>
<span id="cb73-2"><a href="thermal-conversion.html#cb73-2" tabindex="-1"></a>raw_list <span class="ot">&lt;-</span> <span class="fu">list.files</span>(dir_raw) <span class="co">#check this is a list of the images saved out from the SDK step above</span></span>
<span id="cb73-3"><a href="thermal-conversion.html#cb73-3" tabindex="-1"></a>start.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()<span class="co">#to log how long it takes for code to run </span></span>
<span id="cb73-4"><a href="thermal-conversion.html#cb73-4" tabindex="-1"></a></span>
<span id="cb73-5"><a href="thermal-conversion.html#cb73-5" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(raw_list)){<span class="co">#loop that only writes out a folder with the Temperature rasters</span></span>
<span id="cb73-6"><a href="thermal-conversion.html#cb73-6" tabindex="-1"></a>  wh <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">640</span>, <span class="dv">512</span>)</span>
<span id="cb73-7"><a href="thermal-conversion.html#cb73-7" tabindex="-1"></a>  <span class="fu">print</span>(<span class="st">&quot;new&quot;</span>)</span>
<span id="cb73-8"><a href="thermal-conversion.html#cb73-8" tabindex="-1"></a>  str_m <span class="ot">&lt;-</span> raw_list[i]</span>
<span id="cb73-9"><a href="thermal-conversion.html#cb73-9" tabindex="-1"></a>  <span class="co">#getting name of .raw file but without the .raw extension so it can be saved as a tiff with the same name as the .raw (which has the same name as the original H20T images) so they can be swapped after alignment in metashape</span></span>
<span id="cb73-10"><a href="thermal-conversion.html#cb73-10" tabindex="-1"></a>  name <span class="ot">&lt;-</span> <span class="fu">substr</span>(str_m,<span class="dv">1</span>,<span class="fu">nchar</span>(str_m)<span class="sc">-</span><span class="dv">4</span>)</span>
<span id="cb73-11"><a href="thermal-conversion.html#cb73-11" tabindex="-1"></a>  <span class="fu">print</span>(name)</span>
<span id="cb73-12"><a href="thermal-conversion.html#cb73-12" tabindex="-1"></a>  <span class="co">#If else below allows you to rerun this code from where it left off if R aborts the session</span></span>
<span id="cb73-13"><a href="thermal-conversion.html#cb73-13" tabindex="-1"></a>  test_exists <span class="ot">&lt;-</span> <span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Temperature_rasters_EXIF</span><span class="sc">\\</span><span class="st">&quot;</span>, name,<span class="st">&quot;.tiff&quot;</span>)</span>
<span id="cb73-14"><a href="thermal-conversion.html#cb73-14" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">file.exists</span>(test_exists)){</span>
<span id="cb73-15"><a href="thermal-conversion.html#cb73-15" tabindex="-1"></a>    <span class="fu">print</span>(<span class="st">&quot;exists&quot;</span>)</span>
<span id="cb73-16"><a href="thermal-conversion.html#cb73-16" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb73-17"><a href="thermal-conversion.html#cb73-17" tabindex="-1"></a>    <span class="co">#divide by 2 because 16 means 2 bit integers (?)</span></span>
<span id="cb73-18"><a href="thermal-conversion.html#cb73-18" tabindex="-1"></a>    <span class="co">#print(paste0(dir_raw, str_m))</span></span>
<span id="cb73-19"><a href="thermal-conversion.html#cb73-19" tabindex="-1"></a>    </span>
<span id="cb73-20"><a href="thermal-conversion.html#cb73-20" tabindex="-1"></a>    <span class="fu">file.info</span>(<span class="fu">paste0</span>(dir_raw, str_m))<span class="sc">$</span>size<span class="sc">/</span><span class="dv">2</span> </span>
<span id="cb73-21"><a href="thermal-conversion.html#cb73-21" tabindex="-1"></a>    <span class="fu">prod</span>(wh) <span class="co">#getting product of width and height and checking it is correct</span></span>
<span id="cb73-22"><a href="thermal-conversion.html#cb73-22" tabindex="-1"></a>    v <span class="ot">&lt;-</span> <span class="fu">readBin</span>(<span class="fu">paste0</span>(dir_raw,str_m), <span class="at">what =</span> <span class="st">&quot;integer&quot;</span>,  <span class="co">#getting numerical values</span></span>
<span id="cb73-23"><a href="thermal-conversion.html#cb73-23" tabindex="-1"></a>                 <span class="at">n =</span> <span class="fu">prod</span>(wh), <span class="at">size =</span> <span class="dv">2</span>,  </span>
<span id="cb73-24"><a href="thermal-conversion.html#cb73-24" tabindex="-1"></a>                 <span class="at">signed =</span> <span class="cn">TRUE</span>, <span class="at">endian =</span> <span class="st">&quot;little&quot;</span>)</span>
<span id="cb73-25"><a href="thermal-conversion.html#cb73-25" tabindex="-1"></a>    </span>
<span id="cb73-26"><a href="thermal-conversion.html#cb73-26" tabindex="-1"></a>    v_temp <span class="ot">&lt;-</span> v<span class="sc">/</span><span class="dv">10</span> <span class="co">#temp in deg Celsius, DJI requires we divide by 10 here for Celsius</span></span>
<span id="cb73-27"><a href="thermal-conversion.html#cb73-27" tabindex="-1"></a>    <span class="fu">range</span>(v_temp) <span class="co">#check the values</span></span>
<span id="cb73-28"><a href="thermal-conversion.html#cb73-28" tabindex="-1"></a>    matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(v_temp, wh[<span class="dv">1</span>], wh[<span class="dv">2</span>])[wh[<span class="dv">1</span>]<span class="sc">:</span><span class="dv">1</span>,] <span class="co"># creating a matrix of the proper size</span></span>
<span id="cb73-29"><a href="thermal-conversion.html#cb73-29" tabindex="-1"></a>    mat_rotated <span class="ot">=</span> <span class="fu">rotateFixed</span>(matrix, <span class="dv">90</span>)<span class="co">#rotate the matrix by 90 to get correct orientation of image, requires library OpenImageR</span></span>
<span id="cb73-30"><a href="thermal-conversion.html#cb73-30" tabindex="-1"></a>    <span class="co">#to view image</span></span>
<span id="cb73-31"><a href="thermal-conversion.html#cb73-31" tabindex="-1"></a>    <span class="co">#image(matrix(v_temp, wh[1], wh[2])[wh[1]:1,], useRaster = TRUE, col = grey.colors(256))</span></span>
<span id="cb73-32"><a href="thermal-conversion.html#cb73-32" tabindex="-1"></a>    rast <span class="ot">&lt;-</span> <span class="fu">raster</span>(mat_rotated) <span class="co">#creating a raster </span></span>
<span id="cb73-33"><a href="thermal-conversion.html#cb73-33" tabindex="-1"></a>   </span>
<span id="cb73-34"><a href="thermal-conversion.html#cb73-34" tabindex="-1"></a>    <span class="co">#matching original image to measure.raw file</span></span>
<span id="cb73-35"><a href="thermal-conversion.html#cb73-35" tabindex="-1"></a>    dir_h20t <span class="ot">&lt;-</span> <span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>) <span class="co">#original h20T images:</span></span>
<span id="cb73-36"><a href="thermal-conversion.html#cb73-36" tabindex="-1"></a>    str_h20t <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="fu">substr</span>(str_m, <span class="dv">1</span>, <span class="fu">nchar</span>(str_m)<span class="sc">-</span><span class="dv">3</span>),<span class="st">&quot;JPG&quot;</span>) <span class="co">#since names are the same, here we call the name of the raw file -.raw and add .JPG</span></span>
<span id="cb73-37"><a href="thermal-conversion.html#cb73-37" tabindex="-1"></a>    r_h20t <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="fu">paste0</span>(dir_h20t,str_h20t)) <span class="co">#reading in jpg h20T raster</span></span>
<span id="cb73-38"><a href="thermal-conversion.html#cb73-38" tabindex="-1"></a>    r_h20t_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(dir_h20t,str_h20t) <span class="co">#for later exiftool</span></span>
<span id="cb73-39"><a href="thermal-conversion.html#cb73-39" tabindex="-1"></a>    <span class="fu">print</span>(r_h20t_path) <span class="co">#checking the path</span></span>
<span id="cb73-40"><a href="thermal-conversion.html#cb73-40" tabindex="-1"></a>    </span>
<span id="cb73-41"><a href="thermal-conversion.html#cb73-41" tabindex="-1"></a>    <span class="co">#need to add these before exif because exif command used won&#39;t overwrite already written ones</span></span>
<span id="cb73-42"><a href="thermal-conversion.html#cb73-42" tabindex="-1"></a>    <span class="fu">extent</span>(rast) <span class="ot">&lt;-</span> <span class="fu">extent</span>(r_h20t)<span class="co"># the extent is bound by the resolution that you have assigned to it - so must change extent before resolution</span></span>
<span id="cb73-43"><a href="thermal-conversion.html#cb73-43" tabindex="-1"></a>    <span class="fu">res</span>(rast) <span class="ot">&lt;-</span> <span class="fu">res</span>(r_h20t)</span>
<span id="cb73-44"><a href="thermal-conversion.html#cb73-44" tabindex="-1"></a>    <span class="co">#crs(rast) &lt;- crs(r_h20t)</span></span>
<span id="cb73-45"><a href="thermal-conversion.html#cb73-45" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Temperature_rasters</span><span class="sc">\\</span><span class="st">&quot;</span>, name, <span class="st">&quot;.tiff&quot;</span>))</span>
<span id="cb73-46"><a href="thermal-conversion.html#cb73-46" tabindex="-1"></a>    <span class="fu">writeRaster</span>(rast, <span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Temperature_rasters</span><span class="sc">\\</span><span class="st">&quot;</span>, name,<span class="st">&quot;.tiff&quot;</span>), <span class="at">overwrite =</span> <span class="cn">TRUE</span>) <span class="co">#writing out temperature raster, that does not have exif data attached</span></span>
<span id="cb73-47"><a href="thermal-conversion.html#cb73-47" tabindex="-1"></a>    r_temperature_path <span class="ot">&lt;-</span> <span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Temperature_rasters</span><span class="sc">\\</span><span class="st">&quot;</span>, name,<span class="st">&quot;.tiff&quot;</span>)</span>
<span id="cb73-48"><a href="thermal-conversion.html#cb73-48" tabindex="-1"></a>    </span>
<span id="cb73-49"><a href="thermal-conversion.html#cb73-49" tabindex="-1"></a>    <span class="co">#Use EXIFTOOL in terminal to add all remaining/missing exif data from the original H20T images to the new single band temperature TIFFS</span></span>
<span id="cb73-50"><a href="thermal-conversion.html#cb73-50" tabindex="-1"></a>    out_dir <span class="ot">&lt;-</span> <span class="fu">paste0</span>(dir,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>,merged,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Temperature_rasters_EXIF</span><span class="sc">\\</span><span class="st">&quot;</span>, name,<span class="st">&quot;.tiff&quot;</span>)</span>
<span id="cb73-51"><a href="thermal-conversion.html#cb73-51" tabindex="-1"></a>    <span class="fu">shell</span>(<span class="fu">paste0</span>(<span class="st">&quot;exiftool -wm cg -tagsfromfile &quot;</span>,r_h20t_path,<span class="st">&quot; -all:all &quot;</span>,r_temperature_path, <span class="st">&quot; -o &quot;</span>,out_dir)) <span class="co">#shell lets you run windows terminal cmds from R  </span></span>
<span id="cb73-52"><a href="thermal-conversion.html#cb73-52" tabindex="-1"></a>    }</span>
<span id="cb73-53"><a href="thermal-conversion.html#cb73-53" tabindex="-1"></a>  percent <span class="ot">&lt;-</span> i<span class="sc">/</span><span class="fu">length</span>(raw_list)<span class="sc">*</span><span class="dv">100</span></span>
<span id="cb73-54"><a href="thermal-conversion.html#cb73-54" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;percent complete: &quot;</span>, <span class="fu">round</span>(percent, <span class="dv">3</span>))) <span class="co">#gives you the % of photos done to give an idea of code speed/progress</span></span>
<span id="cb73-55"><a href="thermal-conversion.html#cb73-55" tabindex="-1"></a>}</span>
<span id="cb73-56"><a href="thermal-conversion.html#cb73-56" tabindex="-1"></a>end.time <span class="ot">&lt;-</span> <span class="fu">Sys.time</span>()</span>
<span id="cb73-57"><a href="thermal-conversion.html#cb73-57" tabindex="-1"></a>(time.taken <span class="ot">&lt;-</span> <span class="fu">round</span>(end.time <span class="sc">-</span> start.time,<span class="dv">2</span>)) <span class="co">#time taken for the script to run</span></span></code></pre></div>
</details>
<p>The output are single band thermal tiffs that can be loaded into metashape to create a thermal orthomosaic.</p>
</div>
<div id="examples" class="section level2 hasAnchor" number="14.5">
<h2><span class="header-section-number">14.5</span> Examples<a href="thermal-conversion.html#examples" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Below are two examples of data acquired using the H20T to show both the radiometric and spatial resolution of the H20T within the crowns as well as some important factors to keep in mind when interpreting crown temperatures.</p>
<p>Figure <a href="thermal-conversion.html#fig:2-crown-temp-NIR">14.1</a> shows the temperature and NIR values of two mature (~25 year old) Douglas-fir tree crowns, where the crowns delineate the upper 25th percentile of the tree, from a flight that occurred on July 27th, 2022 under heatdome conditions. These flights occurred in full sun conditions. Looking at the NIR plots, we can see shadowed areas (see chapter <a href="shadow-mask.html#shadow-mask">10</a> for shadow masking with NIR) towards the north east sides of both crowns. These shadowed areas roughly align with the areas of cooler temperature seen in the crown temperature plots. As you can see in the daily temperature plot on the left, the MicaSense flight occurred from 1:30-2:30pm and was followed by the thermal flight, flown with the H20T, from roughly 2:40-3:40pm. We see a greater area of cooler crown temperatures in the thermal imagery compared to the NIR proxy for shadow likely due to the increase in shadow from the MicaSense flight to the thermal flight as the solar zenith angle decreases into the afternoon.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:2-crown-temp-NIR"></span>
<img src="Photos_&_gifs/two_crown_nir_rgb_temp_graph.PNG" alt="Left: plot of hourly ambient tempatures from an on-site HOBO climate logger at Canoe for July 27th, 2022. Middle column: near-infrared (NIR) values for two Douglas-fir crowns aquired from a MicaSense flight flown directly before the thermal flight. Right column: temperature values within two mature Douglas-fir crowns flown under heatdome conditions. Pixels plotted for both the NIR and temperature rasters are those within a delineated crown representing the top 25th percentile of the tree." width="100%" />
<p class="caption">
Figure 14.1: Left: plot of hourly ambient tempatures from an on-site HOBO climate logger at Canoe for July 27th, 2022. Middle column: near-infrared (NIR) values for two Douglas-fir crowns aquired from a MicaSense flight flown directly before the thermal flight. Right column: temperature values within two mature Douglas-fir crowns flown under heatdome conditions. Pixels plotted for both the NIR and temperature rasters are those within a delineated crown representing the top 25th percentile of the tree.
</p>
</div>
<!-- # ```{r crown-temp, echo=FALSE, fig.show="hold",fig.align='center', out.width="50%", fig.cap = "Left: temperature values within a Douglas-fir crown flown under heat dome conditions (July 27th, 2022). Right: plot of hourly ambient tempatures from an on-site HOBO climate logger for July 27th, 2022, the grey vertical line is the time of the flight"} -->
<!-- # # Include the pre-brushing and post-brushing images -->
<!-- # knitr::include_graphics(c( -->
<!-- #   here("Photos_&_gifs/crown_temp_graph.png"), -->
<!-- #   here("Photos_&_gifs/Temperature_graph_for_crown_pic_2.png") -->
<!-- # )) -->
<!-- # ``` -->
<p>Figure <a href="thermal-conversion.html#fig:crown-temp-RGB">14.2</a> shows the temperature values for two young (~5 year old) Douglas-fir trees from an overcast day. Whereas we saw higher temperatures in areas with more direct light in Figure <a href="thermal-conversion.html#fig:2-crown-temp-NIR">14.1</a>, we see the opposite pattern below. This is likely due to the heat of the ground radiating (i.e. warming) the lower branches of the young trees which are in view given the relatively small crown sizes and lack of crown closure. This is an important factor to keep in mind when analyzing crown temperatures.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:crown-temp-RGB"></span>
<img src="Photos_&_gifs/Thermal_RGB_crowns.PNG" alt="Left: section of a P1 orthomosaic of W45 showing two neighbouring tree crowns. Right: temperature values for the two neighbouring young Douglas-fir." width="100%" />
<p class="caption">
Figure 14.2: Left: section of a P1 orthomosaic of W45 showing two neighbouring tree crowns. Right: temperature values for the two neighbouring young Douglas-fir.
</p>
</div>
<p>References:</p>
<p>Rubio, E., Caselles, V., &amp; Badenas, C. (1997). Emissivity measurements of several soils and vegetation types in the 8–14, μm Wave band: Analysis of two field methods. Remote Sensing of Environment, 59(3), 490–521. <a href="https://doi.org/10.1016/S0034-4257(96)00123-X" class="uri">https://doi.org/10.1016/S0034-4257(96)00123-X</a></p>
<!-- **Note**: We have run across an error in some imagery that we have copied below, we are in contact with DJI to look for a solution. -->
<!-- The error is as follows: -->
<!-- ERROR: call dirp_set_measurement_params failed -->
<!-- ERROR: call prv_isp_config failed -->
<!-- Test done with return code -6 -->

</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="micasense-irradiance-correction.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/owaite/GenomeBC_BPG/edit/main/0_Thermal_Conversion.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/owaite/GenomeBC_BPG/blob/main/0_Thermal_Conversion.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
