<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 12 MicaSense Irradiance Correction | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</title>
  <meta name="description" content="Chapter 12 MicaSense Irradiance Correction | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 12 MicaSense Irradiance Correction | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 12 MicaSense Irradiance Correction | Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials" />
  
  
  

<meta name="author" content="Jake King*, Olivia Waite, Miriam Isaac-Renton, Nicholas C. Coops, Samuel Grubinger, Liam Irwin, Lise Van Der Merwe, Jon Degner, Alex Liu" />



  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="lidar-processing-workflow.html"/>
<link rel="next" href="Thermal-Conversion.html"/>
<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Drone Based Phenotyping for Research Trials</a></li>

<li class="divider"></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</a>
<ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#github-link"><i class="fa fa-check"></i>GitHub link</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#acknowledgements"><i class="fa fa-check"></i>Acknowledgements</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-cite-this-report"><i class="fa fa-check"></i>How to cite this report:</a></li>
</ul></li>
<li class="chapter" data-level="1" data-path="abstract.html"><a href="abstract.html"><i class="fa fa-check"></i><b>1</b> Abstract</a></li>
<li class="chapter" data-level="2" data-path="background-and-basis-of-knowledge.html"><a href="background-and-basis-of-knowledge.html"><i class="fa fa-check"></i><b>2</b> Background and basis of knowledge</a></li>
<li class="chapter" data-level="3" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html"><i class="fa fa-check"></i><b>3</b> Range of Sites Assessed</a>
<ul>
<li class="chapter" data-level="3.1" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#jordan-river"><i class="fa fa-check"></i><b>3.1</b> Jordan River</a></li>
<li class="chapter" data-level="3.2" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#powell-river"><i class="fa fa-check"></i><b>3.2</b> Powell River</a></li>
<li class="chapter" data-level="3.3" data-path="range-of-sites-assessed.html"><a href="range-of-sites-assessed.html#sites"><i class="fa fa-check"></i><b>3.3</b> 2024 Sites</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="preflight-planning.html"><a href="preflight-planning.html"><i class="fa fa-check"></i><b>4</b> Preflight Planning</a>
<ul>
<li class="chapter" data-level="4.1" data-path="preflight-planning.html"><a href="preflight-planning.html#achieving-positional-accuracy-on-multi-temporal-and-multi-sensor-data-collections"><i class="fa fa-check"></i><b>4.1</b> Achieving positional accuracy on multi-temporal and multi-sensor data collections</a>
<ul>
<li class="chapter" data-level="4.1.1" data-path="preflight-planning.html"><a href="preflight-planning.html#kinematic-processing-rtkppk"><i class="fa fa-check"></i><b>4.1.1</b> Kinematic processing: RTK/PPK</a></li>
<li class="chapter" data-level="4.1.2" data-path="preflight-planning.html"><a href="preflight-planning.html#ground-control-points-gcp"><i class="fa fa-check"></i><b>4.1.2</b> Ground Control Points (GCP)</a></li>
<li class="chapter" data-level="4.1.3" data-path="preflight-planning.html"><a href="preflight-planning.html#absolute-and-relative-reference-with-precise-point-positioning-ppp"><i class="fa fa-check"></i><b>4.1.3</b> Absolute and Relative Reference with Precise Point Positioning (PPP)</a></li>
<li class="chapter" data-level="4.1.4" data-path="preflight-planning.html"><a href="preflight-planning.html#terrain-following-on-sites-with-elevation-change"><i class="fa fa-check"></i><b>4.1.4</b> Terrain Following on Sites with Elevation Change</a></li>
</ul></li>
<li class="chapter" data-level="4.2" data-path="preflight-planning.html"><a href="preflight-planning.html#site-selection-considerations"><i class="fa fa-check"></i><b>4.2</b> Site Selection Considerations</a></li>
<li class="chapter" data-level="4.3" data-path="preflight-planning.html"><a href="preflight-planning.html#drone-and-sensors-what-will-i-need-to-purchase-and-how-much-will-it-cost"><i class="fa fa-check"></i><b>4.3</b> Drone and Sensors: What will I need to purchase and how much will it cost?</a>
<ul>
<li class="chapter" data-level="4.3.1" data-path="preflight-planning.html"><a href="preflight-planning.html#hardware-costs"><i class="fa fa-check"></i><b>4.3.1</b> Hardware Costs</a></li>
<li class="chapter" data-level="4.3.2" data-path="preflight-planning.html"><a href="preflight-planning.html#drone-training-in-canada"><i class="fa fa-check"></i><b>4.3.2</b> Drone Training in Canada</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html"><i class="fa fa-check"></i><b>5</b> Data Collection and Flights</a>
<ul>
<li class="chapter" data-level="5.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#hardware---dji-matrice-3000-rtk-m300"><i class="fa fa-check"></i><b>5.1</b> Hardware - DJI Matrice 3000 RTK (M300)</a></li>
<li class="chapter" data-level="5.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#battery-management"><i class="fa fa-check"></i><b>5.2</b> Battery Management</a></li>
<li class="chapter" data-level="5.3" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#workflow-site-reconnaissance"><i class="fa fa-check"></i><b>5.3</b> Workflow: Site Reconnaissance</a></li>
<li class="chapter" data-level="5.4" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#data-collection-flight-planning"><i class="fa fa-check"></i><b>5.4</b> Data Collection: Flight Planning</a>
<ul>
<li class="chapter" data-level="5.4.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#flight-planning-theory"><i class="fa fa-check"></i><b>5.4.1</b> Flight planning theory</a></li>
<li class="chapter" data-level="5.4.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#flight-planning-with-dji-pilot"><i class="fa fa-check"></i><b>5.4.2</b> Flight planning with DJI Pilot</a></li>
</ul></li>
<li class="chapter" data-level="5.5" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#data-collection-sensors-parameters-and-ideal-conditions"><i class="fa fa-check"></i><b>5.5</b> Data Collection: Sensors, Parameters, and Ideal Conditions</a>
<ul>
<li class="chapter" data-level="5.5.1" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#micasense-10-band-spectral-sensor-for-vegetative-indices"><i class="fa fa-check"></i><b>5.5.1</b> MicaSense: 10-Band Spectral Sensor for Vegetative Indices</a></li>
<li class="chapter" data-level="5.5.2" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-p1-high-quality-natural-colour-rgb-imagery"><i class="fa fa-check"></i><b>5.5.2</b> Zenmuse P1: High-Quality Natural-Colour (RGB) Imagery</a></li>
<li class="chapter" data-level="5.5.3" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-l1-lidar-and-rgb"><i class="fa fa-check"></i><b>5.5.3</b> Zenmuse L1: LiDAR and RGB</a></li>
<li class="chapter" data-level="5.5.4" data-path="data-collection-and-flights.html"><a href="data-collection-and-flights.html#zenmuse-h20t-thermal-and-rgb"><i class="fa fa-check"></i><b>5.5.4</b> Zenmuse H20T: Thermal and RGB</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="processing-orthomosaics.html"><a href="processing-orthomosaics.html"><i class="fa fa-check"></i><b>6</b> Agisoft Photogrammetry pipeline</a>
<ul>
<li class="chapter" data-level="6.1" data-path="processing-orthomosaics.html"><a href="processing-orthomosaics.html#overview."><i class="fa fa-check"></i><b>6.1</b> Overview.</a></li>
<li class="chapter" data-level="6.2" data-path="processing-orthomosaics.html"><a href="processing-orthomosaics.html#detailed-workflow"><i class="fa fa-check"></i><b>6.2</b> Detailed Workflow</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="Georeferencing-Plot-Trees.html"><a href="Georeferencing-Plot-Trees.html"><i class="fa fa-check"></i><b>7</b> Georeferencing Plot Trees</a>
<ul>
<li class="chapter" data-level="7.1" data-path="Georeferencing-Plot-Trees.html"><a href="Georeferencing-Plot-Trees.html#workflow-in-qgis"><i class="fa fa-check"></i><b>7.1</b> Workflow in QGIS</a></li>
<li class="chapter" data-level="7.2" data-path="Georeferencing-Plot-Trees.html"><a href="Georeferencing-Plot-Trees.html#alternate-workflow-in-r"><i class="fa fa-check"></i><b>7.2</b> Alternate Workflow in R</a></li>
<li class="chapter" data-level="7.3" data-path="Georeferencing-Plot-Trees.html"><a href="Georeferencing-Plot-Trees.html#final-steps-in-qgis"><i class="fa fa-check"></i><b>7.3</b> Final Steps in QGIS</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="crown-delineation.html"><a href="crown-delineation.html"><i class="fa fa-check"></i><b>8</b> Crown Delineation</a>
<ul>
<li class="chapter" data-level="8.1" data-path="crown-delineation.html"><a href="crown-delineation.html#circles-proportional-to-tree-height"><i class="fa fa-check"></i><b>8.1</b> Circles Proportional to Tree Height</a></li>
<li class="chapter" data-level="8.2" data-path="crown-delineation.html"><a href="crown-delineation.html#supercell-raster"><i class="fa fa-check"></i><b>8.2</b> Supercell Raster</a></li>
<li class="chapter" data-level="8.3" data-path="crown-delineation.html"><a href="crown-delineation.html#filter-merge-supercells"><i class="fa fa-check"></i><b>8.3</b> Filter &amp; Merge Supercells</a></li>
<li class="chapter" data-level="8.4" data-path="crown-delineation.html"><a href="crown-delineation.html#manually-edit-crowns"><i class="fa fa-check"></i><b>8.4</b> Manually Edit Crowns</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="shadow-mask.html"><a href="shadow-mask.html"><i class="fa fa-check"></i><b>9</b> Shadow Masks</a></li>
<li class="chapter" data-level="10" data-path="crown-level-vegetation-indicies-vegetation-indicies.html"><a href="crown-level-vegetation-indicies-vegetation-indicies.html"><i class="fa fa-check"></i><b>10</b> Crown-level Vegetation Indicies {Vegetation-Indicies}</a>
<ul>
<li class="chapter" data-level="10.1" data-path="crown-level-vegetation-indicies-vegetation-indicies.html"><a href="crown-level-vegetation-indicies-vegetation-indicies.html#vi-workflow"><i class="fa fa-check"></i><b>10.1</b> VI Workflow</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html"><i class="fa fa-check"></i><b>11</b> LiDAR Processing Workflow</a>
<ul>
<li class="chapter" data-level="11.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#dji-terra"><i class="fa fa-check"></i><b>11.1</b> DJI Terra</a></li>
<li class="chapter" data-level="11.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#register-the-lidar-to-the-dap-point-cloud"><i class="fa fa-check"></i><b>11.2</b> Register the LiDAR to the DAP point cloud</a>
<ul>
<li class="chapter" data-level="11.2.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#prepare-lidar-for-registration"><i class="fa fa-check"></i><b>11.2.1</b> Prepare LiDAR for registration</a></li>
<li class="chapter" data-level="11.2.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#register-lidar-to-dap-cloud-in-cloudcompare"><i class="fa fa-check"></i><b>11.2.2</b> Register LiDAR to DAP cloud in CloudCompare</a></li>
<li class="chapter" data-level="11.2.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#rescale-and-tile-the-registered-lidar"><i class="fa fa-check"></i><b>11.2.3</b> Rescale and tile the registered LiDAR:</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#normalization-and-individual-tree-point-clouds"><i class="fa fa-check"></i><b>11.3</b> Normalization and individual tree point clouds</a>
<ul>
<li class="chapter" data-level="11.3.1" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#creating-a-dtm-from-the-registered-lidar-tiles"><i class="fa fa-check"></i><b>11.3.1</b> Creating a DTM from the registered LiDAR tiles</a></li>
<li class="chapter" data-level="11.3.2" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#normalizing-the-tiles-using-the-dtm"><i class="fa fa-check"></i><b>11.3.2</b> Normalizing the tiles using the DTM</a></li>
<li class="chapter" data-level="11.3.3" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#creating-a-4cm-chm-from-the-max-z-values"><i class="fa fa-check"></i><b>11.3.3</b> Creating a 4cm CHM from the max Z values</a></li>
<li class="chapter" data-level="11.3.4" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#segmenting-tiles"><i class="fa fa-check"></i><b>11.3.4</b> Segmenting tiles</a></li>
<li class="chapter" data-level="11.3.5" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#merging-segmented-tiles-to-create-one-large-point-cloud-containing-the-top-defined-height-of-each-tree"><i class="fa fa-check"></i><b>11.3.5</b> Merging segmented tiles to create one large point cloud containing the top defined height % of each tree</a></li>
<li class="chapter" data-level="11.3.6" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#clipping-the-point-cloud-into-individual-point-clouds-per-tree"><i class="fa fa-check"></i><b>11.3.6</b> Clipping the point cloud into individual point clouds per tree</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="lidar-processing-workflow.html"><a href="lidar-processing-workflow.html#individual-tree-metrics"><i class="fa fa-check"></i><b>11.4</b> Individual Tree Metrics</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html"><i class="fa fa-check"></i><b>12</b> MicaSense Irradiance Correction</a>
<ul>
<li class="chapter" data-level="12.1" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#background"><i class="fa fa-check"></i><b>12.1</b> Background</a>
<ul>
<li class="chapter" data-level="12.1.1" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#deriving-horizontal-irradiance"><i class="fa fa-check"></i><b>12.1.1</b> Deriving Horizontal Irradiance</a></li>
<li class="chapter" data-level="12.1.2" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#calculating-reflectance"><i class="fa fa-check"></i><b>12.1.2</b> Calculating Reflectance</a></li>
</ul></li>
<li class="chapter" data-level="12.2" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#the-problem"><i class="fa fa-check"></i><b>12.2</b> The Problem</a></li>
<li class="chapter" data-level="12.3" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#is-correction-needed"><i class="fa fa-check"></i><b>12.3</b> Is Correction Needed?</a>
<ul>
<li class="chapter" data-level="12.3.1" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#do-the-sun-sensor-angles-make-sense"><i class="fa fa-check"></i><b>12.3.1</b> Do the sun sensor angles make sense?</a></li>
<li class="chapter" data-level="12.3.2" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#does-the-relationship-between-direct-and-horizontal-irradiance-make-sense"><i class="fa fa-check"></i><b>12.3.2</b> Does the relationship between direct and horizontal irradiance make sense?</a></li>
<li class="chapter" data-level="12.3.3" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#does-the-scattered-direct-ratio-make-sense-for-the-lighting-conditions-of-that-day"><i class="fa fa-check"></i><b>12.3.3</b> Does the scattered: direct ratio make sense for the lighting conditions of that day?</a></li>
</ul></li>
<li class="chapter" data-level="12.4" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#DLS1-correction"><i class="fa fa-check"></i><b>12.4</b> Correcting Irradiance Values for MicaSense Cameras</a>
<ul>
<li class="chapter" data-level="12.4.1" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#reading-exif-data"><i class="fa fa-check"></i><b>12.4.1</b> Reading Exif Data</a></li>
<li class="chapter" data-level="12.4.2" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#calculating-solar-zenith-anlge"><i class="fa fa-check"></i><b>12.4.2</b> Calculating Solar Zenith Anlge</a></li>
<li class="chapter" data-level="12.4.3" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#SSA-correction"><i class="fa fa-check"></i><b>12.4.3</b> Caluclating Sun-Sensor Angles</a></li>
<li class="chapter" data-level="12.4.4" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#scattereddirect-ratio-estimate"><i class="fa fa-check"></i><b>12.4.4</b> Scattered:Direct Ratio Estimate</a></li>
<li class="chapter" data-level="12.4.5" data-path="MicaSense-Irradiance-Correction.html"><a href="MicaSense-Irradiance-Correction.html#computing-horizontal-corrected-irradiance"><i class="fa fa-check"></i><b>12.4.5</b> Computing Horizontal (Corrected) Irradiance</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="13" data-path="Thermal-Conversion.html"><a href="Thermal-Conversion.html"><i class="fa fa-check"></i><b>13</b> Thermal Conversion</a>
<ul>
<li class="chapter" data-level="13.1" data-path="Thermal-Conversion.html"><a href="Thermal-Conversion.html#folder-set-up"><i class="fa fa-check"></i><b>13.1</b> Folder Set-Up</a></li>
<li class="chapter" data-level="13.2" data-path="Thermal-Conversion.html"><a href="Thermal-Conversion.html#weather-data"><i class="fa fa-check"></i><b>13.2</b> Weather Data</a></li>
<li class="chapter" data-level="13.3" data-path="Thermal-Conversion.html"><a href="Thermal-Conversion.html#dji-thermal-sdk-temperature-conversion"><i class="fa fa-check"></i><b>13.3</b> DJI Thermal SDK: temperature conversion</a>
<ul>
<li class="chapter" data-level="13.3.1" data-path="Thermal-Conversion.html"><a href="Thermal-Conversion.html#parameters"><i class="fa fa-check"></i><b>13.3.1</b> Parameters</a></li>
<li class="chapter" data-level="13.3.2" data-path="Thermal-Conversion.html"><a href="Thermal-Conversion.html#running-the-sdk"><i class="fa fa-check"></i><b>13.3.2</b> Running the SDK</a></li>
</ul></li>
<li class="chapter" data-level="13.4" data-path="Thermal-Conversion.html"><a href="Thermal-Conversion.html#convert-to-raster"><i class="fa fa-check"></i><b>13.4</b> Convert to Raster</a></li>
<li class="chapter" data-level="13.5" data-path="Thermal-Conversion.html"><a href="Thermal-Conversion.html#examples"><i class="fa fa-check"></i><b>13.5</b> Examples</a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Guidelines and Procedures for Drone Based Phenotyping in Forest Research Trials</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="MicaSense-Irradiance-Correction" class="section level1 hasAnchor" number="12">
<h1><span class="header-section-number">Chapter 12</span> MicaSense Irradiance Correction<a href="MicaSense-Irradiance-Correction.html#MicaSense-Irradiance-Correction" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="background" class="section level2 hasAnchor" number="12.1">
<h2><span class="header-section-number">12.1</span> Background<a href="MicaSense-Irradiance-Correction.html#background" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The MicaSense system measures radiance at the camera, which needs to be transformed into surface reflectance. The basic relationship is given by:</p>
<p><span class="math display">\[
R = \frac{L}{I_{\text{hor}}}
\]</span></p>
<p>where <span class="math inline">\(L\)</span> is the at-camera radiance and <span class="math inline">\(I_{\text{hor}}\)</span> is the horizontal irradiance.</p>
<div id="deriving-horizontal-irradiance" class="section level3 hasAnchor" number="12.1.1">
<h3><span class="header-section-number">12.1.1</span> Deriving Horizontal Irradiance<a href="MicaSense-Irradiance-Correction.html#deriving-horizontal-irradiance" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Below we go through the derivation to compute <span class="math inline">\(I_{\text{hor}}\)</span>.</p>
<p>The MicaSense system includes both the cameras and a downwelling light sensor (DLS). Since the DLS is tilted at the angle of the drone during flight and the sun is rarely directly overheard the sensor, the DLS measures non-horizontal irradiance, referred to as spectral irradiance (<span class="math inline">\(I_{\text{spec}}\)</span>). Spectral irradiance is a function of direct irradiance (<span class="math inline">\(I_{\text{direct}}\)</span>), scattered irradiance (<span class="math inline">\(I_{\text{scattered}}\)</span>), and the angle between the sun and the sensor ( <span class="math inline">\(\theta_{\text{sun-sensor}}\)</span>):</p>
<p><span class="math display">\[
I_{\text{spec}} = I_{\text{direct}} \cdot \cos(\theta_{\text{sun-sensor}}) + I_{\text{scattered}}
\]</span></p>
<p>If we take <span class="math inline">\(r\)</span> to be the ratio of scattered to direct irradiance, <span class="math inline">\(r = \frac{I_{\text{scattered}}}{I_{\text{direct}}}\)</span>, we can substitute <span class="math inline">\(I_{\text{scattered}} = r \cdot I_{\text{direct}}\)</span> into the equation:</p>
<p><span class="math display">\[
I_{\text{spec}} = I_{\text{direct}} \cdot \cos(\theta_{\text{sun-sensor}}) + r \cdot I_{\text{direct}}
\]</span></p>
<p>Next, by factoring out <span class="math inline">\(I_{\text{direct}}\)</span> from the equation:</p>
<p><span class="math display">\[
I_{\text{spec}} = I_{\text{direct}} \cdot \left( \cos(\theta_{\text{sun-sensor}}) + r \right)
\]</span></p>
<p>We can solve for <span class="math inline">\(I_{\text{direct}}\)</span> by dividing both sides of the equation by <span class="math inline">\(\cos(\theta_{\text{sun-sensor}}) + r\)</span>:</p>
<p><span class="math display">\[
I_{\text{direct}} = \frac{I_{\text{spec}}}{\cos(\theta_{\text{sun-sensor}}) + r}
\]</span></p>
<p>If we assume that <span class="math inline">\(I_{\text{hor}}\)</span> can be expressed in terms of <span class="math inline">\(I_{\text{direct}}\)</span> with a similar function as seen above for <span class="math inline">\(I_{\text{spec}}\)</span> however using the zenith angle, we can express this as:</p>
<p><span class="math display">\[
I_{\text{hor}} = I_{\text{direct}} \cdot \left( \cos(\theta_{\text{zenith}}) + r \right)
\]</span></p>
<p>Substituting the equation for <span class="math inline">\(I_{\text{direct}}\)</span> into the equation for <span class="math inline">\(I_{\text{hor}}\)</span> gives:</p>
<p><span class="math display">\[
I_{\text{hor}} = \frac{I_{\text{spec}}}{\cos(\theta_{\text{sun-sensor}}) + r} \cdot \left( \cos(\theta_{\text{zenith}}) + r \right)
\]</span></p>
</div>
<div id="calculating-reflectance" class="section level3 hasAnchor" number="12.1.2">
<h3><span class="header-section-number">12.1.2</span> Calculating Reflectance<a href="MicaSense-Irradiance-Correction.html#calculating-reflectance" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Finally, substituting <span class="math inline">\(I_{\text{hor}}\)</span> into the equation for reflectance, we obtain:</p>
<p><span class="math display">\[
R = L \cdot \frac{\cos(\theta_{\text{sun-sensor}}) + r}{I_{\text{spec}} \cdot \left( \cos(\theta_{\text{zenith}}) + r \right)}
\]</span></p>
<p>Thus we see that reflectance is highly dependent on the ratio of scattered to direct irradiance as well as the sun-sensor angle. This is important for understanding the issue we have found when working with the DLS2 and the MicaSense MX Dual camera system.</p>
</div>
</div>
<div id="the-problem" class="section level2 hasAnchor" number="12.2">
<h2><span class="header-section-number">12.2</span> The Problem<a href="MicaSense-Irradiance-Correction.html#the-problem" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The issue we have noticed is that the sun-sensor angle can be absurdly high or low, especially in strong illumination conditions. This leads to equally absurd, sometimes impossible, values for direct and scattered irradiance, that can be multiples higher than the direct solar irradiance.</p>
<p>To begin, let us first look at some main differences between the legacy DLS1 and the current DLS2 system.</p>
<p>The DLS1:</p>
<ul>
<li><p>calculates the sun zenith angle using the GPS location of the drone and the time of acquisition</p></li>
<li><p>calculates the sun-sensor angle from the yaw/pitch/roll of the drone</p></li>
</ul>
<p>The DLS2:</p>
<ul>
<li>directly measures the sun sensor angle and the direct and diffuse irradiance components using a proprietary method that takes in information from the light sensors on the surface of the DSL2</li>
</ul>
</div>
<div id="is-correction-needed" class="section level2 hasAnchor" number="12.3">
<h2><span class="header-section-number">12.3</span> Is Correction Needed?<a href="MicaSense-Irradiance-Correction.html#is-correction-needed" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Deciding whether data needs to be corrected can be challenging. We have found that looking at these three questions can be helpful:</p>
<p><em>1) Do the sun sensor angles make sense?</em></p>
<p><em>2) Does the relationship between direct and horizontal irradiance make sense?</em></p>
<p><em>3) Does the scattered: direct ratio look right for the lighting conditions of that day?</em></p>
<p>Below we have plotted the sun sensor angle (top left), the position of each photo (bottom left) and the irradiance values (right) from the exif data of MicaSense imagery captured on June 25th, 2024 on Vancouver Island in British Columbia, Canada (Figure <a href="MicaSense-Irradiance-Correction.html#fig:Irradiance-flight-lines">12.1</a>). We used yaw values to identify flight lines (blue and green) and roll to filter for images taken when the drone is turning (red). The black horizontal line is the calculated solar zenith angle at the time of the flight. This value was calculated using the latitude and longitude of the imagery and the time of day and was around 30°.</p>
<!-- ```{r Irradiance-flight-lines, echo=FALSE, out.width="100%", fig.align = 'center',fig.cap= " "} -->
<!-- knitr::include_graphics(here("Photos_&_gifs\\labelled_time_Irradiance_flight_lines_with_turning_all_with_spatial_plot_CROPPED.PNG")) -->
<!-- ``` -->
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:Irradiance-flight-lines"></span>
<img src="Photos_&_gifs/time_Irradiance_flight_lines_with_turning_all_with_spatial_plot_CROPPED.PNG" alt="The sun sensor angle (top left), position of each photo (bottom left) and direct, scattered, horizontal, and spectral irradiance values (right) taken from the exif data of MicaSense images captured on June 25th, 2024 on Vancouver Island, BC, Canada. Flight line direction (blue and green) was identified using yaw values  and images taken while the drone was turning were identified using roll (red)." width="100%" />
<p class="caption">
Figure 12.1: The sun sensor angle (top left), position of each photo (bottom left) and direct, scattered, horizontal, and spectral irradiance values (right) taken from the exif data of MicaSense images captured on June 25th, 2024 on Vancouver Island, BC, Canada. Flight line direction (blue and green) was identified using yaw values and images taken while the drone was turning were identified using roll (red).
</p>
</div>
<div id="do-the-sun-sensor-angles-make-sense" class="section level3 hasAnchor" number="12.3.1">
<h3><span class="header-section-number">12.3.1</span> Do the sun sensor angles make sense?<a href="MicaSense-Irradiance-Correction.html#do-the-sun-sensor-angles-make-sense" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Solar zenith angle is the angle between the normal (vertical from the Earths surface) at the location of interest and the position of the sun. Given the tilt of the Earth, the solar zenith reaches its maximum (i.e. greatest angle between the sun and the normal to the Earths surface) in the winter, as the northern hemisphere is tilted away from the sun, and its minimum in the summer when the northern hemisphere is tilted towards the sun.</p>
<p>The solar zenith also changes throughout the day, with its minimum occurring at solar noon, a.k.a. when the sun is at its highest. This is why it is suggested to fly within ± 2 hours of solar noon to avoid shadows in your imagery.</p>
<p>Below we have graphed solar zenith angles over the winter solstice (December 24, 2024), summer solstice (June 21, 2024) and the date of the flight acquisition (June 25th, 2024) to demonstrate the daily and seasonal change in values (Figure <a href="MicaSense-Irradiance-Correction.html#fig:zenith-overview">12.2</a>).</p>
<p>The gray vertical bar highlights the flight time, which was just within the ± 2 hours of solar noon bounds and shows the solar zenith at around 30°, as we saw in Figure <a href="MicaSense-Irradiance-Correction.html#fig:Irradiance-flight-lines">12.1</a>.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:zenith-overview"></span>
<img src="Photos_&_gifs/Solar_zenith_solstice_flight.PNG" alt="Solar zenith values plotted over the winter solstice (December 24, 2024), summer solstice (June 21, 2024) and the date of the flight acquisition (June 25th, 2024). Vertical lines indicate solar noon for the winter solstice (blue), summer solstice (red), and the duration of the drone flight (grey)." width="100%" />
<p class="caption">
Figure 12.2: Solar zenith values plotted over the winter solstice (December 24, 2024), summer solstice (June 21, 2024) and the date of the flight acquisition (June 25th, 2024). Vertical lines indicate solar noon for the winter solstice (blue), summer solstice (red), and the duration of the drone flight (grey).
</p>
</div>
<p>Now that we’ve refreshed our understanding of the solar zenith, let’s dive into the sun sensor angle. The sun sensor angle is, as it sounds, the angle between the normal (perpendicular) of the sensor and the direction of the sun (Figure <a href="MicaSense-Irradiance-Correction.html#fig:SSA-diagram">12.3</a>). Given that drone flights occur relatively close to the ground compared to the distance from the Earth to the sun, this difference is often negligible. Therefore, the solar zenith angle can serve as a rough estimate of the sun sensor angle for a sensor that is parallel to the Earth’s surface - making it a helpful check to see if the sun sensor angle recorded by the DLS2 is within a reasonable range.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:SSA-diagram"></span>
<img src="Photos_&_gifs/SSA_verse_solarZenith_diagram.PNG" alt="Visual representation of the solar zenith angle (left) and the sun sensor angle (right)." width="100%" />
<p class="caption">
Figure 12.3: Visual representation of the solar zenith angle (left) and the sun sensor angle (right).
</p>
</div>
<p>However, drones often fly at an angle, which can cause a cyclical pattern in sun sensor angles depending on flight direction. For example, let’s take a look at Figure <a href="MicaSense-Irradiance-Correction.html#fig:SSA-flight-direction">12.4</a>. When the drone is flying in the general direction of the sun (left), the forward tilt of the drone mid-flight results in a smaller sun sensor angle compared to when the drone is flying away from the general direction of the sun, where the tilt of the drone away from the sun increases the sun sensor angle (right).</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:SSA-flight-direction"></span>
<img src="Photos_&_gifs/SSA_flight_direction_diagram.PNG" alt="Schematic illustrating the impact of drone tilt during flight on the sun sensor angle." width="100%" />
<p class="caption">
Figure 12.4: Schematic illustrating the impact of drone tilt during flight on the sun sensor angle.
</p>
</div>
<p>This pattern of sun sensor angle dependence on drone orientation relative to the sun can be seen for the June 25th flight. Figure <a href="MicaSense-Irradiance-Correction.html#fig:SSA-DSL2-data">12.5</a> shows the uncorrected sun sensor angles, derived from the DLS2 sensor located on the top of the drone, colored by flight line direction. Here red indicates turning and blue and green are opposite flight directions.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:SSA-DSL2-data"></span>
<img src="Photos_&_gifs/time_SSA_flightlines.PNG" alt="Sun sensor angles aquired from the DLS2 sensor colored by flight line direction." width="100%" />
<p class="caption">
Figure 12.5: Sun sensor angles aquired from the DLS2 sensor colored by flight line direction.
</p>
</div>
<p>Now that we understand the reason behind the cyclical pattern of the sun sensor angles, we can use the solar zenith value, plotted as the horizontal black line in Figure <a href="MicaSense-Irradiance-Correction.html#fig:SSA-DSL2-data">12.5</a>, to make an informed decision on whether or not the values need correcting.</p>
<p>To help this decision we recommend plotting the DLS2 sun sensor values and the sun sensor values calculated with the DLS1 method which will be referred to as the “corrected” values, see the section on <a href="MicaSense-Irradiance-Correction.html#SSA-correction">sun sensor anlge correction</a> for the correction method.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:SSA-DSL2-DLS1-data"></span>
<img src="Photos_&_gifs/SSA_DLS1_verse_DLS2.PNG" alt=" Sun sensor angles over the flight duration from the DLS2 (purple) and corrected to mimic the DLS1 method (orange). Horizontal lines indicate the moving averages for the DLS2 (purple) and DLS1 (orange), where the balack line is the solar zenith calculated from GPS longitude, latitude, and time." width="100%" />
<p class="caption">
Figure 12.6:  Sun sensor angles over the flight duration from the DLS2 (purple) and corrected to mimic the DLS1 method (orange). Horizontal lines indicate the moving averages for the DLS2 (purple) and DLS1 (orange), where the balack line is the solar zenith calculated from GPS longitude, latitude, and time.
</p>
</div>
<p>In Figure <a href="MicaSense-Irradiance-Correction.html#fig:SSA-DSL2-DLS1-data">12.6</a> the dashed horizontal lines are the moving averages of the sun sensor angles for the DLS1 and DLS2. Here the moving average of the sun sensor angles from the DLS2 is at times almost 10°lower than the solar zenith, whereas the moving average of the DLS1 (corrected method) is more or less consistently ~2-3° lower than the solar zenith.</p>
<p>Given this data, we would conclude that the DLS1 method provides more accurate sun sensor angles compared to the DLS2. We will now continue to look at irradiance to confirm if correction is needed.</p>
</div>
<div id="does-the-relationship-between-direct-and-horizontal-irradiance-make-sense" class="section level3 hasAnchor" number="12.3.2">
<h3><span class="header-section-number">12.3.2</span> Does the relationship between direct and horizontal irradiance make sense?<a href="MicaSense-Irradiance-Correction.html#does-the-relationship-between-direct-and-horizontal-irradiance-make-sense" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>First, lets define direct and horizontal irradiance with respect to the DLS:</p>
<p><strong>Direct Irradiance</strong>: The direct component of the sunlight reaching the sensor’s surface that is not being scattered. On a clear sunny day, this component is high.</p>
<p><strong>Scattered Irradiance</strong>: The sunlight that is scattered by particles in the atmosphere. This component is generally weaker on sunny days and higher on overcast days.</p>
<p><strong>Horiztonal Irradiance</strong>: The total irradiance on a horizontal surface, including both direct sunlight (projected onto the horizontal plane) and diffuse light. Hence, if the sun is directly above the sensor and it is a clear sunny day, the direct irradiance component will likely be quite close to the horizontal irradiance, however still lower given that horizontal irradiance includes diffuse light as well.</p>
<p>Below we have plotted the direct and horizontal irradiance from the DLS2 and values calculated with the DLS1 method (Figure <a href="MicaSense-Irradiance-Correction.html#fig:Irr-DSL2-DLS1-data">12.7</a> ). We can see that the direct irradiance from the DLS2 is greater than the horizontal irradiance, which is physically impossible. In contrast, the direct irradiance from the DLS1 method is approximately 50 W/m² less than the horizontal irradiance.</p>
<p>Explanations for the lower direct irradiance from the DLS1 compared to the horizontal irradiance include:</p>
<ul>
<li><p>The ~30° sun sensor angle, which reduces the effective direct component captured by the sensor.</p></li>
<li><p>The portion of scattered irradiance in the horizontal irradiance signal that is not included in the direct irradiance value.</p></li>
</ul>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:Irr-DSL2-DLS1-data"></span>
<img src="Photos_&_gifs/Hor_dir_irradiance_DLS1_v_DLS2.PNG" alt="Direct and horizontal irradiance values throughout the flight from the DLS2 (purple) and corrected DLS1 method (orange)." width="100%" />
<p class="caption">
Figure 12.7: Direct and horizontal irradiance values throughout the flight from the DLS2 (purple) and corrected DLS1 method (orange).
</p>
</div>
<p>From Figure <a href="MicaSense-Irradiance-Correction.html#fig:Irr-DSL2-DLS1-data">12.7</a>, we would recommend correcting the data using the DLS1 method outlined below</p>
</div>
<div id="does-the-scattered-direct-ratio-make-sense-for-the-lighting-conditions-of-that-day" class="section level3 hasAnchor" number="12.3.3">
<h3><span class="header-section-number">12.3.3</span> Does the scattered: direct ratio make sense for the lighting conditions of that day?<a href="MicaSense-Irradiance-Correction.html#does-the-scattered-direct-ratio-make-sense-for-the-lighting-conditions-of-that-day" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>For a clear sunny day around solar noon, direct radiation generally accounts for ~85% of the total insolation with scattered radiation accounting for the remaining ~15%. For a completely overcast day, scattered radiation contributes to 100% of solar radiation.<!-- https://www.ftexploring.com/solar-energy/direct-and-diffuse-radiation.htm --></p>
<p>Hence, for a clear sunny day in the summer a ratio of 1:6 scattered to direct irradiance is often used as an estimate. This means that direct irradiance is around 6 times stronger than the scattered irradiance.</p>
<p>Irradiance data plotted in Figure <a href="MicaSense-Irradiance-Correction.html#fig:Dir-Irr-DSL2-DLS1-data">12.8</a> from June 25th was captured on a sunny day with occasional light clouds.</p>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:Dir-Irr-DSL2-DLS1-data"></span>
<img src="Photos_&_gifs/Dir_Scat_irradiance_DLS1_v_DLS2.PNG" alt="Direct and scattered irradiance values throughout the duration of the flight from the DLS2 (purple) and corrected DLS1 method (orange)." width="100%" />
<p class="caption">
Figure 12.8: Direct and scattered irradiance values throughout the duration of the flight from the DLS2 (purple) and corrected DLS1 method (orange).
</p>
</div>
<p>The scattered: direct ratio for the data plotted in Figure <a href="MicaSense-Irradiance-Correction.html#fig:Dir-Irr-DSL2-DLS1-data">12.8</a> is ~0.09 for the DLS2 and ~0.46 for the DLS1.</p>
<p><strong>DLS2:</strong> The ratio of 0.09 scattered:direct components from the DSL2 states that the direct irradiance during the flight was ~11 times greater than the scattered irradiance, or in other words that 91% of the total radiation reaching the earth was direct radiation and 9% was scattered radiation.</p>
<p><strong>DLS1:</strong> The ratio of 0.46 scattered:direct components from the DLS1 states that the direct component was 2.17 times greater than the scattered component, hence 46% of the solar radiation was from the scattered component and the remaining 54% from the direct component.</p>
<p>Given that the flight on June 25th was flown just at the end of the 2 hour solar noon window under a sunny sky with the occasional cloud, we would assume that the scattered component would be greater than the minimum ~15% for fully clear skies at solar noon. Hence a value of 46% scattered radiation could be the result of extra scattering by the occasional clouds and a slight increase in scattering from a greater solar zenith angle. Overall the value of 0.46 is more logical than the value of 0.09, since 0.09 implies less scattered radiation than the generally accepted minimum scattered component percentage on a clear sunny day.</p>
<p>Overall, we recommend correcting this flight using the DLS1 method. The DLS1 corrections are done on individual photos, if the orthomosaic has already been built, you can re-upload the imagery, re-calibrate, and re-build the orthomosaic in metashape without needing to reprocess the dense cloud.</p>
</div>
</div>
<div id="DLS1-correction" class="section level2 hasAnchor" number="12.4">
<h2><span class="header-section-number">12.4</span> Correcting Irradiance Values for MicaSense Cameras<a href="MicaSense-Irradiance-Correction.html#DLS1-correction" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>This chapter explains the process of correcting irradiance values for MicaSense cameras using R. The correction involves several steps, including filtering and mutating data, calculating solar angles, and estimating scattered to direct light ratios. Each step is crucial for ensuring accurate irradiance readings, which are essential for downstream analyses. The code was taken largely from <a href="https://github.com/micasense/imageprocessing/blob/master/MicaSense%20Image%20Processing%20Tutorial%203.ipynb">MicaSense’s GitHub</a> and converted into R to use in our workflow.</p>
<p>To fix the sun-sensor angle and irradiance values we have taken the methodology used by the DLS1. The process involves:</p>
<ul>
<li><p>Using the GPS location and time of acquisition to determine the solar zenith angle, and the yaw/pitch/roll of the drone to determine the sun sensor angle</p></li>
<li><p>Generating a rolling regression of the relationship: <span class="math inline">\(I_{\text{spec}} = I_{\text{direct}} \cdot \cos(\theta_{\text{sun-sensor}}) + I_{\text{scattered}}\)</span> to determine the direct/ scattered irradiance ratio, <span class="math inline">\(r\)</span>, and only keeping realistic models with good fits</p></li>
<li><p>Computing the horizontal irradiance using <span class="math inline">\(I_{\text{hor}} = I_{\text{direct}} \cdot (cos(\theta_{\text{zenith}}) + r)\)</span></p></li>
<li><p>Editing the exif data of the images so that the imagery can be processed by Metashape with the corrected irradiance values</p></li>
</ul>
<div id="reading-exif-data" class="section level3 hasAnchor" number="12.4.1">
<h3><span class="header-section-number">12.4.1</span> Reading Exif Data<a href="MicaSense-Irradiance-Correction.html#reading-exif-data" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>First, we read in the exif data of the imagery we want to correct using the exifr package.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="MicaSense-Irradiance-Correction.html#cb43-1" tabindex="-1"></a><span class="co"># This code was written to be within a for loop that looped through many acquisition dates. Hence the path names used will be in the form &quot; paste0(dir, date,&quot;\\1_Data\\&quot;,MS_folder_name,&quot;\\&quot;...etc)&quot;. Change these path names to match your data</span></span>
<span id="cb43-2"><a href="MicaSense-Irradiance-Correction.html#cb43-2" tabindex="-1"></a><span class="fu">library</span>(exifr)</span>
<span id="cb43-3"><a href="MicaSense-Irradiance-Correction.html#cb43-3" tabindex="-1"></a>dir <span class="ot">&lt;-</span> <span class="st">&quot;directory to folder holding folders representing each flight aquisition date&quot;</span> <span class="co">#change to match your data</span></span>
<span id="cb43-4"><a href="MicaSense-Irradiance-Correction.html#cb43-4" tabindex="-1"></a>MS_folder_name <span class="ot">&lt;-</span> <span class="st">&quot;MicaSense&quot;</span> <span class="co">#change to match the name of your folder holding the folders of imagery from the MicaSense camera</span></span>
<span id="cb43-5"><a href="MicaSense-Irradiance-Correction.html#cb43-5" tabindex="-1"></a>band_length <span class="ot">&lt;-</span>  <span class="dv">10</span> <span class="co"># 10 bands for MicaSense RedEdge-MX Dual</span></span>
<span id="cb43-6"><a href="MicaSense-Irradiance-Correction.html#cb43-6" tabindex="-1"></a><span class="co">#Loops through bands</span></span>
<span id="cb43-7"><a href="MicaSense-Irradiance-Correction.html#cb43-7" tabindex="-1"></a> <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>band_length){ <span class="co"># bands 1 through 10 </span></span>
<span id="cb43-8"><a href="MicaSense-Irradiance-Correction.html#cb43-8" tabindex="-1"></a>   pics <span class="ot">=</span> <span class="fu">list.files</span>(<span class="fu">paste0</span>(dir, date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>), <span class="co">#path the original data that will NOT be written over</span></span>
<span id="cb43-9"><a href="MicaSense-Irradiance-Correction.html#cb43-9" tabindex="-1"></a>                     <span class="at">pattern =</span> <span class="fu">c</span>(<span class="fu">paste0</span>(<span class="st">&quot;IMG_...._&quot;</span>, j, <span class="st">&quot;.tif&quot;</span>), <span class="fu">paste0</span>(<span class="st">&quot;IMG_...._&quot;</span>, j, <span class="st">&quot;_&quot;</span>, <span class="st">&quot;.tif&quot;</span>)), <span class="at">recursive =</span> <span class="cn">TRUE</span>, </span>
<span id="cb43-10"><a href="MicaSense-Irradiance-Correction.html#cb43-10" tabindex="-1"></a>                     <span class="at">full.names =</span> <span class="cn">TRUE</span>) <span class="co"># list of directories to all images</span></span>
<span id="cb43-11"><a href="MicaSense-Irradiance-Correction.html#cb43-11" tabindex="-1"></a>        </span>
<span id="cb43-12"><a href="MicaSense-Irradiance-Correction.html#cb43-12" tabindex="-1"></a>  <span class="cf">if</span>(<span class="sc">!</span><span class="fu">dir.exists</span>(<span class="fu">paste0</span>(dir,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>))){ <span class="co">#creating CSV folders</span></span>
<span id="cb43-13"><a href="MicaSense-Irradiance-Correction.html#cb43-13" tabindex="-1"></a>      <span class="fu">dir.create</span>(<span class="fu">paste0</span>(dir,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>))}</span>
<span id="cb43-14"><a href="MicaSense-Irradiance-Correction.html#cb43-14" tabindex="-1"></a>        </span>
<span id="cb43-15"><a href="MicaSense-Irradiance-Correction.html#cb43-15" tabindex="-1"></a>  mask_images <span class="ot">&lt;-</span> <span class="fu">list.files</span>(<span class="fu">paste0</span>(dir,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">2_Inputs</span><span class="sc">\\</span><span class="st">metashape</span><span class="sc">\\</span><span class="st">MASKS</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>)) <span class="co">#path to folder with masks that are exported from metashape </span></span>
<span id="cb43-16"><a href="MicaSense-Irradiance-Correction.html#cb43-16" tabindex="-1"></a>  mask_img_names <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;_mask</span><span class="sc">\\</span><span class="st">.png$&quot;</span>, <span class="st">&quot;&quot;</span>, mask_images) <span class="co"># removes the suffix &quot;_mask.png&quot; from each element in the &#39;mask_images&#39; list, ie : IMG_0027_1_mask.png becomes : IMG_0027_1 </span></span>
<span id="cb43-17"><a href="MicaSense-Irradiance-Correction.html#cb43-17" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(<span class="st">&quot;example of mask name: &quot;</span>,mask_img_names[[<span class="dv">1</span>]])) <span class="co">#print to ensure your naming is correct, the list of mask_img_names will be used to identify panel images in the micasense image </span></span>
<span id="cb43-18"><a href="MicaSense-Irradiance-Correction.html#cb43-18" tabindex="-1"></a>  <span class="co"># Loops through images in each band</span></span>
<span id="cb43-19"><a href="MicaSense-Irradiance-Correction.html#cb43-19" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(pics)){ <span class="co">#for each image in MicaSense_Cleaned_save, one at a time</span></span>
<span id="cb43-20"><a href="MicaSense-Irradiance-Correction.html#cb43-20" tabindex="-1"></a>    pic <span class="ot">=</span> pics[i]</span>
<span id="cb43-21"><a href="MicaSense-Irradiance-Correction.html#cb43-21" tabindex="-1"></a>    pic_root <span class="ot">&lt;-</span> <span class="fu">gsub</span>(<span class="st">&quot;.*/(IMG_.*)(</span><span class="sc">\\</span><span class="st">.tif)$&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, pic)<span class="co"># The pattern captures the filename starting with &quot;IMG_&quot; and ending with &quot;.tif&quot;.Ie: IMG_0027_1.tiff becomes IMG_0027_1</span></span>
<span id="cb43-22"><a href="MicaSense-Irradiance-Correction.html#cb43-22" tabindex="-1"></a>    <span class="fu">print</span>(pic_root)</span>
<span id="cb43-23"><a href="MicaSense-Irradiance-Correction.html#cb43-23" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">substr</span>(pic_root,<span class="dv">11</span>,<span class="dv">11</span>) <span class="sc">==</span> <span class="st">&quot;0&quot;</span>){ <span class="co"># Distinguishes between _1 (band 1) and _10 (band 10), ie IMG_0027_1 verse IMG_0027_10</span></span>
<span id="cb43-24"><a href="MicaSense-Irradiance-Correction.html#cb43-24" tabindex="-1"></a>        band <span class="ot">=</span> <span class="fu">substr</span>(pic_root,<span class="dv">10</span>,<span class="dv">11</span>) <span class="co"># for _10</span></span>
<span id="cb43-25"><a href="MicaSense-Irradiance-Correction.html#cb43-25" tabindex="-1"></a>        } <span class="cf">else</span> {</span>
<span id="cb43-26"><a href="MicaSense-Irradiance-Correction.html#cb43-26" tabindex="-1"></a>          band <span class="ot">=</span> <span class="fu">substr</span>(pic_root,<span class="dv">10</span>,<span class="dv">10</span>) <span class="co"># for _1, _2, _3, ... _9 (bands 1-9)</span></span>
<span id="cb43-27"><a href="MicaSense-Irradiance-Correction.html#cb43-27" tabindex="-1"></a>          } </span>
<span id="cb43-28"><a href="MicaSense-Irradiance-Correction.html#cb43-28" tabindex="-1"></a>    img_exif <span class="ot">=</span> exifr<span class="sc">::</span><span class="fu">read_exif</span>(pic) <span class="co"># read the XMP data </span></span>
<span id="cb43-29"><a href="MicaSense-Irradiance-Correction.html#cb43-29" tabindex="-1"></a>    <span class="fu">print</span>(<span class="fu">paste0</span>(date, <span class="st">&quot; band &quot;</span>, j, <span class="st">&quot; &quot;</span>, i, <span class="st">&quot;/&quot;</span>, <span class="fu">length</span>(pics))) <span class="co"># keep track of progress</span></span>
<span id="cb43-30"><a href="MicaSense-Irradiance-Correction.html#cb43-30" tabindex="-1"></a>    </span>
<span id="cb43-31"><a href="MicaSense-Irradiance-Correction.html#cb43-31" tabindex="-1"></a>    <span class="co"># Creating df with same column names as exif data</span></span>
<span id="cb43-32"><a href="MicaSense-Irradiance-Correction.html#cb43-32" tabindex="-1"></a>    <span class="cf">if</span> (i <span class="sc">==</span> <span class="dv">1</span>){ <span class="co"># If it&#39;s the first image, make new df from XMP data </span></span>
<span id="cb43-33"><a href="MicaSense-Irradiance-Correction.html#cb43-33" tabindex="-1"></a>      exif_df <span class="ot">=</span> <span class="fu">as.data.frame</span>(img_exif)<span class="sc">%&gt;%</span></span>
<span id="cb43-34"><a href="MicaSense-Irradiance-Correction.html#cb43-34" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">panel_flag =</span> <span class="fu">ifelse</span>( <span class="fu">gsub</span>(<span class="st">&quot;.*/(IMG_.*)(</span><span class="sc">\\</span><span class="st">.tif)$&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, SourceFile) <span class="sc">%in%</span> mask_img_names, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="co"># Give a value of 1 if the pic root name is in the list of mask root names and is therefore a calibration panel, give 0 otherwise (ie not a panel) </span></span>
<span id="cb43-35"><a href="MicaSense-Irradiance-Correction.html#cb43-35" tabindex="-1"></a>      } <span class="cf">else</span> {   <span class="co"># Add each new image exif to dataframe</span></span>
<span id="cb43-36"><a href="MicaSense-Irradiance-Correction.html#cb43-36" tabindex="-1"></a>        exif_df <span class="ot">=</span> <span class="fu">merge</span>(exif_df, img_exif, <span class="at">by =</span> <span class="fu">intersect</span>(<span class="fu">names</span>(exif_df), <span class="fu">names</span>(img_exif)), <span class="at">all =</span> <span class="cn">TRUE</span>)<span class="sc">%&gt;%</span></span>
<span id="cb43-37"><a href="MicaSense-Irradiance-Correction.html#cb43-37" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">panel_flag =</span> <span class="fu">ifelse</span>( <span class="fu">gsub</span>(<span class="st">&quot;.*/(IMG_.*)(</span><span class="sc">\\</span><span class="st">.tif)$&quot;</span>, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1&quot;</span>, SourceFile) <span class="sc">%in%</span> mask_img_names, <span class="dv">1</span>, <span class="dv">0</span>)) <span class="co"># Give a value of 1 if the pic root name is in the list of mask root names and is therefore a calibration panel, give 0 otherwise (ie not a panel) </span></span>
<span id="cb43-38"><a href="MicaSense-Irradiance-Correction.html#cb43-38" tabindex="-1"></a>        }</span>
<span id="cb43-39"><a href="MicaSense-Irradiance-Correction.html#cb43-39" tabindex="-1"></a>    }</span>
<span id="cb43-40"><a href="MicaSense-Irradiance-Correction.html#cb43-40" tabindex="-1"></a>  <span class="fu">saveRDS</span>(exif_df, <span class="fu">paste0</span>(dir,date, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">XMP_data_&quot;</span>, date, <span class="st">&quot;_&quot;</span>, j, <span class="st">&quot;.rds&quot;</span>)) <span class="co"># save output for each band, set path</span></span>
<span id="cb43-41"><a href="MicaSense-Irradiance-Correction.html#cb43-41" tabindex="-1"></a>  <span class="co">#binding all bands into one dataframe</span></span>
<span id="cb43-42"><a href="MicaSense-Irradiance-Correction.html#cb43-42" tabindex="-1"></a>  <span class="cf">if</span> (j <span class="sc">==</span> <span class="dv">1</span>){</span>
<span id="cb43-43"><a href="MicaSense-Irradiance-Correction.html#cb43-43" tabindex="-1"></a>    df_full <span class="ot">=</span> exif_df</span>
<span id="cb43-44"><a href="MicaSense-Irradiance-Correction.html#cb43-44" tabindex="-1"></a>    }<span class="cf">else</span>{</span>
<span id="cb43-45"><a href="MicaSense-Irradiance-Correction.html#cb43-45" tabindex="-1"></a>      <span class="co"># Add missing columns to xmp_all and fill with NA values</span></span>
<span id="cb43-46"><a href="MicaSense-Irradiance-Correction.html#cb43-46" tabindex="-1"></a>      df_full<span class="ot">=</span> <span class="fu">rbind</span>(df_full, exif_df)</span>
<span id="cb43-47"><a href="MicaSense-Irradiance-Correction.html#cb43-47" tabindex="-1"></a>    }</span>
<span id="cb43-48"><a href="MicaSense-Irradiance-Correction.html#cb43-48" tabindex="-1"></a>  <span class="fu">saveRDS</span>(df_full, <span class="fu">paste0</span>(dir,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">XMP_data_&quot;</span>, date,<span class="st">&quot;_AllBands.rds&quot;</span>)) <span class="co">#.rds file containing the original exif data if all images for the flight</span></span>
<span id="cb43-49"><a href="MicaSense-Irradiance-Correction.html#cb43-49" tabindex="-1"></a> } </span></code></pre></div>
</details>
<!-- ```{r eval=FALSE, include=TRUE} -->
<!-- # This code was written to be within a for loop that looped through many acquisition dates. Hence the path names used will be in the form " paste0(dir, date,"\\1_Data\\",MS_folder_name,"\\"...etc)". Change these path names to match your data -->
<!-- library(exifr) -->
<!-- dir <- "directory to folder holding folders representing each flight aquisition date" #change to match your data -->
<!-- MS_folder_name <- "MicaSense" #change to match the name of your folder holding the folders of imagery from the MicaSense camera -->
<!-- band_length <-  10 # 10 bands for MicaSense RedEdge-MX Dual -->
<!-- #Loops through bands -->
<!--  for (j in 1:band_length){ # bands 1 through 10  -->
<!--    pics = list.files(paste0(dir, date,"\\1_Data\\",MS_folder_name,"\\"), #path the original data that will NOT be written over -->
<!--                      pattern = c(paste0("IMG_...._", j, ".tif"), paste0("IMG_...._", j, "_", ".tif")), recursive = TRUE,  -->
<!--                      full.names = TRUE) # list of directories to all images -->
<!--   if(!dir.exists(paste0(dir,date,"\\1_Data\\",MS_folder_name,"\\CSV\\"))){ #creating CSV folders -->
<!--       dir.create(paste0(dir,date,"\\1_Data\\",MS_folder_name,"\\CSV\\"))} -->
<!--   mask_images <- list.files(paste0(dir,date,"\\2_Inputs\\metashape\\MASKS\\",MS_folder_name,"\\")) #path to folder with masks that are exported from metashape  -->
<!--   mask_img_names <- gsub("_mask\\.png$", "", mask_images) # removes the suffix "_mask.png" from each element in the 'mask_images' list, ie : IMG_0027_1_mask.png becomes : IMG_0027_1  -->
<!--   print(paste0("example of mask name: ",mask_img_names[[1]])) #print to ensure your naming is correct, the list of mask_img_names will be used to identify panel images in the micasense image  -->
<!--   # Loops through images in each band -->
<!--   for (i in 1:length(pics)){ #for each image in MicaSense_Cleaned_save, one at a time -->
<!--     pic = pics[i] -->
<!--     pic_root <- gsub(".*/(IMG_.*)(\\.tif)$", "\\1", pic)# The pattern captures the filename starting with "IMG_" and ending with ".tif".Ie: IMG_0027_1.tiff becomes IMG_0027_1 -->
<!--     print(pic_root) -->
<!--     if (substr(pic_root,11,11) == "0"){ # Distinguishes between _1 (band 1) and _10 (band 10), ie IMG_0027_1 verse IMG_0027_10 -->
<!--         band = substr(pic_root,10,11) # for _10 -->
<!--         } else { -->
<!--           band = substr(pic_root,10,10) # for _1, _2, _3, ... _9 (bands 1-9) -->
<!--           }  -->
<!--     img_exif = exifr::read_exif(pic) # read the XMP data  -->
<!--     print(paste0(date, " band ", j, " ", i, "/", length(pics))) # keep track of progress -->
<!--     # Creating df with same column names as exif data -->
<!--     if (i == 1){ # If it's the first image, make new df from XMP data  -->
<!--       exif_df = as.data.frame(img_exif)%>% -->
<!--         mutate(panel_flag = ifelse( gsub(".*/(IMG_.*)(\\.tif)$", "\\1", SourceFile) %in% mask_img_names, 1, 0)) # Give a value of 1 if the pic root name is in the list of mask root names and is therefore a calibration panel, give 0 otherwise (ie not a panel)  -->
<!--       } else {   # Add each new image exif to dataframe -->
<!--         exif_df = merge(exif_df, img_exif, by = intersect(names(exif_df), names(img_exif)), all = TRUE)%>% -->
<!--           mutate(panel_flag = ifelse( gsub(".*/(IMG_.*)(\\.tif)$", "\\1", SourceFile) %in% mask_img_names, 1, 0)) # Give a value of 1 if the pic root name is in the list of mask root names and is therefore a calibration panel, give 0 otherwise (ie not a panel)  -->
<!--         } -->
<!--     } -->
<!--   saveRDS(exif_df, paste0(dir,date, "\\1_Data\\",MS_folder_name,"\\CSV\\XMP_data_", date, "_", j, ".rds")) # save output for each band, set path -->
<!--   #binding all bands into one dataframe -->
<!--   if (j == 1){ -->
<!--     df_full = exif_df -->
<!--     }else{ -->
<!--       # Add missing columns to xmp_all and fill with NA values -->
<!--       df_full= rbind(df_full, exif_df) -->
<!--     } -->
<!--   saveRDS(df_full, paste0(dir,date,"\\1_Data\\",MS_folder_name,"\\CSV\\XMP_data_", date,"_AllBands.rds")) #.rds file containing the original exif data if all images for the flight -->
<!--  }  -->
<!-- ``` -->
<p>Next, we read in the exif data extracted above for all bands.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="MicaSense-Irradiance-Correction.html#cb44-1" tabindex="-1"></a>xmp_all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(dir,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">XMP_data_&quot;</span>, date,<span class="st">&quot;_AllBands.rds&quot;</span>))</span></code></pre></div>
</details>
</div>
<div id="calculating-solar-zenith-anlge" class="section level3 hasAnchor" number="12.4.2">
<h3><span class="header-section-number">12.4.2</span> Calculating Solar Zenith Anlge<a href="MicaSense-Irradiance-Correction.html#calculating-solar-zenith-anlge" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Below we convert the DateTimeOrginal column from the exif data to a date object and use the date object and average lat and lon to calculate solar angle.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="MicaSense-Irradiance-Correction.html#cb45-1" tabindex="-1"></a>xmp_all_filtered <span class="ot">&lt;-</span> xmp_all <span class="sc">%&gt;%</span></span>
<span id="cb45-2"><a href="MicaSense-Irradiance-Correction.html#cb45-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date_time =</span> <span class="fu">ymd_hms</span>(DateTimeOriginal),</span>
<span id="cb45-3"><a href="MicaSense-Irradiance-Correction.html#cb45-3" tabindex="-1"></a>         <span class="at">BandName_Wavelength =</span> <span class="fu">paste0</span>(BandName, <span class="st">&quot;_&quot;</span>, CentralWavelength),</span>
<span id="cb45-4"><a href="MicaSense-Irradiance-Correction.html#cb45-4" tabindex="-1"></a>         <span class="at">Date =</span> <span class="fu">as.Date</span>(Date_time),</span>
<span id="cb45-5"><a href="MicaSense-Irradiance-Correction.html#cb45-5" tabindex="-1"></a>         <span class="at">Time =</span> <span class="fu">format</span>(Date_time, <span class="at">format =</span> <span class="st">&quot;%H:%M:%S&quot;</span>),</span>
<span id="cb45-6"><a href="MicaSense-Irradiance-Correction.html#cb45-6" tabindex="-1"></a>         <span class="at">img_name =</span> <span class="fu">str_split</span>(FileName, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.tif&quot;</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[, <span class="dv">1</span>],</span>
<span id="cb45-7"><a href="MicaSense-Irradiance-Correction.html#cb45-7" tabindex="-1"></a>         <span class="at">img_root =</span> <span class="fu">sub</span>(<span class="st">&quot;_(</span><span class="sc">\\</span><span class="st">d+)$&quot;</span>, <span class="st">&quot;&quot;</span>, img_name)) <span class="sc">%&gt;%</span></span>
<span id="cb45-8"><a href="MicaSense-Irradiance-Correction.html#cb45-8" tabindex="-1"></a>  <span class="fu">drop_na</span>(DateTimeOriginal) <span class="sc">%&gt;%</span> </span>
<span id="cb45-9"><a href="MicaSense-Irradiance-Correction.html#cb45-9" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb45-10"><a href="MicaSense-Irradiance-Correction.html#cb45-10" tabindex="-1"></a>    <span class="at">site_avg_lat =</span> <span class="fu">median</span>(GPSLatitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb45-11"><a href="MicaSense-Irradiance-Correction.html#cb45-11" tabindex="-1"></a>    <span class="at">site_avg_long =</span> <span class="fu">median</span>(GPSLongitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb45-12"><a href="MicaSense-Irradiance-Correction.html#cb45-12" tabindex="-1"></a>    <span class="at">solar_angle =</span> photobiology<span class="sc">::</span><span class="fu">sun_zenith_angle</span>(<span class="at">time =</span> <span class="fu">ymd_hms</span>(DateTimeOriginal),</span>
<span id="cb45-13"><a href="MicaSense-Irradiance-Correction.html#cb45-13" tabindex="-1"></a>                                                 <span class="at">geocode =</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">lon =</span> <span class="fu">unique</span>(site_avg_long),</span>
<span id="cb45-14"><a href="MicaSense-Irradiance-Correction.html#cb45-14" tabindex="-1"></a>                                                                          <span class="at">lat =</span> <span class="fu">unique</span>(site_avg_lat),</span>
<span id="cb45-15"><a href="MicaSense-Irradiance-Correction.html#cb45-15" tabindex="-1"></a>                                                                          <span class="at">address =</span> <span class="st">&quot;Greenwich&quot;</span>)))</span></code></pre></div>
</details>
<p>Next, we check for any missing timestamps in image metadata as this usually indicates that the image was not saved properly and can’t be opened which will throw errors later in the workflow. In our experience, these images are few and far between, so we remove them from the analysis. We recommend manually checking that the image is in fact corrupted before removing it from analysis.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="MicaSense-Irradiance-Correction.html#cb46-1" tabindex="-1"></a>missing_imgs <span class="ot">&lt;-</span> xmp_all[<span class="fu">is.na</span>(<span class="fu">as.Date</span>(xmp_all<span class="sc">$</span>CreateDate, <span class="at">format =</span> <span class="st">&quot;%Y:%m:%d&quot;</span>))]<span class="sc">$</span>FileName</span>
<span id="cb46-2"><a href="MicaSense-Irradiance-Correction.html#cb46-2" tabindex="-1"></a>missing_imgs_roots <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">&quot;_[^_]*$&quot;</span>, <span class="st">&quot;&quot;</span>, missing_imgs)</span>
<span id="cb46-3"><a href="MicaSense-Irradiance-Correction.html#cb46-3" tabindex="-1"></a></span>
<span id="cb46-4"><a href="MicaSense-Irradiance-Correction.html#cb46-4" tabindex="-1"></a>xmp_all_filtered_mis <span class="ot">&lt;-</span> xmp_all_filtered <span class="sc">%&gt;%</span> <span class="co">#removing images with missing date information</span></span>
<span id="cb46-5"><a href="MicaSense-Irradiance-Correction.html#cb46-5" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>FileName <span class="sc">%in%</span> <span class="fu">c</span>(missing_imgs))</span></code></pre></div>
</details>
<!-- ````{=html} -->
<!-- <!-- -->
<!-- ### Caluclating DNI -->
<!-- The solar position and irradiance values are necessary to understand whether or not DLS acquired values are reasonable. We calculate the direct normal irradaiance using the average latitude and longitude from the GPS coordinates of the imagery and the time of the acquisition.  -->
<!-- ```{r eval=FALSE, include=TRUE} -->
<!-- (lat <- unique(xmp_all_filtered$site_avg_lat)) -->
<!-- (lon <- unique(xmp_all_filtered$site_avg_long)) -->
<!-- (time <- mean(xmp_all_filtered$Date_time, na.rm = TRUE)) -->
<!-- sun_pos <- getSunlightPosition(date = time, lat = lat, lon = lon) -->
<!-- elevation_angle <- sun_pos$altitude -->
<!-- turbidity <- 2.5 -->
<!-- solar_constant <- 1367 -->
<!-- air_mass <- 1 / cos(pi/2 - elevation_angle) -->
<!-- dni <- solar_constant * exp(-0.2 * air_mass * turbidity) -->
<!-- print(dni) -->
<!-- ``` -->
</div>
<div id="SSA-correction" class="section level3 hasAnchor" number="12.4.3">
<h3><span class="header-section-number">12.4.3</span> Caluclating Sun-Sensor Angles<a href="MicaSense-Irradiance-Correction.html#SSA-correction" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we show the difference between the archived DLS1 method and the current DLS2 method.</p>
<p><em>DSL1:</em> The following code has been taken from <a href="https://github.com/micasense/imageprocessing/blob/master/MicaSense%20Image%20Processing%20Tutorial%203.ipynb">MicaSense’s GitHub</a> and coded in R to match our workflow</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="MicaSense-Irradiance-Correction.html#cb47-1" tabindex="-1"></a>compute_sun_angle <span class="ot">&lt;-</span> <span class="cf">function</span>(SolarElevation, SolarAzimuth, Roll, Pitch, Yaw) {</span>
<span id="cb47-2"><a href="MicaSense-Irradiance-Correction.html#cb47-2" tabindex="-1"></a>    ori <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb47-3"><a href="MicaSense-Irradiance-Correction.html#cb47-3" tabindex="-1"></a>    SolarElevation <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(SolarElevation)</span>
<span id="cb47-4"><a href="MicaSense-Irradiance-Correction.html#cb47-4" tabindex="-1"></a>    SolarAzimuth <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(SolarAzimuth)</span>
<span id="cb47-5"><a href="MicaSense-Irradiance-Correction.html#cb47-5" tabindex="-1"></a>    Roll <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(Roll)</span>
<span id="cb47-6"><a href="MicaSense-Irradiance-Correction.html#cb47-6" tabindex="-1"></a>    Pitch <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(Pitch)</span>
<span id="cb47-7"><a href="MicaSense-Irradiance-Correction.html#cb47-7" tabindex="-1"></a>    Yaw <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(Yaw)</span>
<span id="cb47-8"><a href="MicaSense-Irradiance-Correction.html#cb47-8" tabindex="-1"></a>  </span>
<span id="cb47-9"><a href="MicaSense-Irradiance-Correction.html#cb47-9" tabindex="-1"></a>    elements <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">cos</span>(SolarAzimuth) <span class="sc">*</span> <span class="fu">cos</span>(SolarElevation),</span>
<span id="cb47-10"><a href="MicaSense-Irradiance-Correction.html#cb47-10" tabindex="-1"></a>                  <span class="fu">sin</span>(SolarAzimuth) <span class="sc">*</span> <span class="fu">cos</span>(SolarElevation),</span>
<span id="cb47-11"><a href="MicaSense-Irradiance-Correction.html#cb47-11" tabindex="-1"></a>                  <span class="sc">-</span><span class="fu">sin</span>(SolarElevation))</span>
<span id="cb47-12"><a href="MicaSense-Irradiance-Correction.html#cb47-12" tabindex="-1"></a>  </span>
<span id="cb47-13"><a href="MicaSense-Irradiance-Correction.html#cb47-13" tabindex="-1"></a>    nSun <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">matrix</span>(elements, <span class="at">ncol =</span> <span class="dv">3</span>))</span>
<span id="cb47-14"><a href="MicaSense-Irradiance-Correction.html#cb47-14" tabindex="-1"></a>  </span>
<span id="cb47-15"><a href="MicaSense-Irradiance-Correction.html#cb47-15" tabindex="-1"></a>    c1 <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="sc">-</span>Yaw)</span>
<span id="cb47-16"><a href="MicaSense-Irradiance-Correction.html#cb47-16" tabindex="-1"></a>    s1 <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="sc">-</span>Yaw)</span>
<span id="cb47-17"><a href="MicaSense-Irradiance-Correction.html#cb47-17" tabindex="-1"></a>    c2 <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="sc">-</span>Pitch)</span>
<span id="cb47-18"><a href="MicaSense-Irradiance-Correction.html#cb47-18" tabindex="-1"></a>    s2 <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="sc">-</span>Pitch)</span>
<span id="cb47-19"><a href="MicaSense-Irradiance-Correction.html#cb47-19" tabindex="-1"></a>    c3 <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="sc">-</span>Roll)</span>
<span id="cb47-20"><a href="MicaSense-Irradiance-Correction.html#cb47-20" tabindex="-1"></a>    s3 <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="sc">-</span>Roll)</span>
<span id="cb47-21"><a href="MicaSense-Irradiance-Correction.html#cb47-21" tabindex="-1"></a>  </span>
<span id="cb47-22"><a href="MicaSense-Irradiance-Correction.html#cb47-22" tabindex="-1"></a>    Ryaw <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(c1, s1, <span class="dv">0</span>, <span class="sc">-</span>s1, c1, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-23"><a href="MicaSense-Irradiance-Correction.html#cb47-23" tabindex="-1"></a>    Rpitch <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(c2, <span class="dv">0</span>, <span class="sc">-</span>s2, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, s2, <span class="dv">0</span>, c2), <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-24"><a href="MicaSense-Irradiance-Correction.html#cb47-24" tabindex="-1"></a>    Rroll <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, c3, s3, <span class="dv">0</span>, <span class="sc">-</span>s3, c3), <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb47-25"><a href="MicaSense-Irradiance-Correction.html#cb47-25" tabindex="-1"></a>  </span>
<span id="cb47-26"><a href="MicaSense-Irradiance-Correction.html#cb47-26" tabindex="-1"></a>    R_sensor <span class="ot">&lt;-</span> Ryaw <span class="sc">%*%</span> Rpitch <span class="sc">%*%</span> Rroll</span>
<span id="cb47-27"><a href="MicaSense-Irradiance-Correction.html#cb47-27" tabindex="-1"></a>    nSensor <span class="ot">&lt;-</span> R_sensor <span class="sc">%*%</span> ori</span>
<span id="cb47-28"><a href="MicaSense-Irradiance-Correction.html#cb47-28" tabindex="-1"></a>  </span>
<span id="cb47-29"><a href="MicaSense-Irradiance-Correction.html#cb47-29" tabindex="-1"></a>    angle <span class="ot">&lt;-</span> <span class="fu">acos</span>(<span class="fu">sum</span>(nSun <span class="sc">*</span> nSensor))</span>
<span id="cb47-30"><a href="MicaSense-Irradiance-Correction.html#cb47-30" tabindex="-1"></a>    <span class="fu">return</span>(angle)</span>
<span id="cb47-31"><a href="MicaSense-Irradiance-Correction.html#cb47-31" tabindex="-1"></a>}</span>
<span id="cb47-32"><a href="MicaSense-Irradiance-Correction.html#cb47-32" tabindex="-1"></a></span>
<span id="cb47-33"><a href="MicaSense-Irradiance-Correction.html#cb47-33" tabindex="-1"></a>SSA_xmp_all_filtered <span class="ot">&lt;-</span> xmp_all_filtered <span class="sc">%&gt;%</span></span>
<span id="cb47-34"><a href="MicaSense-Irradiance-Correction.html#cb47-34" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb47-35"><a href="MicaSense-Irradiance-Correction.html#cb47-35" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SunSensorAngle_DLS1_rad =</span> <span class="fu">compute_sun_angle</span>(SolarElevation, SolarAzimuth, Roll, Pitch, Yaw),</span>
<span id="cb47-36"><a href="MicaSense-Irradiance-Correction.html#cb47-36" tabindex="-1"></a>         <span class="at">SunSensorAngle_DLS1_deg =</span> SunSensorAngle_DLS1_rad <span class="sc">*</span> <span class="dv">180</span> <span class="sc">/</span> pi)</span>
<span id="cb47-37"><a href="MicaSense-Irradiance-Correction.html#cb47-37" tabindex="-1"></a></span>
<span id="cb47-38"><a href="MicaSense-Irradiance-Correction.html#cb47-38" tabindex="-1"></a><span class="fu">saveRDS</span>(SSA_xmp_all_filtered,<span class="fu">paste0</span>(dir,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">XMP_&quot;</span>, date,<span class="st">&quot;_with_SSA.rds&quot;</span>)) <span class="co">#Save XMP rds file with sun sensor angle added</span></span></code></pre></div>
</details>
<p><em>DLS2:</em></p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="MicaSense-Irradiance-Correction.html#cb48-1" tabindex="-1"></a>SSA_xmp_all_filtered<span class="sc">$</span>SunSensorAngle_DLS2_rad <span class="ot">&lt;-</span> <span class="fu">sapply</span>(xmp_all_filtered<span class="sc">$</span>EstimatedDirectLightVector, <span class="cf">function</span>(vec) <span class="fu">acos</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> <span class="fu">as.numeric</span>(vec[[<span class="dv">3</span>]])))</span>
<span id="cb48-2"><a href="MicaSense-Irradiance-Correction.html#cb48-2" tabindex="-1"></a>SSA_xmp_all_filtered<span class="sc">$</span>SunSensorAngle_DLS2_deg <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(SSA_xmp_all_filtered<span class="sc">$</span>SunSensorAngle_DLS2_rad) <span class="sc">/</span> pi <span class="sc">*</span> <span class="dv">180</span></span></code></pre></div>
</details>
<p>Check that the sun-sensor angles are within a reasonable range. They should range from ~30 degrees mid summer to ~80 degrees mid winter. This code outputs Figure <a href="MicaSense-Irradiance-Correction.html#fig:Dir-Irr-DSL2-DLS1-data">12.8</a> facet wrapped for each of the 10 bands (Figure <a href="MicaSense-Irradiance-Correction.html#fig:SSA-bands">12.9</a>). This is a good visual to compare DLS2 to DLS1 sun sensor angles as well as to check that data is consistent between bands and there is no missing information.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="MicaSense-Irradiance-Correction.html#cb49-1" tabindex="-1"></a>xmp_all_ssa <span class="ot">=</span> SSA_xmp_all_filtered <span class="sc">%&gt;%</span></span>
<span id="cb49-2"><a href="MicaSense-Irradiance-Correction.html#cb49-2" tabindex="-1"></a>  <span class="co"># Converting from radians to degrees</span></span>
<span id="cb49-3"><a href="MicaSense-Irradiance-Correction.html#cb49-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Yaw_deg =</span> <span class="fu">as.numeric</span>(Yaw)<span class="sc">*</span><span class="dv">180</span><span class="sc">/</span>pi,</span>
<span id="cb49-4"><a href="MicaSense-Irradiance-Correction.html#cb49-4" tabindex="-1"></a>         <span class="at">Roll_deg =</span> <span class="fu">as.numeric</span>(Roll)<span class="sc">*</span><span class="dv">180</span><span class="sc">/</span>pi,</span>
<span id="cb49-5"><a href="MicaSense-Irradiance-Correction.html#cb49-5" tabindex="-1"></a>         <span class="at">Pitch_deg =</span> <span class="fu">as.numeric</span>(Pitch)<span class="sc">*</span><span class="dv">180</span><span class="sc">/</span>pi) <span class="sc">%&gt;%</span> </span>
<span id="cb49-6"><a href="MicaSense-Irradiance-Correction.html#cb49-6" tabindex="-1"></a>  <span class="co"># Grouping images by Date and band</span></span>
<span id="cb49-7"><a href="MicaSense-Irradiance-Correction.html#cb49-7" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, BandName) <span class="sc">%&gt;%</span> </span>
<span id="cb49-8"><a href="MicaSense-Irradiance-Correction.html#cb49-8" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">ymd_hms</span>(DateTimeOriginal)) <span class="sc">%&gt;%</span> <span class="co"># Converting DateTimeOriginal to a Date and Time object and arranging in order </span></span>
<span id="cb49-9"><a href="MicaSense-Irradiance-Correction.html#cb49-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GPSLatitude_plot =</span> <span class="fu">scale</span>(<span class="fu">as.numeric</span>(GPSLatitude)), <span class="co"># These are for clean ggplotting, no other reason to scale</span></span>
<span id="cb49-10"><a href="MicaSense-Irradiance-Correction.html#cb49-10" tabindex="-1"></a>         <span class="at">GPSLongitude_plot =</span> <span class="fu">scale</span>(<span class="fu">as.numeric</span>(GPSLongitude)),</span>
<span id="cb49-11"><a href="MicaSense-Irradiance-Correction.html#cb49-11" tabindex="-1"></a>         <span class="at">cos_SSA =</span> <span class="fu">cos</span>(SunSensorAngle_DLS1_rad),</span>
<span id="cb49-12"><a href="MicaSense-Irradiance-Correction.html#cb49-12" tabindex="-1"></a>         <span class="at">Irradiance =</span> <span class="fu">as.numeric</span>(Irradiance),</span>
<span id="cb49-13"><a href="MicaSense-Irradiance-Correction.html#cb49-13" tabindex="-1"></a>         <span class="at">Date2 =</span> <span class="fu">ymd_hms</span>(DateTimeOriginal)) <span class="co"># this is the date/time we will use moving forward </span></span>
<span id="cb49-14"><a href="MicaSense-Irradiance-Correction.html#cb49-14" tabindex="-1"></a></span>
<span id="cb49-15"><a href="MicaSense-Irradiance-Correction.html#cb49-15" tabindex="-1"></a>(SSA_plot <span class="ot">&lt;-</span> xmp_all_ssa <span class="sc">%&gt;%</span></span>
<span id="cb49-16"><a href="MicaSense-Irradiance-Correction.html#cb49-16" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(Date_time)) <span class="sc">+</span></span>
<span id="cb49-17"><a href="MicaSense-Irradiance-Correction.html#cb49-17" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> SunSensorAngle_DLS2_deg, <span class="at">color =</span> <span class="st">&quot;DLS2&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb49-18"><a href="MicaSense-Irradiance-Correction.html#cb49-18" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> SunSensorAngle_DLS1_deg, <span class="at">color =</span> <span class="st">&quot;DLS1&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb49-19"><a href="MicaSense-Irradiance-Correction.html#cb49-19" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">data =</span> <span class="fu">subset</span>(xmp_all_ssa, panel_flag <span class="sc">==</span> <span class="dv">1</span>), <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(Date_time)), <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb49-20"><a href="MicaSense-Irradiance-Correction.html#cb49-20" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> solar_angle), <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb49-21"><a href="MicaSense-Irradiance-Correction.html#cb49-21" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(</span>
<span id="cb49-22"><a href="MicaSense-Irradiance-Correction.html#cb49-22" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">y =</span> SunSensorAngle_DLS2_deg),</span>
<span id="cb49-23"><a href="MicaSense-Irradiance-Correction.html#cb49-23" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">&quot;loess&quot;</span>,</span>
<span id="cb49-24"><a href="MicaSense-Irradiance-Correction.html#cb49-24" tabindex="-1"></a>      <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb49-25"><a href="MicaSense-Irradiance-Correction.html#cb49-25" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>,</span>
<span id="cb49-26"><a href="MicaSense-Irradiance-Correction.html#cb49-26" tabindex="-1"></a>      <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>,</span>
<span id="cb49-27"><a href="MicaSense-Irradiance-Correction.html#cb49-27" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb49-28"><a href="MicaSense-Irradiance-Correction.html#cb49-28" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-29"><a href="MicaSense-Irradiance-Correction.html#cb49-29" tabindex="-1"></a>    <span class="co"># Moving average for DLS1</span></span>
<span id="cb49-30"><a href="MicaSense-Irradiance-Correction.html#cb49-30" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(</span>
<span id="cb49-31"><a href="MicaSense-Irradiance-Correction.html#cb49-31" tabindex="-1"></a>      <span class="fu">aes</span>(<span class="at">y =</span> SunSensorAngle_DLS1_deg),</span>
<span id="cb49-32"><a href="MicaSense-Irradiance-Correction.html#cb49-32" tabindex="-1"></a>      <span class="at">method =</span> <span class="st">&quot;loess&quot;</span>,</span>
<span id="cb49-33"><a href="MicaSense-Irradiance-Correction.html#cb49-33" tabindex="-1"></a>      <span class="at">se =</span> <span class="cn">FALSE</span>,</span>
<span id="cb49-34"><a href="MicaSense-Irradiance-Correction.html#cb49-34" tabindex="-1"></a>      <span class="at">color =</span> <span class="st">&quot;red&quot;</span>,</span>
<span id="cb49-35"><a href="MicaSense-Irradiance-Correction.html#cb49-35" tabindex="-1"></a>      <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>,</span>
<span id="cb49-36"><a href="MicaSense-Irradiance-Correction.html#cb49-36" tabindex="-1"></a>      <span class="at">size =</span> <span class="dv">1</span></span>
<span id="cb49-37"><a href="MicaSense-Irradiance-Correction.html#cb49-37" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb49-38"><a href="MicaSense-Irradiance-Correction.html#cb49-38" tabindex="-1"></a>    <span class="fu">scale_x_datetime</span>(<span class="at">date_breaks =</span> <span class="st">&quot;10 min&quot;</span>, <span class="at">date_labels =</span> <span class="st">&quot;%H:%M&quot;</span>) <span class="sc">+</span></span>
<span id="cb49-39"><a href="MicaSense-Irradiance-Correction.html#cb49-39" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Time&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Sun Sensor Angle&quot;</span>, <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;SSA, Site: &quot;</span>,site_to_plot,<span class="st">&quot;, Date: &quot;</span>, date_to_plot, <span class="st">&quot;, Camera: &quot;</span>, camera_to_plot))<span class="sc">+</span></span>
<span id="cb49-40"><a href="MicaSense-Irradiance-Correction.html#cb49-40" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;Grey vertical lines are calibration panel images, black hoirzontal line is the solar angle (calculated from lat, long, and flight time)&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>) <span class="sc">+</span> </span>
<span id="cb49-41"><a href="MicaSense-Irradiance-Correction.html#cb49-41" tabindex="-1"></a>     <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;DLS2&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>,</span>
<span id="cb49-42"><a href="MicaSense-Irradiance-Correction.html#cb49-42" tabindex="-1"></a>                                  <span class="st">&quot;DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>),</span>
<span id="cb49-43"><a href="MicaSense-Irradiance-Correction.html#cb49-43" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;DLS2&quot;</span> <span class="ot">=</span> <span class="st">&quot;DLS2 (from metadata)&quot;</span>, </span>
<span id="cb49-44"><a href="MicaSense-Irradiance-Correction.html#cb49-44" tabindex="-1"></a>                                  <span class="st">&quot;DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;DLS1 (calculated)&quot;</span>),</span>
<span id="cb49-45"><a href="MicaSense-Irradiance-Correction.html#cb49-45" tabindex="-1"></a>                       <span class="at">name =</span> <span class="st">&quot;Sun Sensor Angle Comparison&quot;</span>)<span class="sc">+</span></span>
<span id="cb49-46"><a href="MicaSense-Irradiance-Correction.html#cb49-46" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(. <span class="sc">~</span>BandName_Wavelength, </span>
<span id="cb49-47"><a href="MicaSense-Irradiance-Correction.html#cb49-47" tabindex="-1"></a>               <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>, <span class="at">ncol =</span> <span class="dv">2</span>)<span class="sc">+</span> <span class="co"># this will plot each band as its own plot as a check for all data</span></span>
<span id="cb49-48"><a href="MicaSense-Irradiance-Correction.html#cb49-48" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb49-49"><a href="MicaSense-Irradiance-Correction.html#cb49-49" tabindex="-1"></a>)</span></code></pre></div>
</details>
<!-- ````{=html} -->
<!-- <!-- -->
<!-- ```{r eval=FALSE, include=TRUE} -->
<!-- ggsave(plot = SSA_plot, #save out the plot for reference -->
<!--        filename = paste0(plot_dir, "0_SSA_plot.jpeg"), #change plot_dir to the location you would like to save to -->
<!--        device = jpeg, -->
<!--        width = 6, -->
<!--        height = 6, -->
<!--        units = 'in', -->
<!--        dpi = 300, -->
<!--        bg = 'white') -->
<!-- ``` -->
<!-- -->
<!-- ```` -->
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:SSA-bands"></span>
<img src="Photos_&_gifs/0_SSA_plot_updated.jpeg" alt="Sun sensor angles across the duration of the flight for each of the 10 MicaSense bands from image metadata written by the DLS2 compared to sun sensor angles corrected using the DLS1 method. The black horiztonal lines plotted are the calculated solar zenith throughout the flight, where as the dotted lines are the moving average of sun sensor angles from the DLS1 (red) and DLS2 (blue). Grey vertical lines highlight calibration imagery taken when the drone was on the ground." width="100%" />
<p class="caption">
Figure 12.9: Sun sensor angles across the duration of the flight for each of the 10 MicaSense bands from image metadata written by the DLS2 compared to sun sensor angles corrected using the DLS1 method. The black horiztonal lines plotted are the calculated solar zenith throughout the flight, where as the dotted lines are the moving average of sun sensor angles from the DLS1 (red) and DLS2 (blue). Grey vertical lines highlight calibration imagery taken when the drone was on the ground.
</p>
</div>
</div>
<div id="scattereddirect-ratio-estimate" class="section level3 hasAnchor" number="12.4.4">
<h3><span class="header-section-number">12.4.4</span> Scattered:Direct Ratio Estimate<a href="MicaSense-Irradiance-Correction.html#scattereddirect-ratio-estimate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we estimate scattered:direct ratio for each flight by relating cosine of the sun-sensor angle to spectral irradiance measured by the DLS2. This relationship, in a perfect world, should give you the scattered irradiance as the intercept, which is independent of angle, and the direct irradiance, which is the slope, and therefore perfectly proportional to sun angle. In reality, these relationships are extremely messy and most data needs to be discarded.</p>
<p>Below are three main steps to find the estimated scattered:direct ratio:</p>
<ol style="list-style-type: decimal">
<li><p>First, generate a rolling regression of this linear relationship over a certain time window</p></li>
<li><p>Second, eliminate all models with poor fits using the R<span class="math inline">\(^2\)</span> value</p></li>
<li><p>Third, drop any models with negative slopes or intercepts (physically impossible)</p></li>
</ol>
<p>First, we generate a rolling regression of the linear relationship <span class="math inline">\(I_{\text{spec}} = I_{\text{direct}} \cdot \cos(\theta_{\text{sun-sensor}}) + I_{\text{scattered}}\)</span> via a regression of irradiance on <span class="math inline">\(\cos(\theta_{\text{sun-sensor}})\)</span> over a specified time window (we used 30 seconds here).</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="MicaSense-Irradiance-Correction.html#cb50-1" tabindex="-1"></a><span class="co"># via a regression of Irradiance on cos_SSA over a specified time window (30s here)</span></span>
<span id="cb50-2"><a href="MicaSense-Irradiance-Correction.html#cb50-2" tabindex="-1"></a>mod_frame <span class="ot">=</span> xmp_all_ssa_site_date <span class="sc">%&gt;%</span></span>
<span id="cb50-3"><a href="MicaSense-Irradiance-Correction.html#cb50-3" tabindex="-1"></a>  <span class="fu">drop_na</span>(Date2) <span class="sc">%&gt;%</span> </span>
<span id="cb50-4"><a href="MicaSense-Irradiance-Correction.html#cb50-4" tabindex="-1"></a>  <span class="fu">drop_na</span>(cos_SSA) <span class="sc">%&gt;%</span> </span>
<span id="cb50-5"><a href="MicaSense-Irradiance-Correction.html#cb50-5" tabindex="-1"></a>  <span class="fu">drop_na</span>(Irradiance) <span class="sc">%&gt;%</span> </span>
<span id="cb50-6"><a href="MicaSense-Irradiance-Correction.html#cb50-6" tabindex="-1"></a>  <span class="co"># Fit a rolling regression</span></span>
<span id="cb50-7"><a href="MicaSense-Irradiance-Correction.html#cb50-7" tabindex="-1"></a>  <span class="co"># for each image, fit a linear model of all images (of the same band) within 30 seconds of the image</span></span>
<span id="cb50-8"><a href="MicaSense-Irradiance-Correction.html#cb50-8" tabindex="-1"></a>  tidyfit<span class="sc">::</span><span class="fu">regress</span>(Irradiance <span class="sc">~</span> cos_SSA, <span class="fu">m</span>(<span class="st">&quot;lm&quot;</span>),</span>
<span id="cb50-9"><a href="MicaSense-Irradiance-Correction.html#cb50-9" tabindex="-1"></a>                   <span class="at">.cv =</span> <span class="st">&quot;sliding_index&quot;</span>, <span class="at">.cv_args =</span> <span class="fu">list</span>(<span class="at">lookback =</span> lubridate<span class="sc">::</span><span class="fu">seconds</span>(<span class="dv">30</span>), <span class="at">index =</span> <span class="st">&quot;Date2&quot;</span>),</span>
<span id="cb50-10"><a href="MicaSense-Irradiance-Correction.html#cb50-10" tabindex="-1"></a>                   <span class="at">.force_cv =</span> <span class="cn">TRUE</span>, <span class="at">.return_slices =</span> <span class="cn">TRUE</span>)</span>
<span id="cb50-11"><a href="MicaSense-Irradiance-Correction.html#cb50-11" tabindex="-1"></a><span class="co"># df : summary of models, adding R sqaured and Dates</span></span>
<span id="cb50-12"><a href="MicaSense-Irradiance-Correction.html#cb50-12" tabindex="-1"></a>df <span class="ot">=</span> mod_frame <span class="sc">%&gt;%</span> </span>
<span id="cb50-13"><a href="MicaSense-Irradiance-Correction.html#cb50-13" tabindex="-1"></a>  <span class="co"># Get a summary of each model and extract the r squared value</span></span>
<span id="cb50-14"><a href="MicaSense-Irradiance-Correction.html#cb50-14" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">R2 =</span> <span class="fu">map</span>(model_object, <span class="cf">function</span>(obj) <span class="fu">summary</span>(obj)<span class="sc">$</span>adj.r.squared)) <span class="sc">%&gt;%</span> </span>
<span id="cb50-15"><a href="MicaSense-Irradiance-Correction.html#cb50-15" tabindex="-1"></a>  <span class="co"># Extract the slope and intercept</span></span>
<span id="cb50-16"><a href="MicaSense-Irradiance-Correction.html#cb50-16" tabindex="-1"></a>  <span class="fu">coef</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb50-17"><a href="MicaSense-Irradiance-Correction.html#cb50-17" tabindex="-1"></a>  <span class="fu">unnest</span>(model_info) <span class="sc">%&gt;%</span> </span>
<span id="cb50-18"><a href="MicaSense-Irradiance-Correction.html#cb50-18" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date2 =</span> <span class="fu">ymd_hms</span>(slice_id)) </span>
<span id="cb50-19"><a href="MicaSense-Irradiance-Correction.html#cb50-19" tabindex="-1"></a><span class="co"># df_params : adding slope (direct irradiance) and y-intercept (scatterd irradiance) values</span></span>
<span id="cb50-20"><a href="MicaSense-Irradiance-Correction.html#cb50-20" tabindex="-1"></a>df_params <span class="ot">=</span> df <span class="sc">%&gt;%</span></span>
<span id="cb50-21"><a href="MicaSense-Irradiance-Correction.html#cb50-21" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Date<span class="sc">:</span>estimate, Date2) <span class="sc">%&gt;%</span> </span>
<span id="cb50-22"><a href="MicaSense-Irradiance-Correction.html#cb50-22" tabindex="-1"></a>  <span class="co"># we will have to go from long, with 2 observations per model, to wide</span></span>
<span id="cb50-23"><a href="MicaSense-Irradiance-Correction.html#cb50-23" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> term, <span class="at">values_from =</span> estimate, <span class="at">values_fn =</span> {first}) <span class="sc">%&gt;%</span> </span>
<span id="cb50-24"><a href="MicaSense-Irradiance-Correction.html#cb50-24" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="st">&quot;Intercept&quot;</span> <span class="ot">=</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>,</span>
<span id="cb50-25"><a href="MicaSense-Irradiance-Correction.html#cb50-25" tabindex="-1"></a>                <span class="st">&quot;Slope&quot;</span> <span class="ot">=</span> <span class="st">&quot;cos_SSA&quot;</span>)</span>
<span id="cb50-26"><a href="MicaSense-Irradiance-Correction.html#cb50-26" tabindex="-1"></a><span class="co"># Cleaning up the df</span></span>
<span id="cb50-27"><a href="MicaSense-Irradiance-Correction.html#cb50-27" tabindex="-1"></a>df_p <span class="ot">=</span> df <span class="sc">%&gt;%</span></span>
<span id="cb50-28"><a href="MicaSense-Irradiance-Correction.html#cb50-28" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&quot;cos_SSA&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb50-29"><a href="MicaSense-Irradiance-Correction.html#cb50-29" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Date<span class="sc">:</span>model, R2, p.value, Date2)</span>
<span id="cb50-30"><a href="MicaSense-Irradiance-Correction.html#cb50-30" tabindex="-1"></a><span class="co"># Joining model info, parameter (slope, y intercept) info and XMP data with sun sensor angle and using the linear relationship </span></span>
<span id="cb50-31"><a href="MicaSense-Irradiance-Correction.html#cb50-31" tabindex="-1"></a><span class="co"># (spectral_irr = direct_irr * cos(SSA) + scattered_irr) to create % scattered and scattered/direct ratios</span></span>
<span id="cb50-32"><a href="MicaSense-Irradiance-Correction.html#cb50-32" tabindex="-1"></a>df_filtered <span class="ot">=</span> df_params <span class="sc">%&gt;%</span> </span>
<span id="cb50-33"><a href="MicaSense-Irradiance-Correction.html#cb50-33" tabindex="-1"></a>  <span class="fu">left_join</span>(df_p) <span class="sc">%&gt;%</span> </span>
<span id="cb50-34"><a href="MicaSense-Irradiance-Correction.html#cb50-34" tabindex="-1"></a>  <span class="fu">left_join</span>(xmp_all_ssa_site_date) <span class="sc">%&gt;%</span> </span>
<span id="cb50-35"><a href="MicaSense-Irradiance-Correction.html#cb50-35" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent_scattered =</span> Intercept <span class="sc">/</span> (Slope <span class="sc">+</span> Intercept),</span>
<span id="cb50-36"><a href="MicaSense-Irradiance-Correction.html#cb50-36" tabindex="-1"></a>         <span class="at">dir_diff =</span> Intercept<span class="sc">/</span>Slope)</span></code></pre></div>
</details>
<p>Next, we eliminate all models with poor fits. In this case we eliminate models with R<span class="math inline">\(^2\)</span> &lt; 0.4 and drop any models with negative slopes or intercepts (physically impossible)</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="MicaSense-Irradiance-Correction.html#cb51-1" tabindex="-1"></a>df_to_use <span class="ot">=</span> df_filtered <span class="sc">%&gt;%</span> </span>
<span id="cb51-2"><a href="MicaSense-Irradiance-Correction.html#cb51-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">R2 =</span> <span class="fu">as.numeric</span>(R2)) <span class="sc">%&gt;%</span> </span>
<span id="cb51-3"><a href="MicaSense-Irradiance-Correction.html#cb51-3" tabindex="-1"></a>  <span class="fu">filter</span>(R2 <span class="sc">&gt;</span> .<span class="dv">4</span> </span>
<span id="cb51-4"><a href="MicaSense-Irradiance-Correction.html#cb51-4" tabindex="-1"></a>         <span class="sc">&amp;</span> Slope <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> Intercept <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb51-5"><a href="MicaSense-Irradiance-Correction.html#cb51-5" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span> </span>
<span id="cb51-6"><a href="MicaSense-Irradiance-Correction.html#cb51-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean_scattered =</span> <span class="fu">mean</span>(percent_scattered),</span>
<span id="cb51-7"><a href="MicaSense-Irradiance-Correction.html#cb51-7" tabindex="-1"></a>         <span class="at">dir_diff_ratio =</span> <span class="fu">mean</span>(dir_diff))</span>
<span id="cb51-8"><a href="MicaSense-Irradiance-Correction.html#cb51-8" tabindex="-1"></a><span class="co">#save out dataframe as an rds</span></span>
<span id="cb51-9"><a href="MicaSense-Irradiance-Correction.html#cb51-9" tabindex="-1"></a><span class="fu">saveRDS</span>(df_to_use,<span class="fu">paste0</span>(dir,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>,date,<span class="st">&quot;_rolling_regression_filteredModels_used_plot1.rds&quot;</span>))  <span class="co">#SET PATH to save the rds to </span></span></code></pre></div>
</details>
<p>Below we plot the percent of scattered irradiance calculated from the models kept (blues) and those removed (grey). Percent scattered was calculated by diving the intercept (scattered component) by the sum of the intercept and the slope (direct component), see equation:<span class="math inline">\(I_{\text{spec}} = I_{\text{direct}} \cdot \cos(\theta_{\text{sun-sensor}}) + I_{\text{scattered}}\)</span>. The maroon horizontal line shows the mean percent scattered irradiance, in this case just above 30% (Figure <a href="MicaSense-Irradiance-Correction.html#fig:check-percent-scat-plot">12.10</a>). If you are loosing too many models, adjust the filters.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="MicaSense-Irradiance-Correction.html#cb52-1" tabindex="-1"></a>(RR_params <span class="ot">&lt;-</span> df_to_use <span class="sc">%&gt;%</span></span>
<span id="cb52-2"><a href="MicaSense-Irradiance-Correction.html#cb52-2" tabindex="-1"></a>    <span class="fu">group_by</span>(Date, BandName) <span class="sc">%&gt;%</span> </span>
<span id="cb52-3"><a href="MicaSense-Irradiance-Correction.html#cb52-3" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Date2, <span class="at">y =</span> percent_scattered, <span class="at">color =</span> R2)) <span class="sc">+</span></span>
<span id="cb52-4"><a href="MicaSense-Irradiance-Correction.html#cb52-4" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> df_filtered, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb52-5"><a href="MicaSense-Irradiance-Correction.html#cb52-5" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb52-6"><a href="MicaSense-Irradiance-Correction.html#cb52-6" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb52-7"><a href="MicaSense-Irradiance-Correction.html#cb52-7" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> mean_scattered), <span class="at">color =</span> <span class="st">&quot;red4&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb52-8"><a href="MicaSense-Irradiance-Correction.html#cb52-8" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, .<span class="dv">2</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb52-9"><a href="MicaSense-Irradiance-Correction.html#cb52-9" tabindex="-1"></a>    ggnewscale<span class="sc">::</span><span class="fu">new_scale_color</span>() <span class="sc">+</span></span>
<span id="cb52-10"><a href="MicaSense-Irradiance-Correction.html#cb52-10" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Site: &quot;</span>,site_to_plot,<span class="st">&quot;, Date: &quot;</span>, date_to_plot, <span class="st">&quot;, Camera: &quot;</span>, camera_to_plot),</span>
<span id="cb52-11"><a href="MicaSense-Irradiance-Correction.html#cb52-11" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">&quot;Time (UTC)&quot;</span>)<span class="sc">+</span></span>
<span id="cb52-12"><a href="MicaSense-Irradiance-Correction.html#cb52-12" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb52-13"><a href="MicaSense-Irradiance-Correction.html#cb52-13" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(. <span class="sc">~</span> Date, </span>
<span id="cb52-14"><a href="MicaSense-Irradiance-Correction.html#cb52-14" tabindex="-1"></a>               <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>))</span></code></pre></div>
</details>
<!-- ````{=html} -->
<!-- <!-- -->
<!-- ```{r eval=FALSE, include=TRUE} -->
<!-- ggsave(plot = RR_params, -->
<!--        filename = paste0(plot_dir,"1_CheckRollingRegressionParams_plot.jpeg"), -->
<!--        device = jpeg, -->
<!--        width = 15, -->
<!--        height = 10, -->
<!--        units = 'in', -->
<!--        dpi = 300, -->
<!--        bg = 'white') -->
<!-- ``` -->
<!-- ```` -->
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:check-percent-scat-plot"></span>
<img src="Photos_&_gifs/1_CheckRollingRegressionParams_plot_panel_paths_removed.jpeg" alt="Percent scattered irradiance calculated from the slope and y-intercept of the regression models. Blue points are those from regression models that remain after the models were filtered, where the shade of blue represents the R-squared of the regression model the value was calculated from. Grey point are values from mdoels that have been filtered out.  " width="100%" />
<p class="caption">
Figure 12.10: Percent scattered irradiance calculated from the slope and y-intercept of the regression models. Blue points are those from regression models that remain after the models were filtered, where the shade of blue represents the R-squared of the regression model the value was calculated from. Grey point are values from mdoels that have been filtered out.
</p>
</div>
<p>Next, check that the linear relationships you’re keeping look realistic. The slope should be steeper for sunny days (i.e. more direct irradiance) and shallower for overcast days (Figure <a href="MicaSense-Irradiance-Correction.html#fig:linear-plot-cosSSA">12.11</a>).</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="MicaSense-Irradiance-Correction.html#cb53-1" tabindex="-1"></a>(linear_plots <span class="ot">&lt;-</span> df_to_use <span class="sc">%&gt;%</span></span>
<span id="cb53-2"><a href="MicaSense-Irradiance-Correction.html#cb53-2" tabindex="-1"></a>    <span class="fu">filter</span>(BandName <span class="sc">==</span> <span class="st">&quot;Blue&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb53-3"><a href="MicaSense-Irradiance-Correction.html#cb53-3" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> cos_SSA, <span class="at">y =</span> Irradiance, <span class="at">color =</span> R2)) <span class="sc">+</span></span>
<span id="cb53-4"><a href="MicaSense-Irradiance-Correction.html#cb53-4" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">filter</span>(df_filtered, BandName <span class="sc">==</span> <span class="st">&quot;Blue&quot;</span>), <span class="at">color =</span> <span class="st">&quot;grey30&quot;</span>, <span class="at">alpha =</span> .<span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb53-5"><a href="MicaSense-Irradiance-Correction.html#cb53-5" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">filter</span>(df_filtered, BandName <span class="sc">==</span> <span class="st">&quot;Blue&quot;</span> <span class="sc">&amp;</span> R2 <span class="sc">&gt;</span> .<span class="dv">4</span>), <span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.numeric</span>(R2))) <span class="sc">+</span></span>
<span id="cb53-6"><a href="MicaSense-Irradiance-Correction.html#cb53-6" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="fu">aes</span>(<span class="at">group =</span> BandName)) <span class="sc">+</span></span>
<span id="cb53-7"><a href="MicaSense-Irradiance-Correction.html#cb53-7" tabindex="-1"></a>    <span class="fu">lims</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb53-8"><a href="MicaSense-Irradiance-Correction.html#cb53-8" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(df_to_use<span class="sc">$</span>Irradiance))) <span class="sc">+</span></span>
<span id="cb53-9"><a href="MicaSense-Irradiance-Correction.html#cb53-9" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="fu">aes</span>(<span class="at">slope =</span> Slope, <span class="at">intercept =</span> Intercept, <span class="at">color =</span> R2), <span class="at">alpha =</span> .<span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb53-10"><a href="MicaSense-Irradiance-Correction.html#cb53-10" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Site: &quot;</span>,site_to_plot,<span class="st">&quot;, Date: &quot;</span>, date_to_plot, <span class="st">&quot;, Camera: &quot;</span>, camera_to_plot))<span class="sc">+</span></span>
<span id="cb53-11"><a href="MicaSense-Irradiance-Correction.html#cb53-11" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb53-12"><a href="MicaSense-Irradiance-Correction.html#cb53-12" tabindex="-1"></a>    <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb53-13"><a href="MicaSense-Irradiance-Correction.html#cb53-13" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(. <span class="sc">~</span> Date, </span>
<span id="cb53-14"><a href="MicaSense-Irradiance-Correction.html#cb53-14" tabindex="-1"></a>               <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>))</span></code></pre></div>
</details>
<!-- ````{=html} -->
<!-- <!-- -->
<!-- ```{r eval=FALSE, include=TRUE} -->
<!-- ggsave(plot = linear_plots, -->
<!--        filename = paste0(plot_dir,"2_LinearRegression_plot.jpeg"), -->
<!--        device = jpeg, -->
<!--        width = 15, -->
<!--        height = 10, -->
<!--        units = 'in', -->
<!--        dpi = 300, -->
<!--        bg = 'white') -->
<!-- ``` -->
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:linear-plot-cosSSA"></span>
<img src="Photos_&_gifs/2_LinearRegression_plot_reDone.PNG" alt="Output of the linear regression models run on spectral irradiance and cos(sun sensor angle) over 30 second time windows. These models were filtered to only retain those that had an R2 greater than 0.4 and both a positive slope and intercept." width="100%" />
<p class="caption">
Figure 12.11: Output of the linear regression models run on spectral irradiance and cos(sun sensor angle) over 30 second time windows. These models were filtered to only retain those that had an R2 greater than 0.4 and both a positive slope and intercept.
</p>
</div>
<p>We recommend checking that there is no excessive spatial pattern in the data by plotting the locations of imagery used in the models. Here you want to ensure that imagery throughout the plot is being used rather than only images from a certain location (Figure <a href="MicaSense-Irradiance-Correction.html#fig:spatial-regression-kept">12.12</a>). The code to do this is below:</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="MicaSense-Irradiance-Correction.html#cb54-1" tabindex="-1"></a>(photos_kept <span class="ot">&lt;-</span> df_to_use <span class="sc">%&gt;%</span></span>
<span id="cb54-2"><a href="MicaSense-Irradiance-Correction.html#cb54-2" tabindex="-1"></a>    <span class="fu">filter</span>(GPSLongitude <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> GPSLatitude <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="co"># Filter out imgs with GPSLongitude and GPSLatitude of zero, </span></span>
<span id="cb54-3"><a href="MicaSense-Irradiance-Correction.html#cb54-3" tabindex="-1"></a>    <span class="co"># this is rare and in my experience were corrupted imgs where the XMP could not be properly read</span></span>
<span id="cb54-4"><a href="MicaSense-Irradiance-Correction.html#cb54-4" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> GPSLongitude, <span class="at">y =</span> GPSLatitude, <span class="at">color =</span> SunSensorAngle_DLS1_deg)) <span class="sc">+</span></span>
<span id="cb54-5"><a href="MicaSense-Irradiance-Correction.html#cb54-5" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> df_filtered, <span class="at">color =</span> <span class="st">&quot;grey60&quot;</span>) <span class="sc">+</span></span>
<span id="cb54-6"><a href="MicaSense-Irradiance-Correction.html#cb54-6" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb54-7"><a href="MicaSense-Irradiance-Correction.html#cb54-7" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Site: &quot;</span>,site_to_plot,<span class="st">&quot;, Date: &quot;</span>, date_to_plot, <span class="st">&quot;, Camera: &quot;</span>, camera_to_plot))<span class="sc">+</span></span>
<span id="cb54-8"><a href="MicaSense-Irradiance-Correction.html#cb54-8" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb54-9"><a href="MicaSense-Irradiance-Correction.html#cb54-9" tabindex="-1"></a>    <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb54-10"><a href="MicaSense-Irradiance-Correction.html#cb54-10" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(. <span class="sc">~</span> Date, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>))</span></code></pre></div>
</details>
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:spatial-regression-kept"></span>
<img src="Photos_&_gifs/3_GPSphotosKept_plot_lat_cutoff.jpeg" alt="Location of MicaSense imagery aquired over the June 25th, 2024 flight on Vancouver Island. Grey points are the locations of images that were filtered out in the above steps and not used in the final regression models. Coloured dots are those used in the regression models kept and are coloured by sun sensor angle calculated with the DLS1 method." width="100%" />
<p class="caption">
Figure 12.12: Location of MicaSense imagery aquired over the June 25th, 2024 flight on Vancouver Island. Grey points are the locations of images that were filtered out in the above steps and not used in the final regression models. Coloured dots are those used in the regression models kept and are coloured by sun sensor angle calculated with the DLS1 method.
</p>
</div>
<p>Lastly, we compute the scattered/ direct irradiance ratios dataframe from the dataframe of filtered models</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="MicaSense-Irradiance-Correction.html#cb55-1" tabindex="-1"></a>(<span class="at">ratios =</span> df_to_use <span class="sc">%&gt;%</span> </span>
<span id="cb55-2"><a href="MicaSense-Irradiance-Correction.html#cb55-2" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(Date, mean_scattered, dir_diff_ratio,</span>
<span id="cb55-3"><a href="MicaSense-Irradiance-Correction.html#cb55-3" tabindex="-1"></a>                  GPSLatitude, GPSLongitude, Date2) <span class="sc">%&gt;%</span> </span>
<span id="cb55-4"><a href="MicaSense-Irradiance-Correction.html#cb55-4" tabindex="-1"></a>    <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span> </span>
<span id="cb55-5"><a href="MicaSense-Irradiance-Correction.html#cb55-5" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Lat_mean =</span> <span class="fu">mean</span>(GPSLatitude),</span>
<span id="cb55-6"><a href="MicaSense-Irradiance-Correction.html#cb55-6" tabindex="-1"></a>           <span class="at">Long_mean =</span> <span class="fu">mean</span>(GPSLongitude),</span>
<span id="cb55-7"><a href="MicaSense-Irradiance-Correction.html#cb55-7" tabindex="-1"></a>           <span class="at">Date_mean =</span> <span class="fu">mean</span>(Date2)) <span class="sc">%&gt;%</span> </span>
<span id="cb55-8"><a href="MicaSense-Irradiance-Correction.html#cb55-8" tabindex="-1"></a>    <span class="fu">distinct</span>(Date, mean_scattered, dir_diff_ratio, Lat_mean, Long_mean, Date_mean))</span>
<span id="cb55-9"><a href="MicaSense-Irradiance-Correction.html#cb55-9" tabindex="-1"></a></span>
<span id="cb55-10"><a href="MicaSense-Irradiance-Correction.html#cb55-10" tabindex="-1"></a><span class="fu">saveRDS</span>(ratios,<span class="fu">paste0</span>(dir,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>,date,<span class="st">&quot;_ratios.rds&quot;</span>))  <span class="co">#SET PATH to save the rds to </span></span>
<span id="cb55-11"><a href="MicaSense-Irradiance-Correction.html#cb55-11" tabindex="-1"></a></span>
<span id="cb55-12"><a href="MicaSense-Irradiance-Correction.html#cb55-12" tabindex="-1"></a><span class="co"># Print the values to use in the calibration as a check (does this ratio looks reasonable?)</span></span>
<span id="cb55-13"><a href="MicaSense-Irradiance-Correction.html#cb55-13" tabindex="-1"></a><span class="fu">round</span>(ratios<span class="sc">$</span>dir_diff_ratio, <span class="dv">2</span>)</span></code></pre></div>
</details>
<p>The ratio for the DLS1 was 0.46 and the mean_scattered component was ~32 W/m<span class="math inline">\(^2\)</span>.</p>
</div>
<div id="computing-horizontal-corrected-irradiance" class="section level3 hasAnchor" number="12.4.5">
<h3><span class="header-section-number">12.4.5</span> Computing Horizontal (Corrected) Irradiance<a href="MicaSense-Irradiance-Correction.html#computing-horizontal-corrected-irradiance" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This is the Fresnel correction, which adjusts for the DLS reflecting, rather than measuring, some of the irradiance that hits it. We aquired this code from <a href="https://github.com/micasense/imageprocessing/blob/master/MicaSense%20Image%20Processing%20Tutorial%203.ipynb">MicaSense’s GitHub</a> and converted to R to use in this workflow.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="MicaSense-Irradiance-Correction.html#cb56-1" tabindex="-1"></a>fresnel_transmission <span class="ot">=</span> <span class="cf">function</span>(phi, n1, n2, polarization) {</span>
<span id="cb56-2"><a href="MicaSense-Irradiance-Correction.html#cb56-2" tabindex="-1"></a>  f1 <span class="ot">=</span> <span class="fu">cos</span>(phi)</span>
<span id="cb56-3"><a href="MicaSense-Irradiance-Correction.html#cb56-3" tabindex="-1"></a>  f2 <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> (n1 <span class="sc">/</span> n2 <span class="sc">*</span> <span class="fu">sin</span>(phi))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb56-4"><a href="MicaSense-Irradiance-Correction.html#cb56-4" tabindex="-1"></a>  Rs <span class="ot">=</span> ((n1 <span class="sc">*</span> f1 <span class="sc">-</span> n2 <span class="sc">*</span> f2) <span class="sc">/</span> (n1 <span class="sc">*</span> f1 <span class="sc">+</span> n2 <span class="sc">*</span> f2))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb56-5"><a href="MicaSense-Irradiance-Correction.html#cb56-5" tabindex="-1"></a>  Rp <span class="ot">=</span> ((n1 <span class="sc">*</span> f2 <span class="sc">-</span> n2 <span class="sc">*</span> f1) <span class="sc">/</span> (n1 <span class="sc">*</span> f2 <span class="sc">+</span> n2 <span class="sc">*</span> f1))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb56-6"><a href="MicaSense-Irradiance-Correction.html#cb56-6" tabindex="-1"></a>  T <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> polarization[<span class="dv">1</span>] <span class="sc">*</span> Rs <span class="sc">-</span> polarization[<span class="dv">2</span>] <span class="sc">*</span> Rp</span>
<span id="cb56-7"><a href="MicaSense-Irradiance-Correction.html#cb56-7" tabindex="-1"></a>  T <span class="ot">=</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(T, <span class="dv">0</span>), <span class="dv">1</span>)  <span class="co"># Clamp the value between 0 and 1</span></span>
<span id="cb56-8"><a href="MicaSense-Irradiance-Correction.html#cb56-8" tabindex="-1"></a>  <span class="fu">return</span>(T)</span>
<span id="cb56-9"><a href="MicaSense-Irradiance-Correction.html#cb56-9" tabindex="-1"></a>}</span>
<span id="cb56-10"><a href="MicaSense-Irradiance-Correction.html#cb56-10" tabindex="-1"></a></span>
<span id="cb56-11"><a href="MicaSense-Irradiance-Correction.html#cb56-11" tabindex="-1"></a>multilayer_transmission <span class="ot">=</span> <span class="cf">function</span>(phi, n, polarization) {</span>
<span id="cb56-12"><a href="MicaSense-Irradiance-Correction.html#cb56-12" tabindex="-1"></a>  T <span class="ot">=</span> <span class="fl">1.0</span></span>
<span id="cb56-13"><a href="MicaSense-Irradiance-Correction.html#cb56-13" tabindex="-1"></a>  phi_eff <span class="ot">=</span> phi</span>
<span id="cb56-14"><a href="MicaSense-Irradiance-Correction.html#cb56-14" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(n) <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb56-15"><a href="MicaSense-Irradiance-Correction.html#cb56-15" tabindex="-1"></a>    n1 <span class="ot">=</span> n[i]</span>
<span id="cb56-16"><a href="MicaSense-Irradiance-Correction.html#cb56-16" tabindex="-1"></a>    n2 <span class="ot">=</span> n[i <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb56-17"><a href="MicaSense-Irradiance-Correction.html#cb56-17" tabindex="-1"></a>    phi_eff <span class="ot">=</span> <span class="fu">asin</span>(<span class="fu">sin</span>(phi_eff) <span class="sc">/</span> n1)</span>
<span id="cb56-18"><a href="MicaSense-Irradiance-Correction.html#cb56-18" tabindex="-1"></a>    T <span class="ot">=</span> T <span class="sc">*</span> <span class="fu">fresnel_transmission</span>(phi_eff, n1, n2, polarization)</span>
<span id="cb56-19"><a href="MicaSense-Irradiance-Correction.html#cb56-19" tabindex="-1"></a>  }</span>
<span id="cb56-20"><a href="MicaSense-Irradiance-Correction.html#cb56-20" tabindex="-1"></a>  <span class="fu">return</span>(T)</span>
<span id="cb56-21"><a href="MicaSense-Irradiance-Correction.html#cb56-21" tabindex="-1"></a>}</span>
<span id="cb56-22"><a href="MicaSense-Irradiance-Correction.html#cb56-22" tabindex="-1"></a></span>
<span id="cb56-23"><a href="MicaSense-Irradiance-Correction.html#cb56-23" tabindex="-1"></a><span class="co"># Defining the fresnel_correction function </span></span>
<span id="cb56-24"><a href="MicaSense-Irradiance-Correction.html#cb56-24" tabindex="-1"></a>fresnel_correction <span class="ot">=</span> <span class="cf">function</span>(x) {</span>
<span id="cb56-25"><a href="MicaSense-Irradiance-Correction.html#cb56-25" tabindex="-1"></a>  </span>
<span id="cb56-26"><a href="MicaSense-Irradiance-Correction.html#cb56-26" tabindex="-1"></a>  Irradiance <span class="ot">=</span> x<span class="sc">$</span>Irradiance</span>
<span id="cb56-27"><a href="MicaSense-Irradiance-Correction.html#cb56-27" tabindex="-1"></a>  SunSensorAngle_DLS1_rad <span class="ot">=</span> x<span class="sc">$</span>SunSensorAngle_DLS1_rad</span>
<span id="cb56-28"><a href="MicaSense-Irradiance-Correction.html#cb56-28" tabindex="-1"></a>  n1<span class="ot">=</span><span class="fl">1.000277</span></span>
<span id="cb56-29"><a href="MicaSense-Irradiance-Correction.html#cb56-29" tabindex="-1"></a>  n2<span class="ot">=</span><span class="fl">1.38</span></span>
<span id="cb56-30"><a href="MicaSense-Irradiance-Correction.html#cb56-30" tabindex="-1"></a>  polarization<span class="ot">=</span><span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)</span>
<span id="cb56-31"><a href="MicaSense-Irradiance-Correction.html#cb56-31" tabindex="-1"></a>  </span>
<span id="cb56-32"><a href="MicaSense-Irradiance-Correction.html#cb56-32" tabindex="-1"></a>  <span class="co"># Convert sun-sensor angle from radians to degrees</span></span>
<span id="cb56-33"><a href="MicaSense-Irradiance-Correction.html#cb56-33" tabindex="-1"></a>  SunSensorAngle_DLS1_deg <span class="ot">&lt;-</span> SunSensorAngle_DLS1_rad <span class="sc">*</span> (<span class="dv">180</span> <span class="sc">/</span> pi)</span>
<span id="cb56-34"><a href="MicaSense-Irradiance-Correction.html#cb56-34" tabindex="-1"></a>  </span>
<span id="cb56-35"><a href="MicaSense-Irradiance-Correction.html#cb56-35" tabindex="-1"></a>  <span class="co"># Perform the multilayer Fresnel correction</span></span>
<span id="cb56-36"><a href="MicaSense-Irradiance-Correction.html#cb56-36" tabindex="-1"></a>  Fresnel <span class="ot">&lt;-</span> <span class="fu">multilayer_transmission</span>(SunSensorAngle_DLS1_rad, <span class="fu">c</span>(n1, n2), polarization)</span>
<span id="cb56-37"><a href="MicaSense-Irradiance-Correction.html#cb56-37" tabindex="-1"></a>  <span class="fu">return</span>(Fresnel)</span>
<span id="cb56-38"><a href="MicaSense-Irradiance-Correction.html#cb56-38" tabindex="-1"></a>}</span></code></pre></div>
</details>
<p>Now we put it all together to compute the horizontal irradiance. Here the horizontal irradiance can be thought of as a corrected value for the total irradiance that is reaching a point on the flat ground directly underneath the drone.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="MicaSense-Irradiance-Correction.html#cb57-1" tabindex="-1"></a>xmp_corrected <span class="ot">=</span> xmp_all_ssa  <span class="sc">%&gt;%</span> </span>
<span id="cb57-2"><a href="MicaSense-Irradiance-Correction.html#cb57-2" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, BandName) <span class="sc">%&gt;%</span> </span>
<span id="cb57-3"><a href="MicaSense-Irradiance-Correction.html#cb57-3" tabindex="-1"></a>  <span class="co">#filter(BandName == &quot;Red&quot;) %&gt;% </span></span>
<span id="cb57-4"><a href="MicaSense-Irradiance-Correction.html#cb57-4" tabindex="-1"></a>  <span class="co">#slice_head(n = 900) %&gt;% </span></span>
<span id="cb57-5"><a href="MicaSense-Irradiance-Correction.html#cb57-5" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="fu">c</span>(Irradiance, SunSensorAngle_DLS1_rad)) <span class="sc">%&gt;%</span> <span class="co"># Creates a nested df where each group is stored as a list-column named data, containing the variables Irradiance and SunSensorAngle_DLS1_rad</span></span>
<span id="cb57-6"><a href="MicaSense-Irradiance-Correction.html#cb57-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Fresnel =</span> <span class="fu">as.numeric</span>(<span class="fu">map</span>(<span class="at">.x =</span> data, <span class="at">.f =</span> fresnel_correction))) <span class="sc">%&gt;%</span> <span class="co"># Applies the fresnel_correction function to each group of nested data</span></span>
<span id="cb57-7"><a href="MicaSense-Irradiance-Correction.html#cb57-7" tabindex="-1"></a>  <span class="fu">unnest</span>(data) <span class="sc">%&gt;%</span> <span class="co">#unnesting</span></span>
<span id="cb57-8"><a href="MicaSense-Irradiance-Correction.html#cb57-8" tabindex="-1"></a>  <span class="co"># Joining the ratios</span></span>
<span id="cb57-9"><a href="MicaSense-Irradiance-Correction.html#cb57-9" tabindex="-1"></a>  <span class="fu">left_join</span>(ratios, <span class="at">by =</span> <span class="st">&quot;Date&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb57-10"><a href="MicaSense-Irradiance-Correction.html#cb57-10" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SensorIrradiance =</span> <span class="fu">as.numeric</span>(SpectralIrradiance) <span class="sc">/</span> Fresnel, <span class="co"># irradiance adjusted for some reflected light from the DLS diffuser</span></span>
<span id="cb57-11"><a href="MicaSense-Irradiance-Correction.html#cb57-11" tabindex="-1"></a>         <span class="at">DirectIrradiance_new =</span> SensorIrradiance <span class="sc">/</span> (dir_diff_ratio <span class="sc">+</span> <span class="fu">cos</span>(<span class="fu">as.numeric</span>(SunSensorAngle_DLS1_rad))), <span class="co"># adjusted for sun angle, </span></span>
<span id="cb57-12"><a href="MicaSense-Irradiance-Correction.html#cb57-12" tabindex="-1"></a>         <span class="at">HorizontalIrradiance_new =</span> DirectIrradiance_new <span class="sc">*</span> (dir_diff_ratio <span class="sc">+</span> <span class="fu">sin</span>(<span class="fu">as.numeric</span>(SolarElevation))), </span>
<span id="cb57-13"><a href="MicaSense-Irradiance-Correction.html#cb57-13" tabindex="-1"></a>         <span class="at">ScatteredIrradiance_new =</span> HorizontalIrradiance_new <span class="sc">-</span> DirectIrradiance_new)</span>
<span id="cb57-14"><a href="MicaSense-Irradiance-Correction.html#cb57-14" tabindex="-1"></a><span class="fu">saveRDS</span>(xmp_corrected,<span class="fu">paste0</span>(dir,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>,date,<span class="st">&quot;_xmp_corrected.rds&quot;</span>))  <span class="co">#SET PATH to save the rds to</span></span></code></pre></div>
</details>
<p>Now we plot the sensor irradiance along with the corrected horizontal, direct, and scattered irradiance values</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="MicaSense-Irradiance-Correction.html#cb58-1" tabindex="-1"></a>(Sensor_irr <span class="ot">&lt;-</span> xmp_corrected <span class="sc">%&gt;%</span> </span>
<span id="cb58-2"><a href="MicaSense-Irradiance-Correction.html#cb58-2" tabindex="-1"></a>    <span class="fu">filter</span>(BandName <span class="sc">==</span> <span class="st">&quot;Blue&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb58-3"><a href="MicaSense-Irradiance-Correction.html#cb58-3" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Date2)) <span class="sc">+</span></span>
<span id="cb58-4"><a href="MicaSense-Irradiance-Correction.html#cb58-4" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> SensorIrradiance, <span class="at">color =</span> <span class="st">&quot;Sensor Irradiance&quot;</span>),<span class="at">size =</span> <span class="dv">1</span>,<span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb58-5"><a href="MicaSense-Irradiance-Correction.html#cb58-5" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> HorizontalIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Horizontal_DLS1&quot;</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb58-6"><a href="MicaSense-Irradiance-Correction.html#cb58-6" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> DirectIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Direct_DLS1&quot;</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb58-7"><a href="MicaSense-Irradiance-Correction.html#cb58-7" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> ScatteredIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Scattered_DLS1&quot;</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb58-8"><a href="MicaSense-Irradiance-Correction.html#cb58-8" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb58-9"><a href="MicaSense-Irradiance-Correction.html#cb58-9" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Sensor Irradiance&quot;</span><span class="ot">=</span> <span class="st">&quot;black&quot;</span>, <span class="st">&quot;Horizontal_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;Direct_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;orange&quot;</span>, <span class="st">&quot;Scattered_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;purple&quot;</span>)) <span class="sc">+</span></span>
<span id="cb58-10"><a href="MicaSense-Irradiance-Correction.html#cb58-10" tabindex="-1"></a>    <span class="co">#lims(y = c(50, 150)) +</span></span>
<span id="cb58-11"><a href="MicaSense-Irradiance-Correction.html#cb58-11" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;Irradiance&quot;</span>, <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Site: &quot;</span>,site_to_plot,<span class="st">&quot;, Date: &quot;</span>, date_to_plot, <span class="st">&quot;, Camera: &quot;</span>, camera_to_plot))<span class="sc">+</span></span>
<span id="cb58-12"><a href="MicaSense-Irradiance-Correction.html#cb58-12" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb58-13"><a href="MicaSense-Irradiance-Correction.html#cb58-13" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(. <span class="sc">~</span> Date, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>,</span>
<span id="cb58-14"><a href="MicaSense-Irradiance-Correction.html#cb58-14" tabindex="-1"></a>               <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb58-15"><a href="MicaSense-Irradiance-Correction.html#cb58-15" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">&quot;Irradiance Type&quot;</span>))</span></code></pre></div>
</details>
<!-- ````{=html} -->
<!-- <!-- -->
<!-- ```{r eval=FALSE, include=TRUE} -->
<!-- ggsave(plot = Sensor_irr, -->
<!--        filename = paste0(plot_dir,"4_SensorIrradiance_w_CorrectedIrradiance_plot.jpeg"), -->
<!--        device = jpeg, -->
<!--        width = 15, -->
<!--        height = 10, -->
<!--        units = 'in', -->
<!--        dpi = 300, -->
<!--        bg = 'white') -->
<!-- ``` -->
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:DLS1-corrected-irradiance"></span>
<img src="Photos_&_gifs/4_SensorIrradiance_w_CorrectedIrradiance_reDone.PNG" alt="Direct, horizontal, sensor, and scattered irradiance across the duration of the flight corrected using the DLS1 method." width="100%" />
<p class="caption">
Figure 12.13: Direct, horizontal, sensor, and scattered irradiance across the duration of the flight corrected using the DLS1 method.
</p>
</div>
<p>Now that we have corrected the data using the DLS1 method (Figure <a href="MicaSense-Irradiance-Correction.html#fig:DLS1-corrected-irradiance">12.13</a>), we can compare the DLS1 values to the DLS2 values to see if correction is needed. The code below creates a dataframe that has the median scatted/direct ratios and median percent scattered irradiance values for the DLS1 method and from the DLS2 sensor. These values will be used to annotate the comparison plot in Figure <a href="MicaSense-Irradiance-Correction.html#fig:DLS1-vs-DLS2-irr">12.14</a>.</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="MicaSense-Irradiance-Correction.html#cb59-1" tabindex="-1"></a>avg_ratio_data <span class="ot">&lt;-</span> xmp_corrected <span class="sc">%&gt;%</span></span>
<span id="cb59-2"><a href="MicaSense-Irradiance-Correction.html#cb59-2" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(BandName))<span class="sc">%&gt;%</span></span>
<span id="cb59-3"><a href="MicaSense-Irradiance-Correction.html#cb59-3" tabindex="-1"></a>  <span class="fu">group_by</span>(BandName) <span class="sc">%&gt;%</span></span>
<span id="cb59-4"><a href="MicaSense-Irradiance-Correction.html#cb59-4" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">median_ScatteredDirectRatio_DLS2 =</span> <span class="fu">median</span>(<span class="fu">as.numeric</span>(ScatteredIrradiance) <span class="sc">/</span><span class="fu">as.numeric</span>(DirectIrradiance), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb59-5"><a href="MicaSense-Irradiance-Correction.html#cb59-5" tabindex="-1"></a>            <span class="at">median_ScatteredDirectRatio_DLS1_calc =</span> <span class="fu">median</span>(<span class="fu">as.numeric</span>(ScatteredIrradiance_new) <span class="sc">/</span><span class="fu">as.numeric</span>(DirectIrradiance_new), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb59-6"><a href="MicaSense-Irradiance-Correction.html#cb59-6" tabindex="-1"></a>            <span class="at">median_percent_scat_DLS2 =</span> <span class="fu">median</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">as.numeric</span>(ScatteredIrradiance)<span class="sc">/</span>(<span class="fu">as.numeric</span>(ScatteredIrradiance)<span class="sc">+</span><span class="fu">as.numeric</span>(DirectIrradiance))),</span>
<span id="cb59-7"><a href="MicaSense-Irradiance-Correction.html#cb59-7" tabindex="-1"></a>            <span class="at">median_percent_scat_DLS1 =</span> <span class="fu">median</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">as.numeric</span>(ScatteredIrradiance_new)<span class="sc">/</span>(<span class="fu">as.numeric</span>(ScatteredIrradiance_new)<span class="sc">+</span><span class="fu">as.numeric</span>(DirectIrradiance_new))),</span>
<span id="cb59-8"><a href="MicaSense-Irradiance-Correction.html#cb59-8" tabindex="-1"></a>            <span class="at">max_Date_time =</span> <span class="fu">max</span>(Date_time),</span>
<span id="cb59-9"><a href="MicaSense-Irradiance-Correction.html#cb59-9" tabindex="-1"></a>            <span class="at">max_dir =</span> <span class="fu">max</span>(DirectIrradiance, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb59-10"><a href="MicaSense-Irradiance-Correction.html#cb59-10" tabindex="-1"></a>  <span class="fu">ungroup</span>()<span class="sc">%&gt;%</span></span>
<span id="cb59-11"><a href="MicaSense-Irradiance-Correction.html#cb59-11" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb59-12"><a href="MicaSense-Irradiance-Correction.html#cb59-12" tabindex="-1"></a>    <span class="at">Scattered_To_Direct_Ratio_DLS2 =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(median_ScatteredDirectRatio_DLS2,<span class="dv">2</span>)),</span>
<span id="cb59-13"><a href="MicaSense-Irradiance-Correction.html#cb59-13" tabindex="-1"></a>    <span class="at">Scattered_To_Direct_Ratio_DLS1 =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(median_ScatteredDirectRatio_DLS1_calc,<span class="dv">2</span>)),</span>
<span id="cb59-14"><a href="MicaSense-Irradiance-Correction.html#cb59-14" tabindex="-1"></a>    <span class="at">Percent_Scat_DLS2 =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(median_percent_scat_DLS2,<span class="dv">2</span>)),</span>
<span id="cb59-15"><a href="MicaSense-Irradiance-Correction.html#cb59-15" tabindex="-1"></a>    <span class="at">Percent_Scat_DLS1 =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(median_percent_scat_DLS1,<span class="dv">2</span>)),</span>
<span id="cb59-16"><a href="MicaSense-Irradiance-Correction.html#cb59-16" tabindex="-1"></a>    <span class="at">x =</span> max_Date_time,</span>
<span id="cb59-17"><a href="MicaSense-Irradiance-Correction.html#cb59-17" tabindex="-1"></a>    <span class="at">y =</span> max_dir,</span>
<span id="cb59-18"><a href="MicaSense-Irradiance-Correction.html#cb59-18" tabindex="-1"></a>  )<span class="sc">%&gt;%</span></span>
<span id="cb59-19"><a href="MicaSense-Irradiance-Correction.html#cb59-19" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(Scattered_To_Direct_Ratio_DLS2,Scattered_To_Direct_Ratio_DLS1,Percent_Scat_DLS2,Percent_Scat_DLS1, x, y, BandName, camera))</span>
<span id="cb59-20"><a href="MicaSense-Irradiance-Correction.html#cb59-20" tabindex="-1"></a></span>
<span id="cb59-21"><a href="MicaSense-Irradiance-Correction.html#cb59-21" tabindex="-1"></a><span class="fu">unique</span>(xmp_corrected<span class="sc">$</span>CenterWavelength) <span class="co">#make sure all wavebands are present</span></span>
<span id="cb59-22"><a href="MicaSense-Irradiance-Correction.html#cb59-22" tabindex="-1"></a></span>
<span id="cb59-23"><a href="MicaSense-Irradiance-Correction.html#cb59-23" tabindex="-1"></a><span class="fu">saveRDS</span>(avg_ratio_data,<span class="fu">paste0</span>(dir,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name ,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>,date,<span class="st">&quot;_avg_ratio_data.rds&quot;</span>))  <span class="co">#SET PATH to save the rds to</span></span></code></pre></div>
</details>
<p>Plotting original VS correctedirradiance exif data to compare values from the DLS2 to corrected values using the DLS1 method (Figure <a href="MicaSense-Irradiance-Correction.html#fig:DLS1-vs-DLS2-irr">12.14</a>).</p>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="MicaSense-Irradiance-Correction.html#cb60-1" tabindex="-1"></a>data <span class="ot">=</span> avg_ratio_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(BandName <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Blue&quot;</span>)) <span class="co"># only need to look at one band</span></span>
<span id="cb60-2"><a href="MicaSense-Irradiance-Correction.html#cb60-2" tabindex="-1"></a></span>
<span id="cb60-3"><a href="MicaSense-Irradiance-Correction.html#cb60-3" tabindex="-1"></a>(Dir_scat_irr_plot <span class="ot">&lt;-</span> xmp_corrected <span class="sc">%&gt;%</span></span>
<span id="cb60-4"><a href="MicaSense-Irradiance-Correction.html#cb60-4" tabindex="-1"></a>    <span class="fu">filter</span>(BandName <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Blue&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb60-5"><a href="MicaSense-Irradiance-Correction.html#cb60-5" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">DirectIrradiance =</span> <span class="fu">as.numeric</span>(DirectIrradiance),</span>
<span id="cb60-6"><a href="MicaSense-Irradiance-Correction.html#cb60-6" tabindex="-1"></a>           <span class="at">ScatteredIrradiance =</span> <span class="fu">as.numeric</span>(ScatteredIrradiance),</span>
<span id="cb60-7"><a href="MicaSense-Irradiance-Correction.html#cb60-7" tabindex="-1"></a>           <span class="at">Irradiance =</span> <span class="fu">as.numeric</span>(Irradiance),</span>
<span id="cb60-8"><a href="MicaSense-Irradiance-Correction.html#cb60-8" tabindex="-1"></a>           <span class="at">SpectralIrradiance =</span> <span class="fu">as.numeric</span>(SpectralIrradiance),</span>
<span id="cb60-9"><a href="MicaSense-Irradiance-Correction.html#cb60-9" tabindex="-1"></a>           <span class="at">HorizontalIrradiance =</span> <span class="fu">as.numeric</span>(HorizontalIrradiance),</span>
<span id="cb60-10"><a href="MicaSense-Irradiance-Correction.html#cb60-10" tabindex="-1"></a>           <span class="co"># Date_time = ymd_hms(CreateDate),</span></span>
<span id="cb60-11"><a href="MicaSense-Irradiance-Correction.html#cb60-11" tabindex="-1"></a>           <span class="at">Time =</span> <span class="fu">format</span>(Date_time, <span class="at">format =</span> <span class="st">&quot;%H:%M:%S&quot;</span>),</span>
<span id="cb60-12"><a href="MicaSense-Irradiance-Correction.html#cb60-12" tabindex="-1"></a>           <span class="co">#scaled </span></span>
<span id="cb60-13"><a href="MicaSense-Irradiance-Correction.html#cb60-13" tabindex="-1"></a>           <span class="at">DirectIrradiance_scaled =</span> <span class="fu">as.numeric</span>(DirectIrradiance)<span class="sc">*</span><span class="fl">0.01</span>,</span>
<span id="cb60-14"><a href="MicaSense-Irradiance-Correction.html#cb60-14" tabindex="-1"></a>           <span class="at">ScatteredIrradiance_scaled =</span> <span class="fu">as.numeric</span>(ScatteredIrradiance)<span class="sc">*</span><span class="fl">0.01</span>,</span>
<span id="cb60-15"><a href="MicaSense-Irradiance-Correction.html#cb60-15" tabindex="-1"></a>           <span class="at">SpectralIrradiance_scaled =</span> <span class="fu">as.numeric</span>(SpectralIrradiance)<span class="sc">*</span><span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb60-16"><a href="MicaSense-Irradiance-Correction.html#cb60-16" tabindex="-1"></a>    </span>
<span id="cb60-17"><a href="MicaSense-Irradiance-Correction.html#cb60-17" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(Date_time)) <span class="sc">+</span></span>
<span id="cb60-18"><a href="MicaSense-Irradiance-Correction.html#cb60-18" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> DirectIrradiance, <span class="at">color =</span> <span class="st">&quot;Direct&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb60-19"><a href="MicaSense-Irradiance-Correction.html#cb60-19" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> DirectIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Direct_DLS1&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb60-20"><a href="MicaSense-Irradiance-Correction.html#cb60-20" tabindex="-1"></a>    </span>
<span id="cb60-21"><a href="MicaSense-Irradiance-Correction.html#cb60-21" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ScatteredIrradiance, <span class="at">color =</span> <span class="st">&quot;Scattered&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb60-22"><a href="MicaSense-Irradiance-Correction.html#cb60-22" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ScatteredIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Scattered_DLS1&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>,<span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb60-23"><a href="MicaSense-Irradiance-Correction.html#cb60-23" tabindex="-1"></a>    </span>
<span id="cb60-24"><a href="MicaSense-Irradiance-Correction.html#cb60-24" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> HorizontalIrradiance, <span class="at">color =</span> <span class="st">&quot;Horizontal&quot;</span>),<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb60-25"><a href="MicaSense-Irradiance-Correction.html#cb60-25" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> HorizontalIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Horizontal_DLS1&quot;</span>),<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb60-26"><a href="MicaSense-Irradiance-Correction.html#cb60-26" tabindex="-1"></a>    </span>
<span id="cb60-27"><a href="MicaSense-Irradiance-Correction.html#cb60-27" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Irradiance, <span class="at">color =</span> <span class="st">&quot;Irradiance&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb60-28"><a href="MicaSense-Irradiance-Correction.html#cb60-28" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> HorizontalIrradiance, <span class="at">color =</span> <span class="st">&quot;Horizontal&quot;</span>),<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb60-29"><a href="MicaSense-Irradiance-Correction.html#cb60-29" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> SpectralIrradiance, <span class="at">color =</span> <span class="st">&quot;Spectral&quot;</span>), <span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb60-30"><a href="MicaSense-Irradiance-Correction.html#cb60-30" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Time (UTC)&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Irradiance&quot;</span>, <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;DLS1 (corrected) vs. DLS2 (metadata) Irradiance, Site: &quot;</span>,site_to_plot,<span class="st">&quot;, </span></span>
<span id="cb60-31"><a href="MicaSense-Irradiance-Correction.html#cb60-31" tabindex="-1"></a><span class="st">                                                      </span><span class="sc">\n</span><span class="st">Date: &quot;</span>, date_to_plot,<span class="st">&quot;, Camera: &quot;</span>, camera_to_plot,</span>
<span id="cb60-32"><a href="MicaSense-Irradiance-Correction.html#cb60-32" tabindex="-1"></a>                                                      <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Scattered_To_Direct_Ratio_DLS1:&quot;</span>, data<span class="sc">$</span>Scattered_To_Direct_Ratio_DLS1,</span>
<span id="cb60-33"><a href="MicaSense-Irradiance-Correction.html#cb60-33" tabindex="-1"></a>                                                      <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Scattered_To_Direct_Ratio_DLS2:&quot;</span>, data<span class="sc">$</span>Scattered_To_Direct_Ratio_DLS2,</span>
<span id="cb60-34"><a href="MicaSense-Irradiance-Correction.html#cb60-34" tabindex="-1"></a>                                                      <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Percent_Scat_DLS1:&quot;</span>, data<span class="sc">$</span>Percent_Scat_DLS1,</span>
<span id="cb60-35"><a href="MicaSense-Irradiance-Correction.html#cb60-35" tabindex="-1"></a>                                                      <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Percent_Scat_DLS2:&quot;</span>, data<span class="sc">$</span>Percent_Scat_DLS2</span>
<span id="cb60-36"><a href="MicaSense-Irradiance-Correction.html#cb60-36" tabindex="-1"></a>                                                      )) <span class="sc">+</span></span>
<span id="cb60-37"><a href="MicaSense-Irradiance-Correction.html#cb60-37" tabindex="-1"></a>    <span class="fu">scale_x_datetime</span>(<span class="at">date_breaks =</span> <span class="st">&quot;10 min&quot;</span>, <span class="at">date_labels =</span> <span class="st">&quot;%H:%M&quot;</span>) <span class="sc">+</span></span>
<span id="cb60-38"><a href="MicaSense-Irradiance-Correction.html#cb60-38" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Direct&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>, </span>
<span id="cb60-39"><a href="MicaSense-Irradiance-Correction.html#cb60-39" tabindex="-1"></a>                                  <span class="st">&quot;Direct_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;lightblue&quot;</span>,</span>
<span id="cb60-40"><a href="MicaSense-Irradiance-Correction.html#cb60-40" tabindex="-1"></a>                                  <span class="st">&quot;Scattered&quot;</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb60-41"><a href="MicaSense-Irradiance-Correction.html#cb60-41" tabindex="-1"></a>                                  <span class="st">&quot;Scattered_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;grey&quot;</span>,</span>
<span id="cb60-42"><a href="MicaSense-Irradiance-Correction.html#cb60-42" tabindex="-1"></a>                                  <span class="st">&quot;Horizontal&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>,</span>
<span id="cb60-43"><a href="MicaSense-Irradiance-Correction.html#cb60-43" tabindex="-1"></a>                                  <span class="st">&quot;Horizontal_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;orange&quot;</span>,</span>
<span id="cb60-44"><a href="MicaSense-Irradiance-Correction.html#cb60-44" tabindex="-1"></a>                                  <span class="st">&quot;Spectral&quot;</span> <span class="ot">=</span> <span class="st">&quot;forestgreen&quot;</span>,</span>
<span id="cb60-45"><a href="MicaSense-Irradiance-Correction.html#cb60-45" tabindex="-1"></a>                                  <span class="st">&quot;Irradiance&quot;</span> <span class="ot">=</span><span class="st">&quot;purple&quot;</span></span>
<span id="cb60-46"><a href="MicaSense-Irradiance-Correction.html#cb60-46" tabindex="-1"></a>    ),</span>
<span id="cb60-47"><a href="MicaSense-Irradiance-Correction.html#cb60-47" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;Irradiance (W/m2/nm)&quot;</span>)<span class="sc">+</span></span>
<span id="cb60-48"><a href="MicaSense-Irradiance-Correction.html#cb60-48" tabindex="-1"></a>    <span class="fu">facet_grid</span>(BandName <span class="sc">~</span> camera, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>)<span class="sc">+</span></span>
<span id="cb60-49"><a href="MicaSense-Irradiance-Correction.html#cb60-49" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb60-50"><a href="MicaSense-Irradiance-Correction.html#cb60-50" tabindex="-1"></a>)</span></code></pre></div>
</details>
<!-- ````{=html} -->
<!-- <!-- -->
<!-- ```{r eval=FALSE, include=TRUE} -->
<!-- ggsave(plot = Dir_scat_irr_plot, -->
<!--        filename = paste0(plot_dir, "5_Irradiance_DLS1_DLS2_plot.jpeg"), -->
<!--        device = jpeg, -->
<!--        width = 15, -->
<!--        height = 10, -->
<!--        units = 'in', -->
<!--        dpi = 300, -->
<!--        bg = 'white') -->
<!-- ``` -->
<div class="figure" style="text-align: center"><span style="display:block;" id="fig:DLS1-vs-DLS2-irr"></span>
<img src="Photos_&_gifs/5_Irradiance_DLS1_DLS2_plot_reDone.PNG" alt="Direct, horizontal, scattered, and spectral irradiance from the DLS2 and DLS1 method from the MicaSense exif data, flown on June 25th, 2024. Average ratio of scattered: direct irradiance componenets for the DLS1 was 0.46 and 0.09 for the DSL2." width="100%" />
<p class="caption">
Figure 12.14: Direct, horizontal, scattered, and spectral irradiance from the DLS2 and DLS1 method from the MicaSense exif data, flown on June 25th, 2024. Average ratio of scattered: direct irradiance componenets for the DLS1 was 0.46 and 0.09 for the DSL2.
</p>
</div>
<p>Refer to the section <a href="MicaSense-Irradiance-Correction.html#is-correction-needed">Is Correction Needed?</a> to help decide whether or not your data needs correcting.</p>
<p>Up to this point, we have calculated “corrected” irradiance and sun sensor angles however have not overwritten the exif data within the MicaSense imagery. In this next step, we will overwrite image exif data with the corrected DLS1 values. Before moving on to this step ensure that :</p>
<ol style="list-style-type: decimal">
<li><p>You have decided that your data needs correcting</p></li>
<li><p>You have created a backup of your original data, since you will be irreversibly overwriting the exif data of the imagery. Prior to running the code below we copied all images in our MicaSense folder to a folder in the same directory as the MicaSense folder however named named MicaSense_cor. Imagery in the MicaSense_cor folder will be the imagery we will be editing, and the MicaSense folder will contain the unedited imagery</p></li>
<li><p>The MicaSense.config has been downloaded from <a href="https://github.com/owaite/GenomeBC_BPG">GitHub</a>, the file can be found in the “Scripts” folder under MicaSense</p></li>
</ol>
<details>
<summary>
Click to show the code
</summary>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="MicaSense-Irradiance-Correction.html#cb61-1" tabindex="-1"></a><span class="co"># Writing over exif data with corrected SSA, horizontal irradiance, direct irradiance, and scattered irradiance</span></span>
<span id="cb61-2"><a href="MicaSense-Irradiance-Correction.html#cb61-2" tabindex="-1"></a></span>
<span id="cb61-3"><a href="MicaSense-Irradiance-Correction.html#cb61-3" tabindex="-1"></a>corrected_directory <span class="ot">&lt;-</span> <span class="fu">paste0</span>(dir,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;_cor</span><span class="sc">\\</span><span class="st">&quot;</span>) <span class="co">#i.e. this folder is called MicaSense_cor and is a copied version of the MicaSense folder, we will be correcting the exif data of images in the MicaSense_cor folder and leaving the MicaSense folder untouched with the original exif data</span></span>
<span id="cb61-4"><a href="MicaSense-Irradiance-Correction.html#cb61-4" tabindex="-1"></a>original_directory <span class="ot">&lt;-</span> <span class="fu">paste0</span>(dir,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>) <span class="co"># path the folder of micasense images</span></span>
<span id="cb61-5"><a href="MicaSense-Irradiance-Correction.html#cb61-5" tabindex="-1"></a></span>
<span id="cb61-6"><a href="MicaSense-Irradiance-Correction.html#cb61-6" tabindex="-1"></a>xmp_corrected <span class="ot">=</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(dir, date, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">&quot;</span>, MS_folder_name,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>,date,<span class="st">&quot;_xmp_corrected.rds&quot;</span>)) <span class="sc">%&gt;%</span> <span class="co">#path to corrected xmp data .rds file</span></span>
<span id="cb61-7"><a href="MicaSense-Irradiance-Correction.html#cb61-7" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SourceFile =</span> <span class="fu">str_replace</span>(SourceFile,original_directory, corrected_directory), <span class="co"># Changing source file name from the original directory to the corrected_directory. This will result in imagery in the corrected direcotry only to be edited</span></span>
<span id="cb61-8"><a href="MicaSense-Irradiance-Correction.html#cb61-8" tabindex="-1"></a>         <span class="at">TargetFile =</span> SourceFile) <span class="co">#the TargetFiles are the path names to the files to be edited</span></span>
<span id="cb61-9"><a href="MicaSense-Irradiance-Correction.html#cb61-9" tabindex="-1"></a></span>
<span id="cb61-10"><a href="MicaSense-Irradiance-Correction.html#cb61-10" tabindex="-1"></a><span class="co"># As vectors</span></span>
<span id="cb61-11"><a href="MicaSense-Irradiance-Correction.html#cb61-11" tabindex="-1"></a>(<span class="at">img_list =</span> xmp_corrected<span class="sc">$</span>FileName)</span>
<span id="cb61-12"><a href="MicaSense-Irradiance-Correction.html#cb61-12" tabindex="-1"></a>(<span class="at">targets =</span> xmp_corrected<span class="sc">$</span>TargetFile)</span>
<span id="cb61-13"><a href="MicaSense-Irradiance-Correction.html#cb61-13" tabindex="-1"></a>(<span class="at">SSA =</span> xmp_corrected<span class="sc">$</span>SunSensorAngle_DLS1_rad)</span>
<span id="cb61-14"><a href="MicaSense-Irradiance-Correction.html#cb61-14" tabindex="-1"></a></span>
<span id="cb61-15"><a href="MicaSense-Irradiance-Correction.html#cb61-15" tabindex="-1"></a>(<span class="at">horirrorig =</span> xmp_corrected<span class="sc">$</span>HorizontalIrradiance)</span>
<span id="cb61-16"><a href="MicaSense-Irradiance-Correction.html#cb61-16" tabindex="-1"></a>(<span class="at">horirr =</span> xmp_corrected<span class="sc">$</span>HorizontalIrradiance_new)</span>
<span id="cb61-17"><a href="MicaSense-Irradiance-Correction.html#cb61-17" tabindex="-1"></a>(<span class="at">dirirr =</span> xmp_corrected<span class="sc">$</span>DirectIrradiance_new)</span>
<span id="cb61-18"><a href="MicaSense-Irradiance-Correction.html#cb61-18" tabindex="-1"></a>(<span class="at">scairr =</span> xmp_corrected<span class="sc">$</span>ScatteredIrradiance_new)</span>
<span id="cb61-19"><a href="MicaSense-Irradiance-Correction.html#cb61-19" tabindex="-1"></a></span>
<span id="cb61-20"><a href="MicaSense-Irradiance-Correction.html#cb61-20" tabindex="-1"></a>targets[<span class="dv">1</span>] <span class="co">#checking its the right imgs</span></span>
<span id="cb61-21"><a href="MicaSense-Irradiance-Correction.html#cb61-21" tabindex="-1"></a></span>
<span id="cb61-22"><a href="MicaSense-Irradiance-Correction.html#cb61-22" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="fu">seq_along</span>(targets)) {</span>
<span id="cb61-23"><a href="MicaSense-Irradiance-Correction.html#cb61-23" tabindex="-1"></a>  <span class="co"># given a micasense config file, overwrite tags with computed values</span></span>
<span id="cb61-24"><a href="MicaSense-Irradiance-Correction.html#cb61-24" tabindex="-1"></a>  <span class="co"># using exiftool_call from the exifr package</span></span>
<span id="cb61-25"><a href="MicaSense-Irradiance-Correction.html#cb61-25" tabindex="-1"></a>  call <span class="ot">=</span> <span class="fu">paste0</span>(<span class="st">&quot;-config G:/GitHub/GenomeBC_BPG/MicaSense/MicaSense.config&quot;</span>, <span class="co"># SET PATH to the config file, this file is on the PARSER GitHub in the same folder as this R script</span></span>
<span id="cb61-26"><a href="MicaSense-Irradiance-Correction.html#cb61-26" tabindex="-1"></a>                <span class="st">&quot; -overwrite_original_in_place&quot;</span>,</span>
<span id="cb61-27"><a href="MicaSense-Irradiance-Correction.html#cb61-27" tabindex="-1"></a>                <span class="st">&quot; -SunSensorAngle=&quot;</span>, SSA[i],</span>
<span id="cb61-28"><a href="MicaSense-Irradiance-Correction.html#cb61-28" tabindex="-1"></a>                <span class="st">&quot; -HorizontalIrradiance=&quot;</span>, horirr[i],</span>
<span id="cb61-29"><a href="MicaSense-Irradiance-Correction.html#cb61-29" tabindex="-1"></a>                <span class="st">&quot; -HorizontalIrradianceDLS2=&quot;</span>, horirrorig[i],</span>
<span id="cb61-30"><a href="MicaSense-Irradiance-Correction.html#cb61-30" tabindex="-1"></a>                <span class="st">&quot; -DirectIrradiance=&quot;</span>, dirirr[i],</span>
<span id="cb61-31"><a href="MicaSense-Irradiance-Correction.html#cb61-31" tabindex="-1"></a>                <span class="st">&quot; -ScatteredIrradiance=&quot;</span>, scairr[i], <span class="st">&quot; &quot;</span>,</span>
<span id="cb61-32"><a href="MicaSense-Irradiance-Correction.html#cb61-32" tabindex="-1"></a>                targets[i])</span>
<span id="cb61-33"><a href="MicaSense-Irradiance-Correction.html#cb61-33" tabindex="-1"></a>  </span>
<span id="cb61-34"><a href="MicaSense-Irradiance-Correction.html#cb61-34" tabindex="-1"></a>  <span class="fu">exiftool_call</span>(call, <span class="at">quiet =</span> <span class="cn">TRUE</span>)</span>
<span id="cb61-35"><a href="MicaSense-Irradiance-Correction.html#cb61-35" tabindex="-1"></a>  <span class="fu">print</span>(<span class="fu">paste0</span>(i, <span class="st">&quot;/&quot;</span>, <span class="fu">length</span>(targets), <span class="st">&quot; updated img:&quot;</span>,img_list[i] ))</span>
<span id="cb61-36"><a href="MicaSense-Irradiance-Correction.html#cb61-36" tabindex="-1"></a>}</span></code></pre></div>
</details>
<p>Lastly, check the exif data of the first and last image to ensure that the data has been properly overwritten.</p>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="lidar-processing-workflow.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="Thermal-Conversion.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/owaite/GenomeBC_BPG/edit/main/0_MicaSense_Irradiance_Correction.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/owaite/GenomeBC_BPG/blob/main/0_MicaSense_Irradiance_Correction.Rmd",
"text": null
},
"download": null,
"search": {
"engine": "fuse",
"options": null
},
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
