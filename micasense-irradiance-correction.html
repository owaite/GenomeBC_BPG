<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 1 MicaSense Irradiance Correction | 0_MicaSense_Irradiance_Correction.knit</title>
  <meta name="description" content="" />
  <meta name="generator" content="bookdown 0.40 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 1 MicaSense Irradiance Correction | 0_MicaSense_Irradiance_Correction.knit" />
  <meta property="og:type" content="book" />
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 1 MicaSense Irradiance Correction | 0_MicaSense_Irradiance_Correction.knit" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  


<script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.6/dist/fuse.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />








<link href="libs/anchor-sections-1.1.0/anchor-sections.css" rel="stylesheet" />
<link href="libs/anchor-sections-1.1.0/anchor-sections-hash.css" rel="stylesheet" />
<script src="libs/anchor-sections-1.1.0/anchor-sections.js"></script>


<style type="text/css">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<style type="text/css">
  
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><a href="./">Drone Based Phenotyping for Research Trials</a></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path=""><a href="#micasense-irradiance-correction"><i class="fa fa-check"></i><b>1</b> MicaSense Irradiance Correction</a>
<ul>
<li class="chapter" data-level="1.1" data-path=""><a href="#background"><i class="fa fa-check"></i><b>1.1</b> Background</a>
<ul>
<li class="chapter" data-level="1.1.1" data-path=""><a href="#deriving-horizontal-irradiance"><i class="fa fa-check"></i><b>1.1.1</b> Deriving Horizontal Irradiance</a></li>
<li class="chapter" data-level="1.1.2" data-path=""><a href="#calculating-reflectance"><i class="fa fa-check"></i><b>1.1.2</b> Calculating Reflectance</a></li>
</ul></li>
<li class="chapter" data-level="1.2" data-path=""><a href="#issue"><i class="fa fa-check"></i><b>1.2</b> Issue</a></li>
<li class="chapter" data-level="1.3" data-path=""><a href="#is-correction-needed"><i class="fa fa-check"></i><b>1.3</b> Is correction needed?</a>
<ul>
<li class="chapter" data-level="1.3.1" data-path=""><a href="#do-the-sun-sensor-angles-make-sense"><i class="fa fa-check"></i><b>1.3.1</b> 1) Do the sun sensor angles make sense?</a></li>
</ul></li>
<li class="chapter" data-level="1.4" data-path=""><a href="#correcting-irradiance-values-for-micasense-cameras"><i class="fa fa-check"></i><b>1.4</b> Correcting Irradiance Values for Micasense Cameras</a>
<ul>
<li class="chapter" data-level="1.4.1" data-path=""><a href="#initial-setup-and-data-loading"><i class="fa fa-check"></i><b>1.4.1</b> Initial Setup and Data Loading</a></li>
<li class="chapter" data-level="1.4.2" data-path=""><a href="#calculating-solar-angle"><i class="fa fa-check"></i><b>1.4.2</b> Calculating Solar Angle</a></li>
<li class="chapter" data-level="1.4.3" data-path=""><a href="#caluclating-solar-angles"><i class="fa fa-check"></i><b>1.4.3</b> Caluclating Solar Angles</a></li>
<li class="chapter" data-level="1.4.4" data-path=""><a href="#caluclating-sun-sensor-angles"><i class="fa fa-check"></i><b>1.4.4</b> Caluclating Sun-Sensor Angles</a></li>
<li class="chapter" data-level="1.4.5" data-path=""><a href="#scattereddirect-ratio-estimate"><i class="fa fa-check"></i><b>1.4.5</b> Scattered/Direct Ratio Estimate</a></li>
<li class="chapter" data-level="1.4.6" data-path=""><a href="#compute-horizontal-corrected-irradiance"><i class="fa fa-check"></i><b>1.4.6</b> Compute horizontal (corrected) irradiance</a></li>
<li class="chapter" data-level="1.4.7" data-path=""><a href="#visualizing-the"><i class="fa fa-check"></i><b>1.4.7</b> Visualizing the</a></li>
</ul></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./"></a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<!--bookdown:title:end-->
<!--bookdown:title:start-->
<div id="micasense-irradiance-correction" class="section level1 hasAnchor" number="1">
<h1><span class="header-section-number">Chapter 1</span> MicaSense Irradiance Correction<a href="#micasense-irradiance-correction" class="anchor-section" aria-label="Anchor link to header"></a></h1>
<div id="background" class="section level2 hasAnchor" number="1.1">
<h2><span class="header-section-number">1.1</span> Background<a href="#background" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>The MicaSense system measures radiance at the camera, which needs to be transformed into surface reflectance. The basic relationship is given by:</p>
<p><span class="math display">\[
R = \frac{L}{I_{\text{hor}}}
\]</span></p>
<p>where <span class="math inline">\(L\)</span> is the at-camera radiance and <span class="math inline">\(I_{\text{hor}}\)</span> is the horizontal irradiance.</p>
<div id="deriving-horizontal-irradiance" class="section level3 hasAnchor" number="1.1.1">
<h3><span class="header-section-number">1.1.1</span> Deriving Horizontal Irradiance<a href="#deriving-horizontal-irradiance" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Below we go through the derivation to compute <span class="math inline">\(I_{\text{hor}}\)</span>.</p>
<p>The MicaSense system includes both the camera and a downwelling light sensor (DLS). Since the DLS is tilted at the angle of the drone during flight, it measures non-horizontal irradiance, referred to as spectral irradiance (<span class="math inline">\(I_{\text{spec}}\)</span>). Spectral irradiance is a function of direct irradiance (<span class="math inline">\(I_{\text{direct}}\)</span>), scattered irradiance (<span class="math inline">\(I_{\text{scattered}}\)</span>), and the angle between the sun and the sensor ( <span class="math inline">\(\theta_{\text{sun-sensor}}\)</span>):</p>
<p><span class="math display">\[
I_{\text{spec}} = I_{\text{direct}} \cdot \cos(\theta_{\text{sun-sensor}}) + I_{\text{scattered}}
\]</span></p>
<p>Given that <span class="math inline">\(r = \frac{I_{\text{scattered}}}{I_{\text{direct}}}\)</span>, we can substitute <span class="math inline">\(I_{\text{scattered}} = r \cdot I_{\text{direct}}\)</span> into the equation:</p>
<p><span class="math display">\[
I_{\text{spec}} = I_{\text{direct}} \cdot \cos(\theta_{\text{sun-sensor}}) + r \cdot I_{\text{direct}}
\]</span></p>
<p>Next, by factoring out <span class="math inline">\(I_{\text{direct}}\)</span> from the equation:</p>
<p><span class="math display">\[
I_{\text{spec}} = I_{\text{direct}} \cdot \left( \cos(\theta_{\text{sun-sensor}}) + r \right)
\]</span></p>
<p>We can solve for <span class="math inline">\(I_{\text{direct}}\)</span> by dividing both sides of the equation by <span class="math inline">\(\cos(\theta_{\text{sun-sensor}}) + r\)</span>:</p>
<p><span class="math display">\[
I_{\text{direct}} = \frac{I_{\text{spec}}}{\cos(\theta_{\text{sun-sensor}}) + r}
\]</span></p>
<p>If we assume that <span class="math inline">\(I_{\text{hor}}\)</span> can be expressed in terms of <span class="math inline">\(I_{\text{direct}}\)</span> with a similar function involving the zenith angle, we can express this as:</p>
<p><span class="math display">\[
I_{\text{hor}} = I_{\text{direct}} \cdot \left( \cos(\theta_{\text{zenith}}) + r \right)
\]</span></p>
<p>Substituting the equation for <span class="math inline">\(I_{\text{direct}}\)</span> into the equation for <span class="math inline">\(I_{\text{hor}}\)</span> gives:</p>
<p><span class="math display">\[
I_{\text{hor}} = \frac{I_{\text{spec}}}{\cos(\theta_{\text{sun-sensor}}) + r} \cdot \left( \cos(\theta_{\text{zenith}}) + r \right)
\]</span></p>
</div>
<div id="calculating-reflectance" class="section level3 hasAnchor" number="1.1.2">
<h3><span class="header-section-number">1.1.2</span> Calculating Reflectance<a href="#calculating-reflectance" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Finally, substituting <span class="math inline">\(I_{\text{hor}}\)</span> into the equation for reflectance, we obtain:</p>
<p><span class="math display">\[
R = L \cdot \frac{\cos(\theta_{\text{sun-sensor}}) + r}{I_{\text{spec}} \cdot \left( \cos(\theta_{\text{zenith}}) + r \right)}
\]</span></p>
<p>Thus we see that reflectance is highly dependent on the ratio of scattered to direct irradiance as well as the sun-sensor angle. This is important for understanding the issue we have found when working with the DLS2 and the MicaSense MX Dual camera system.</p>
</div>
</div>
<div id="issue" class="section level2 hasAnchor" number="1.2">
<h2><span class="header-section-number">1.2</span> Issue<a href="#issue" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To begin, let us first look at the difference between the historic DLS1 and the current DLS2 system.</p>
<p>The DLS1:</p>
<ul>
<li><p>has ### sensor on the surface</p></li>
<li><p>the sun zenith angle is calculated using the GPS location of the drone and the time of acquisition</p></li>
<li><p>the sun-sensor angle is calculated from the yaw/pitch/roll of the drone</p></li>
<li><p>scattered/direct irradiance ratio was assumed to perform the atmospheric correction</p></li>
</ul>
<p>The DLS2:</p>
<ul>
<li>uses a proprietary method that takes in information from the #### sensors on the surface and calculated the sun-sensor angle, the direct irradiance and the scattered irradiance</li>
</ul>
<p>The issue we have noticed is that the sun-sensor angle can be absurdly high or low, especially in strong illumination conditions. This leads to absurd values for direct and scattered irradiance, that can be multiples higher than the direct solar irradiance.</p>
<div id="insert-example-graphs" class="section level13" number="1.2.0.0.0.0.0.0.0.0.0.0.1">
<p class="heading"><span class="header-section-number">1.2.0.0.0.0.0.0.0.0.0.0.1</span> INSERT EXAMPLE GRAPHS</p>
</div>
</div>
<div id="is-correction-needed" class="section level2 hasAnchor" number="1.3">
<h2><span class="header-section-number">1.3</span> Is correction needed?<a href="#is-correction-needed" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>Deciding whether data needs to be corrected can be challenging. We have found that looking at a few key metrics can be very helpful.</p>
<ol style="list-style-type: decimal">
<li><p>Do the sun sensor angles make sense?</p></li>
<li><p>Does the scattered: direct ratio make sense for the lighting conditions of that day?</p></li>
<li><p>Does the magnitude of irradiance values make sense?</p></li>
<li><p>Do the relationships between direct and horizontal irradiance make sense?</p></li>
</ol>
<p>We will go into more detail into each of these questions but first will introduce how this data is affected by light conditions.</p>
<p>Below we have plotted the sun to sensor angle (top left), the position of each photo (bottom left) and the irradiance values (right). We have used the yaw values to identify flight lines (blue and green) and roll to filter for images taken when the drone is turning.</p>
<div id="do-the-sun-sensor-angles-make-sense" class="section level3 hasAnchor" number="1.3.1">
<h3><span class="header-section-number">1.3.1</span> 1) Do the sun sensor angles make sense?<a href="#do-the-sun-sensor-angles-make-sense" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This data was captured on June 25th, 2024 on Vancouver Island in British Columbia, Canada. As seen by the black horizontal line, the solar angle at the time of the flight was around 30
<img src="Photos_&_gifs/Irradiance_flight_lines_with_turning_all_with_spatial_plot.PNG" width="100%" style="display: block; margin: auto;" /></p>
</div>
</div>
<div id="correcting-irradiance-values-for-micasense-cameras" class="section level2 hasAnchor" number="1.4">
<h2><span class="header-section-number">1.4</span> Correcting Irradiance Values for Micasense Cameras<a href="#correcting-irradiance-values-for-micasense-cameras" class="anchor-section" aria-label="Anchor link to header"></a></h2>
<p>To fix the sun-sensor angle and irradiance values we have taken the methodology used by the DLS1.</p>
<p>???????????????? from thomas below##########:</p>
<ul>
<li><p>The idea is to use the GPS location and time of acquisition to determine the solar angle, and determine the sun-sensor angle using the yaw/pitch/roll of the drone</p></li>
<li><p>However, we do not want to assume the scattered/direct ratio: a quick sensitivity analysis on the effect of drone tilt on the horizontal irradiance value derived from the spectral irradiance showed that in sunny conditions, during summer (sun zenith angle of 40 deg), the difference was at most 30%</p></li>
<li><p>We assume that all irradiance values computed by the DLS2 are correct as long as the final horizontal irradiance values are within 30% of the spectral irradiances, and derive the scattered/direct ratio of the whole flight from the DLS2 measurements</p></li>
<li><p>We then employ the formulas present in slide 2 to compute the horizontal irradiance from the spectral irradiance</p></li>
<li><p>We edit the exif data of the images so that they can be processed by Metashape with the correct irradiance values</p></li>
</ul>
<div id="from-chat" class="section level16" number="1.4.0.0.0.0.0.0.0.0.0.0.0.0.0.1">
<p class="heading"><span class="header-section-number">1.4.0.0.0.0.0.0.0.0.0.0.0.0.0.1</span> FROM CHAT ##########:</p>
</div>
<div id="initial-setup-and-data-loading" class="section level3 hasAnchor" number="1.4.1">
<h3><span class="header-section-number">1.4.1</span> Initial Setup and Data Loading<a href="#initial-setup-and-data-loading" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This chapter explains the process of correcting irradiance values for Micasense cameras using R. The correction involves several steps, including filtering and mutating data, calculating solar angles, and estimating scattered to direct light ratios. Each step is crucial for ensuring accurate irradiance readings, which are essential for downstream analyses.</p>
<p>First, we define the site and date variables. These are used to specify the data for the current analysis. We then load the XMP metadata for all bands and calibration panels.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>xmp_all <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>, date, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>, camera, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">XMP_data_&quot;</span>, camera, <span class="st">&quot;_&quot;</span>, date, <span class="st">&quot;_AllBands_CalPanelsLabelled.rds&quot;</span>)) <span class="sc">%&gt;%</span> </span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">str_detect</span>(SourceFile, camera))</span></code></pre></div>
</div>
<div id="calculating-solar-angle" class="section level3 hasAnchor" number="1.4.2">
<h3><span class="header-section-number">1.4.2</span> Calculating Solar Angle<a href="#calculating-solar-angle" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Below we check that the calibration panels are flagged and convert the DateTimeOrgiianl to a date object. The date time and average lat and lon are then used to calucalte solar angle:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">unique</span>(xmp_all<span class="sc">$</span>panel_flag[xmp_all<span class="sc">$</span>site <span class="sc">==</span> site])</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>xmp_all_filtered <span class="ot">&lt;-</span> xmp_all <span class="sc">%&gt;%</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date_time =</span> <span class="fu">ymd_hms</span>(DateTimeOriginal),</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>         <span class="at">BandName_Wavelength =</span> <span class="fu">paste0</span>(BandName, <span class="st">&quot;_&quot;</span>, CentralWavelength),</span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>         <span class="at">Date =</span> <span class="fu">as.Date</span>(Date_time),</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>         <span class="at">Time =</span> <span class="fu">format</span>(Date_time, <span class="at">format =</span> <span class="st">&quot;%H:%M:%S&quot;</span>),</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>         <span class="at">img_name =</span> <span class="fu">str_split</span>(FileName, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">.tif&quot;</span>, <span class="at">simplify =</span> <span class="cn">TRUE</span>)[, <span class="dv">1</span>],</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>         <span class="at">img_root =</span> <span class="fu">sub</span>(<span class="st">&quot;_(</span><span class="sc">\\</span><span class="st">d+)$&quot;</span>, <span class="st">&quot;&quot;</span>, img_name)) <span class="sc">%&gt;%</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>  <span class="fu">drop_na</span>(DateTimeOriginal) <span class="sc">%&gt;%</span> </span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>  <span class="fu">group_by</span>(site) <span class="sc">%&gt;%</span></span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">mutate</span>(</span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>    <span class="at">site_avg_lat =</span> <span class="fu">median</span>(GPSLatitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>    <span class="at">site_avg_long =</span> <span class="fu">median</span>(GPSLongitude, <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>    <span class="at">solar_angle =</span> photobiology<span class="sc">::</span><span class="fu">sun_zenith_angle</span>(<span class="at">time =</span> <span class="fu">ymd_hms</span>(DateTimeOriginal),</span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>                                                 <span class="at">geocode =</span> tibble<span class="sc">::</span><span class="fu">tibble</span>(<span class="at">lon =</span> <span class="fu">unique</span>(site_avg_long),</span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>                                                                          <span class="at">lat =</span> <span class="fu">unique</span>(site_avg_lat),</span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>                                                                          <span class="at">address =</span> <span class="st">&quot;Greenwich&quot;</span>)))</span></code></pre></div>
<p>Next, we check for any missing timestamps in image metadata as this usually indicates that the image was not saved properly and cant be opened which will throw errors later in the workflow. In our experience, these images are few and far between, so we remove them from the analysis.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>missing_imgs <span class="ot">&lt;-</span> xmp_all[<span class="fu">is.na</span>(<span class="fu">as.Date</span>(xmp_all<span class="sc">$</span>CreateDate, <span class="at">format =</span> <span class="st">&quot;%Y:%m:%d&quot;</span>))]<span class="sc">$</span>FileName</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>missing_imgs_roots <span class="ot">&lt;-</span> <span class="fu">sub</span>(<span class="st">&quot;_[^_]*$&quot;</span>, <span class="st">&quot;&quot;</span>, missing_imgs)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>xmp_all_filtered_mis <span class="ot">&lt;-</span> xmp_all_filtered <span class="sc">%&gt;%</span></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span>FileName <span class="sc">%in%</span> <span class="fu">c</span>(missing_imgs))</span></code></pre></div>
</div>
<div id="caluclating-solar-angles" class="section level3 hasAnchor" number="1.4.3">
<h3><span class="header-section-number">1.4.3</span> Caluclating Solar Angles<a href="#caluclating-solar-angles" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>The solar position and irradiance values are necessary to understand whether or not DLS acquired values are reasonable. We calculate the direct normal irradaiance using the average lattitude and longitude from the GPS coordinates of the imagery and the time of the acquisition.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>(lat <span class="ot">&lt;-</span> <span class="fu">unique</span>(xmp_all_filtered<span class="sc">$</span>site_avg_lat))</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>(lon <span class="ot">&lt;-</span> <span class="fu">unique</span>(xmp_all_filtered<span class="sc">$</span>site_avg_long))</span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>(time <span class="ot">&lt;-</span> <span class="fu">mean</span>(xmp_all_filtered<span class="sc">$</span>Date_time, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a>sun_pos <span class="ot">&lt;-</span> <span class="fu">getSunlightPosition</span>(<span class="at">date =</span> time, <span class="at">lat =</span> lat, <span class="at">lon =</span> lon)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>elevation_angle <span class="ot">&lt;-</span> sun_pos<span class="sc">$</span>altitude</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>turbidity <span class="ot">&lt;-</span> <span class="fl">2.5</span></span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>solar_constant <span class="ot">&lt;-</span> <span class="dv">1367</span></span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>air_mass <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> <span class="fu">cos</span>(pi<span class="sc">/</span><span class="dv">2</span> <span class="sc">-</span> elevation_angle)</span>
<span id="cb4-11"><a href="#cb4-11" tabindex="-1"></a>dni <span class="ot">&lt;-</span> solar_constant <span class="sc">*</span> <span class="fu">exp</span>(<span class="sc">-</span><span class="fl">0.2</span> <span class="sc">*</span> air_mass <span class="sc">*</span> turbidity)</span>
<span id="cb4-12"><a href="#cb4-12" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" tabindex="-1"></a><span class="fu">print</span>(dni)</span></code></pre></div>
</div>
<div id="caluclating-sun-sensor-angles" class="section level3 hasAnchor" number="1.4.4">
<h3><span class="header-section-number">1.4.4</span> Caluclating Sun-Sensor Angles<a href="#caluclating-sun-sensor-angles" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we explain the difference between the archived DLS1 method and the current DLS2 method.</p>
<p><em>DSL1:</em></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>compute_sun_angle <span class="ot">&lt;-</span> <span class="cf">function</span>(SolarElevation, SolarAzimuth, Roll, Pitch, Yaw) {</span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>    ori <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">0</span>, <span class="sc">-</span><span class="dv">1</span>)</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    SolarElevation <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(SolarElevation)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    SolarAzimuth <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(SolarAzimuth)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    Roll <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(Roll)</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    Pitch <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(Pitch)</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>    Yaw <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(Yaw)</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>  </span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>    elements <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">cos</span>(SolarAzimuth) <span class="sc">*</span> <span class="fu">cos</span>(SolarElevation),</span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>                  <span class="fu">sin</span>(SolarAzimuth) <span class="sc">*</span> <span class="fu">cos</span>(SolarElevation),</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>                  <span class="sc">-</span><span class="fu">sin</span>(SolarElevation))</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>  </span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>    nSun <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">matrix</span>(elements, <span class="at">ncol =</span> <span class="dv">3</span>))</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a>  </span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>    c1 <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="sc">-</span>Yaw)</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a>    s1 <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="sc">-</span>Yaw)</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a>    c2 <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="sc">-</span>Pitch)</span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a>    s2 <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="sc">-</span>Pitch)</span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a>    c3 <span class="ot">&lt;-</span> <span class="fu">cos</span>(<span class="sc">-</span>Roll)</span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a>    s3 <span class="ot">&lt;-</span> <span class="fu">sin</span>(<span class="sc">-</span>Roll)</span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a>  </span>
<span id="cb5-22"><a href="#cb5-22" tabindex="-1"></a>    Ryaw <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(c1, s1, <span class="dv">0</span>, <span class="sc">-</span>s1, c1, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">1</span>), <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-23"><a href="#cb5-23" tabindex="-1"></a>    Rpitch <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(c2, <span class="dv">0</span>, <span class="sc">-</span>s2, <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>, s2, <span class="dv">0</span>, c2), <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-24"><a href="#cb5-24" tabindex="-1"></a>    Rroll <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">0</span>, <span class="dv">0</span>, c3, s3, <span class="dv">0</span>, <span class="sc">-</span>s3, c3), <span class="at">ncol =</span> <span class="dv">3</span>, <span class="at">byrow =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-25"><a href="#cb5-25" tabindex="-1"></a>  </span>
<span id="cb5-26"><a href="#cb5-26" tabindex="-1"></a>    R_sensor <span class="ot">&lt;-</span> Ryaw <span class="sc">%*%</span> Rpitch <span class="sc">%*%</span> Rroll</span>
<span id="cb5-27"><a href="#cb5-27" tabindex="-1"></a>    nSensor <span class="ot">&lt;-</span> R_sensor <span class="sc">%*%</span> ori</span>
<span id="cb5-28"><a href="#cb5-28" tabindex="-1"></a>  </span>
<span id="cb5-29"><a href="#cb5-29" tabindex="-1"></a>    angle <span class="ot">&lt;-</span> <span class="fu">acos</span>(<span class="fu">sum</span>(nSun <span class="sc">*</span> nSensor))</span>
<span id="cb5-30"><a href="#cb5-30" tabindex="-1"></a>    <span class="fu">return</span>(angle)</span>
<span id="cb5-31"><a href="#cb5-31" tabindex="-1"></a>}</span>
<span id="cb5-32"><a href="#cb5-32" tabindex="-1"></a></span>
<span id="cb5-33"><a href="#cb5-33" tabindex="-1"></a>SSA_xmp_all_filtered <span class="ot">&lt;-</span> xmp_all_filtered <span class="sc">%&gt;%</span></span>
<span id="cb5-34"><a href="#cb5-34" tabindex="-1"></a>  <span class="fu">rowwise</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb5-35"><a href="#cb5-35" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SunSensorAngle_DLS1_rad =</span> <span class="fu">compute_sun_angle</span>(SolarElevation, SolarAzimuth, Roll, Pitch, Yaw),</span>
<span id="cb5-36"><a href="#cb5-36" tabindex="-1"></a>         <span class="at">SunSensorAngle_DLS1_deg =</span> SunSensorAngle_DLS1_rad <span class="sc">*</span> <span class="dv">180</span> <span class="sc">/</span> pi)</span>
<span id="cb5-37"><a href="#cb5-37" tabindex="-1"></a></span>
<span id="cb5-38"><a href="#cb5-38" tabindex="-1"></a><span class="fu">saveRDS</span>(SSA_xmp_all_filtered,<span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>,site,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,date,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">XMP_&quot;</span>, date_range,<span class="st">&quot;_with_SSA.rds&quot;</span>)) <span class="co"># Save XMP rds file with sun sensor angle added</span></span></code></pre></div>
<p><em>DLS2:</em></p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>xmp_all_filtered<span class="sc">$</span>SunSensorAngle_DLS2_rad <span class="ot">&lt;-</span> <span class="fu">sapply</span>(xmp_all_filtered<span class="sc">$</span>EstimatedDirectLightVector, <span class="cf">function</span>(vec) <span class="fu">acos</span>(<span class="sc">-</span><span class="dv">1</span> <span class="sc">*</span> <span class="fu">as.numeric</span>(vec[[<span class="dv">3</span>]])))</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>xmp_all_filtered<span class="sc">$</span>SunSensorAngle_DLS2_deg <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(xmp_all_filtered<span class="sc">$</span>SunSensorAngle_DLS2_rad) <span class="sc">/</span> pi <span class="sc">*</span> <span class="dv">180</span></span></code></pre></div>
<p>???????????????????</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>xmp_all_ssa <span class="ot">=</span> SSA_xmp_all_filtered <span class="sc">%&gt;%</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="co"># Converting from radians to degrees</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Yaw_deg =</span> <span class="fu">as.numeric</span>(Yaw)<span class="sc">*</span><span class="dv">180</span><span class="sc">/</span>pi,</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>         <span class="at">Roll_deg =</span> <span class="fu">as.numeric</span>(Roll)<span class="sc">*</span><span class="dv">180</span><span class="sc">/</span>pi,</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>         <span class="at">Pitch_deg =</span> <span class="fu">as.numeric</span>(Pitch)<span class="sc">*</span><span class="dv">180</span><span class="sc">/</span>pi) <span class="sc">%&gt;%</span> </span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="co"># Grouping images by Date and band</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, BandName) <span class="sc">%&gt;%</span> </span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">ymd_hms</span>(DateTimeOriginal)) <span class="sc">%&gt;%</span> <span class="co"># Converting DateTimeOriginal to a Date and Time object and arranging in order </span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">GPSLatitude_plot =</span> <span class="fu">scale</span>(<span class="fu">as.numeric</span>(GPSLatitude)), <span class="co"># These are for clean ggplotting, no other reason to scale</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>         <span class="at">GPSLongitude_plot =</span> <span class="fu">scale</span>(<span class="fu">as.numeric</span>(GPSLongitude)),</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>         <span class="at">cos_SSA =</span> <span class="fu">cos</span>(SunSensorAngle_DLS1_rad),</span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>         <span class="at">Irradiance =</span> <span class="fu">as.numeric</span>(Irradiance),</span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>         <span class="at">Date2 =</span> <span class="fu">ymd_hms</span>(DateTimeOriginal)) <span class="co"># this is the date/time we will use moving forward </span></span></code></pre></div>
<p>Check that the sun-sensor angles are within a reasonable range. They should range from 30ish degrees mid summer to 80 ish degrees mid winter</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>(SSA_plot <span class="ot">&lt;-</span> xmp_all_ssa <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>    <span class="fu">filter</span>(</span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>      site <span class="sc">==</span> site_to_plot,</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>      camera <span class="sc">==</span> camera_to_plot,</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>    )<span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>    <span class="co"># filter(BandName %in% c(&quot;Blue&quot;,&quot;Green&quot;,&quot;Red&quot;,&quot;Red edge&quot;)) %&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(Date_time)) <span class="sc">+</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> SunSensorAngle_DLS2_deg, <span class="at">color =</span> <span class="st">&quot;DLS2 (from metadata)&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> SunSensorAngle_DLS1_deg, <span class="at">color =</span> <span class="st">&quot;DLS1 (calculated)&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>    <span class="fu">geom_vline</span>(<span class="at">data =</span> <span class="fu">subset</span>(xmp_all_ssa, panel_flag <span class="sc">==</span> <span class="dv">1</span>), <span class="fu">aes</span>(<span class="at">xintercept =</span> <span class="fu">as.numeric</span>(Date_time)), <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>, <span class="at">alpha =</span> <span class="fl">0.3</span>) <span class="sc">+</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> solar_angle), <span class="at">color =</span> <span class="st">&quot;black&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">alpha =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>    <span class="fu">scale_x_datetime</span>(<span class="at">date_breaks =</span> <span class="st">&quot;10 min&quot;</span>, <span class="at">date_labels =</span> <span class="st">&quot;%H:%M&quot;</span>) <span class="sc">+</span></span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Time&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Sun Sensor Anlge&quot;</span>, <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;SSA, Site: &quot;</span>,site_to_plot,<span class="st">&quot;, Date: &quot;</span>, date_to_plot, <span class="st">&quot;, Camera: &quot;</span>, camera_to_plot))<span class="sc">+</span></span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">subtitle =</span> <span class="st">&quot;Grey vertical lines are calibration panel images, black hoirzontal lines are solar angle (calculated from lat, long, and flight time)&quot;</span>, <span class="at">size =</span> <span class="dv">10</span>) <span class="sc">+</span> </span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;blue&quot;</span>, <span class="st">&quot;red&quot;</span>),</span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>                       <span class="at">labels =</span> <span class="fu">c</span>(<span class="st">&quot;DLS2 (from metadata)&quot;</span>, <span class="st">&quot;DLS1 (calculated)&quot;</span>),</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>                       <span class="at">name =</span> <span class="st">&quot;Sun Sesnor Angle Comparison&quot;</span>)<span class="sc">+</span></span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>    <span class="co"># facet_grid(BandName ~ camera, scales = &quot;free_x&quot;)+</span></span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(. <span class="sc">~</span>BandName_Wavelength, </span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>               <span class="at">scales =</span> <span class="st">&quot;free_x&quot;</span>, <span class="at">ncol =</span> <span class="dv">2</span>)<span class="sc">+</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>    </span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a>  </span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a>)</span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> SSA_plot,</span>
<span id="cb8-26"><a href="#cb8-26" tabindex="-1"></a>       <span class="co"># filename = paste0(&quot;Q:\\SNC\\Data\\&quot;, site_to_plot,&quot;\\Flights\\&quot;,gsub(&quot;-&quot;, &quot;_&quot;, date_to_plot), &quot;\\1_Data\\CSV_Mica_MicaP\\SSA_plot.jpeg&quot;),</span></span>
<span id="cb8-27"><a href="#cb8-27" tabindex="-1"></a>       <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot), <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">0_SSA_plot.jpeg&quot;</span>),</span>
<span id="cb8-28"><a href="#cb8-28" tabindex="-1"></a>       <span class="at">device =</span> jpeg,</span>
<span id="cb8-29"><a href="#cb8-29" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">15</span>,</span>
<span id="cb8-30"><a href="#cb8-30" tabindex="-1"></a>       <span class="at">height =</span> <span class="dv">10</span>,</span>
<span id="cb8-31"><a href="#cb8-31" tabindex="-1"></a>       <span class="at">units =</span> <span class="st">&#39;in&#39;</span>,</span>
<span id="cb8-32"><a href="#cb8-32" tabindex="-1"></a>       <span class="at">dpi =</span> <span class="dv">300</span>,</span>
<span id="cb8-33"><a href="#cb8-33" tabindex="-1"></a>       <span class="at">bg =</span> <span class="st">&#39;white&#39;</span>)</span></code></pre></div>
</div>
<div id="scattereddirect-ratio-estimate" class="section level3 hasAnchor" number="1.4.5">
<h3><span class="header-section-number">1.4.5</span> Scattered/Direct Ratio Estimate<a href="#scattereddirect-ratio-estimate" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>Here we estimate scattered:direct ratio for each flight by relating cosine of the sun-sensor angle to spectral irradiance measured by the DLS. This relationship, in a perfect world, should give you the scattered irradiance as the intercept, which is independent of angle, and the direct irradiance, which is the slope, and therefore perfectly proportional to sun angle. In reality, these relationships are extremely messy and most data needs to be discarded.</p>
<p>Below are three main steps to find the estimated scattered:direct ratio:
1) First, generate a rolling regression of this linear relationship over a certain time window.
2) Second, eliminate all models with poor fits using the R^2 value.
3) Third, drop any models with negative slopes or intercepts (physically impossible).</p>
<p>First, we generate a rolling regression of the linear relationship <span class="math inline">\(I_{\text{spec}} = I_{\text{direct}} \cdot \cos(\theta_{\text{sun-sensor}}) + I_{\text{scattered}}\)</span> via a regression of irradiance on <span class="math inline">\(\cos(\theta_{\text{sun-sensor}})\)</span> over a specified time window (we used 30 seconds here).</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a><span class="do">#### (1) </span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co"># via a regression of Irradiance on cos_SSA over a specified time window (30s here)</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>mod_frame <span class="ot">=</span> xmp_all_ssa_site_date <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  <span class="fu">drop_na</span>(Date2) <span class="sc">%&gt;%</span> </span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a>  <span class="fu">drop_na</span>(cos_SSA) <span class="sc">%&gt;%</span> </span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a>  <span class="fu">drop_na</span>(Irradiance) <span class="sc">%&gt;%</span> </span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>  <span class="co"># Fit a rolling regression</span></span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a>  <span class="co"># for each image, fit a linear model of all images (of the same band) within 30 seconds of the image</span></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>  tidyfit<span class="sc">::</span><span class="fu">regress</span>(Irradiance <span class="sc">~</span> cos_SSA, <span class="fu">m</span>(<span class="st">&quot;lm&quot;</span>),</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>                   <span class="at">.cv =</span> <span class="st">&quot;sliding_index&quot;</span>, <span class="at">.cv_args =</span> <span class="fu">list</span>(<span class="at">lookback =</span> lubridate<span class="sc">::</span><span class="fu">seconds</span>(<span class="dv">30</span>), <span class="at">index =</span> <span class="st">&quot;Date2&quot;</span>),</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>                   <span class="at">.force_cv =</span> <span class="cn">TRUE</span>, <span class="at">.return_slices =</span> <span class="cn">TRUE</span>)</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a><span class="co"># df : summary of models, adding R sqaured and Dates</span></span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>df <span class="ot">=</span> mod_frame <span class="sc">%&gt;%</span> </span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>  <span class="co"># Get a summary of each model and extract the r squared value</span></span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">R2 =</span> <span class="fu">map</span>(model_object, <span class="cf">function</span>(obj) <span class="fu">summary</span>(obj)<span class="sc">$</span>adj.r.squared)) <span class="sc">%&gt;%</span> </span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>  <span class="co"># Extract the slope and intercept</span></span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>  <span class="fu">coef</span>() <span class="sc">%&gt;%</span> </span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>  <span class="fu">unnest</span>(model_info) <span class="sc">%&gt;%</span> </span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Date2 =</span> <span class="fu">ymd_hms</span>(slice_id)) </span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a></span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a><span class="co"># df_params : adding slope (direct irradiance) and y-intercept (scatterd irradiance) values</span></span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a>df_params <span class="ot">=</span> df <span class="sc">%&gt;%</span></span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Date<span class="sc">:</span>estimate, Date2) <span class="sc">%&gt;%</span> </span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>  <span class="co"># we will have to go from long, with 2 observations per model, to wide</span></span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> term, <span class="at">values_from =</span> estimate, <span class="at">values_fn =</span> {first}) <span class="sc">%&gt;%</span> </span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">rename</span>(<span class="st">&quot;Intercept&quot;</span> <span class="ot">=</span> <span class="st">`</span><span class="at">(Intercept)</span><span class="st">`</span>,</span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>                <span class="st">&quot;Slope&quot;</span> <span class="ot">=</span> <span class="st">&quot;cos_SSA&quot;</span>)</span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a></span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a><span class="co"># Cleaning up the df</span></span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a>df_p <span class="ot">=</span> df <span class="sc">%&gt;%</span></span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a>  <span class="fu">filter</span>(term <span class="sc">==</span> <span class="st">&quot;cos_SSA&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(Date<span class="sc">:</span>model, R2, p.value, Date2)</span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" tabindex="-1"></a><span class="co"># Joining model info, parameter (slope, y intercept) info and XMP data with sun sensor angle and using the linear relationship </span></span>
<span id="cb9-37"><a href="#cb9-37" tabindex="-1"></a><span class="co"># (spectral_irr = direct_irr * cos(SSA) + scattered_irr) to create % scattered and scattered/direct ratios</span></span>
<span id="cb9-38"><a href="#cb9-38" tabindex="-1"></a>df_filtered <span class="ot">=</span> df_params <span class="sc">%&gt;%</span> </span>
<span id="cb9-39"><a href="#cb9-39" tabindex="-1"></a>  <span class="fu">left_join</span>(df_p) <span class="sc">%&gt;%</span> </span>
<span id="cb9-40"><a href="#cb9-40" tabindex="-1"></a>  <span class="fu">left_join</span>(xmp_all_ssa_site_date) <span class="sc">%&gt;%</span> </span>
<span id="cb9-41"><a href="#cb9-41" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">percent_scattered =</span> Intercept <span class="sc">/</span> (Slope <span class="sc">+</span> Intercept),</span>
<span id="cb9-42"><a href="#cb9-42" tabindex="-1"></a>         <span class="at">dir_diff =</span> Intercept<span class="sc">/</span>Slope)</span>
<span id="cb9-43"><a href="#cb9-43" tabindex="-1"></a></span>
<span id="cb9-44"><a href="#cb9-44" tabindex="-1"></a>df_filtered<span class="sc">$</span>SourceFile</span>
<span id="cb9-45"><a href="#cb9-45" tabindex="-1"></a>df_filtered<span class="sc">$</span>percent_scattered</span></code></pre></div>
<p>Next, we eliminate all models with poor fits. In this case we eliminate models with R^2 &lt; 0.4 (R^2) and drop any models with negative slopes or intercepts (physically impossible)</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>df_to_use <span class="ot">=</span> df_filtered <span class="sc">%&gt;%</span> </span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">R2 =</span> <span class="fu">as.numeric</span>(R2)) <span class="sc">%&gt;%</span> </span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  <span class="fu">filter</span>(R2 <span class="sc">&gt;</span> .<span class="dv">4</span> </span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>         <span class="sc">&amp;</span> Slope <span class="sc">&gt;</span> <span class="dv">0</span> <span class="sc">&amp;</span> Intercept <span class="sc">&gt;</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span> </span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">mean_scattered =</span> <span class="fu">mean</span>(percent_scattered),</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>         <span class="at">dir_diff_ratio =</span> <span class="fu">mean</span>(dir_diff))</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a><span class="fu">saveRDS</span>(df_to_use,<span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>,site_to_plot,<span class="st">&quot;_&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;_rolling_regression_filteredModels_used_plot1.rds&quot;</span>))  <span class="co">#SET PATH to save the rds to </span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>df_to_use <span class="ot">=</span> <span class="fu">read_rds</span>(<span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>,site_to_plot,<span class="st">&quot;_&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;_rolling_regression_filteredModels_used_plot1.rds&quot;</span>)) <span class="co"># read in rds that was just saved</span></span></code></pre></div>
<p>Below we plot the pattern in the rolling regression and make sure youre keeping enough models. If you are loosing too many models, adjust the filters.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>(RR_params <span class="ot">&lt;-</span> df_to_use <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>    <span class="fu">group_by</span>(Date, BandName) <span class="sc">%&gt;%</span> </span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Date2, <span class="at">y =</span> percent_scattered, <span class="at">color =</span> R2)) <span class="sc">+</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> df_filtered, <span class="at">color =</span> <span class="st">&quot;grey&quot;</span>) <span class="sc">+</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="co">#data = filter(df_filtered, Slope &gt; 0)</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">linetype =</span> <span class="dv">2</span>) <span class="sc">+</span></span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="fu">aes</span>(<span class="at">yintercept =</span> mean_scattered), <span class="at">color =</span> <span class="st">&quot;red4&quot;</span>, <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>    <span class="fu">scale_y_continuous</span>(<span class="at">breaks =</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, .<span class="dv">2</span>), <span class="at">limits =</span> <span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">1</span>)) <span class="sc">+</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>    ggnewscale<span class="sc">::</span><span class="fu">new_scale_color</span>() <span class="sc">+</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Site: &quot;</span>,site_to_plot,<span class="st">&quot;, Date: &quot;</span>, date_to_plot, <span class="st">&quot;, Camera: &quot;</span>, camera_to_plot))<span class="sc">+</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(. <span class="sc">~</span> Date, </span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>               <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>))</span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> RR_params,</span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>       <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot), <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot, <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_CheckRollingRegressionParams_plot.jpeg&quot;</span>),</span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>       <span class="at">device =</span> jpeg,</span>
<span id="cb11-20"><a href="#cb11-20" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">15</span>,</span>
<span id="cb11-21"><a href="#cb11-21" tabindex="-1"></a>       <span class="at">height =</span> <span class="dv">10</span>,</span>
<span id="cb11-22"><a href="#cb11-22" tabindex="-1"></a>       <span class="at">units =</span> <span class="st">&#39;in&#39;</span>,</span>
<span id="cb11-23"><a href="#cb11-23" tabindex="-1"></a>       <span class="at">dpi =</span> <span class="dv">300</span>,</span>
<span id="cb11-24"><a href="#cb11-24" tabindex="-1"></a>       <span class="at">bg =</span> <span class="st">&#39;white&#39;</span>)</span></code></pre></div>
<p>Next, check that the linear relationships youre keeping look realistic. The slope should be steeper for sunny days (ie more direct irradiance) and shallower for overcast days.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>(linear_plots <span class="ot">&lt;-</span> df_to_use <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>    <span class="fu">filter</span>(BandName <span class="sc">==</span> <span class="st">&quot;Blue&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> cos_SSA, <span class="at">y =</span> Irradiance, <span class="at">color =</span> R2)) <span class="sc">+</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">filter</span>(df_filtered, BandName <span class="sc">==</span> <span class="st">&quot;Blue&quot;</span>), <span class="at">color =</span> <span class="st">&quot;grey30&quot;</span>, <span class="at">alpha =</span> .<span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> <span class="fu">filter</span>(df_filtered, BandName <span class="sc">==</span> <span class="st">&quot;Blue&quot;</span> <span class="sc">&amp;</span> R2 <span class="sc">&gt;</span> .<span class="dv">4</span>), <span class="fu">aes</span>(<span class="at">color =</span> <span class="fu">as.numeric</span>(R2))) <span class="sc">+</span></span>
<span id="cb12-6"><a href="#cb12-6" tabindex="-1"></a>    <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, <span class="at">se =</span> <span class="cn">FALSE</span>, <span class="fu">aes</span>(<span class="at">group =</span> BandName)) <span class="sc">+</span></span>
<span id="cb12-7"><a href="#cb12-7" tabindex="-1"></a>    <span class="fu">lims</span>(<span class="at">x =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>),</span>
<span id="cb12-8"><a href="#cb12-8" tabindex="-1"></a>         <span class="at">y =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">max</span>(df_to_use<span class="sc">$</span>Irradiance))) <span class="sc">+</span></span>
<span id="cb12-9"><a href="#cb12-9" tabindex="-1"></a>    <span class="fu">geom_abline</span>(<span class="fu">aes</span>(<span class="at">slope =</span> Slope, <span class="at">intercept =</span> Intercept, <span class="at">color =</span> R2), <span class="at">alpha =</span> .<span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb12-10"><a href="#cb12-10" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Site: &quot;</span>,site_to_plot,<span class="st">&quot;, Date: &quot;</span>, date_to_plot, <span class="st">&quot;, Camera: &quot;</span>, camera_to_plot))<span class="sc">+</span></span>
<span id="cb12-11"><a href="#cb12-11" tabindex="-1"></a>    <span class="fu">theme_bw</span>(<span class="at">base_size =</span> <span class="dv">16</span>) <span class="sc">+</span></span>
<span id="cb12-12"><a href="#cb12-12" tabindex="-1"></a>    <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb12-13"><a href="#cb12-13" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(. <span class="sc">~</span> Date, </span>
<span id="cb12-14"><a href="#cb12-14" tabindex="-1"></a>               <span class="at">scales =</span> <span class="st">&quot;free_y&quot;</span>))</span>
<span id="cb12-15"><a href="#cb12-15" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> linear_plots,</span>
<span id="cb12-17"><a href="#cb12-17" tabindex="-1"></a>       <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot), <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">2_LinearRegression_plot.jpeg&quot;</span>),</span>
<span id="cb12-18"><a href="#cb12-18" tabindex="-1"></a>       <span class="at">device =</span> jpeg,</span>
<span id="cb12-19"><a href="#cb12-19" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">15</span>,</span>
<span id="cb12-20"><a href="#cb12-20" tabindex="-1"></a>       <span class="at">height =</span> <span class="dv">10</span>,</span>
<span id="cb12-21"><a href="#cb12-21" tabindex="-1"></a>       <span class="at">units =</span> <span class="st">&#39;in&#39;</span>,</span>
<span id="cb12-22"><a href="#cb12-22" tabindex="-1"></a>       <span class="at">dpi =</span> <span class="dv">300</span>,</span>
<span id="cb12-23"><a href="#cb12-23" tabindex="-1"></a>       <span class="at">bg =</span> <span class="st">&#39;white&#39;</span>)</span></code></pre></div>
<p>Here, check that there is no excessive spatial pattern in the data</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>(photos_kept <span class="ot">&lt;-</span> df_to_use <span class="sc">%&gt;%</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>    <span class="fu">filter</span>(GPSLongitude <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> GPSLatitude <span class="sc">!=</span> <span class="dv">0</span>) <span class="sc">%&gt;%</span> <span class="co"># Filter out imgs with GPSLongitude and GPSLatitude of zero, </span></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>    <span class="co"># this is rare and in my experience were corrupted imgs where the XMP could not be properly read</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> GPSLongitude, <span class="at">y =</span> GPSLatitude, <span class="at">color =</span> SunSensorAngle_DLS1_deg)) <span class="sc">+</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> df_filtered, <span class="at">color =</span> <span class="st">&quot;grey60&quot;</span>) <span class="sc">+</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Site: &quot;</span>,site_to_plot,<span class="st">&quot;, Date: &quot;</span>, date_to_plot, <span class="st">&quot;, Camera: &quot;</span>, camera_to_plot))<span class="sc">+</span></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>    <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(. <span class="sc">~</span> Date, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>))</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a></span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> photos_kept,</span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>       <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot), <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">3_GPSphotosKept_plot.jpeg&quot;</span>),</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a>       <span class="at">device =</span> jpeg,</span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">15</span>,</span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>       <span class="at">height =</span> <span class="dv">10</span>,</span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>       <span class="at">units =</span> <span class="st">&#39;in&#39;</span>,</span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>       <span class="at">dpi =</span> <span class="dv">300</span>,</span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>       <span class="at">bg =</span> <span class="st">&#39;white&#39;</span>)</span></code></pre></div>
<p>Create the final ratios df from the df of filtered models</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>(<span class="at">ratios =</span> df_to_use <span class="sc">%&gt;%</span> </span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>    dplyr<span class="sc">::</span><span class="fu">select</span>(Date, mean_scattered, dir_diff_ratio,</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>                  GPSLatitude, GPSLongitude, Date2) <span class="sc">%&gt;%</span> </span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    <span class="fu">group_by</span>(Date) <span class="sc">%&gt;%</span> </span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">Lat_mean =</span> <span class="fu">mean</span>(GPSLatitude),</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>           <span class="at">Long_mean =</span> <span class="fu">mean</span>(GPSLongitude),</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>           <span class="at">Date_mean =</span> <span class="fu">mean</span>(Date2)) <span class="sc">%&gt;%</span> </span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>    <span class="fu">distinct</span>(Date, mean_scattered, dir_diff_ratio, Lat_mean, Long_mean, Date_mean))</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="fu">saveRDS</span>(ratios,<span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>,site_to_plot,<span class="st">&quot;_&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;_ratios.rds&quot;</span>))  <span class="co">#SET PATH to save the rds to </span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>ratios <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>,site_to_plot,<span class="st">&quot;_&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;_ratios.rds&quot;</span>))  <span class="co">#SET PATH to save the rds to </span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a><span class="co"># Print the values to use in the calibration as a check (does this ratio looks reasonable?)</span></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a><span class="fu">round</span>(ratios<span class="sc">$</span>dir_diff_ratio, <span class="dv">2</span>)</span></code></pre></div>
</div>
<div id="compute-horizontal-corrected-irradiance" class="section level3 hasAnchor" number="1.4.6">
<h3><span class="header-section-number">1.4.6</span> Compute horizontal (corrected) irradiance<a href="#compute-horizontal-corrected-irradiance" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p>This is the Fresnel correction, which adjusts for the DLS reflecting, rather than measuring, some of the irradiance that hits it. We aquired this code from the micasense github</p>
<p>??????????? linke micasens github above?????</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>fresnel_transmission <span class="ot">=</span> <span class="cf">function</span>(phi, n1, n2, polarization) {</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>  f1 <span class="ot">=</span> <span class="fu">cos</span>(phi)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>  f2 <span class="ot">=</span> <span class="fu">sqrt</span>(<span class="dv">1</span> <span class="sc">-</span> (n1 <span class="sc">/</span> n2 <span class="sc">*</span> <span class="fu">sin</span>(phi))<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  Rs <span class="ot">=</span> ((n1 <span class="sc">*</span> f1 <span class="sc">-</span> n2 <span class="sc">*</span> f2) <span class="sc">/</span> (n1 <span class="sc">*</span> f1 <span class="sc">+</span> n2 <span class="sc">*</span> f2))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>  Rp <span class="ot">=</span> ((n1 <span class="sc">*</span> f2 <span class="sc">-</span> n2 <span class="sc">*</span> f1) <span class="sc">/</span> (n1 <span class="sc">*</span> f2 <span class="sc">+</span> n2 <span class="sc">*</span> f1))<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  T <span class="ot">=</span> <span class="dv">1</span> <span class="sc">-</span> polarization[<span class="dv">1</span>] <span class="sc">*</span> Rs <span class="sc">-</span> polarization[<span class="dv">2</span>] <span class="sc">*</span> Rp</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>  T <span class="ot">=</span> <span class="fu">pmin</span>(<span class="fu">pmax</span>(T, <span class="dv">0</span>), <span class="dv">1</span>)  <span class="co"># Clamp the value between 0 and 1</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>  <span class="fu">return</span>(T)</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>}</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>multilayer_transmission <span class="ot">=</span> <span class="cf">function</span>(phi, n, polarization) {</span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>  T <span class="ot">=</span> <span class="fl">1.0</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>  phi_eff <span class="ot">=</span> phi</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>(<span class="fu">length</span>(n) <span class="sc">-</span> <span class="dv">1</span>)) {</span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>    n1 <span class="ot">=</span> n[i]</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a>    n2 <span class="ot">=</span> n[i <span class="sc">+</span> <span class="dv">1</span>]</span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a>    phi_eff <span class="ot">=</span> <span class="fu">asin</span>(<span class="fu">sin</span>(phi_eff) <span class="sc">/</span> n1)</span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a>    T <span class="ot">=</span> T <span class="sc">*</span> <span class="fu">fresnel_transmission</span>(phi_eff, n1, n2, polarization)</span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a>  }</span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a>  <span class="fu">return</span>(T)</span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a>}</span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="co"># Defining the fresnel_correction function </span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a>fresnel_correction <span class="ot">=</span> <span class="cf">function</span>(x) {</span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a>  </span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a>  Irradiance <span class="ot">=</span> x<span class="sc">$</span>Irradiance</span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a>  SunSensorAngle_DLS1_rad <span class="ot">=</span> x<span class="sc">$</span>SunSensorAngle_DLS1_rad</span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a>  n1<span class="ot">=</span><span class="fl">1.000277</span></span>
<span id="cb15-29"><a href="#cb15-29" tabindex="-1"></a>  n2<span class="ot">=</span><span class="fl">1.38</span></span>
<span id="cb15-30"><a href="#cb15-30" tabindex="-1"></a>  polarization<span class="ot">=</span><span class="fu">c</span>(<span class="fl">0.5</span>, <span class="fl">0.5</span>)</span>
<span id="cb15-31"><a href="#cb15-31" tabindex="-1"></a>  </span>
<span id="cb15-32"><a href="#cb15-32" tabindex="-1"></a>  <span class="co"># Convert sun-sensor angle from radians to degrees</span></span>
<span id="cb15-33"><a href="#cb15-33" tabindex="-1"></a>  SunSensorAngle_DLS1_deg <span class="ot">&lt;-</span> SunSensorAngle_DLS1_rad <span class="sc">*</span> (<span class="dv">180</span> <span class="sc">/</span> pi)</span>
<span id="cb15-34"><a href="#cb15-34" tabindex="-1"></a>  </span>
<span id="cb15-35"><a href="#cb15-35" tabindex="-1"></a>  <span class="co"># Perform the multilayer Fresnel correction</span></span>
<span id="cb15-36"><a href="#cb15-36" tabindex="-1"></a>  Fresnel <span class="ot">&lt;-</span> <span class="fu">multilayer_transmission</span>(SunSensorAngle_DLS1_rad, <span class="fu">c</span>(n1, n2), polarization)</span>
<span id="cb15-37"><a href="#cb15-37" tabindex="-1"></a>  <span class="fu">return</span>(Fresnel)</span>
<span id="cb15-38"><a href="#cb15-38" tabindex="-1"></a>}</span></code></pre></div>
<p>Now we put it all together to compute the horizontal irradiance. Here the horizontal irradiance can be thought of as a corrected value for the irradiance that is reaching a point on the flat ground directly underneath the drone.</p>
<p>#?? Below xmp_all_ssa_site_date was originally xmp_all_ssa, it was changed to just filtered everything for one site and one date ???????????????</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>xmp_corrected <span class="ot">=</span> xmp_all_ssa_site_date  <span class="sc">%&gt;%</span> </span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>  <span class="fu">group_by</span>(Date, BandName) <span class="sc">%&gt;%</span> </span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>  <span class="co">#filter(BandName == &quot;Red&quot;) %&gt;% </span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>  <span class="co">#slice_head(n = 900) %&gt;% </span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>  <span class="fu">nest</span>(<span class="at">data =</span> <span class="fu">c</span>(Irradiance, SunSensorAngle_DLS1_rad)) <span class="sc">%&gt;%</span> <span class="co"># Creates a nested df where each group is stored as a list-column named data, containing the variables Irradiance and SunSensorAngle_DLS1_rad</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">Fresnel =</span> <span class="fu">as.numeric</span>(<span class="fu">map</span>(<span class="at">.x =</span> data, <span class="at">.f =</span> fresnel_correction))) <span class="sc">%&gt;%</span> <span class="co"># Applies the fresnel_correction function to each group of nested data</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>  <span class="fu">unnest</span>(data) <span class="sc">%&gt;%</span> <span class="co">#unnesting</span></span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>  <span class="co"># Joining the ratios</span></span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>  <span class="fu">left_join</span>(ratios, <span class="at">by =</span> <span class="st">&quot;Date&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">SensorIrradiance =</span> <span class="fu">as.numeric</span>(SpectralIrradiance) <span class="sc">/</span> Fresnel, <span class="co"># irradiance adjusted for some reflected light from the DLS diffuser</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>         <span class="at">DirectIrradiance_new =</span> SensorIrradiance <span class="sc">/</span> (dir_diff_ratio <span class="sc">+</span> <span class="fu">cos</span>(<span class="fu">as.numeric</span>(SunSensorAngle_DLS1_rad))), <span class="co"># adjusted for sun angle, </span></span>
<span id="cb16-12"><a href="#cb16-12" tabindex="-1"></a>         <span class="at">HorizontalIrradiance_new =</span> DirectIrradiance_new <span class="sc">*</span> (dir_diff_ratio <span class="sc">+</span> <span class="fu">sin</span>(<span class="fu">as.numeric</span>(SolarElevation))), </span>
<span id="cb16-13"><a href="#cb16-13" tabindex="-1"></a>         <span class="at">ScatteredIrradiance_new =</span> HorizontalIrradiance_new <span class="sc">-</span> DirectIrradiance_new)</span></code></pre></div>
<p>Now we plot the sensor irradiance and horizontal/direct/scattered irradiance</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">saveRDS</span>(xmp_corrected,<span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>,site_to_plot,<span class="st">&quot;_&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;_xmp_corrected.rds&quot;</span>))  <span class="co">#SET PATH to save the rds to</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>(Sensor_irr <span class="ot">&lt;-</span> xmp_corrected <span class="sc">%&gt;%</span> </span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>    <span class="fu">filter</span>(BandName <span class="sc">==</span> <span class="st">&quot;Blue&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> Date2)) <span class="sc">+</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> SensorIrradiance, <span class="at">color =</span> <span class="st">&quot;Sensor Irradiance&quot;</span>),<span class="at">size =</span> <span class="dv">1</span>,<span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> HorizontalIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Horizontal_DLS1&quot;</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> DirectIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Direct_DLS1&quot;</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">y =</span> ScatteredIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Scattered_DLS1&quot;</span>), <span class="at">size =</span> <span class="dv">1</span>, <span class="at">show.legend =</span> <span class="cn">TRUE</span>) <span class="sc">+</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Sensor Irradiance&quot;</span><span class="ot">=</span> <span class="st">&quot;black&quot;</span>, <span class="st">&quot;Horizontal_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>, <span class="st">&quot;Direct_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;orange&quot;</span>, <span class="st">&quot;Scattered_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;purple&quot;</span>)) <span class="sc">+</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>    <span class="co">#lims(y = c(50, 150)) +</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">y =</span> <span class="st">&quot;Irradiance&quot;</span>, <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Site: &quot;</span>,site_to_plot,<span class="st">&quot;, Date: &quot;</span>, date_to_plot, <span class="st">&quot;, Camera: &quot;</span>, camera_to_plot))<span class="sc">+</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>    <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(. <span class="sc">~</span> Date, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>,</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>               <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">color =</span> <span class="st">&quot;Irradiance Type&quot;</span>))</span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> Sensor_irr,</span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a>       <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot), <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">4_SensorIrradiance_w_CorrectedIrradiance_plot.jpeg&quot;</span>),</span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a>       <span class="at">device =</span> jpeg,</span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">15</span>,</span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a>       <span class="at">height =</span> <span class="dv">10</span>,</span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a>       <span class="at">units =</span> <span class="st">&#39;in&#39;</span>,</span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a>       <span class="at">dpi =</span> <span class="dv">300</span>,</span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a>       <span class="at">bg =</span> <span class="st">&#39;white&#39;</span>)</span></code></pre></div>
<p>Looking at spatial distribution of SSA</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>Spatial_distribution_SSA <span class="ot">&lt;-</span> xmp_corrected <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>  <span class="fu">filter</span>(BandName <span class="sc">==</span> <span class="st">&quot;NIR&quot;</span>) <span class="sc">%&gt;%</span> </span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>  <span class="fu">filter</span>(GPSLongitude <span class="sc">!=</span> <span class="dv">0</span> <span class="sc">&amp;</span> GPSLatitude <span class="sc">!=</span> <span class="dv">0</span>)<span class="sc">%&gt;%</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> GPSLongitude, <span class="at">y =</span> GPSLatitude, <span class="at">color =</span> SunSensorAngle_DLS1_deg)) <span class="sc">+</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a>  <span class="co">#geom_point(data = df_filtered, color = &quot;grey60&quot;) +</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="dv">4</span>) <span class="sc">+</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;Site: &quot;</span>,site_to_plot,<span class="st">&quot;, Date: &quot;</span>, date_to_plot, <span class="st">&quot;, Camera: &quot;</span>, camera_to_plot))<span class="sc">+</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a>  <span class="fu">theme_bw</span>() <span class="sc">+</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a>  <span class="fu">scale_color_viridis_c</span>() <span class="sc">+</span></span>
<span id="cb18-10"><a href="#cb18-10" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(. <span class="sc">~</span> Date, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>)</span>
<span id="cb18-11"><a href="#cb18-11" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> Spatial_distribution_SSA,</span>
<span id="cb18-13"><a href="#cb18-13" tabindex="-1"></a>       <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot), <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">0_SSA_spatial_distribution_plot.jpeg&quot;</span>),</span>
<span id="cb18-14"><a href="#cb18-14" tabindex="-1"></a>       <span class="at">device =</span> jpeg,</span>
<span id="cb18-15"><a href="#cb18-15" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">15</span>,</span>
<span id="cb18-16"><a href="#cb18-16" tabindex="-1"></a>       <span class="at">height =</span> <span class="dv">10</span>,</span>
<span id="cb18-17"><a href="#cb18-17" tabindex="-1"></a>       <span class="at">units =</span> <span class="st">&#39;in&#39;</span>,</span>
<span id="cb18-18"><a href="#cb18-18" tabindex="-1"></a>       <span class="at">dpi =</span> <span class="dv">300</span>,</span>
<span id="cb18-19"><a href="#cb18-19" tabindex="-1"></a>       <span class="at">bg =</span> <span class="st">&#39;white&#39;</span>)</span></code></pre></div>
<p>Calculating direct/scat ratio per band: used in title of below _5 and _6 plots</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a>xmp_corrected <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>,site_to_plot,<span class="st">&quot;_&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;_xmp_corrected.rds&quot;</span>))  <span class="co">#SET PATH to save the rds to</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a></span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a>avg_ratio_data <span class="ot">&lt;-</span> xmp_corrected <span class="sc">%&gt;%</span></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(BandName),<span class="sc">!</span><span class="fu">is.na</span>(camera))<span class="sc">%&gt;%</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>  <span class="fu">group_by</span>(BandName, camera) <span class="sc">%&gt;%</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>  <span class="fu">summarize</span>(<span class="at">median_ScatteredDirectRatio_DLS2 =</span> <span class="fu">median</span>(<span class="fu">as.numeric</span>(ScatteredIrradiance) <span class="sc">/</span><span class="fu">as.numeric</span>(DirectIrradiance), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>            <span class="at">median_ScatteredDirectRatio_DLS1_calc =</span> <span class="fu">median</span>(<span class="fu">as.numeric</span>(ScatteredIrradiance_new) <span class="sc">/</span><span class="fu">as.numeric</span>(DirectIrradiance_new), <span class="at">na.rm =</span> <span class="cn">TRUE</span>),</span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>            <span class="at">median_percent_scat_DLS2 =</span> <span class="fu">median</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">as.numeric</span>(ScatteredIrradiance)<span class="sc">/</span>(<span class="fu">as.numeric</span>(ScatteredIrradiance)<span class="sc">+</span><span class="fu">as.numeric</span>(DirectIrradiance))),</span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>            <span class="at">median_percent_scat_DLS1 =</span> <span class="fu">median</span>(<span class="dv">100</span><span class="sc">*</span><span class="fu">as.numeric</span>(ScatteredIrradiance_new)<span class="sc">/</span>(<span class="fu">as.numeric</span>(ScatteredIrradiance_new)<span class="sc">+</span><span class="fu">as.numeric</span>(DirectIrradiance_new))),</span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>            <span class="at">max_Date_time =</span> <span class="fu">max</span>(Date_time),</span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>            <span class="at">max_dir =</span> <span class="fu">max</span>(DirectIrradiance, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>  <span class="fu">ungroup</span>()<span class="sc">%&gt;%</span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>    <span class="at">Scattered_To_Direct_Ratio_DLS2 =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(median_ScatteredDirectRatio_DLS2,<span class="dv">2</span>)),</span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>    <span class="at">Scattered_To_Direct_Ratio_DLS1 =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(median_ScatteredDirectRatio_DLS1_calc,<span class="dv">2</span>)),</span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a>    <span class="at">Percent_Scat_DLS2 =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(median_percent_scat_DLS2,<span class="dv">2</span>)),</span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>    <span class="at">Percent_Scat_DLS1 =</span> <span class="fu">as.character</span>(<span class="fu">round</span>(median_percent_scat_DLS1,<span class="dv">2</span>)),</span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a>    <span class="at">x =</span> max_Date_time,</span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a>    <span class="at">y =</span> max_dir,</span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a>  )<span class="sc">%&gt;%</span></span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a>  dplyr<span class="sc">::</span><span class="fu">select</span>(<span class="fu">c</span>(Scattered_To_Direct_Ratio_DLS2,Scattered_To_Direct_Ratio_DLS1,Percent_Scat_DLS2,Percent_Scat_DLS1, x, y, BandName, camera))</span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a>xmp_corrected<span class="sc">$</span>dir_diff_ratio</span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a><span class="fu">unique</span>(xmp_corrected<span class="sc">$</span>CenterWavelength)</span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a></span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a><span class="fu">saveRDS</span>(avg_ratio_data,<span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">CSV</span><span class="sc">\\</span><span class="st">&quot;</span>,site_to_plot,<span class="st">&quot;_&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot),<span class="st">&quot;_avg_ratio_data.rds&quot;</span>))  <span class="co">#SET PATH to save the rds to</span></span></code></pre></div>
<p>Comparing original VS corrected data spectral data</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>data <span class="ot">=</span> avg_ratio_data <span class="sc">%&gt;%</span> <span class="fu">filter</span>(BandName <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Blue&quot;</span>))</span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>(Dir_scat_irr_plot <span class="ot">&lt;-</span> xmp_corrected <span class="sc">%&gt;%</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>    <span class="fu">filter</span>(BandName <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Blue&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">DirectIrradiance =</span> <span class="fu">as.numeric</span>(DirectIrradiance),</span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a>           <span class="at">ScatteredIrradiance =</span> <span class="fu">as.numeric</span>(ScatteredIrradiance),</span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a>           <span class="at">Irradiance =</span> <span class="fu">as.numeric</span>(Irradiance),</span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a>           <span class="at">SpectralIrradiance =</span> <span class="fu">as.numeric</span>(SpectralIrradiance),</span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a>           <span class="at">HorizontalIrradiance =</span> <span class="fu">as.numeric</span>(HorizontalIrradiance),</span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a>           <span class="co"># Date_time = ymd_hms(CreateDate),</span></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a>           <span class="at">Time =</span> <span class="fu">format</span>(Date_time, <span class="at">format =</span> <span class="st">&quot;%H:%M:%S&quot;</span>),</span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a>           <span class="co">#scaled </span></span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a>           <span class="at">DirectIrradiance_scaled =</span> <span class="fu">as.numeric</span>(DirectIrradiance)<span class="sc">*</span><span class="fl">0.01</span>,</span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a>           <span class="at">ScatteredIrradiance_scaled =</span> <span class="fu">as.numeric</span>(ScatteredIrradiance)<span class="sc">*</span><span class="fl">0.01</span>,</span>
<span id="cb20-16"><a href="#cb20-16" tabindex="-1"></a>           <span class="at">SpectralIrradiance_scaled =</span> <span class="fu">as.numeric</span>(SpectralIrradiance)<span class="sc">*</span><span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-17"><a href="#cb20-17" tabindex="-1"></a>    </span>
<span id="cb20-18"><a href="#cb20-18" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(Date_time)) <span class="sc">+</span></span>
<span id="cb20-19"><a href="#cb20-19" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> DirectIrradiance, <span class="at">color =</span> <span class="st">&quot;Direct&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-20"><a href="#cb20-20" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> DirectIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Direct_DLS1&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb20-21"><a href="#cb20-21" tabindex="-1"></a>    </span>
<span id="cb20-22"><a href="#cb20-22" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ScatteredIrradiance, <span class="at">color =</span> <span class="st">&quot;Scattered&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-23"><a href="#cb20-23" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> ScatteredIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Scattered_DLS1&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>,<span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb20-24"><a href="#cb20-24" tabindex="-1"></a>    </span>
<span id="cb20-25"><a href="#cb20-25" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> HorizontalIrradiance, <span class="at">color =</span> <span class="st">&quot;Horizontal&quot;</span>),<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-26"><a href="#cb20-26" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> HorizontalIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Horizontal_DLS1&quot;</span>),<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb20-27"><a href="#cb20-27" tabindex="-1"></a>    </span>
<span id="cb20-28"><a href="#cb20-28" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> Irradiance, <span class="at">color =</span> <span class="st">&quot;Irradiance&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-29"><a href="#cb20-29" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> HorizontalIrradiance, <span class="at">color =</span> <span class="st">&quot;Horizontal&quot;</span>),<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb20-30"><a href="#cb20-30" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> SpectralIrradiance, <span class="at">color =</span> <span class="st">&quot;Spectral&quot;</span>), <span class="at">linewidth =</span> <span class="fl">1.5</span>, <span class="at">linetype =</span> <span class="st">&quot;dotted&quot;</span>) <span class="sc">+</span></span>
<span id="cb20-31"><a href="#cb20-31" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Time&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Irradiance&quot;</span>, <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;DLS1 (corrected) vs. DLS2 (metadata) Irradiance, Site: &quot;</span>,site_to_plot,<span class="st">&quot;, </span></span>
<span id="cb20-32"><a href="#cb20-32" tabindex="-1"></a><span class="st">                                                      </span><span class="sc">\n</span><span class="st">Date: &quot;</span>, date_to_plot,<span class="st">&quot;, Camera: &quot;</span>, camera_to_plot,</span>
<span id="cb20-33"><a href="#cb20-33" tabindex="-1"></a>                                                      <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Scattered_To_Direct_Ratio_DLS1:&quot;</span>, data<span class="sc">$</span>Scattered_To_Direct_Ratio_DLS1,</span>
<span id="cb20-34"><a href="#cb20-34" tabindex="-1"></a>                                                      <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Scattered_To_Direct_Ratio_DLS2:&quot;</span>, data<span class="sc">$</span>Scattered_To_Direct_Ratio_DLS2,</span>
<span id="cb20-35"><a href="#cb20-35" tabindex="-1"></a>                                                      <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Percent_Scat_DLS1:&quot;</span>, data<span class="sc">$</span>Percent_Scat_DLS1,</span>
<span id="cb20-36"><a href="#cb20-36" tabindex="-1"></a>                                                      <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Percent_Scat_DLS2:&quot;</span>, data<span class="sc">$</span>Percent_Scat_DLS2</span>
<span id="cb20-37"><a href="#cb20-37" tabindex="-1"></a>                                                      )) <span class="sc">+</span></span>
<span id="cb20-38"><a href="#cb20-38" tabindex="-1"></a>    <span class="fu">scale_x_datetime</span>(<span class="at">date_breaks =</span> <span class="st">&quot;10 min&quot;</span>, <span class="at">date_labels =</span> <span class="st">&quot;%H:%M&quot;</span>) <span class="sc">+</span></span>
<span id="cb20-39"><a href="#cb20-39" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Direct&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>, </span>
<span id="cb20-40"><a href="#cb20-40" tabindex="-1"></a>                                  <span class="st">&quot;Direct_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;lightblue&quot;</span>,</span>
<span id="cb20-41"><a href="#cb20-41" tabindex="-1"></a>                                  <span class="st">&quot;Scattered&quot;</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb20-42"><a href="#cb20-42" tabindex="-1"></a>                                  <span class="st">&quot;Scattered_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;grey&quot;</span>,</span>
<span id="cb20-43"><a href="#cb20-43" tabindex="-1"></a>                                  <span class="st">&quot;Horizontal&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>,</span>
<span id="cb20-44"><a href="#cb20-44" tabindex="-1"></a>                                  <span class="st">&quot;Horizontal_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;orange&quot;</span>,</span>
<span id="cb20-45"><a href="#cb20-45" tabindex="-1"></a>                                  <span class="st">&quot;Spectral&quot;</span> <span class="ot">=</span> <span class="st">&quot;forestgreen&quot;</span>,</span>
<span id="cb20-46"><a href="#cb20-46" tabindex="-1"></a>                                  <span class="st">&quot;Irradiance&quot;</span> <span class="ot">=</span><span class="st">&quot;purple&quot;</span></span>
<span id="cb20-47"><a href="#cb20-47" tabindex="-1"></a>    ),</span>
<span id="cb20-48"><a href="#cb20-48" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;Irradiance (W/m2/nm)&quot;</span>)<span class="sc">+</span></span>
<span id="cb20-49"><a href="#cb20-49" tabindex="-1"></a>    <span class="fu">facet_grid</span>(BandName <span class="sc">~</span> camera, <span class="at">scales =</span> <span class="st">&quot;free&quot;</span>)<span class="sc">+</span></span>
<span id="cb20-50"><a href="#cb20-50" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb20-51"><a href="#cb20-51" tabindex="-1"></a>    <span class="co"># labs(subtitle = &quot;Numbers within each plot are the median direct/scattered irradiance ratios from metadata, ..._new names are those calulcated using the DLS1 method&quot;, size = 10) + </span></span>
<span id="cb20-52"><a href="#cb20-52" tabindex="-1"></a>    <span class="co"># labs(subtitle = &quot;Numbers within each plot are the median direct/scattered irradiance ratios from metadata&quot;, size = 10) + </span></span>
<span id="cb20-53"><a href="#cb20-53" tabindex="-1"></a>    </span>
<span id="cb20-54"><a href="#cb20-54" tabindex="-1"></a>    <span class="co"># geom_text(aes(x, y, label= SD_Ratio_DLS1),</span></span>
<span id="cb20-55"><a href="#cb20-55" tabindex="-1"></a>    <span class="co">#         # data = avg_ratio_data,</span></span>
<span id="cb20-56"><a href="#cb20-56" tabindex="-1"></a>    <span class="co">#          data = avg_ratio_data %&gt;% filter(BandName %in% c(&quot;Blue&quot;)), </span></span>
<span id="cb20-57"><a href="#cb20-57" tabindex="-1"></a>    <span class="co">#          vjust=1)</span></span>
<span id="cb20-58"><a href="#cb20-58" tabindex="-1"></a>    <span class="co"># geom_text(data = avg_ratio_data %&gt;% filter(BandName %in% c(&quot;Blue&quot;)), </span></span>
<span id="cb20-59"><a href="#cb20-59" tabindex="-1"></a>    <span class="co">#           aes(x = x, y = y, label = paste(&quot;Scattered_To_Direct_Ratio_DLS1:&quot;, Scattered_To_Direct_Ratio_DLS1)),</span></span>
<span id="cb20-60"><a href="#cb20-60" tabindex="-1"></a>    <span class="co">#           vjust = 2, hjust = 3) +</span></span>
<span id="cb20-61"><a href="#cb20-61" tabindex="-1"></a>    <span class="co"># geom_text(data = avg_ratio_data %&gt;% filter(BandName %in% c(&quot;Blue&quot;)), </span></span>
<span id="cb20-62"><a href="#cb20-62" tabindex="-1"></a>    <span class="co">#           aes(x = x, y = y, label = paste(&quot;Scattered_To_Direct_Ratio_DLS2:&quot;, Scattered_To_Direct_Ratio_DLS2)),</span></span>
<span id="cb20-63"><a href="#cb20-63" tabindex="-1"></a>    <span class="co">#           vjust = 4,hjust = 3) +</span></span>
<span id="cb20-64"><a href="#cb20-64" tabindex="-1"></a>    <span class="co"># geom_text(data = avg_ratio_data %&gt;% filter(BandName %in% c(&quot;Blue&quot;)), </span></span>
<span id="cb20-65"><a href="#cb20-65" tabindex="-1"></a>    <span class="co">#           aes(x = x, y = y, label = paste(&quot;Percent_Scat_DLS1:&quot;, Percent_Scat_DLS1)),</span></span>
<span id="cb20-66"><a href="#cb20-66" tabindex="-1"></a>    <span class="co">#           vjust = 6,hjust = 4.3) +</span></span>
<span id="cb20-67"><a href="#cb20-67" tabindex="-1"></a>    <span class="co"># geom_text(data = avg_ratio_data %&gt;% filter(BandName %in% c(&quot;Blue&quot;)), </span></span>
<span id="cb20-68"><a href="#cb20-68" tabindex="-1"></a>    <span class="co">#           aes(x = x, y = y, label = paste(&quot;Percent_Scat_DLS2:&quot;, Percent_Scat_DLS2)),</span></span>
<span id="cb20-69"><a href="#cb20-69" tabindex="-1"></a>    <span class="co">#           vjust = 8,hjust = 4.5)</span></span>
<span id="cb20-70"><a href="#cb20-70" tabindex="-1"></a>)</span>
<span id="cb20-71"><a href="#cb20-71" tabindex="-1"></a></span>
<span id="cb20-72"><a href="#cb20-72" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> Dir_scat_irr_plot,</span>
<span id="cb20-73"><a href="#cb20-73" tabindex="-1"></a>       <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot), <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">5_Irradiance_DLS1_DLS2_plot.jpeg&quot;</span>),</span>
<span id="cb20-74"><a href="#cb20-74" tabindex="-1"></a>       <span class="at">device =</span> jpeg,</span>
<span id="cb20-75"><a href="#cb20-75" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">15</span>,</span>
<span id="cb20-76"><a href="#cb20-76" tabindex="-1"></a>       <span class="at">height =</span> <span class="dv">10</span>,</span>
<span id="cb20-77"><a href="#cb20-77" tabindex="-1"></a>       <span class="at">units =</span> <span class="st">&#39;in&#39;</span>,</span>
<span id="cb20-78"><a href="#cb20-78" tabindex="-1"></a>       <span class="at">dpi =</span> <span class="dv">300</span>,</span>
<span id="cb20-79"><a href="#cb20-79" tabindex="-1"></a>       <span class="at">bg =</span> <span class="st">&#39;white&#39;</span>)</span></code></pre></div>
<p>Looking at direct irradiance alone:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>(Dir_horiz_irr_plot <span class="ot">&lt;-</span> xmp_corrected <span class="sc">%&gt;%</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>    <span class="fu">filter</span>(BandName <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">&quot;Blue&quot;</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">DirectIrradiance =</span> <span class="fu">as.numeric</span>(DirectIrradiance),</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>           <span class="at">ScatteredIrradiance =</span> <span class="fu">as.numeric</span>(ScatteredIrradiance),</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>           <span class="at">Irradiance =</span> <span class="fu">as.numeric</span>(Irradiance),</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>           <span class="at">SpectralIrradiance =</span> <span class="fu">as.numeric</span>(SpectralIrradiance),</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>           <span class="at">HorizontalIrradiance =</span> <span class="fu">as.numeric</span>(HorizontalIrradiance),</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>           <span class="co"># Date_time = ymd_hms(CreateDate),</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>           <span class="at">Time =</span> <span class="fu">format</span>(Date_time, <span class="at">format =</span> <span class="st">&quot;%H:%M:%S&quot;</span>),</span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>           <span class="co">#scaled </span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>           <span class="at">DirectIrradiance_scaled =</span> <span class="fu">as.numeric</span>(DirectIrradiance)<span class="sc">*</span><span class="fl">0.01</span>,</span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>           <span class="at">ScatteredIrradiance_scaled =</span> <span class="fu">as.numeric</span>(ScatteredIrradiance)<span class="sc">*</span><span class="fl">0.01</span>,</span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>           <span class="at">SpectralIrradiance_scaled =</span> <span class="fu">as.numeric</span>(SpectralIrradiance)<span class="sc">*</span><span class="fl">0.01</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a>    </span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a>    <span class="fu">ggplot</span>(<span class="fu">aes</span>(Date_time)) <span class="sc">+</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> DirectIrradiance, <span class="at">color =</span> <span class="st">&quot;Direct&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> DirectIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Direct_DLS1&quot;</span>), <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a>    </span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a>    </span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> HorizontalIrradiance, <span class="at">color =</span> <span class="st">&quot;Horizontal&quot;</span>),<span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> HorizontalIrradiance_new, <span class="at">color =</span> <span class="st">&quot;Horizontal_DLS1&quot;</span>),<span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">&quot;dashed&quot;</span>) <span class="sc">+</span></span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a>    </span>
<span id="cb21-23"><a href="#cb21-23" tabindex="-1"></a>    <span class="fu">labs</span>(<span class="at">x =</span> <span class="st">&quot;Time&quot;</span>, <span class="at">y =</span> <span class="st">&quot;Irradiance&quot;</span>, <span class="at">title =</span> <span class="fu">paste0</span>(<span class="st">&quot;DLS1 (corrected) vs. DLS2 (metadata) Direct and Horizontal Irradiance, </span></span>
<span id="cb21-24"><a href="#cb21-24" tabindex="-1"></a><span class="st">                                                      </span><span class="sc">\n</span><span class="st">Site: &quot;</span>,site_to_plot,<span class="st">&quot;, Date: &quot;</span>, date_to_plot,<span class="st">&quot;, Camera: &quot;</span>, camera_to_plot,</span>
<span id="cb21-25"><a href="#cb21-25" tabindex="-1"></a>                                                      <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Scattered_To_Direct_Ratio_DLS1:&quot;</span>, data<span class="sc">$</span>Scattered_To_Direct_Ratio_DLS1,</span>
<span id="cb21-26"><a href="#cb21-26" tabindex="-1"></a>                                                      <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Scattered_To_Direct_Ratio_DLS2:&quot;</span>, data<span class="sc">$</span>Scattered_To_Direct_Ratio_DLS2,</span>
<span id="cb21-27"><a href="#cb21-27" tabindex="-1"></a>                                                      <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Percent_Scat_DLS1:&quot;</span>, data<span class="sc">$</span>Percent_Scat_DLS1,</span>
<span id="cb21-28"><a href="#cb21-28" tabindex="-1"></a>                                                      <span class="st">&quot;</span><span class="sc">\n</span><span class="st">Percent_Scat_DLS2:&quot;</span>, data<span class="sc">$</span>Percent_Scat_DLS2)) <span class="sc">+</span></span>
<span id="cb21-29"><a href="#cb21-29" tabindex="-1"></a>    <span class="fu">scale_x_datetime</span>(<span class="at">date_breaks =</span> <span class="st">&quot;10 min&quot;</span>, <span class="at">date_labels =</span> <span class="st">&quot;%H:%M&quot;</span>) <span class="sc">+</span></span>
<span id="cb21-30"><a href="#cb21-30" tabindex="-1"></a>    <span class="fu">scale_color_manual</span>(<span class="at">values =</span> <span class="fu">c</span>(<span class="st">&quot;Direct&quot;</span> <span class="ot">=</span> <span class="st">&quot;blue&quot;</span>, </span>
<span id="cb21-31"><a href="#cb21-31" tabindex="-1"></a>                                  <span class="st">&quot;Direct_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;lightblue&quot;</span>,</span>
<span id="cb21-32"><a href="#cb21-32" tabindex="-1"></a>                                  <span class="st">&quot;Scattered&quot;</span> <span class="ot">=</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb21-33"><a href="#cb21-33" tabindex="-1"></a>                                  <span class="st">&quot;Scattered_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;grey&quot;</span>,</span>
<span id="cb21-34"><a href="#cb21-34" tabindex="-1"></a>                                  <span class="st">&quot;Horizontal&quot;</span> <span class="ot">=</span> <span class="st">&quot;red&quot;</span>,</span>
<span id="cb21-35"><a href="#cb21-35" tabindex="-1"></a>                                  <span class="st">&quot;Horizontal_DLS1&quot;</span> <span class="ot">=</span> <span class="st">&quot;orange&quot;</span>,</span>
<span id="cb21-36"><a href="#cb21-36" tabindex="-1"></a>                                  <span class="st">&quot;Spectral&quot;</span> <span class="ot">=</span> <span class="st">&quot;forestgreen&quot;</span>,</span>
<span id="cb21-37"><a href="#cb21-37" tabindex="-1"></a>                                  <span class="st">&quot;Irradiance&quot;</span> <span class="ot">=</span><span class="st">&quot;purple&quot;</span></span>
<span id="cb21-38"><a href="#cb21-38" tabindex="-1"></a>    ),</span>
<span id="cb21-39"><a href="#cb21-39" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;Irradiance (W/m2/nm)&quot;</span>) <span class="sc">+</span></span>
<span id="cb21-40"><a href="#cb21-40" tabindex="-1"></a>    <span class="co"># facet_wrap(~ BandName, scales = &quot;free&quot;, ncol = 2)+</span></span>
<span id="cb21-41"><a href="#cb21-41" tabindex="-1"></a>    <span class="fu">theme_bw</span>()</span>
<span id="cb21-42"><a href="#cb21-42" tabindex="-1"></a>    <span class="co"># labs(subtitle = &quot;Numbers within each plot are the median direct/scattered irradiance ratios from metadata, ..._new names are those calulcated using the DLS1 method&quot;, size = 10) + </span></span>
<span id="cb21-43"><a href="#cb21-43" tabindex="-1"></a>    <span class="co"># labs(subtitle = &quot;Numbers within each plot are the median direct/scattered irradiance ratios from metadata&quot;, size = 10) + </span></span>
<span id="cb21-44"><a href="#cb21-44" tabindex="-1"></a>    </span>
<span id="cb21-45"><a href="#cb21-45" tabindex="-1"></a>    <span class="co"># geom_text(aes(x, y, label= SD_Ratio_DLS1),</span></span>
<span id="cb21-46"><a href="#cb21-46" tabindex="-1"></a>    <span class="co">#         # data = avg_ratio_data,</span></span>
<span id="cb21-47"><a href="#cb21-47" tabindex="-1"></a>    <span class="co">#          data = avg_ratio_data %&gt;% filter(BandName %in% c(&quot;Blue&quot;)), </span></span>
<span id="cb21-48"><a href="#cb21-48" tabindex="-1"></a>    <span class="co">#          vjust=1)</span></span>
<span id="cb21-49"><a href="#cb21-49" tabindex="-1"></a>    <span class="co"># geom_text(data = avg_ratio_data %&gt;% filter(BandName %in% c(&quot;Blue&quot;)), </span></span>
<span id="cb21-50"><a href="#cb21-50" tabindex="-1"></a>    <span class="co">#           aes(x = x, y = y, label = paste(&quot;Scattered_To_Direct_Ratio_DLS2:&quot;, Scattered_To_Direct_Ratio_DLS1)),</span></span>
<span id="cb21-51"><a href="#cb21-51" tabindex="-1"></a>    <span class="co">#           vjust = 36, hjust = 4.5) +</span></span>
<span id="cb21-52"><a href="#cb21-52" tabindex="-1"></a>    <span class="co"># geom_text(data = avg_ratio_data %&gt;% filter(BandName %in% c(&quot;Blue&quot;)), </span></span>
<span id="cb21-53"><a href="#cb21-53" tabindex="-1"></a>    <span class="co">#           aes(x = x, y = y, label = paste(&quot;Scattered_To_Direct_Ratio_DLS2:&quot;, Scattered_To_Direct_Ratio_DLS2)),</span></span>
<span id="cb21-54"><a href="#cb21-54" tabindex="-1"></a>    <span class="co">#           vjust = 38,hjust = 4.5) +</span></span>
<span id="cb21-55"><a href="#cb21-55" tabindex="-1"></a>    <span class="co"># geom_text(data = avg_ratio_data %&gt;% filter(BandName %in% c(&quot;Blue&quot;)), </span></span>
<span id="cb21-56"><a href="#cb21-56" tabindex="-1"></a>    <span class="co">#           aes(x = x, y = y, label = paste(&quot;Percent_Scat_DLS1:&quot;, Percent_Scat_DLS1)),</span></span>
<span id="cb21-57"><a href="#cb21-57" tabindex="-1"></a>    <span class="co">#           vjust = 40,hjust = 6.5) +</span></span>
<span id="cb21-58"><a href="#cb21-58" tabindex="-1"></a>    <span class="co"># geom_text(data = avg_ratio_data %&gt;% filter(BandName %in% c(&quot;Blue&quot;)), </span></span>
<span id="cb21-59"><a href="#cb21-59" tabindex="-1"></a>    <span class="co">#           aes(x = x, y = y, label = paste(&quot;Percent_Scat_DLS2:&quot;, Percent_Scat_DLS2)),</span></span>
<span id="cb21-60"><a href="#cb21-60" tabindex="-1"></a>    <span class="co">#           vjust = 42,hjust = 6.5)</span></span>
<span id="cb21-61"><a href="#cb21-61" tabindex="-1"></a>  </span>
<span id="cb21-62"><a href="#cb21-62" tabindex="-1"></a>)</span>
<span id="cb21-63"><a href="#cb21-63" tabindex="-1"></a></span>
<span id="cb21-64"><a href="#cb21-64" tabindex="-1"></a></span>
<span id="cb21-65"><a href="#cb21-65" tabindex="-1"></a><span class="fu">ggsave</span>(<span class="at">plot =</span> Dir_horiz_irr_plot,</span>
<span id="cb21-66"><a href="#cb21-66" tabindex="-1"></a>       <span class="at">filename =</span> <span class="fu">paste0</span>(<span class="st">&quot;Q:</span><span class="sc">\\</span><span class="st">SNC</span><span class="sc">\\</span><span class="st">Data</span><span class="sc">\\</span><span class="st">&quot;</span>, site_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">Flights</span><span class="sc">\\</span><span class="st">&quot;</span>,<span class="fu">gsub</span>(<span class="st">&quot;-&quot;</span>, <span class="st">&quot;_&quot;</span>, date_to_plot), <span class="st">&quot;</span><span class="sc">\\</span><span class="st">1_Data</span><span class="sc">\\</span><span class="st">&quot;</span>,camera_to_plot,<span class="st">&quot;</span><span class="sc">\\</span><span class="st">6_Direct_Horiztonal_Irradiance_DLS1_DLS2_plot.jpeg&quot;</span>),</span>
<span id="cb21-67"><a href="#cb21-67" tabindex="-1"></a>       <span class="at">device =</span> jpeg,</span>
<span id="cb21-68"><a href="#cb21-68" tabindex="-1"></a>       <span class="at">width =</span> <span class="dv">15</span>,</span>
<span id="cb21-69"><a href="#cb21-69" tabindex="-1"></a>       <span class="at">height =</span> <span class="dv">10</span>,</span>
<span id="cb21-70"><a href="#cb21-70" tabindex="-1"></a>       <span class="at">units =</span> <span class="st">&#39;in&#39;</span>,</span>
<span id="cb21-71"><a href="#cb21-71" tabindex="-1"></a>       <span class="at">dpi =</span> <span class="dv">300</span>,</span>
<span id="cb21-72"><a href="#cb21-72" tabindex="-1"></a>       <span class="at">bg =</span> <span class="st">&#39;white&#39;</span>)</span></code></pre></div>
</div>
<div id="visualizing-the" class="section level3 hasAnchor" number="1.4.7">
<h3><span class="header-section-number">1.4.7</span> Visualizing the<a href="#visualizing-the" class="anchor-section" aria-label="Anchor link to header"></a></h3>
<p><a href="09-Crown_delineation#Crown-delineation">derivation of</a></p>
</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>


    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"whatsapp": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/owaite/GenomeBC_BPG/edit/main/%s",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/owaite/GenomeBC_BPG/blob/main/%s",
"text": null
},
"download": null,
"search": false,
"toc": {
"collapse": "subsection"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
